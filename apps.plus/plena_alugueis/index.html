<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plena Aluguéis - Gestão Profissional</title>

    <meta name="theme-color" content="#2563EB">
    <meta name="msapplication-TileColor" content="#2563EB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Plena Aluguéis">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        plena: {
                            blue: '#2563EB',
                            dark: '#1e3a8a',
                            black: '#0f172a',
                            orange: '#f59e0b',
                            gray: '#334155',
                            lightblue: '#60A5FA',
                            purple: '#7C3AED'
                        },
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out',
                    }
                }
            }
        }
    </script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* CSS Otimizado */
        :root {
            --plena-blue: #2563EB;
            --plena-dark: #1e3a8a;
            --plena-black: #0f172a;
            --plena-orange: '#f59e0b';
            --plena-gray: #334155;
            --plena-lightblue: #60A5FA;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #F3F4F6;
            -webkit-tap-highlight-color: transparent;
        }

        .hide {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-10px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        /* Sidebar Mobile */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
                height: 100vh;
                width: 280px;
            }

            .sidebar.open {
                transform: translateX(0);
            }
        }

        @media (min-width: 1025px) {
            .sidebar {
                width: 280px;
                position: fixed;
                height: 100vh;
            }

            .main-content {
                margin-left: 280px;
            }
        }

        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background-color: #DCFCE7;
            color: #166534;
        }

        .badge-warning {
            background-color: #FEF3C7;
            color: #92400E;
        }

        .badge-danger {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Tutorial Steps */
        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }

        /* Checklist */
        .checklist-item {
            transition: all 0.2s ease;
        }

        .checklist-item.completed {
            opacity: 0.7;
            text-decoration: line-through;
        }

        /* Code-like examples */
        .code-block {
            background: #1a1a1a;
            color: #f8f8f2;
            padding: 12px 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 8px 0;
        }

        /* Progress bar */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7C3AED, #5b21b6);
            transition: width 0.5s ease;
        }

        .main-content {
            padding-bottom: 0;
        }

        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                height: 100vh;
                margin: 0;
                padding: 0;
            }

            /* Hide everything by default */
            body>* {
                display: none !important;
            }

            /* Only show the active modal if it's the receipt modal */
            #receiptModal {
                display: flex !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background: white;
                z-index: 9999;
                align-items: flex-start;
                /* Align top for print */
                justify-content: center;
                overflow: visible !important;
            }

            #receiptModal .bg-white {
                box-shadow: none !important;
                max-width: 100% !important;
                width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* Specific Print Adjustments for Receipt Content */
            #receipt-content {
                padding: 40px !important;
                /* Standard A4 padding */
                width: 100%;
                font-size: 12pt;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Print Styles */
        @media print {

            /* Hide UI elements */
            .sidebar,
            .mobile-nav,
            .header-search,
            .view-section>div:first-child,
            /* Hide section titles */
            button:not(.print-only),
            .no-print,
            #month-selector-container,
            #report-filters-card,
            .data-entry-fab {
                display: none !important;
            }

            /* Adjust Layout */
            body,
            main {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
            }

            main {
                margin-left: 0 !important;
                padding-bottom: 0 !important;
            }

            .content-area {
                padding: 0 !important;
            }

            /* Report Header Visibility */
            #print-header {
                display: block !important;
                margin-bottom: 2rem;
                border-bottom: 2px solid #eee;
                padding-bottom: 1rem;
            }

            /* Typography */
            body {
                font-size: 11pt;
                color: #000;
            }

            h2,
            h3 {
                color: #000 !important;
            }

            /* Cards for Print */
            .bg-white,
            .bg-gray-50,
            .bg-green-50,
            .bg-red-50,
            .bg-blue-50 {
                background: white !important;
                border: 1px solid #ddd !important;
                box-shadow: none !important;
                break-inside: avoid;
            }

            /* Table optimization */
            table {
                width: 100% !important;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }

            /* Colors functionality */
            .text-green-600 {
                color: #166534 !important;
            }

            .text-red-600 {
                color: #dc2626 !important;
            }

            /* Force chart bars to print background colors */
            .print-color-exact {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="text-gray-800 antialiased">

    <!-- Overlay para sidebar mobile -->
    <div id="overlay" class="fixed inset-0 bg-black/50 hidden z-40 transition-opacity" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="sidebar bg-plena-black text-white transition-transform duration-300 flex flex-col shadow-2xl">
        <div class="h-20 flex items-center px-6 bg-gradient-to-r from-plena-blue to-plena-dark">
            <i data-lucide="home" class="w-8 h-8 mr-3"></i>
            <div>
                <h1 class="text-xl font-bold tracking-tight">PLENA ALUGUÉIS</h1>
                <p class="text-xs text-white/90 font-medium">Gestão Profissional de Imóveis</p>
            </div>
        </div>

        <nav class="p-4 space-y-2 flex-1 overflow-y-auto">
            <button onclick="router('dashboard')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group active-nav"
                id="nav-dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Dashboard
            </button>
            <button onclick="router('properties')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-properties">
                <i data-lucide="building-2" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Imóveis
            </button>
            <button onclick="router('tenants')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-tenants">
                <i data-lucide="users" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Inquilinos
            </button>
            <button onclick="router('transactions')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-transactions">
                <i data-lucide="wallet" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Financeiro
            </button>
            <button onclick="router('reports')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-reports">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Relatórios
            </button>
            <button onclick="router('settings')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-settings">
                <i data-lucide="settings" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Configurações
            </button>
            <button onclick="router('instructions')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-instructions">
                <i data-lucide="book-open" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Manual de Uso
            </button>

            <button onclick="router('about')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-about">
                <i data-lucide="info" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                Sobre a Plena
            </button>

            <button onclick="router('system')"
                class="nav-item w-full flex items-center px-4 py-3 rounded-xl hover:bg-white/10 transition-all group"
                id="nav-system">
                <i data-lucide="settings" class="w-5 h-5 mr-3 text-gray-400 group-hover:text-white"></i>
                <span class="font-medium">Sistema</span>
            
                <span id="sidebar-badge" class="hidden ml-auto flex h-3 w-3">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                </span>
</button>




        </nav>

        <div class="p-6 border-t border-white/10 text-center">
            <p class="text-xs text-gray-500">Todos os Direitos Reservados &copy; 2026</p>
            <a href="https://www.plenaaplicativos.com.br" target="_blank"
                class="text-[10px] text-gray-600 hover:text-plena-blue transition-colors mt-1 block decoration-0">
                Plena Soluções Digitais LTDA
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content min-h-screen flex flex-col">
        <!-- Header -->
        <header
            class="bg-white h-20 flex items-center justify-between px-4 lg:px-8 sticky top-0 z-30 shadow-sm border-b border-gray-100">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 hover:bg-gray-100 rounded-lg text-gray-600">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="page-title" class="text-xl font-bold text-gray-800 hidden sm:block">Dashboard</h2>
            </div>

            <div class="flex items-center gap-2 sm:gap-3">
                <!-- Notification Bell -->
                <button onclick="router('system')"
                    class="relative p-2 mr-2 text-gray-500 hover:bg-gray-100 rounded-full transition-colors group"
                    title="Notificações do Sistema">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span id="header-badge" class="absolute top-2 right-2 flex h-3 w-3 hidden">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500 border-2 border-white"></span>
                    </span>
                </button>

                <div class="relative group">
                    <div
                        class="absolute -inset-1 bg-plena-purple/20 rounded-lg blur opacity-0 group-hover:opacity-100 transition duration-300">
                    </div>
                    <button onclick="openPropertyModal()"
                        class="relative flex items-center px-4 py-2.5 bg-plena-blue text-white rounded-lg text-sm font-bold hover:bg-plena-dark transition-all shadow-lg shadow-blue-200 active:scale-95">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        <span>Novo Imóvel</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-4 lg:p-8 flex-1 overflow-y-auto">

            <!-- System View v5.3 -->
            <section id="view-system" class="view-section hide fade-in">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 tracking-tight">Sistema e Atualizações</h2>
                        <p class="text-gray-500 text-sm mt-1">Central de notificações e controle de versão.</p>
                    </div>
                    <div
                        class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 text-green-700 rounded-full text-xs font-bold border border-green-100">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        Sistema Online
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative overflow-hidden">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="font-bold text-gray-700 flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-plena-blue">
                                        <i data-lucide="bell" class="w-4 h-4"></i>
                                    </div>
                                    Notificações do Sistema
                                </h3>
                                <button onclick="markAllAsRead()"
                                    class="text-xs font-medium text-gray-400 hover:text-plena-blue transition flex items-center gap-1">
                                    <i data-lucide="check-check" class="w-3 h-3"></i> Limpar tudo
                                </button>
                            </div>
                            <div id="notification-feed-container" class="space-y-3 min-h-[100px]">
                                <div class="text-center py-8 opacity-50">
                                    <i data-lucide="loader-2"
                                        class="w-6 h-6 mx-auto animate-spin text-plena-blue mb-2"></i>
                                    <p class="text-xs text-gray-400">Verificando...</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                <i data-lucide="activity" class="w-4 h-4 text-gray-400"></i>
                                Diagnóstico do Dispositivo
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div
                                    class="bg-gray-50 p-4 rounded-xl flex items-center justify-between border border-gray-100">
                                    <div>
                                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">
                                            Conexão</div>
                                        <div class="text-green-600 font-bold text-sm mt-1 flex items-center gap-1">
                                            <i data-lucide="wifi" class="w-3 h-3"></i> Online
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="bg-gray-50 p-4 rounded-xl flex items-center justify-between border border-gray-100">
                                    <div>
                                        <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">
                                            Armazenamento</div>
                                        <div class="text-blue-600 font-bold text-sm mt-1" id="storage-status">
                                            Calculando...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl relative overflow-hidden group">
                            <div class="absolute -right-6 -top-6 opacity-5 transform rotate-12">
                                <i data-lucide="cpu" class="w-32 h-32 text-white"></i>
                            </div>
                            <div class="relative z-10">
                                <div class="text-[10px] uppercase tracking-widest font-bold mb-1 text-slate-400">VERSÃO
                                    INSTALADA</div>
                                <div
                                    class="text-5xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-white to-blue-300">
                                    v5.3</div>
                                <div class="text-slate-400 text-xs mb-6 border-l-2 border-slate-700 pl-3">
                                    Build 2026.01.24<br>Plena Aluguéis Pro
                                </div>
                                <button onclick="checkForUpdates()"
                                    class="w-full bg-plena-blue hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                    Verificar Atualizações
                                </button>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-700 mb-2">Sobre esta versão</h3>
                            <p class="text-xs text-gray-500 leading-relaxed">
                                A versão 5.3 traz melhorias significativas de performance, correções de segurança na
                                geração de recibos e compatibilidade expandida.
                            </p>
                        </div>
                    </div>
                </div>
            </section <!-- Dashboard View -->
            <section id="view-dashboard" class="view-section fade-in">
                <!-- Month Selector -->
                <div
                    class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 text-plena-blue"></i>
                            Visão Geral
                        </h3>
                        <p class="text-sm text-gray-500">Acompanhe o desempenho mensal</p>
                    </div>
                    <div class="flex items-center gap-3 w-full sm:w-auto">
                        <div class="relative w-full sm:w-auto">
                            <i data-lucide="calendar"
                                class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-plena-blue"></i>
                            <input type="month" id="month-selector" onchange="renderDashboard()"
                                class="w-full sm:w-auto pl-10 pr-4 py-2.5 rounded-lg border-2 border-plena-purple/20 text-sm bg-plena-purple/5 font-bold text-plena-dark focus:border-plena-purple focus:ring-4 focus:ring-plena-purple/10 outline-none transition-all cursor-pointer hover:bg-plena-purple/10">
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Ocupação</p>
                                <h3 id="dash-occupancy" class="text-3xl font-bold text-gray-900">0/0</h3>
                                <p class="text-xs text-gray-500 mt-1">Imóveis ocupados</p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-plena-purple/10 flex items-center justify-center">
                                <i data-lucide="home" class="w-6 h-6 text-plena-blue"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Recebido (Mês)
                                </p>
                                <h3 id="dash-received" class="text-2xl font-bold text-green-600">R$ 0,00</h3>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="received-growth" class="text-green-500">+0%</span> vs último mês
                                </p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-6 h-6 text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Pendente</p>
                                <h3 id="dash-pending" class="text-2xl font-bold text-red-600">R$ 0,00</h3>
                                <p class="text-xs text-gray-500 mt-1">
                                    <span id="pending-growth" class="text-red-500">+0%</span> vs último mês
                                </p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                <i data-lucide="alert-circle" class="w-6 h-6 text-red-600"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Saldo Total</p>
                                <h3 id="dash-balance" class="text-2xl font-bold text-blue-600">R$ 0,00</h3>
                                <p class="text-xs text-gray-500 mt-1">Disponível</p>
                            </div>
                            <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                                <i data-lucide="wallet" class="w-6 h-6 text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Status -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800">Status dos Pagamentos</h3>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                    <span class="text-xs text-gray-600">Pago</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                    <span class="text-xs text-gray-600">Pendente</span>
                                </div>
                            </div>
                        </div>
                        <div id="payment-status-list" class="space-y-4"></div>
                    </div>

                    <!-- Upcoming Payments -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="calendar" class="w-4 h-4 mr-2 text-plena-blue"></i>
                                Próximos Vencimentos
                            </h3>
                            <div id="upcoming-payments" class="space-y-3">
                                <!-- Dynamic content -->
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4">Imóveis Vagos</h3>
                            <div id="vacant-properties" class="space-y-3">
                                <!-- Dynamic content -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Properties View -->
            <section id="view-properties" class="view-section hide fade-in">
                <div class="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Imóveis</h2>
                        <p class="text-sm text-gray-600">Gerencie todos os seus imóveis</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- Botão de exportação removido -->
                    </div>
                </div>

                <!-- Properties Grid -->
                <div id="properties-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>

            <!-- Tenants View -->
            <section id="view-tenants" class="view-section hide fade-in">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Inquilinos</h2>
                    <p class="text-sm text-gray-600">Gerencie todos os inquilinos ativos</p>
                </div>

                <!-- Tenants List -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-3">Nome</th>
                                    <th class="px-6 py-3">Imóvel</th>
                                    <th class="px-6 py-3">WhatsApp</th>
                                    <th class="px-6 py-3">Aluguel</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tenants-table-body" class="divide-y divide-gray-100 text-sm"></tbody>
                        </table>
                    </div>
                    <div id="tenants-empty-msg" class="hidden p-8 text-center text-gray-400">
                        <i data-lucide="users" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Nenhum inquilino cadastrado.</p>
                    </div>
                </div>
            </section>

            <!-- Transactions View -->
            <section id="view-transactions" class="view-section hide fade-in">
                <div class="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Financeiro</h2>
                        <p class="text-sm text-gray-600">Gerencie todas as movimentações financeiras</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openTransModal()"
                            class="flex items-center gap-2 px-4 py-2 bg-plena-black text-white rounded-lg text-sm font-bold hover:bg-gray-900 transition-colors shadow-lg shadow-gray-200">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Lançar Movimentação
                        </button>
                        <!-- Botão de exportação removido -->
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                    <div class="p-4 bg-gray-50 grid grid-cols-1 md:grid-cols-4 gap-3 border-b border-gray-200">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="search-transactions" onkeyup="renderTransactions()"
                                placeholder="Buscar..."
                                class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-plena-purple outline-none text-sm">
                        </div>
                        <div>
                            <input type="date" id="filter-start-date" onchange="renderTransactions()"
                                class="w-full border p-2 rounded-lg text-sm bg-white">
                        </div>
                        <div>
                            <input type="date" id="filter-end-date" onchange="renderTransactions()"
                                class="w-full border p-2 rounded-lg text-sm bg-white">
                        </div>
                        <div class="flex gap-2">
                            <select id="filter-trans-type" onchange="renderTransactions()"
                                class="flex-1 px-4 py-2 rounded-lg border border-gray-300 text-sm bg-white outline-none">
                                <option value="all">Todos</option>
                                <option value="income">Entradas</option>
                                <option value="expense">Saídas</option>
                            </select>
                            <button onclick="clearTransactionFilters()"
                                class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm transition-colors">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                                <tr>
                                    <th class="px-6 py-3">Data</th>
                                    <th class="px-6 py-3">Descrição</th>
                                    <th class="px-6 py-3">Imóvel</th>
                                    <th class="px-6 py-3">Tipo</th>
                                    <th class="px-6 py-3 text-right">Valor</th>
                                    <th class="px-6 py-3 text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="trans-table-body" class="divide-y divide-gray-100 text-sm"></tbody>
                        </table>
                    </div>
                    <div id="trans-empty-msg" class="hidden p-8 text-center text-gray-400">
                        <i data-lucide="file-text" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                        <p>Nenhuma transação encontrada.</p>
                    </div>
                </div>

                <!-- Summary -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Total Entradas</p>
                        <p id="filter-income" class="text-lg font-bold text-green-700">R$ 0,00</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Total Saídas</p>
                        <p id="filter-expense" class="text-lg font-bold text-red-700">R$ 0,00</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1">Saldo Filtrado</p>
                        <p id="filter-balance" class="text-lg font-bold text-blue-700">R$ 0,00</p>
                    </div>
                </div>
            </section>

            <!-- Reports View -->
            <section id="view-reports" class="view-section hide fade-in">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Relatórios Avançados</h2>
                    <p class="text-sm text-gray-600">Gere relatórios detalhados para análise financeira</p>
                </div>

                <!-- Print Header (Hidden on Screen) -->
                <div id="print-header" class="hidden">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-plena-black rounded-lg flex items-center justify-center">
                                <i data-lucide="building-2" class="w-6 h-6 text-white"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-900">Relatório Financeiro</h1>
                                <p class="text-sm text-gray-500" id="print-subtitle">Plena Aluguéis</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-800" id="print-date">Gerado em: DD/MM/AAAA</p>
                            <p class="text-xs text-gray-500" id="print-period">Período: -</p>
                        </div>
                    </div>
                </div>

                <!-- Report Filters (No-Print) -->
                <div id="report-filters-card"
                    class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6 no-print">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h3 class="font-bold text-gray-800">Configurar Período</h3>

                        <!-- Shortcuts -->
                        <div class="flex gap-2 bg-gray-100 p-1 rounded-lg overflow-x-auto max-w-full">
                            <button onclick="setReportPeriod('last-month')"
                                class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-gray-900 rounded-md transition-all whitespace-nowrap">Mês
                                Passado</button>
                            <button onclick="setReportPeriod('this-year')"
                                class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-gray-900 rounded-md transition-all whitespace-nowrap">Este
                                Ano</button>
                            <button onclick="setReportPeriod('last-year')"
                                class="px-3 py-1.5 text-xs font-medium text-gray-600 hover:bg-white hover:text-gray-900 rounded-md transition-all whitespace-nowrap">Ano
                                Passado</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Data Inicial</label>
                            <input type="date" id="rep-start"
                                class="w-full border border-gray-300 p-2.5 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-plena-blue outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Data Final</label>
                            <input type="date" id="rep-end"
                                class="w-full border border-gray-300 p-2.5 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-plena-blue outline-none">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="generateReport()"
                                class="flex-1 bg-plena-black text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-gray-900 transition-colors shadow-lg shadow-gray-200 flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i>
                                Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Results -->
                <div id="report-result" class="hide space-y-6">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-6 rounded-xl text-center border border-green-100">
                            <div
                                class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="trending-up" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Entradas</p>
                            <p id="rep-inc" class="text-2xl font-bold text-green-700 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-red-50 p-6 rounded-xl text-center border border-red-100">
                            <div
                                class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="trending-down" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Saídas</p>
                            <p id="rep-exp" class="text-2xl font-bold text-red-700 mt-2">R$ 0,00</p>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-xl text-center border border-blue-100">
                            <div
                                class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="wallet" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Saldo</p>
                            <p id="rep-bal" class="text-2xl font-bold text-blue-700 mt-2">R$ 0,00</p>
                        </div>
                    </div>

                    <!-- Print & Share Actions (Visible only after generation) -->
                    <div class="flex justify-end gap-2 no-print">
                        <button onclick="shareReport()"
                            class="bg-green-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg shadow-green-200">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            WhatsApp
                        </button>
                        <button onclick="printReport()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-lg shadow-blue-200">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                            Imprimir Relatório
                        </button>
                    </div>

                    <!-- Visual Chart & Category Analysis -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Visual Cashflow Chart -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-6">Fluxo Visual</h3>
                            <div id="financial-chart" class="space-y-4">
                                <!-- Filled by JS -->
                            </div>
                        </div>

                        <!-- Category Breakdown -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4">Despesas por Categoria</h3>
                            <div id="category-report" class="space-y-3">
                                <!-- Filled by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Property Breakdown -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-4">Detalhamento por Imóvel</h3>
                        <div id="property-report" class="space-y-2"></div>
                    </div>
                </div>
            </section>

            <!-- Settings View -->
            <section id="view-settings" class="view-section hide fade-in">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Configurações do Sistema</h2>
                    <p class="text-sm text-gray-600">Personalize e gerencie suas preferências</p>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">

                    <!-- 1. Dados do Proprietário -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full">
                        <h3 class="font-bold text-gray-800 mb-6 flex items-center text-lg">
                            <div class="p-2 bg-plena-purple/10 rounded-lg mr-3">
                                <i data-lucide="user-circle-2" class="w-5 h-5 text-plena-blue"></i>
                            </div>
                            Dados do Proprietário
                        </h3>

                        <div class="space-y-5 flex-1">
                            <!-- Tipo de uso removido -->
                            <div id="establishment-name-container">
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Nome do
                                    Estabelecimento</label>
                                <input type="text" id="set-establishment-name"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-2 focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                    placeholder="Ex: Imobiliária Silva Ltda">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Nome / Razão
                                    Social</label>
                                <input type="text" id="set-owner-name"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-2 focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                    placeholder="Ex: João Silva Imóveis">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">CPF /
                                    CNPJ</label>
                                <input type="text" id="set-owner-doc"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-2 focus:ring-2 focus:ring-plena-purple focus:border-transparent outline-none transition-all"
                                    placeholder="000.000.000-00">
                                <p class="text-[10px] text-gray-400 mt-1">Este dado aparecerá no rodapé dos recibos.
                                </p>
                            </div>
                        </div>
                        <button onclick="saveGlobalSettings()"
                            class="mt-4 w-full bg-blue-600 text-white py-3 rounded-xl text-sm font-bold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i>
                            Salvar Dados do Proprietário
                        </button>
                    </div>

                    <!-- 2. Multas e Juros -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full">
                        <h3 class="font-bold text-gray-800 mb-6 flex items-center text-lg">
                            <div class="p-2 bg-plena-purple/10 rounded-lg mr-3">
                                <i data-lucide="percent" class="w-5 h-5 text-plena-blue"></i>
                            </div>
                            Multas e Juros (Cálculo Automático)
                        </h3>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-5 flex-1">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Multa Atraso
                                    (%)</label>
                                <div class="relative mt-2">
                                    <input type="number" step="0.1" id="set-late-fee"
                                        class="w-full border border-gray-300 p-3 rounded-xl text-sm focus:ring-2 focus:ring-plena-purple focus:border-transparent outline-none transition-all pl-3"
                                        placeholder="2.0">
                                    <span class="absolute right-4 top-3 text-gray-400 text-sm">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase tracking-wide">Juros/Dia
                                    (%)</label>
                                <div class="relative mt-2">
                                    <input type="number" step="0.001" id="set-daily-interest"
                                        class="w-full border border-gray-300 p-3 rounded-xl text-sm focus:ring-2 focus:ring-plena-purple focus:border-transparent outline-none transition-all pl-3"
                                        placeholder="0.033">
                                    <span class="absolute right-4 top-3 text-gray-400 text-sm">%</span>
                                </div>
                            </div>
                        </div>

                        <button onclick="saveGlobalSettings()"
                            class="w-full bg-gray-900 text-white py-3.5 rounded-xl text-sm font-bold hover:bg-black transition-transform active:scale-95 shadow-lg shadow-gray-200">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Salvar Configurações
                        </button>
                    </div>

                    <!-- 3. Categorias -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 h-full">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-gray-800 flex items-center">
                                <i data-lucide="tag" class="w-5 h-5 mr-2 text-plena-blue"></i>
                                Categorias de Despesas
                            </h3>
                            <button onclick="toggleCatForm()"
                                class="flex items-center gap-2 px-3 py-1.5 bg-plena-purple text-white text-sm rounded-lg hover:bg-plena-dark">
                                <i data-lucide="plus" class="w-4 h-4"></i> Nova
                            </button>
                        </div>

                        <!-- Category Form -->
                        <div id="cat-form-box"
                            class="hidden mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200 slide-in">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" id="new-cat-name" placeholder="Nome da categoria"
                                    class="border p-2 rounded-lg text-sm">
                                <div class="flex gap-2">
                                    <input type="color" id="new-cat-color" value="#7C3AED"
                                        class="h-10 w-10 p-0 border-0 rounded cursor-pointer">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="addCategory()"
                                    class="flex-1 bg-gray-800 text-white py-2 rounded-lg text-sm font-bold hover:bg-black">
                                    Salvar Categoria
                                </button>
                                <button onclick="toggleCatForm()"
                                    class="px-4 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">
                                    Cancelar
                                </button>
                            </div>
                        </div>

                        <!-- Categories List -->
                        <div id="cat-list" class="space-y-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                        </div>
                    </div>

                    <!-- 4. Segurança e Dados -->
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                                <i data-lucide="shield-check" class="w-5 h-5 mr-2 text-plena-blue"></i>
                                Segurança de Dados
                            </h3>

                            <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-sm text-blue-800 mb-6">
                                <p class="font-bold mb-2">⚠️ Importante</p>
                                <p>Seus dados ficam salvos 100% no navegador. Faça backup regularmente!</p>
                            </div>

                            <div class="space-y-3">
                                <button onclick="downloadBackup()"
                                    class="w-full border border-gray-300 py-3 rounded-lg text-sm font-medium hover:bg-gray-50 flex justify-center items-center gap-2">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    Baixar Backup (.json)
                                </button>

                                <div class="relative">
                                    <button
                                        class="w-full bg-gray-800 text-white py-3 rounded-lg text-sm font-medium flex justify-center items-center gap-2">
                                        <i data-lucide="upload" class="w-4 h-4"></i>
                                        Restaurar Backup
                                    </button>
                                    <input type="file" onchange="restoreBackup(this)" accept=".json"
                                        class="absolute inset-0 opacity-0 cursor-pointer">
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 class="font-bold text-gray-800 mb-4 flex items-center text-red-600">
                                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                                Zona de Perigo
                            </h3>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="clearAllTransactions()"
                                    class="py-2.5 border border-red-300 text-red-600 rounded-lg text-sm hover:bg-red-50 transition-colors">
                                    Limpar Transações
                                </button>
                                <button onclick="factoryReset()"
                                    class="py-2.5 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition-colors">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Instructions View - COMPLETAMENTE REVISADA -->
            <section id="view-instructions" class="view-section hide fade-in">
                <div class="max-w-6xl mx-auto pb-12">
                    <!-- Cabeçalho Hero -->
                    <div class="text-center mb-10 pt-4">
                        <div
                            class="inline-flex items-center justify-center p-4 bg-gradient-to-r from-plena-blue to-plena-dark rounded-2xl mb-4 shadow-lg">
                            <i data-lucide="home" class="w-12 h-12 text-white"
                                aria-label="Ícone de Casa - Manual de Uso"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Manual Completo de Uso</h1>
                        <p class="text-gray-600 text-lg max-w-2xl mx-auto">Guia passo a passo para proprietários e
                            gestores imobiliários</p>
                        <div class="mt-4 flex flex-wrap justify-center gap-2">
                            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">✓ Para
                                Iniciantes</span>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">📱 Mobile e
                                Desktop</span>
                            <span class="px-3 py-1 bg-blue-100 text-plena-blue rounded-full text-xs font-bold">⚡ Rápido
                                e Prático</span>
                        </div>
                    </div>

                    <!-- Barra de Progresso do Tutorial -->
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 mb-8">
                        <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i data-lucide="compass" class="w-5 h-5 mr-2 text-plena-blue"></i>
                            Seu Progresso no Aprendizado
                        </h3>
                        <div class="mb-4">
                            <div class="progress-bar">
                                <div id="tutorial-progress" class="progress-fill" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-2">
                                <span>0% Concluído</span>
                                <span id="completed-steps">0/7 etapas</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-7 gap-2">
                            <button onclick="scrollToSection('instalacao')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                1. Instalação
                            </button>
                            <button onclick="scrollToSection('primeiro-cadastro')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                2. Primeiro Cadastro
                            </button>
                            <button onclick="scrollToSection('cobranca')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                3. Cobrança
                            </button>
                            <button onclick="scrollToSection('relatorios')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                4. Relatórios
                            </button>
                            <button onclick="scrollToSection('backup')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                5. Backup
                            </button>
                            <button onclick="scrollToSection('duvidas')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                6. Dúvidas
                            </button>
                            <button onclick="scrollToSection('checklist')"
                                class="tutorial-step text-center p-2 rounded-lg border border-gray-200 hover:bg-gray-50 text-xs">
                                7. Checklist
                            </button>
                        </div>
                    </div>

                    <!-- Seção 1: Instalação -->
                    <div id="instalacao"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">1
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Instalação do App no Celular</h3>
                            </div>
                            <button onclick="markSectionComplete('instalacao')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="bg-gray-900 rounded-2xl p-6 text-white shadow-lg mb-6">
                            <h4 class="font-bold text-lg mb-4 flex items-center">
                                <i data-lucide="download" class="w-5 h-5 mr-2 text-green-400"></i>
                                Torne o App Disponível OFFLINE
                            </h4>
                            <p class="text-gray-300 mb-4">Instale no celular para usar sem internet, igual um app
                                normal:</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                <div class="bg-white/10 p-4 rounded-xl border border-white/10">
                                    <div class="font-bold text-white mb-3 flex items-center">
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center mr-2">
                                            <i data-lucide="smartphone" class="w-4 h-4"></i>
                                        </div>
                                        Android (Chrome)
                                    </div>
                                    <ol class="list-decimal pl-5 space-y-3 text-gray-300">
                                        <li class="flex items-start">
                                            <span class="mr-2">1.</span>
                                            <div>
                                                <strong>Abra esta página no Chrome</strong>
                                                <p class="text-xs text-gray-400">Não use outros navegadores</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">2.</span>
                                            <div>
                                                <strong>Toque nos 3 pontinhos ☰</strong>
                                                <p class="text-xs text-gray-400">Canto superior direito</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">3.</span>
                                            <div>
                                                <strong>Toque em "Instalar app" ou "Adicionar à tela inicial"</strong>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">4.</span>
                                            <div>
                                                <strong>Pronto! O ícone aparecerá na sua tela inicial</strong>
                                            </div>
                                        </li>
                                    </ol>
                                </div>
                                <div class="bg-white/10 p-4 rounded-xl border border-white/10">
                                    <div class="font-bold text-white mb-3 flex items-center">
                                        <div
                                            class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center mr-2">
                                            <i data-lucide="apple" class="w-4 h-4"></i>
                                        </div>
                                        iPhone (Safari)
                                    </div>
                                    <ol class="list-decimal pl-5 space-y-3 text-gray-300">
                                        <li class="flex items-start">
                                            <span class="mr-2">1.</span>
                                            <div>
                                                <strong>Abra esta página no Safari</strong>
                                                <p class="text-xs text-gray-400">Não use Chrome no iPhone</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">2.</span>
                                            <div>
                                                <strong>Toque no ícone de compartilhar</strong>
                                                <p class="text-xs text-gray-400">É o quadrado com seta para cima</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">3.</span>
                                            <div>
                                                <strong>Role para baixo e toque em "Adicionar à Tela de Início"</strong>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <span class="mr-2">4.</span>
                                            <div>
                                                <strong>Toque "Adicionar" no canto superior direito</strong>
                                            </div>
                                        </li>
                                    </ol>
                                </div>
                            </div>
                            <div class="mt-6 p-4 bg-yellow-900/30 border border-yellow-700 rounded-xl">
                                <p class="text-yellow-200 text-sm flex items-center">
                                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                                    <strong>Dica:</strong> Depois de instalar, abra o app pelo ícone na tela inicial,
                                    não pelo navegador.
                                </p>
                            </div>

                            <!-- Windows Instructions (New) -->
                            <div class="mt-6 bg-gray-900 rounded-2xl p-6 text-white shadow-lg">
                                <h4 class="font-bold text-lg mb-4 flex items-center">
                                    <i data-lucide="monitor" class="w-5 h-5 mr-2 text-blue-400"></i>
                                    Instalação no Computador (Windows)
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                                    <div class="bg-white/10 p-4 rounded-xl border border-white/10">
                                        <div class="font-bold text-white mb-3 flex items-center">
                                            <div
                                                class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center mr-2">
                                                <i data-lucide="chrome" class="w-4 h-4"></i>
                                            </div>
                                            Google Chrome
                                        </div>
                                        <ol class="list-decimal pl-5 space-y-3 text-gray-300">
                                            <li>
                                                <strong>Verifique a barra de endereços:</strong><br>
                                                No final da barra (onde digita o site), procure um ícone de
                                                <strong>Monitor com Seta para Baixo</strong> <i
                                                    data-lucide="monitor-down" class="inline w-3 h-3"></i>.
                                            </li>
                                            <li>
                                                <strong>Se não aparecer o ícone:</strong><br>
                                                Clique nos <strong>3 pontinhos</strong> (canto superior direito) >
                                                <strong>Salvar e Compartilhar</strong> > <strong>Instalar página como
                                                    app...</strong>
                                            </li>
                                            <li>Clique em <strong>Instalar</strong> na janela que abrir.</li>
                                            <li>O app abrirá em uma janela separada e criará um atalho na sua Área de
                                                Trabalho.</li>
                                        </ol>
                                    </div>
                                    <div class="bg-white/10 p-4 rounded-xl border border-white/10">
                                        <div class="font-bold text-white mb-3 flex items-center">
                                            <div
                                                class="w-8 h-8 rounded-full bg-blue-800 flex items-center justify-center mr-2">
                                                <i data-lucide="monitor" class="w-4 h-4"></i>
                                            </div>
                                            Microsoft Edge
                                        </div>
                                        <ol class="list-decimal pl-5 space-y-3 text-gray-300">
                                            <li>
                                                <strong>Opção Rápida:</strong><br>
                                                Na barra de endereço, procure o ícone de <strong>App Disponível
                                                    (+)</strong> no canto direito.
                                            </li>
                                            <li>
                                                <strong>Opção Manual:</strong><br>
                                                Vá nos <strong>3 pontinhos (...)</strong> > <strong>Apps</strong> >
                                                <strong>Instalar este site como um
                                                    aplicativo</strong>.
                                            </li>
                                            <li>Clique em <strong>Instalar</strong>.</li>
                                            <li>Marque "Fixar na barra de tarefas" e "Criar atalho na área de trabalho"
                                                para facilitar o acesso.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 2: Primeiro Cadastro -->
                    <div id="primeiro-cadastro"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">2
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Configuração Inicial (10 Minutos)</h3>
                            </div>
                            <button onclick="markSectionComplete('primeiro-cadastro')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                    <h4 class="font-bold text-blue-700 mb-3 flex items-center">
                                        <i data-lucide="user-check" class="w-5 h-5 mr-2"></i>
                                        PASSO 1: Seus Dados Pessoais
                                    </h4>
                                    <ol class="space-y-3 text-sm">
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                A</div>
                                            <div>
                                                <strong>Clique em "Configurações" no menu lateral</strong>
                                                <p class="text-gray-600 text-xs">Ícone da engrenagem</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                B</div>
                                            <div>
                                                <strong>Preencha seu Nome/Razão Social</strong>
                                                <p class="text-gray-600 text-xs">Ex: "João Silva Imóveis"</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                C</div>
                                            <div>
                                                <strong>Preencha seu CPF ou CNPJ</strong>
                                                <p class="text-gray-600 text-xs">Aparecerá automaticamente nos recibos
                                                </p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                D</div>
                                            <div>
                                                <strong>Clique em "Salvar Configurações"</strong>
                                            </div>
                                        </li>
                                    </ol>
                                </div>

                                <div class="bg-green-50 p-5 rounded-xl border border-green-100">
                                    <h4 class="font-bold text-green-700 mb-3 flex items-center">
                                        <i data-lucide="home" class="w-5 h-5 mr-2"></i>
                                        PASSO 2: Cadastrar Primeiro Imóvel
                                    </h4>
                                    <ol class="space-y-3 text-sm">
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-green-100 text-green-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                A</div>
                                            <div>
                                                <strong>Volte ao "Dashboard" (primeira opção do menu)</strong>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-green-100 text-green-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                B</div>
                                            <div>
                                                <strong>Clique no botão roxo "Novo Imóvel"</strong>
                                                <p class="text-gray-600 text-xs">No canto superior direito</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-green-100 text-green-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                C</div>
                                            <div>
                                                <strong>Preencha os dados básicos:</strong>
                                                <div class="code-block mt-1 text-xs">
                                                    Apelido: "Apto Centro 101"<br>
                                                    Valor Aluguel: 1200.00<br>
                                                    Dia Vencimento: 5<br>
                                                    Endereço: (opcional)
                                                </div>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-green-100 text-green-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                D</div>
                                            <div>
                                                <strong>Marque "Imóvel Ocupado" se já tiver inquilino</strong>
                                                <p class="text-gray-600 text-xs">Preencha dados do inquilino que
                                                    aparecerão</p>
                                            </div>
                                        </li>
                                    </ol>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-purple-50 p-5 rounded-xl border border-purple-100">
                                    <h4 class="font-bold text-plena-blue mb-3 flex items-center">
                                        <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                                        PASSO 3: Dados do Inquilino (IMPORTANTE)
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-3">Preencha CORRETAMENTE para ter segurança
                                        jurídica:</p>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5 mr-2"></i>
                                            <span><strong>Nome completo</strong> (igual ao contrato)</span>
                                        </div>
                                        <div class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5 mr-2"></i>
                                            <span><strong>CPF</strong> (para recibos válidos)</span>
                                        </div>
                                        <div class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5 mr-2"></i>
                                            <span><strong>WhatsApp</strong> (para envio automático de recibos)</span>
                                        </div>
                                        <div class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mt-0.5 mr-2"></i>
                                            <span><strong>E-mail</strong> (para comunicação formal)</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <p class="text-xs text-yellow-800">
                                            <strong>💡 Dica:</strong> Use o CPF do inquilino para garantir que os
                                            recibos tenham validade jurídica em caso de necessidade.
                                        </p>
                                    </div>
                                </div>

                                <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                                    <h4 class="font-bold text-gray-700 mb-3 flex items-center">
                                        <i data-lucide="settings" class="w-5 h-5 mr-2"></i>
                                        PASSO 4: Configurar Multas e Juros
                                    </h4>
                                    <p class="text-sm text-gray-700 mb-3">O sistema calcula automaticamente:</p>
                                    <div class="grid grid-cols-2 gap-3 text-sm">
                                        <div class="bg-white p-3 rounded-lg border">
                                            <p class="font-bold text-gray-800">Multa por Atraso</p>
                                            <p class="text-xs text-gray-600">Recomendado: 2%</p>
                                            <div class="code-block mt-1 text-xs">
                                                Vai em: Configurações<br>
                                                Busque: "Multas e Juros"<br>
                                                Digite: 2.0 no campo "Multa"
                                            </div>
                                        </div>
                                        <div class="bg-white p-3 rounded-lg border">
                                            <p class="font-bold text-gray-800">Juros ao Dia</p>
                                            <p class="text-xs text-gray-600">Recomendado: 0,033%</p>
                                            <div class="code-block mt-1 text-xs">
                                                No mesmo local:<br>
                                                Digite: 0.033<br>
                                                Isso dá 1% ao mês<br>
                                                (Calculado automaticamente)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            class="mt-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-xl">
                            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                                <i data-lucide="zap" class="w-5 h-5 mr-2 text-green-600"></i>
                                Parabéns! Configuração Básica Concluída
                            </h4>
                            <p class="text-sm text-gray-700">
                                Seu sistema já está pronto para uso! Agora você pode:
                            </p>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
                                <div class="bg-white p-3 rounded-lg border text-center">
                                    <i data-lucide="eye" class="w-6 h-6 text-plena-blue mx-auto mb-1"></i>
                                    <p class="text-xs font-bold">Ver Dashboard</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border text-center">
                                    <i data-lucide="bell" class="w-6 h-6 text-plena-blue mx-auto mb-1"></i>
                                    <p class="text-xs font-bold">Receber Lembretes</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg border text-center">
                                    <i data-lucide="file-text" class="w-6 h-6 text-plena-blue mx-auto mb-1"></i>
                                    <p class="text-xs font-bold">Emitir Recibos</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 3: Cobrança e Pagamentos -->
                    <div id="cobranca"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">3
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Cobrança, Pagamentos e Recibos</h3>
                            </div>
                            <button onclick="markSectionComplete('cobranca')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                            <!-- Cartão 1 -->
                            <div class="bg-gradient-to-br from-blue-50 to-white p-5 rounded-xl border border-blue-100">
                                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mb-3">
                                    <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <h4 class="font-bold text-gray-800 mb-2">Dia 1 ao 5 do Mês</h4>
                                <p class="text-sm text-gray-600 mb-3">Rotina de cobrança inicial</p>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-start">
                                        <i data-lucide="check-circle" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                        <span>Verifique o <strong>Dashboard</strong> para ver pendências</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i data-lucide="message-circle" class="w-4 h-4 text-blue-500 mr-2 mt-0.5"></i>
                                        <span>Clique no botão WhatsApp para <strong>enviar lembrete</strong></span>
                                    </li>
                                    <li class="flex items-start">
                                        <i data-lucide="bell" class="w-4 h-4 text-yellow-500 mr-2 mt-0.5"></i>
                                        <span>O sistema mostra automaticamente quem está <strong>em
                                                atraso</strong></span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Cartão 2 -->
                            <div
                                class="bg-gradient-to-br from-green-50 to-white p-5 rounded-xl border border-green-100">
                                <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mb-3">
                                    <i data-lucide="wallet" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <h4 class="font-bold text-gray-800 mb-2">Registrar Pagamento</h4>
                                <p class="text-sm text-gray-600 mb-3">Quando o inquilino pagar:</p>
                                <ol class="space-y-2 text-sm pl-1">
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2">1.</span>
                                        <span>No <strong>Dashboard</strong>, clique em <button
                                                class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Registrar</button>
                                            ao lado do imóvel</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2">2.</span>
                                        <span>Se estiver <strong>atrasado</strong>, o sistema calcula multa/juros
                                            automaticamente</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="font-bold mr-2">3.</span>
                                        <span>Confirme o valor e clique em <strong>Registrar Pagamento</strong></span>
                                    </li>
                                </ol>
                            </div>

                            <!-- Cartão 3 -->
                            <div
                                class="bg-gradient-to-br from-purple-50 to-white p-5 rounded-xl border border-purple-100">
                                <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mb-3">
                                    <i data-lucide="file-text" class="w-5 h-5 text-plena-blue"></i>
                                </div>
                                <h4 class="font-bold text-gray-800 mb-2">Enviar Recibo</h4>
                                <p class="text-sm text-gray-600 mb-3">Dois tipos disponíveis:</p>
                                <div class="space-y-3">
                                    <div class="bg-white p-3 rounded-lg border">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center mr-2">
                                                    <i data-lucide="message-circle" class="w-3 h-3 text-green-600"></i>
                                                </div>
                                                <span class="text-sm font-medium">Recibo Rápido (WhatsApp)</span>
                                            </div>
                                            <button class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded"
                                                onclick="showExample('whatsapp')">Ver Exemplo</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Após registrar pagamento, clique no ícone
                                            verde do WhatsApp</p>
                                    </div>
                                    <div class="bg-white p-3 rounded-lg border">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                                                    <i data-lucide="printer" class="w-3 h-3 text-blue-600"></i>
                                                </div>
                                                <span class="text-sm font-medium">Recibo Formal (PDF/Impressão)</span>
                                            </div>
                                            <button class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded"
                                                onclick="showExample('formal')">Ver Exemplo</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Clique no ícone da impressora para gerar
                                            documento assinável</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Exemplo Visual de Atraso -->
                        <div
                            class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-100 rounded-xl p-5 mb-6">
                            <h4 class="font-bold text-red-800 mb-3 flex items-center">
                                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                                Exemplo Prático: Pagamento em Atraso
                            </h4>
                            <div class="bg-white p-4 rounded-lg border border-red-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div>
                                        <p class="font-bold text-gray-800">Cenário:</p>
                                        <p class="text-sm text-gray-600">Aluguel de R$ 1.200, venceu dia 5, pagou dia 10
                                        </p>
                                    </div>
                                    <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-xs font-bold">5
                                        dias atrasado</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 text-sm">
                                    <div class="text-center p-3 bg-gray-50 rounded-lg">
                                        <p class="text-xs text-gray-500">Valor Base</p>
                                        <p class="font-bold text-gray-800">R$ 1.200,00</p>
                                    </div>
                                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                                        <p class="text-xs text-gray-500">Multa (2%)</p>
                                        <p class="font-bold text-yellow-700">+ R$ 24,00</p>
                                    </div>
                                    <div class="text-center p-3 bg-orange-50 rounded-lg">
                                        <p class="text-xs text-gray-500">Juros (5 dias)</p>
                                        <p class="font-bold text-orange-700">+ R$ 1,98</p>
                                    </div>
                                    <div class="text-center p-3 bg-green-50 rounded-lg">
                                        <p class="text-xs text-gray-500">Total a Pagar</p>
                                        <p class="font-bold text-green-700">R$ 1.225,98</p>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-3 text-center">
                                    <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                    O sistema faz este cálculo automaticamente quando você registra o pagamento atrasado
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 4: Relatórios -->
                    <div id="relatorios"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">4
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Relatórios e Análise Financeira</h3>
                            </div>
                            <button onclick="markSectionComplete('relatorios')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2 text-plena-blue"></i>
                                    Relatório Mensal Automático
                                </h4>
                                <p class="text-sm text-gray-700 mb-4">Todo dia 1º, faça este passo a passo:</p>
                                <ol class="space-y-3 text-sm">
                                    <li class="flex items-start">
                                        <div
                                            class="w-6 h-6 rounded-full bg-plena-blue/20 text-plena-blue flex items-center justify-center mr-2 text-xs font-bold">
                                            1</div>
                                        <div>
                                            <strong>Clique em "Relatórios" no menu</strong>
                                            <p class="text-gray-600 text-xs">Ícone do gráfico de barras</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <div
                                            class="w-6 h-6 rounded-full bg-plena-blue/20 text-plena-blue flex items-center justify-center mr-2 text-xs font-bold">
                                            2</div>
                                        <div>
                                            <strong>Clique em "Relatório Completo"</strong>
                                            <p class="text-gray-600 text-xs">Botão do lado direito</p>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <div
                                            class="w-6 h-6 rounded-full bg-plena-blue/20 text-plena-blue flex items-center justify-center mr-2 text-xs font-bold">
                                            3</div>
                                        <div>
                                            <strong>Analise os resultados:</strong>
                                            <ul class="mt-1 space-y-1 text-gray-600">
                                                <li>• Receitas totais do mês</li>
                                                <li>• Despesas (IPTU, condomínio, etc)</li>
                                                <li>• Saldo líquido</li>
                                                <li>• Análise por imóvel</li>
                                            </ul>
                                        </div>
                                    </li>
                                    <li class="flex items-start">
                                        <div
                                            class="w-6 h-6 rounded-full bg-plena-blue/20 text-plena-blue flex items-center justify-center mr-2 text-xs font-bold">
                                            4</div>
                                        <div>
                                            <strong>Compartilhe com seu contador</strong>
                                            <p class="text-gray-600 text-xs">Use os botões WhatsApp ou Impressora</p>
                                        </div>
                                    </li>
                                </ol>
                            </div>

                            <div>
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i data-lucide="filter" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Filtros Avançados (Para Controle Detalhado)
                                </h4>
                                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                    <p class="text-sm text-gray-700 mb-3">Na aba "Financeiro", você pode filtrar por:
                                    </p>
                                    <div class="space-y-2">
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>
                                            <span class="text-sm"><strong>Período específico</strong> (ex: 01/03 a
                                                31/03)</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                                            <span class="text-sm"><strong>Apenas entradas ou saídas</strong></span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 rounded-full bg-purple-500 mr-2"></div>
                                            <span class="text-sm"><strong>Imóvel específico</strong></span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                                            <span class="text-sm"><strong>Palavra-chave</strong> (ex: "IPTU",
                                                "Manutenção")</span>
                                        </div>
                                    </div>

                                </div>

                                <div class="mt-6">
                                    <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                        <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-600"></i>
                                        Dicas para Análise
                                    </h4>
                                    <ul class="space-y-2 text-sm text-gray-700">
                                        <li class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                            <span>Compare mês atual vs mês anterior no <strong>Dashboard</strong></span>
                                        </li>
                                        <li class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                            <span>Use as <strong>categorias</strong> para classificar despesas (IPTU,
                                                Manutenção, etc)</span>
                                        </li>
                                        <li class="flex items-start">
                                            <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                            <span>Identifique imóveis com <strong>maior lucratividade</strong></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 5: Backup e Segurança -->
                    <div id="backup"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">5
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Backup e Segurança dos Dados</h3>
                            </div>
                            <button onclick="markSectionComplete('backup')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-r-xl mb-6">
                            <h4 class="font-bold text-red-800 mb-3 flex items-center">
                                <i data-lucide="alert-octagon" class="w-5 h-5 mr-2"></i>
                                ATENÇÃO: Leia com Cuidado!
                            </h4>
                            <div class="text-sm text-red-800 space-y-2">
                                <p>📱 <strong>Seus dados ficam APENAS no seu celular/computador.</strong></p>
                                <p>🔄 <strong>Se você perder o aparelho, formatar ou limpar o navegador, perderá TODOS
                                        os dados.</strong></p>
                                <p>💾 <strong>O backup é SUA responsabilidade.</strong> Faça SEMPRE!</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i data-lucide="download" class="w-5 h-5 mr-2 text-green-600"></i>
                                    Como Fazer Backup (Guia Passo a Passo)
                                </h4>
                                <div class="space-y-4">
                                    <div class="bg-white p-4 rounded-xl border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <div
                                                class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                                <span class="font-bold text-green-700">1</span>
                                            </div>
                                            <p class="font-bold text-gray-800">Acesse Configurações</p>
                                        </div>
                                        <p class="text-sm text-gray-600 ml-11">Menu lateral → Ícone da engrenagem</p>
                                    </div>

                                    <div class="bg-white p-4 rounded-xl border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <div
                                                class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                                <span class="font-bold text-green-700">2</span>
                                            </div>
                                            <p class="font-bold text-gray-800">Desça até "Segurança de Dados"</p>
                                        </div>
                                        <p class="text-sm text-gray-600 ml-11">Procure pelo ícone do escudo</p>
                                    </div>

                                    <div class="bg-white p-4 rounded-xl border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <div
                                                class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                                <span class="font-bold text-green-700">3</span>
                                            </div>
                                            <p class="font-bold text-gray-800">Clique em "Baixar Backup (.json)"</p>
                                        </div>
                                        <p class="text-sm text-gray-600 ml-11">Um arquivo será baixado automaticamente
                                        </p>
                                    </div>

                                    <div class="bg-white p-4 rounded-xl border border-green-200">
                                        <div class="flex items-center mb-2">
                                            <div
                                                class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3">
                                                <span class="font-bold text-green-700">4</span>
                                            </div>
                                            <p class="font-bold text-gray-800">Salve em 2 Lugares Seguros</p>
                                        </div>
                                        <div class="ml-11">
                                            <p class="text-sm text-gray-600 mb-1"><strong>Recomendado:</strong></p>
                                            <ul class="text-sm text-gray-600 space-y-1">
                                                <li>• Google Drive (na pasta "Backup Plena")</li>
                                                <li>• Envie para você mesmo no WhatsApp</li>
                                                <li>• Pendrive ou HD externo</li>
                                                <li>• E-mail (anexe o arquivo)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                                    <i data-lucide="refresh-cw" class="w-5 h-5 mr-2 text-blue-600"></i>
                                    Como Restaurar Backup (Se Perder Dados)
                                </h4>
                                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                    <p class="text-sm text-gray-700 mb-4">Se você perdeu os dados ou comprou um celular
                                        novo:</p>
                                    <ol class="space-y-3 text-sm">
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                A</div>
                                            <div>
                                                <strong>Baixe o arquivo de backup</strong>
                                                <p class="text-gray-600 text-xs">Do Google Drive, WhatsApp ou e-mail</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                B</div>
                                            <div>
                                                <strong>Acesse as Configurações do app</strong>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                C</div>
                                            <div>
                                                <strong>Clique em "Restaurar Backup"</strong>
                                                <p class="text-gray-600 text-xs">Selecione o arquivo .json baixado</p>
                                            </div>
                                        </li>
                                        <li class="flex items-start">
                                            <div
                                                class="w-6 h-6 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center mr-2 text-xs font-bold">
                                                D</div>
                                            <div>
                                                <strong>Confirme a restauração</strong>
                                                <p class="text-gray-600 text-xs">O app será recarregado com seus dados
                                                    antigos</p>
                                            </div>
                                        </li>
                                    </ol>
                                    <div class="mt-4 p-3 bg-white rounded-lg border">
                                        <p class="text-xs font-bold text-gray-800 mb-1">Frequência Recomendada</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-600">Backup Semanal</span>
                                            <span
                                                class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded">OBRIGATÓRIO</span>
                                        </div>
                                        <div class="flex items-center justify-between mt-1">
                                            <span class="text-xs text-gray-600">Backup Antes de Formatar Celular</span>
                                            <span
                                                class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded">CRÍTICO</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                <div
                                    class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>
                                </div>
                                <p class="text-xs font-bold text-gray-800">Não Faça</p>
                                <p class="text-xs text-gray-600">Limpar histórico/cache do navegador sem backup</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                <div
                                    class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600"></i>
                                </div>
                                <p class="text-xs font-bold text-gray-800">Cuidado</p>
                                <p class="text-xs text-gray-600">Trocar de celular sem restaurar backup primeiro</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200 text-center">
                                <div
                                    class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-2">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <p class="text-xs font-bold text-gray-800">Faça Sempre</p>
                                <p class="text-xs text-gray-600">Backup após cadastrar novo imóvel ou inquilino</p>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 6: Dúvidas Frequentes -->
                    <div id="duvidas"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">6
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Dúvidas Frequentes (FAQ)</h3>
                            </div>
                            <button onclick="markSectionComplete('duvidas')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="space-y-4">
                            <!-- FAQ Item 1 -->
                            <details class="group bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                                <summary
                                    class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-100 transition-colors select-none">
                                    <div class="flex items-center gap-3 font-bold text-gray-700">
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                            <i data-lucide="help-circle" class="w-4 h-4"></i>
                                        </div>
                                        Perdi meu celular. Como recupero meus dados?
                                    </div>
                                    <i data-lucide="chevron-down"
                                        class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div class="p-6 pt-0 border-t border-gray-100">
                                    <div class="mt-4 space-y-3">
                                        <p class="text-sm text-gray-600"><strong>Resposta:</strong> Se você fez backup
                                            regularmente, é simples:</p>
                                        <ol class="list-decimal pl-5 space-y-2 text-sm text-gray-600">
                                            <li>Compre/use outro celular</li>
                                            <li>Instale o app Plena Aluguéis novamente (passo 1 deste manual)</li>
                                            <li>Acesse seu backup salvo no Google Drive/WhatsApp/e-mail</li>
                                            <li>Vá em Configurações → "Restaurar Backup"</li>
                                            <li>Selecione o arquivo .json mais recente</li>
                                        </ol>
                                        <div class="bg-yellow-50 p-3 rounded-lg mt-3">
                                            <p class="text-xs text-yellow-800">
                                                <strong>Importante:</strong> Se NÃO fez backup, infelizmente os dados
                                                estão perdidos.
                                                Por isso enfatizamos tanto a importância dos backups semanais.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- FAQ Item 2 -->
                            <details class="group bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                                <summary
                                    class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-100 transition-colors select-none">
                                    <div class="flex items-center gap-3 font-bold text-gray-700">
                                        <div
                                            class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                            <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                                        </div>
                                        Como o sistema calcula multas e juros?
                                    </div>
                                    <i data-lucide="chevron-down"
                                        class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div class="p-6 pt-0 border-t border-gray-100">
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 mb-3"><strong>Resposta:</strong>
                                            Automaticamente, seguindo esta fórmula:</p>
                                        <div class="bg-white p-4 rounded-lg border">
                                            <p class="text-sm font-bold text-gray-800 mb-2">Cálculo Automático:</p>
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                                <div class="text-center p-2 bg-gray-50 rounded">
                                                    <p class="text-xs text-gray-500">Multa Fixa</p>
                                                    <p class="font-bold">2% (configurável)</p>
                                                </div>
                                                <div class="text-center p-2 bg-gray-50 rounded">
                                                    <p class="text-xs text-gray-500">Juros ao Dia</p>
                                                    <p class="font-bold">0,033% (1% ao mês)</p>
                                                </div>
                                                <div class="text-center p-2 bg-gray-50 rounded">
                                                    <p class="text-xs text-gray-500">Dias em Atraso</p>
                                                    <p class="font-bold">Calculado automaticamente</p>
                                                </div>
                                            </div>
                                            <div class="mt-3 p-3 bg-blue-50 rounded">
                                                <p class="text-xs text-blue-800">
                                                    <strong>Exemplo prático:</strong> Aluguel de R$ 1.000, 5 dias
                                                    atrasado<br>
                                                    Multa: R$ 1.000 × 2% = R$ 20,00<br>
                                                    Juros: R$ 1.000 × 0,033% × 5 = R$ 1,65<br>
                                                    <strong>Total: R$ 1.021,65</strong>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- FAQ Item 3 -->
                            <details class="group bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                                <summary
                                    class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-100 transition-colors select-none">
                                    <div class="flex items-center gap-3 font-bold text-gray-700">
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-plena-blue">
                                            <i data-lucide="printer" class="w-4 h-4"></i>
                                        </div>
                                        Posso imprimir recibos para assinar manualmente?
                                    </div>
                                    <i data-lucide="chevron-down"
                                        class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div class="p-6 pt-0 border-t border-gray-100">
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 mb-3"><strong>Resposta:</strong> Sim! Dois tipos
                                            de recibos:</p>
                                        <div class="space-y-3">
                                            <div class="flex items-start">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center mr-3 mt-0.5">
                                                    <i data-lucide="message-circle" class="w-3 h-3 text-green-600"></i>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-bold text-gray-800">Recibo Digital (WhatsApp)
                                                    </p>
                                                    <p class="text-xs text-gray-600">Enviado automaticamente pelo
                                                        WhatsApp após registrar pagamento</p>
                                                </div>
                                            </div>
                                            <div class="flex items-start">
                                                <div
                                                    class="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center mr-3 mt-0.5">
                                                    <i data-lucide="printer" class="w-3 h-3 text-blue-600"></i>
                                                </div>
                                                <div>
                                                    <p class="text-sm font-bold text-gray-800">Recibo Formal (PDF)</p>
                                                    <p class="text-xs text-gray-600">
                                                        1. Registre o pagamento<br>
                                                        2. Clique no ícone da impressora<br>
                                                        3. Imprima ou salve como PDF<br>
                                                        4. Assine e entregue ao inquilino
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-3 bg-gray-100 rounded">
                                            <p class="text-xs text-gray-700">
                                                <strong>Dica:</strong> Configure seus dados em "Configurações" para que
                                                o recibo já saia com seu nome e CPF/CNPJ.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- FAQ Item 4 -->
                            <details class="group bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                                <summary
                                    class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-100 transition-colors select-none">
                                    <div class="flex items-center gap-3 font-bold text-gray-700">
                                        <div
                                            class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                                            <i data-lucide="wifi-off" class="w-4 h-4"></i>
                                        </div>
                                        O app funciona sem internet?
                                    </div>
                                    <i data-lucide="chevron-down"
                                        class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div class="p-6 pt-0 border-t border-gray-100">
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 mb-3"><strong>Resposta:</strong> Sim, funciona
                                            100% offline após instalado!</p>
                                        <div class="space-y-2 text-sm text-gray-700">
                                            <div class="flex items-start">
                                                <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                                <span><strong>Registrar pagamentos</strong> (sem internet)</span>
                                            </div>
                                            <div class="flex items-start">
                                                <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                                <span><strong>Consultar histórico</strong> (todos os dados ficam no seu
                                                    celular)</span>
                                            </div>
                                            <div class="flex items-start">
                                                <i data-lucide="check" class="w-4 h-4 text-green-500 mr-2 mt-0.5"></i>
                                                <span><strong>Gerar recibos para imprimir</strong> (PDF offline)</span>
                                            </div>
                                            <div class="flex items-start">
                                                <i data-lucide="x" class="w-4 h-4 text-red-500 mr-2 mt-0.5"></i>
                                                <span><strong>Enviar WhatsApp</strong> (precisa de internet apenas para
                                                    esta função)</span>
                                            </div>
                                            <div class="flex items-start">
                                                <i data-lucide="x" class="w-4 h-4 text-red-500 mr-2 mt-0.5"></i>
                                                <span><strong>Fazer backup na nuvem</strong> (precisa de
                                                    internet)</span>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-3 bg-green-50 rounded">
                                            <p class="text-xs text-green-800">
                                                <strong>Vantagem:</strong> Seu controle não depende de internet. Pode
                                                registrar pagamentos no meio do campo,
                                                em prédios sem sinal, etc. A sincronização com WhatsApp é opcional.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- FAQ Item 5 -->
                            <details class="group bg-gray-50 border border-gray-200 rounded-xl overflow-hidden">
                                <summary
                                    class="flex items-center justify-between p-4 cursor-pointer hover:bg-gray-100 transition-colors select-none">
                                    <div class="flex items-center gap-3 font-bold text-gray-700">
                                        <div
                                            class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                                            <i data-lucide="smartphone" class="w-4 h-4"></i>
                                        </div>
                                        Posso usar no computador também?
                                    </div>
                                    <i data-lucide="chevron-down"
                                        class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"></i>
                                </summary>
                                <div class="p-6 pt-0 border-t border-gray-100">
                                    <div class="mt-4">
                                        <p class="text-sm text-gray-600 mb-3"><strong>Resposta:</strong> Sim! Funciona
                                            em qualquer dispositivo:</p>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                                <i data-lucide="smartphone"
                                                    class="w-6 h-6 text-blue-600 mx-auto mb-2"></i>
                                                <p class="text-xs font-bold">Celular</p>
                                                <p class="text-xs text-gray-600">Android e iPhone</p>
                                            </div>
                                            <div class="text-center p-3 bg-green-50 rounded-lg">
                                                <i data-lucide="tablet" class="w-6 h-6 text-green-600 mx-auto mb-2"></i>
                                                <p class="text-xs font-bold">Tablet</p>
                                                <p class="text-xs text-gray-600">iPad, Samsung, etc</p>
                                            </div>
                                            <div class="text-center p-3 bg-purple-50 rounded-lg">
                                                <i data-lucide="monitor"
                                                    class="w-6 h-6 text-plena-blue mx-auto mb-2"></i>
                                                <p class="text-xs font-bold">Computador</p>
                                                <p class="text-xs text-gray-600">Windows, Mac, Linux</p>
                                            </div>
                                        </div>
                                        <div class="space-y-2 text-sm text-gray-700">
                                            <p><strong>Importante:</strong> Os dados NÃO sincronizam automaticamente
                                                entre dispositivos.</p>
                                            <p><strong>Solução:</strong> Faça backup no celular → Restaure no computador
                                                (e vice-versa).</p>
                                        </div>
                                        <div class="mt-3 p-3 bg-blue-50 rounded">
                                            <p class="text-xs text-blue-800">
                                                <strong>Dica profissional:</strong> Use no celular para registro rápido
                                                de pagamentos "na rua".
                                                Use no computador para gerar relatórios detalhados e imprimir recibos.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div
                            class="mt-8 p-4 bg-gradient-to-r from-plena-blue/10 to-blue-50 rounded-xl border border-plena-blue/20">
                            <h4 class="font-bold text-gray-800 mb-2 flex items-center">
                                <i data-lucide="message-circle" class="w-5 h-5 mr-2 text-plena-blue"></i>
                                Ainda com dúvidas?
                            </h4>
                            <p class="text-sm text-gray-700 mb-3">
                                Nossa equipe de suporte responde em até 24h úteis por e-mail.
                            </p>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <a href="mailto:tecnologia@plenaaplicativos.com.br"
                                    class="inline-flex items-center justify-center bg-plena-purple text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-plena-dark transition-colors">
                                    <i data-lucide="mail" class="w-4 h-4 mr-2"></i>
                                    Enviar E-mail para Suporte
                                </a>
                                <button onclick="router('settings')"
                                    class="inline-flex items-center justify-center border border-gray-300 text-gray-700 px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-gray-50 transition-colors">
                                    <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                                    Voltar às Configurações
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Seção 7: Checklist Interativo -->
                    <div id="checklist"
                        class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm mb-8 scroll-mt-24">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center">
                                <div class="step-number bg-gradient-to-r from-plena-blue to-plena-dark text-white">7
                                </div>
                                <h3 class="text-xl font-bold text-gray-800">Checklist Interativo de Rotina</h3>
                            </div>
                            <button onclick="markSectionComplete('checklist')"
                                class="text-xs text-gray-500 hover:text-green-600">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Marcar como concluído
                            </button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Coluna 1 -->
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-blue-600 uppercase text-sm">Início do Mês (Dia 1-5)
                                        </h4>
                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">CRÍTICO</span>
                                    </div>
                                    <div id="checklist-1" class="space-y-3">
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-1-1"
                                                class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                                onchange="updateChecklist()">
                                            <label for="check-1-1" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Conferir Dashboard para ver pendências
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-1-2"
                                                class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                                onchange="updateChecklist()">
                                            <label for="check-1-2" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Enviar lembretes por WhatsApp (botão verde)
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-1-3"
                                                class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                                                onchange="updateChecklist()">
                                            <label for="check-1-3" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Verificar imóveis vagos para anunciar
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-green-50 p-5 rounded-xl border border-green-100">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-green-600 uppercase text-sm">Durante o Mês</h4>
                                        <span
                                            class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">ROTINA</span>
                                    </div>
                                    <div id="checklist-2" class="space-y-3">
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-2-1"
                                                class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500"
                                                onchange="updateChecklist()">
                                            <label for="check-2-1" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Registrar pagamentos recebidos
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-2-2"
                                                class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500"
                                                onchange="updateChecklist()">
                                            <label for="check-2-2" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Enviar recibos automáticos (WhatsApp)
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-2-3"
                                                class="w-5 h-5 text-green-600 rounded border-gray-300 focus:ring-green-500"
                                                onchange="updateChecklist()">
                                            <label for="check-2-3" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Lançar despesas (IPTU, condomínio, manutenção)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna 2 -->
                            <div class="space-y-4">
                                <div class="bg-purple-50 p-5 rounded-xl border border-purple-100">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-plena-blue uppercase text-sm">Fim do Mês (Dia 25-31)
                                        </h4>
                                        <span
                                            class="text-xs bg-blue-100 text-plena-blue px-2 py-1 rounded">ANÁLISE</span>
                                    </div>
                                    <div id="checklist-3" class="space-y-3">
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-3-1"
                                                class="w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500"
                                                onchange="updateChecklist()">
                                            <label for="check-3-1" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Gerar relatório mensal completo
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-3-2"
                                                class="w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500"
                                                onchange="updateChecklist()">
                                            <label for="check-3-2" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                FAZER BACKUP dos dados (OBRIGATÓRIO)
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-3-3"
                                                class="w-5 h-5 text-purple-600 rounded border-gray-300 focus:ring-purple-500"
                                                onchange="updateChecklist()">
                                            <label for="check-3-3" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Enviar relatório para contador (opcional)
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-bold text-red-600 uppercase text-sm">Quando Alugar Novo Imóvel
                                        </h4>
                                        <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">CADASTRO</span>
                                    </div>
                                    <div id="checklist-4" class="space-y-3">
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-4-1"
                                                class="w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500"
                                                onchange="updateChecklist()">
                                            <label for="check-4-1" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Cadastrar imóvel no sistema
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-4-2"
                                                class="w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500"
                                                onchange="updateChecklist()">
                                            <label for="check-4-2" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Preencher TODOS dados do inquilino
                                            </label>
                                        </div>
                                        <div class="checklist-item flex items-center">
                                            <input type="checkbox" id="check-4-3"
                                                class="w-5 h-5 text-red-600 rounded border-gray-300 focus:ring-red-500"
                                                onchange="updateChecklist()">
                                            <label for="check-4-3" class="ml-3 text-sm text-gray-700 cursor-pointer">
                                                Fazer backup após cadastro
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna 3: Resumo -->
                            <div>
                                <div
                                    class="bg-gradient-to-br from-gray-900 to-plena-black text-white p-5 rounded-xl shadow-lg">
                                    <h4 class="font-bold text-white mb-4 text-lg">Seu Progresso da Semana</h4>

                                    <div class="space-y-4">
                                        <div>
                                            <div class="flex justify-between text-sm mb-1">
                                                <span>Checklist do Mês</span>
                                                <span id="checklist-percent">0%</span>
                                            </div>
                                            <div class="progress-bar bg-gray-700">
                                                <div id="checklist-progress"
                                                    class="progress-fill bg-gradient-to-r from-green-400 to-blue-400"
                                                    style="width: 0%"></div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div class="text-center p-3 bg-white/10 rounded-lg">
                                                <p class="text-2xl font-bold" id="checklist-completed">0</p>
                                                <p class="text-white/70 text-xs">Concluídos</p>
                                            </div>
                                            <div class="text-center p-3 bg-white/10 rounded-lg">
                                                <p class="text-2xl font-bold" id="checklist-total">12</p>
                                                <p class="text-white/70 text-xs">Total Itens</p>
                                            </div>
                                        </div>

                                        <div class="pt-4 border-t border-white/10">
                                            <p class="text-xs text-white/80 mb-3">Próximas tarefas prioritárias:</p>
                                            <div id="next-tasks" class="space-y-2">
                                                <!-- Será preenchido por JavaScript -->
                                            </div>
                                        </div>
                                    </div>

                                    <button onclick="resetChecklist()"
                                        class="w-full mt-4 bg-white/20 hover:bg-white/30 text-white py-2.5 rounded-lg text-sm font-medium transition-colors">
                                        <i data-lucide="refresh-ccw" class="w-4 h-4 inline mr-2"></i>
                                        Reiniciar Checklist da Semana
                                    </button>
                                </div>

                                <div class="mt-6 bg-white p-4 rounded-xl border border-gray-200">
                                    <h4 class="font-bold text-gray-800 mb-3 text-sm">Lembretes Automáticos</h4>
                                    <div class="space-y-2 text-sm text-gray-600">
                                        <div class="flex items-center">
                                            <i data-lucide="bell" class="w-4 h-4 text-yellow-500 mr-2"></i>
                                            <span>O Dashboard mostra automaticamente quem está em atraso</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i data-lucide="calendar" class="w-4 h-4 text-blue-500 mr-2"></i>
                                            <span>Próximos vencimentos aparecem no lado direito</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500 mr-2"></i>
                                            <span>Imóveis vagos são destacados automaticamente</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Final Completion Card (Centralized & Enhanced) -->
                    <div
                        class="mt-12 text-center max-w-2xl mx-auto p-8 bg-gradient-to-b from-green-50 to-white border border-green-200 rounded-3xl shadow-lg relative overflow-hidden">
                        <!-- Background Decoration -->
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-green-400 to-plena-blue">
                        </div>

                        <div
                            class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-6 shadow-sm">
                            <i data-lucide="award" class="w-10 h-10 text-green-600"></i>
                        </div>

                        <h4 class="text-2xl font-bold text-gray-800 mb-3">
                            Parabéns! Você Dominou o Sistema 🚀
                        </h4>
                        <p class="text-gray-600 mb-8 leading-relaxed">
                            Você concluiu todas as etapas do manual. Agora você tem o conhecimento necessário para
                            gerenciar seus imóveis com total segurança e profissionalismo.
                        </p>

                        <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                                class="w-full sm:w-auto px-6 py-3 bg-white border border-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                                <i data-lucide="arrow-up" class="w-4 h-4 inline mr-2"></i>
                                Voltar ao Topo
                            </button>

                            <button onclick="router('dashboard')"
                                class="w-full sm:w-auto px-8 py-3 bg-plena-purple text-white rounded-xl font-bold hover:bg-plena-dark transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                Ir para o Dashboard
                            </button>
                        </div>

                        <button onclick="resetTraining()"
                            class="mt-8 text-xs text-gray-400 hover:text-red-500 underline transition-colors">
                            Reiniciar todo o treinamento (Limpar progresso)
                        </button>
                    </div>
                </div>

                <!-- Rodapé do Manual -->
                <div class="text-center mt-12 pt-8 border-t border-gray-200">
                    <p class="text-sm text-gray-600 mb-2">
                        Este manual faz parte do sistema Plena Aluguéis v4.1 Pro
                    </p>
                    <p class="text-[10px] text-gray-400">
                        Plena Soluções Digitais LTDA • CNPJ: 17.347.919/0001-59 •
                        <a href="mailto:tecnologia@plenaaplicativos.com.br" class="text-plena-blue hover:underline">
                            tecnologia@plenaaplicativos.com.br
                        </a>
                    </p>
                    <p class="text-[8px] text-gray-300 mt-2">
                        Última atualização: Janeiro 2026 • Compatível com Android, iPhone, Windows, Mac
                    </p>
                </div>
        </div>
        </section>

        <!-- About View: Legal & Safety Center -->
        <section id="view-about" class="view-section hide fade-in">
            <div class="max-w-4xl mx-auto pb-12">

                <!-- 1. Header Institucional -->
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 mb-8 text-center">
                    <div
                        class="w-20 h-20 rounded-full bg-gradient-to-r from-plena-blue to-plena-dark flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-200">
                        <i data-lucide="shield-check" class="w-10 h-10 text-white"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-1">Central de Segurança e Legalidade</h2>
                    <p class="text-gray-500 font-medium">Plena Soluções Digitais • Transparência Total</p>
                </div>

                <!-- 2. Grid de Políticas -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Termos de Uso -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center text-lg">
                            <div class="p-2 bg-blue-50 rounded-lg mr-3">
                                <i data-lucide="file-text" class="w-5 h-5 text-plena-blue"></i>
                            </div>
                            Termos de Uso
                        </h3>
                        <p class="text-sm text-gray-600 leading-relaxed text-justify">
                            A licença concedida é <strong>pessoal, intransferível e não exclusiva</strong>. O software é
                            fornecido "no estado em que se encontra" (as-is). É estritamente proibida a revenda, cópia,
                            distribuição não autorizada ou engenharia reversa do código-fonte, sob pena das sanções
                            previstas na Lei de Propriedade Intelectual (9.610/98).
                        </p>
                    </div>

                    <!-- Privacidade e LGPD -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center text-lg">
                            <div class="p-2 bg-green-50 rounded-lg mr-3">
                                <i data-lucide="lock" class="w-5 h-5 text-green-600"></i>
                            </div>
                            Privacidade (LGPD)
                        </h3>
                        <p class="text-sm text-gray-600 leading-relaxed text-justify">
                            Adotamos a arquitetura <strong>Privacy by Design (Local-First)</strong>. Seus dados
                            financeiros e de inquilinos ficam salvos <strong>exclusivamente no seu dispositivo</strong>.
                            A Plena não coleta, não armazena e não tem acesso a nenhuma informação inserida no sistema.
                            Sua privacidade é absoluta.
                        </p>
                    </div>
                </div>

                <!-- 3. Responsabilidade do Usuário (Crítico) -->
                <div class="bg-red-50 border border-red-100 p-8 rounded-2xl mb-8 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10">
                        <i data-lucide="alert-octagon" class="w-32 h-32 text-red-900"></i>
                    </div>
                    <div class="relative z-10">
                        <h3 class="font-bold text-red-800 mb-4 flex items-center text-lg">
                            <i data-lucide="alert-triangle" class="w-6 h-6 mr-3"></i>
                            IMPORTANTE: Sua Responsabilidade sobre os Dados
                        </h3>
                        <div class="space-y-4 text-sm text-red-900/80 text-justify font-medium">
                            <p>
                                <strong>1. Backup é Obrigatório:</strong> Como não temos acesso aos seus dados,
                                <strong>não podemos recuperá-los</strong> em caso de perda, roubo ou dano ao seu
                                dispositivo. A realização de cópias de segurança (Backup) é de responsabilidade única e
                                exclusiva do usuário.
                            </p>
                            <p>
                                <strong>2. Isenção de Responsabilidade Técnica:</strong> A Plena exime-se de qualquer
                                responsabilidade por prejuízos decorrentes de falhas de hardware, vírus no dispositivo
                                do usuário, ou uso incorreto dos cálculos financeiros do sistema. Verifique sempre as
                                taxas configuradas.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 4. Suporte e SLA -->
                <div class="bg-gradient-to-br from-gray-900 to-plena-dark text-white p-8 rounded-2xl mb-12 shadow-xl">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="flex-1">
                            <h3 class="font-bold text-xl mb-2 flex items-center">
                                <i data-lucide="life-buoy" class="w-6 h-6 mr-3 text-plena-blue"></i>
                                Suporte Premium Especializado
                            </h3>
                            <p class="text-gray-300 text-sm mb-6 leading-relaxed">
                                Precisa de ajuda ou encontrou alguma inconsistência? Nossa equipe técnica está pronta
                                para atender você com prioridade. Garantimos a qualidade e a segurança da nossa marca.
                            </p>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <p class="text-xs text-gray-400 uppercase font-bold">Canal Oficial</p>
                                    <p class="font-bold text-white">E-mail</p>
                                </div>
                                <div class="bg-white/10 p-3 rounded-lg backdrop-blur-sm">
                                    <p class="text-xs text-gray-400 uppercase font-bold">Tempo de Resposta (SLA)</p>
                                    <p class="font-bold text-plena-blue">Até 24h Úteis</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <a href="mailto:tecnologia@plenaaplicativos.com.br"
                                class="inline-flex items-center justify-center bg-white text-plena-dark px-8 py-4 rounded-xl font-bold hover:bg-gray-100 transition-transform transform hover:scale-105 shadow-lg">
                                <i data-lucide="mail" class="w-5 h-5 mr-2"></i>
                                Falar com Suporte
                            </a>
                            <p class="text-xs text-center text-gray-400 mt-3">tecnologia@plenaaplicativos.com.br</p>
                        </div>
                    </div>
                </div>

                <!-- 5. Confirmação e Aceite (REMOVIDO) -->

                <!-- 6. Rodapé Legal -->
                <div class="text-center border-t border-gray-200 pt-8">
                    <p class="text-sm font-bold text-gray-800">Plena Soluções Digitais LTDA</p>
                    <p class="text-xs text-gray-500 mt-1">CNPJ: 17.347.919/0001-59 • Todos os direitos reservados</p>
                    <p class="text-[10px] text-gray-400 mt-4">
                        Versão 4.1 Pro • Build 2026.01.07
                    </p>
                </div>

            </div>
        </section>

        </div>



    </main>

    <!-- Property Modal (Responsive Optimized) -->
    <div id="propertyModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl transform transition-all p-6 md:p-8">
            <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-900" id="prop-modal-title">Novo Imóvel</h3>
                    <p class="text-sm text-gray-500">Gerencie os dados do imóvel e do contrato</p>
                </div>
                <button onclick="closeModal('propertyModal')"
                    class="bg-gray-100 hover:bg-gray-200 p-2 rounded-full text-gray-500 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <form onsubmit="submitProperty(event)">
                <input type="hidden" id="p-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- LEFT COLUMN: Property Data -->
                    <div class="space-y-5">
                        <div
                            class="flex items-center gap-2 text-plena-blue font-bold uppercase text-xs tracking-wider mb-2">
                            <i data-lucide="home" class="w-4 h-4"></i> Dados do Imóvel
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Apelido do Imóvel</label>
                            <input type="text" id="p-name" required
                                class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                placeholder="Ex: Apto Centro 101">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase">Endereço Completo</label>
                            <input type="text" id="p-address"
                                class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                placeholder="Rua, Número, Bairro">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Valor Aluguel</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-3 text-gray-400 text-sm">R$</span>
                                    <input type="number" step="0.01" id="p-value" required
                                        class="w-full border border-gray-300 p-3 pl-10 rounded-xl text-sm focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                        placeholder="0,00">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Dia Vencimento</label>
                                <input type="number" min="1" max="31" id="p-due" required
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-plena-blue focus:border-transparent outline-none transition-all"
                                    placeholder="Dia 1-31">
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-100">
                            <div
                                class="flex items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <div>
                                    <label class="text-sm font-bold text-gray-800 block">Imóvel Ocupado?</label>
                                    <span class="text-xs text-gray-500">Habilite se houver inquilino</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="p-occupied" onchange="toggleTenantFields()"
                                        class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500">
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Tenant Data (or Vacant State) -->
                    <div class="bg-gray-50 rounded-2xl p-6 border border-gray-200 flex flex-col relative overflow-hidden transition-all duration-300"
                        id="tenant-column">

                        <!-- 1. Vacant State (Default) -->
                        <div id="vacant-state"
                            class="flex-1 flex flex-col items-center justify-center text-center py-10">
                            <div
                                class="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 shadow-sm">
                                <i data-lucide="key" class="w-8 h-8 text-gray-300"></i>
                            </div>
                            <h4 class="text-gray-900 font-bold mb-1">Imóvel Vago</h4>
                            <p class="text-sm text-gray-500 px-4">Ative a opção "Imóvel Ocupado" ao lado para cadastrar
                                um novo inquilino.</p>
                        </div>

                        <!-- 2. Tenant Fields (Hidden by default) -->
                        <div id="tenant-fields" class="space-y-4 hidden w-full">
                            <div
                                class="flex items-center gap-2 text-green-600 font-bold uppercase text-xs tracking-wider mb-2">
                                <i data-lucide="user-check" class="w-4 h-4"></i> Dados do Inquilino
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Nome Completo</label>
                                <input type="text" id="p-tenant"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all bg-white"
                                    placeholder="Nome do Inquilino">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">WhatsApp</label>
                                    <input type="tel" id="p-phone"
                                        class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all bg-white"
                                        placeholder="(00) 00000-0000">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase">CPF</label>
                                    <input type="text" id="p-tenant-doc"
                                        class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all bg-white"
                                        placeholder="000.000.000-00">
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">E-mail</label>
                                <input type="email" id="p-tenant-email"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all bg-white"
                                    placeholder="email@exemplo.com">
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Início do Contrato</label>
                                <input type="date" id="p-tenant-start"
                                    class="w-full border border-gray-300 p-3 rounded-xl text-sm mt-1 focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none transition-all bg-white">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="deleteProperty()" id="btn-delete-prop"
                        class="hidden px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl font-bold border border-red-200">
                        Excluir Imóvel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-plena-blue text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-plena-dark transition-all">
                        Salvar Imóvel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-gray-800">Nova Movimentação</h3>
                <button onclick="closeModal('transactionModal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <form onsubmit="submitTransaction(event)" class="space-y-4">
                <input type="hidden" id="t-id">

                <div class="grid grid-cols-2 gap-3 p-1 bg-gray-100 rounded-lg">
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="t-type" value="income" class="peer hidden" checked>
                        <div
                            class="py-2 text-sm font-bold text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-green-600 shadow-sm transition-all">
                            Receita
                        </div>
                    </label>
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="t-type" value="expense" class="peer hidden">
                        <div
                            class="py-2 text-sm font-bold text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-red-600 shadow-sm transition-all">
                            Despesa
                        </div>
                    </label>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Valor (R$)</label>
                    <input type="number" id="t-amount" step="0.01" min="0.01" required
                        class="w-full border-2 border-gray-200 p-3 rounded-xl text-lg font-bold focus:border-plena-purple outline-none"
                        placeholder="0,00">
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Descrição</label>
                    <input type="text" id="t-desc" required
                        class="w-full border p-2 rounded-lg text-sm focus:border-plena-purple outline-none"
                        placeholder="Ex: Aluguel ou Pagamento de conta">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Imóvel</label>
                        <select id="t-property" class="w-full border p-2 rounded-lg text-sm bg-white outline-none">
                            <option value="">Geral</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Categoria</label>
                        <select id="t-cat" class="w-full border p-2 rounded-lg text-sm bg-white outline-none">
                            <option value="">Geral</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Data</label>
                    <input type="date" id="t-date" required
                        class="w-full border p-2 rounded-lg text-sm bg-white outline-none">
                </div>

                <button type="submit"
                    class="w-full bg-plena-blue text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-plena-dark transition-all mt-2">
                    Salvar Movimentação
                </button>
            </form>
        </div>
    </div>

    </a>
    </div>
    </div>
    </div>
    </div>



    <!-- Receipt Modal (A4 Style) -->
    <div id="receiptModal" class="fixed inset-0 modal-backdrop hidden z-50 overflow-y-auto">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl shadow-2xl relative">
                <div class="bg-gray-900 text-white p-4 flex justify-between items-center no-print">
                    <h3 class="font-bold flex items-center gap-2"><i data-lucide="file-check" class="w-5 h-5"></i>
                        Recibo Formal</h3>
                    <div class="flex gap-3">
                        <button onclick="window.print()"
                            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors">
                            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                        </button>
                        <button onclick="closeModal('receiptModal')"
                            class="text-gray-400 hover:text-white transition-colors">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <div class="p-12 md:p-16 text-gray-900 font-serif leading-relaxed" id="receipt-content">
                    <div class="text-center border-b-2 border-gray-800 pb-6 mb-8">
                        <h1 class="text-3xl font-bold uppercase tracking-wide mb-2">Recibo de Aluguel</h1>
                        <p class="text-sm text-gray-500">Documento Comprobatório de Pagamento</p>
                    </div>

                    <div class="flex justify-end mb-8">
                        <div class="border-2 border-gray-800 p-4 rounded bg-gray-50">
                            <p class="text-sm font-bold text-gray-500 uppercase">Valor Pago</p>
                            <p class="text-3xl font-bold text-gray-900" id="rec-value">R$ 0,00</p>
                        </div>
                    </div>

                    <div class="text-lg text-justify mb-12 space-y-6">
                        <p>
                            Recebi de <strong id="rec-tenant">NOME DO INQUILINO</strong> a importância supra de
                            <strong id="rec-value-text">VALOR</strong>, referente ao pagamento do aluguel do imóvel
                            situado à:
                        </p>
                        <p class="italic bg-gray-50 p-4 border-l-4 border-gray-300">
                            <span id="rec-address">ENDEREÇO DO IMÓVEL</span>
                        </p>
                        <div class="grid grid-cols-2 gap-4 text-base mt-4">
                            <div>
                                <strong>Competência:</strong> <span id="rec-period">MM/AAAA</span>
                            </div>
                            <div>
                                <strong>Vencimento Original:</strong> Dia <span id="rec-due">DD</span>
                            </div>
                        </div>
                        <p>
                            Sendo verdade, firmo o presente recibo para que produza seus devidos efeitos legais e
                            jurídicos.
                        </p>
                    </div>

                    <div class="mt-20 pt-8 flex flex-col items-end">
                        <div class="text-center w-64">
                            <p id="rec-date" class="mb-12">Local, 01 de Janeiro de 2026</p>
                            <div class="border-t border-gray-800 pt-2">
                                <p class="font-bold" id="rec-owner-name">Proprietário / Administrador</p>
                                <p class="text-xs" id="rec-owner-doc"></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-16 text-center text-xs text-gray-400 border-t pt-4">
                        Gerado digitalmente por Plena Aluguéis • Autenticação: <span id="rec-hash">---</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform transition-all p-6 animate-slide-in">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2" id="confirm-title">Confirmação</h3>
                <p class="text-sm text-gray-500" id="confirm-message">Tem certeza que deseja realizar esta ação?</p>
            </div>
            <div class="flex gap-3">
                <button id="confirm-btn-cancel" onclick="handleConfirmCancel()"
                    class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-xl font-medium hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
                <button id="confirm-btn-action"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>

        // ESTADO GLOBAL
        const DB_KEY = 'plena_alugueis_pro_v4';
        const defaultDB = {
            properties: [],
            transactions: [],
            categories: [
                { id: '1', name: 'Manutenção', color: '#F59E0B' },
                { id: '2', name: 'Condomínio', color: '#3B82F6' },
                { id: '3', name: 'IPTU', color: '#EF4444' },
                { id: '4', name: 'Água/Luz/Gás', color: '#10B981' },
                { id: '5', name: 'Material de Limpeza', color: '#8B5CF6' },
                { id: '6', name: 'Outros', color: '#6366F1' }
            ],
            settings: {
                currency: 'R$',
                theme: 'light',
                autoBackup: true,
                ownerName: '',
                ownerDoc: '',
                lateFee: 0,
                dailyInterest: 0
            }
        };

        let db = JSON.parse(localStorage.getItem(DB_KEY)) || defaultDB;

        // UTILITÁRIOS
        const save = () => {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            updateDataStatus();
        };

        const fmtMoney = (v) => {
            return v.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        const fmtDate = (d) => {
            const date = new Date(d);
            return date.toLocaleDateString('pt-BR');
        };

        const fmtDateInput = (d) => {
            return new Date(d).toISOString().split('T')[0];
        };

        const getID = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        };

        const sanitizeHTML = (str) => {
            if (str === null || typeof str === 'undefined') {
                return '';
            }
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.toString().replace(/[&<>"']/g, (m) => map[m]);
        };

        const calculatePercentage = (current, previous) => {
            if (previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous * 100).toFixed(1);
        };

        const getCurrentMonthKey = () => {
            return new Date().toISOString().slice(0, 7);
        };

        // FUNÇÕES ESPECÍFICAS DO MANUAL DE USO (Padronizado)
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function markSectionComplete(sectionId) {
            if (!db.settings.tutorial) db.settings.tutorial = {};
            if (!db.settings.tutorial.completedSections) db.settings.tutorial.completedSections = [];

            const completedSections = db.settings.tutorial.completedSections;
            if (!completedSections.includes(sectionId)) {
                completedSections.push(sectionId);
                save();
                updateTutorialProgress();
                showNotification('Seção marcada como concluída!', 'success');
            }
        }

        function updateTutorialProgress() {
            const sections = ['instalacao', 'primeiro-cadastro', 'cobranca', 'relatorios', 'backup', 'duvidas', 'checklist'];
            const completedSections = (db.settings.tutorial && db.settings.tutorial.completedSections) ? db.settings.tutorial.completedSections : [];

            const progress = sections.length > 0 ? (completedSections.length / sections.length) * 100 : 0;

            const progressBar = document.getElementById('tutorial-progress');
            const completedSteps = document.getElementById('completed-steps');

            if (progressBar) progressBar.style.width = `${progress}%`;
            if (completedSteps) completedSteps.textContent = `${completedSections.length}/${sections.length} etapas`;

            sections.forEach(sectionId => {
                const button = document.querySelector(`.tutorial-step[onclick="scrollToSection('${sectionId}')"]`);
                if (button) {
                    if (completedSections.includes(sectionId)) {
                        button.classList.add('bg-green-100', 'border-green-300', 'text-green-800');
                        button.classList.remove('border-gray-200', 'hover:bg-gray-50');
                    } else {
                        button.classList.remove('bg-green-100', 'border-green-300', 'text-green-800');
                        button.classList.add('border-gray-200', 'hover:bg-gray-50');
                    }
                }
            });
            updateChecklist();
        }

        function updateChecklist() {
            const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
            if (checkboxes.length === 0) return;

            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const percentage = (checked / checkboxes.length) * 100;

            const progressBar = document.getElementById('checklist-progress');
            const percentageText = document.getElementById('checklist-percent');
            const completedText = document.getElementById('checklist-completed');
            const totalText = document.getElementById('checklist-total');

            if (progressBar) progressBar.style.width = `${percentage}%`;
            if (percentageText) percentageText.textContent = `${Math.round(percentage)}%`;
            if (completedText) completedText.textContent = checked;
            if (totalText) totalText.textContent = checkboxes.length;

            const nextTasks = document.getElementById('next-tasks');
            if (nextTasks) {
                const uncheckedItems = Array.from(checkboxes).filter(cb => !cb.checked).slice(0, 3).map(cb => {
                    const label = document.querySelector(`label[for="${cb.id}"]`);
                    return label ? label.textContent.trim() : '';
                }).filter(text => text);

                nextTasks.innerHTML = uncheckedItems.length > 0
                    ? uncheckedItems.map(task => `<div class="flex items-center"><i data-lucide="circle" class="w-3 h-3 text-white/60 mr-2"></i><span class="text-xs text-white/90">${task}</span></div>`).join('')
                    : `<div class="flex items-center"><i data-lucide="check-circle" class="w-3 h-3 text-green-400 mr-2"></i><span class="text-xs text-white/90">Todas as tarefas concluídas!</span></div>`;
                if (lucide) lucide.createIcons();
            }

            const checklistState = {};
            checkboxes.forEach(cb => {
                checklistState[cb.id] = cb.checked;
                const item = cb.closest('.checklist-item');
                if (item) {
                    item.classList.toggle('completed', cb.checked);
                }
            });

            if (!db.settings.tutorial) db.settings.tutorial = {};
            db.settings.tutorial.checklist = checklistState;
            save();
        }

        function loadTutorialState() {
            const savedChecklist = (db.settings.tutorial && db.settings.tutorial.checklist) ? db.settings.tutorial.checklist : {};
            Object.keys(savedChecklist).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = savedChecklist[id];
            });

            updateTutorialProgress();
        }

        function resetChecklist() {
            showCustomConfirm('Reiniciar Checklist', 'Tem certeza que deseja reiniciar todas as tarefas do checklist da semana?', () => {
                const checkboxes = document.querySelectorAll('#checklist input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = false;
                });
                if (db.settings.tutorial) {
                    db.settings.tutorial.checklist = {};
                }
                save();
                updateChecklist();
                showNotification('Checklist reiniciado com sucesso!', 'success');
            }, true, 'Reiniciar', 'Cancelar');
        }

        function resetTraining() {
            showCustomConfirm('Reiniciar Treinamento', 'Isso irá limpar todo o seu progresso no manual de uso e no checklist. Deseja continuar?', () => {
                if (db.settings.tutorial) {
                    db.settings.tutorial = {};
                }
                save();
                location.reload();
            }, true, 'Reiniciar Agora', 'Cancelar');
        }

        function showExample(type) {
            if (type === 'whatsapp') {
                alert('Exemplo de recibo WhatsApp:\n\n' +
                    '*RECIBO DE PAGAMENTO*\n' +
                    '----------------------------\n' +
                    '*Inquilino:* João Silva\n' +
                    '*Imóvel:* Apto Centro 101\n' +
                    '----------------------------\n' +
                    '*Valor Pago:* R$ 1.200,00\n' +
                    '*Referência:* 03/2026\n' +
                    '*Data:* 05/03/2026\n' +
                    '----------------------------\n' +
                    '*Status:* PAGO\n' +
                    '_Gerado por Plena Aluguéis_');
            } else if (type === 'formal') {
                alert('Exemplo de recibo formal (PDF):\n\n' +
                    'Será aberta uma janela de impressão com:\n' +
                    '- Seu nome/CPF como locador\n' +
                    '- Dados completos do inquilino\n' +
                    '- Endereço do imóvel\n' +
                    '- Valor e período do aluguel\n' +
                    '- Data do pagamento\n' +
                    '- Código de autenticação único\n' +
                    '\nClique em "Imprimir" para gerar PDF.');
            }
        }

        // INICIALIZAÇÃO
        function init() {
            try {
                if (window.lucide) lucide.createIcons();

                // DETECÇÃO E CONFIGURAÇÃO WINDOWS
                const isWindows = navigator.platform.toLowerCase().includes('win');
                const isWindows11 = isWindows && navigator.userAgent.includes('Windows NT 10.0');

                if (isWindows) {
                    // Configurações específicas Windows
                    document.documentElement.classList.add('windows-platform');

                    // Ajustes de caminho para Windows
                    if (isWindows11) {
                        console.log('Windows 11 detectado - Aplicando otimizações');
                    }

                    // Configurar PWA para Windows
                    if ('serviceWorker' in navigator) {
                        // Registrar service worker com suporte Windows
                        navigator.serviceWorker.register('sw.js').then(registration => {
                            console.log('Service Worker registrado para Windows');
                        }).catch(err => {
                            console.log('Service Worker não disponível');
                        });
                    }

                    // Ajustes de interface Windows
                    document.body.style.fontFeatureSettings = '"tnum"'; // Números tabulares

                    // Notificações Windows
                    if ('Notification' in window && Notification.permission === 'granted') {
                        // Configurar notificações nativas Windows
                        const originalNotification = window.Notification;
                        window.Notification = function (title, options) {
                            return new originalNotification(title, {
                                ...options,
                                icon: '/icon-192.png',
                                badge: '/icon-72.png'
                            });
                        };
                    }
                }

                // Configurar datas padrão
                const today = new Date().toISOString().split('T')[0];
                const firstDay = new Date();
                firstDay.setDate(1);
                const firstDayStr = firstDay.toISOString().split('T')[0];

                // Configurar inputs de data
                const dateInput = document.getElementById('t-date');
                if (dateInput) dateInput.value = today;

                const monthSelector = document.getElementById('month-selector');
                if (monthSelector) monthSelector.value = today.slice(0, 7);

                if (document.getElementById('rep-start')) document.getElementById('rep-start').value = firstDayStr;
                if (document.getElementById('rep-end')) document.getElementById('rep-end').value = today;
                if (document.getElementById('filter-start-date')) document.getElementById('filter-start-date').value = firstDayStr;
                if (document.getElementById('filter-end-date')) document.getElementById('filter-end-date').value = today;

                // Renderizar dados iniciais
                renderDashboard();
                renderCategories();
                updateDataStatus();

                // Carregar configurações globais
                if (db.settings.ownerName) {
                    document.getElementById('set-owner-name').value = db.settings.ownerName;
                }
                if (db.settings.ownerDoc) {
                    document.getElementById('set-owner-doc').value = db.settings.ownerDoc;
                }
                if (db.settings.lateFee) document.getElementById('set-late-fee').value = db.settings.lateFee;
                if (db.settings.dailyInterest) document.getElementById('set-daily-interest').value = db.settings.dailyInterest;

                // Carregar nome do estabelecimento
                if (db.settings.establishmentName) document.getElementById('set-establishment-name').value = db.settings.establishmentName;

                // Inicializar componentes do manual
                loadTutorialState();

                // Inicializar Notificações
                if (typeof initNotificationSystem === 'function') {
                    initNotificationSystem();
                }

                // Configurar periodicidade para salvar
                setInterval(save, 30000); // Salva a cada 30 segundos
            } catch (error) {
                console.error('Erro na inicialização:', error);
                alert('Ocorreu um erro ao iniciar o aplicativo: ' + error.message);
            }
        }

        // ROTEAMENTO E NAVEGAÇÃO
        function router(view) {
            // Esconder todas as views
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));

            // Remover classe active de todos os nav items
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-white/10', 'text-white');
                el.classList.add('text-gray-400');
            });

            // Mostrar view selecionada
            const viewElement = document.getElementById(`view-${view}`);
            if (viewElement) {
                viewElement.classList.remove('hide');
                viewElement.classList.add('fade-in');
            }

            // Ativar nav item selecionado
            const navElement = document.getElementById(`nav-${view}`);
            if (navElement) {
                navElement.classList.add('bg-white/10', 'text-white');
                navElement.classList.remove('text-gray-400');
            }

            // Atualizar título da página
            const titles = {
                dashboard: 'Dashboard',
                properties: 'Imóveis',
                tenants: 'Inquilinos',
                transactions: 'Financeiro',
                reports: 'Relatórios',
                settings: 'Configurações',
                instructions: 'Manual de Uso',
                about: 'Sobre a Plena'
            };

            document.getElementById('page-title').innerText = titles[view] || 'Plena Aluguéis';

            // Fechar sidebar no mobile
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }

            // Renderizar dados específicos da view
            if (view === 'dashboard') {
                renderDashboard();
            } else if (view === 'properties') {
                renderProperties();
            } else if (view === 'tenants') {
                renderTenants();
            } else if (view === 'transactions') {
                renderTransactions();
            } else if (view === 'settings') {
                renderCategories();
            } else if (view === 'instructions') {
                loadTutorialState();
            } else if (view === 'system') {
                initNotificationSystem(); // Força update ao abrir
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');

            // Bloquear scroll do body quando sidebar aberta
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        // DASHBOARD
        function renderDashboard() {
            const monthSelector = document.getElementById('month-selector').value;
            const currentMonth = monthSelector || getCurrentMonthKey();

            // Filtrar imóveis ocupados
            const occupiedProperties = db.properties.filter(p => p.tenant && p.tenant.trim() !== '');
            const totalProperties = db.properties.length;

            // Calcular recebido e pendente do mês
            let totalReceived = 0;
            let totalPending = 0;

            const currentMonthTrans = db.transactions.filter(t => {
                return t.date && t.date.startsWith(currentMonth) && t.type === 'income';
            });

            totalReceived = currentMonthTrans.reduce((sum, t) => sum + t.amount, 0);

            // Calcular pendente (imóveis ocupados não pagos este mês)
            occupiedProperties.forEach(p => {
                const hasPayment = currentMonthTrans.some(t => t.propertyId === p.id);
                if (!hasPayment) {
                    totalPending += p.value || 0;
                }
            });

            // Calcular saldo total
            const allIncome = db.transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const allExpense = db.transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = allIncome - allExpense;

            // Atualizar cards
            document.getElementById('dash-occupancy').innerText = `${occupiedProperties.length}/${totalProperties}`;
            document.getElementById('dash-received').innerText = fmtMoney(totalReceived);
            document.getElementById('dash-pending').innerText = fmtMoney(totalPending);
            document.getElementById('dash-balance').innerText = fmtMoney(totalBalance);

            // Calcular crescimento vs último mês
            const prevMonth = getPreviousMonthData(currentMonth);
            const receivedGrowth = calculatePercentage(totalReceived, prevMonth.received);
            const pendingGrowth = calculatePercentage(totalPending, prevMonth.pending);

            document.getElementById('received-growth').innerText = `${receivedGrowth}%`;
            document.getElementById('pending-growth').innerText = `${pendingGrowth}%`;

            // Atualizar status dos pagamentos
            renderPaymentStatus(currentMonth, occupiedProperties, currentMonthTrans);

            // Atualizar próximos vencimentos
            renderUpcomingPayments();

            // Atualizar imóveis vagos
            renderVacantProperties();

            if (window.lucide) lucide.createIcons();
        }

        function getPreviousMonthData(currentMonth) {
            const [year, month] = currentMonth.split('-').map(Number);
            let prevYear = year;
            let prevMonth = month - 1;

            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear--;
            }

            const prevMonthStr = `${prevYear}-${prevMonth.toString().padStart(2, '0')}`;
            const prevTrans = db.transactions.filter(t => t.date && t.date.startsWith(prevMonthStr) && t.type === 'income');

            return {
                received: prevTrans.reduce((a, b) => a + b.amount, 0),
                pending: 0 // Simplificado para demo
            };
        }

        function renderPaymentStatus(currentMonth, occupiedProperties, monthTransactions) {
            const container = document.getElementById('payment-status-list');

            if (occupiedProperties.length === 0) {
                container.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-12 text-center">
                            <div class="bg-gray-50 p-4 rounded-full mb-4">
                                <i data-lucide="users" class="w-12 h-12 text-gray-300"></i>
                            </div>
                            <h3 class="text-gray-900 font-bold text-lg mb-1">Nenhum imóvel ocupado</h3>
                            <p class="text-gray-500 text-sm">Registre inquilinos para gerenciar pagamentos.</p>
                        </div>
                    `;
                return;
            }

            const monthNumber = currentMonth.slice(5, 7);

            container.innerHTML = occupiedProperties.map(p => {
                const transaction = monthTransactions.find(t => t.propertyId === p.id);
                const hasPayment = !!transaction;

                return `
                        <div class="flex flex-col md:flex-row items-center justify-between p-4 rounded-xl border ${hasPayment ? 'border-green-100 bg-green-50' : 'border-red-100 bg-white shadow-sm'} gap-4">
                            <div class="flex-1 w-full md:w-auto">
                                <h4 class="font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="home" class="w-4 h-4 text-gray-400"></i>
                                    ${sanitizeHTML(p.name)}
                                </h4>
                                <p class="text-sm text-gray-500 mt-1 flex items-center gap-2">
                                    <i data-lucide="user" class="w-3 h-3"></i>
                                    ${sanitizeHTML(p.tenant)} 
                                    <span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded-full font-bold">Dia ${p.dueDay || 5}</span>
                                </p>
                            </div>
                            
                            <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-end">
                                <div class="text-right mr-2">
                                    <p class="text-[10px] uppercase text-gray-500 font-bold mb-0.5">Valor</p>
                                    <span class="text-lg font-bold ${hasPayment ? 'text-green-700' : 'text-gray-900'}">
                                        ${fmtMoney(p.value || 0)}
                                    </span>
                                </div>

                                ${hasPayment ?
                        `<div class="flex gap-2">
                                        <button onclick="sendReceipt('${p.id}', '${currentMonth}')" class="bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-green-700 transition-colors flex items-center gap-2 shadow-sm shadow-green-200">
                                            <i data-lucide="share-2" class="w-3 h-3"></i> WhatsApp
                                        </button>
                                        <button onclick="window.openReceiptModal('${transaction.id}')" class="bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-blue-700 transition-colors flex items-center gap-2 shadow-sm shadow-blue-200">
                                            <i data-lucide="printer" class="w-3 h-3"></i> Imprimir
                                        </button>
                                    </div>` :
                        `<div class="flex gap-2">
                                        <button onclick="registerPayment('${p.id}', '${currentMonth}')" class="bg-plena-blue text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-plena-dark transition-colors flex items-center gap-2 shadow-sm shadow-indigo-200">
                                            <i data-lucide="check" class="w-4 h-4"></i> RECEBER
                                        </button>
                                        <button onclick="sendReminder('${p.id}')" class="bg-orange-100 text-orange-700 px-3 py-2 rounded-lg text-xs font-bold hover:bg-orange-200 transition-colors flex items-center gap-2">
                                            <i data-lucide="bell" class="w-4 h-4"></i> Cobrar
                                        </button>
                                    </div>`}
                            </div>
                        </div>
                    `;
            }).join('');
        }

        function renderUpcomingPayments() {
            const container = document.getElementById('upcoming-payments');
            const today = new Date();
            const currentDay = today.getDate();

            const upcoming = db.properties.filter(p => p.tenant && p.dueDay).map(p => {
                const daysUntilDue = (p.dueDay - currentDay);
                return {
                    ...p,
                    daysUntilDue: daysUntilDue > 0 ? daysUntilDue : 30 + daysUntilDue // Se já passou, conta para próximo mês
                };
            }).sort((a, b) => a.daysUntilDue - b.daysUntilDue).slice(0, 3);

            if (upcoming.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Sem vencimentos próximos</p>';
                return;
            }

            container.innerHTML = upcoming.map(p => `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${sanitizeHTML(p.name)}</p>
                            <p class="text-xs text-gray-500">${sanitizeHTML(p.tenant)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-plena-blue">${fmtMoney(p.value)}</p>
                            <p class="text-xs ${p.daysUntilDue <= 3 ? 'text-red-500' : 'text-gray-500'}">
                                Dia ${p.dueDay} (${p.daysUntilDue} dias)
                            </p>
                        </div>
                    </div>
                `).join('');
        }

        function renderVacantProperties() {
            const container = document.getElementById('vacant-properties');
            const vacant = db.properties.filter(p => !p.tenant || p.tenant.trim() === '');

            if (vacant.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Todos os imóveis ocupados</p>';
                return;
            }

            container.innerHTML = vacant.slice(0, 3).map(p => `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded-lg cursor-pointer" onclick="openPropertyModal('${p.id}')">
                        <div>
                            <p class="text-sm font-medium text-gray-800">${sanitizeHTML(p.name)}</p>
                            <p class="text-xs text-gray-500">${sanitizeHTML(p.address) || 'Sem endereço'}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-bold text-gray-600">${fmtMoney(p.value)}</p>
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded">VAGO</span>
                        </div>
                    </div>
                `).join('');
        }

        // --- VALIDATORS ---
        function validateCPF(cpf) {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
            let sum = 0, remainder;
            for (let i = 1; i <= 9; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if ((remainder === 10) || (remainder === 11)) remainder = 0;
            if (remainder !== parseInt(cpf.substring(9, 10))) return false;
            sum = 0;
            for (let i = 1; i <= 10; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (12 - i);
            remainder = (sum * 10) % 11;
            if ((remainder === 10) || (remainder === 11)) remainder = 0;
            if (remainder !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj.length !== 14) return false;
            // Validação simples de tamanho, validação completa de CNPJ pode ser complexa demais para inline, 
            // mas podemos adicionar se necessário. Para UX básica, length 14 já ajuda.
            // Implementação básica de dígito verificador:
            let size = cnpj.length - 2
            let numbers = cnpj.substring(0, size);
            let digits = cnpj.substring(size);
            let sum = 0;
            let pos = size - 7;
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(0)) return false;
            size = size + 1;
            numbers = cnpj.substring(0, size);
            sum = 0;
            pos = size - 7;
            for (let i = size; i >= 1; i--) {
                sum += numbers.charAt(size - i) * pos--;
                if (pos < 2) pos = 9;
            }
            result = sum % 11 < 2 ? 0 : 11 - sum % 11;
            if (result != digits.charAt(1)) return false;
            return true;
        }

        // --- CUSTOM MODALS ---
        let currentConfirmCallback = null;
        let currentCancelCallback = null;

        function showCustomConfirm(title, message, onConfirm, isDestructive = true, confirmText = 'Confirmar', cancelText = 'Cancelar', onCancel = null) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-message').innerText = message;

            const btnConfirm = document.getElementById('confirm-btn-action');
            const btnCancel = document.getElementById('confirm-btn-cancel');

            btnConfirm.innerText = confirmText;
            btnCancel.innerText = cancelText;

            if (isDestructive) {
                btnConfirm.className = "flex-1 px-4 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200";
            } else {
                btnConfirm.className = "flex-1 px-4 py-2 bg-plena-blue text-white rounded-xl font-bold hover:bg-plena-dark transition-colors shadow-lg shadow-blue-200";
            }

            currentConfirmCallback = onConfirm;
            currentCancelCallback = onCancel;

            document.getElementById('confirmModal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            currentConfirmCallback = null;
            currentCancelCallback = null;
        }

        function handleConfirmCancel() {
            if (currentCancelCallback) currentCancelCallback();
            closeConfirmModal();
        }

        document.getElementById('confirm-btn-action').addEventListener('click', () => {
            if (currentConfirmCallback) currentConfirmCallback();
            closeConfirmModal();
        });
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function openPropertyModal(id = null) {
            const modal = document.getElementById('propertyModal');
            const title = modal.querySelector('#prop-modal-title');
            const form = modal.querySelector('form');

            if (id) {
                // Modo edição
                const p = db.properties.find(x => x.id === id);
                if (p) {
                    title.textContent = 'Editar Imóvel';
                    document.getElementById('p-id').value = p.id;
                    document.getElementById('p-name').value = p.name || '';
                    document.getElementById('p-address').value = p.address || '';
                    document.getElementById('p-value').value = p.value || '';
                    document.getElementById('p-due').value = p.dueDay || 5;

                    // Update state first
                    const hasTenant = p.tenant && p.tenant.trim() !== '';
                    document.getElementById('p-occupied').checked = hasTenant;
                    toggleTenantFields(); // Apply visual state

                    if (hasTenant) {
                        document.getElementById('p-tenant').value = p.tenant || '';
                        document.getElementById('p-phone').value = p.phone || '';
                        document.getElementById('p-tenant-doc').value = p.tenantDoc || '';
                        document.getElementById('p-tenant-email').value = p.tenantEmail || '';
                        document.getElementById('p-tenant-start').value = p.contractStart || '';
                    }

                    document.getElementById('btn-delete-prop').classList.remove('hidden');
                }
            } else {
                // Modo criação
                title.textContent = 'Novo Imóvel';
                form.reset();
                document.getElementById('p-id').value = '';
                document.getElementById('p-occupied').checked = false;
                toggleTenantFields(); // Apply visual state (Vacant)
                document.getElementById('btn-delete-prop').classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function toggleTenantFields() {
            const chk = document.getElementById('p-occupied').checked;
            const tenantFields = document.getElementById('tenant-fields');
            const vacantState = document.getElementById('vacant-state');
            const tenantColumn = document.getElementById('tenant-column');

            if (chk) {
                tenantFields.classList.remove('hidden');
                if (vacantState) vacantState.classList.add('hidden');

                // Active visual state
                if (tenantColumn) {
                    tenantColumn.classList.remove('bg-gray-50', 'border-gray-200');
                    tenantColumn.classList.add('bg-green-50', 'border-green-200');
                }
            } else {
                tenantFields.classList.add('hidden');
                if (vacantState) vacantState.classList.remove('hidden');

                // Inactive visual state
                if (tenantColumn) {
                    tenantColumn.classList.add('bg-gray-50', 'border-gray-200');
                    tenantColumn.classList.remove('bg-green-50', 'border-green-200');
                }

                // Limpar campos de inquilino
                document.getElementById('p-tenant').value = '';
                document.getElementById('p-phone').value = '';
                document.getElementById('p-tenant-doc').value = '';
                document.getElementById('p-tenant-email').value = '';
                document.getElementById('p-tenant-start').value = '';
            }
        }

        function submitProperty(e) {
            e.preventDefault();

            const id = document.getElementById('p-id').value;
            const occupied = document.getElementById('p-occupied').checked;

            const propertyData = {
                id: id || getID(),
                name: document.getElementById('p-name').value.trim(),
                address: document.getElementById('p-address').value.trim(),
                value: parseFloat(document.getElementById('p-value').value) || 0,
                dueDay: parseInt(document.getElementById('p-due').value) || 5,
                tenant: occupied ? document.getElementById('p-tenant').value.trim() : null,
                phone: occupied ? document.getElementById('p-phone').value.trim() : null,
                tenantDoc: occupied ? document.getElementById('p-tenant-doc').value.trim() : null,
                tenantEmail: occupied ? document.getElementById('p-tenant-email').value.trim() : null,
                contractStart: occupied ? document.getElementById('p-tenant-start').value : null,
                payments: {}
            };

            // Preservar histórico de pagamentos se estiver editando
            if (id) {
                const existing = db.properties.find(p => p.id === id);
                if (existing && existing.payments) {
                    propertyData.payments = existing.payments;
                }
            }

            if (id) {
                // Editar propriedade existente
                const index = db.properties.findIndex(p => p.id === id);
                if (index !== -1) {
                    db.properties[index] = propertyData;
                }
            } else {
                // Adicionar nova propriedade
                db.properties.push(propertyData);
            }

            save();
            closeModal('propertyModal');

            // Resetar formulário
            e.target.reset();

            // Atualizar views
            if (document.getElementById('view-dashboard').classList.contains('hide') === false) {
                renderDashboard();
            }
            if (document.getElementById('view-properties').classList.contains('hide') === false) {
                renderProperties();
            }
            if (document.getElementById('view-tenants').classList.contains('hide') === false) {
                renderTenants();
            }

            showNotification('Imóvel salvo com sucesso!', 'success');
        }

        function deleteProperty() {
            const id = document.getElementById('p-id').value;

            showCustomConfirm('Excluir Imóvel', 'Tem certeza que deseja excluir este imóvel? O histórico financeiro será mantido apenas no extrato geral.', () => {
                db.properties = db.properties.filter(p => p.id !== id);
                save();
                closeModal('propertyModal');

                // Atualizar views
                renderProperties();
                renderDashboard();
                renderTenants();

                showNotification('Imóvel excluído com sucesso!', 'success');
            });
        }

        function renderProperties() {
            const container = document.getElementById('properties-list');

            if (db.properties.length === 0) {
                container.innerHTML = `
                        <div class="col-span-3 bg-white p-8 rounded-2xl text-center border border-gray-100">
                            <i data-lucide="home" class="w-12 h-12 mx-auto mb-4 text-gray-300"></i>
                            <h3 class="text-lg font-bold text-gray-800 mb-2">Nenhum imóvel cadastrado</h3>
                            <p class="text-gray-500 mb-4">Comece cadastrando seu primeiro imóvel</p>
                            <button onclick="openPropertyModal()" class="bg-plena-purple text-white px-4 py-2 rounded-lg font-bold hover:bg-plena-dark">
                                Cadastrar Primeiro Imóvel
                            </button>
                        </div>
                `;
                return;
            }

            container.innerHTML = db.properties.map(p => `
                    <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm card-hover cursor-pointer" onclick="openPropertyModal('${p.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-lg truncate">${sanitizeHTML(p.name)}</h3>
                            <p class="text-xs text-gray-500 truncate">${sanitizeHTML(p.address) || 'Sem endereço'}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${p.tenant ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${p.tenant ? 'OCUPADO' : 'VAGO'}
                        </span>
                    </div>
                        
                        ${p.tenant ? `
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm font-medium text-gray-800">${sanitizeHTML(p.tenant)}</p>
                                <p class="text-xs text-gray-500">${sanitizeHTML(p.phone) || 'Sem telefone'}</p>
                            </div>
                        ` : ''
                }

            <div class="flex justify-between items-end border-t pt-4">
                <div>
                    <p class="text-[10px] uppercase text-gray-400 font-bold">Aluguel</p>
                    <p class="font-bold text-plena-blue">${fmtMoney(p.value || 0)}</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] uppercase text-gray-400 font-bold">Vencimento</p>
                    <p class="text-sm font-medium">Dia ${p.dueDay || 5}</p>
                </div>
            </div>
                    </div>
                `).join('');

            if (window.lucide) lucide.createIcons();
        }

        // INQUILINOS
        function renderTenants() {
            const tbody = document.getElementById('tenants-table-body');
            const emptyMsg = document.getElementById('tenants-empty-msg');

            const tenants = db.properties.filter(p => p.tenant && p.tenant.trim() !== '');

            if (tenants.length === 0) {
                tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="bg-gray-50 p-4 rounded-full mb-4">
                                        <i data-lucide="users" class="w-12 h-12 text-gray-300"></i>
                                    </div>
                                    <h3 class="text-gray-900 font-bold text-lg mb-1">Nenhum inquilino encontrado</h3>
                                    <p class="text-gray-500 text-sm">Edite um imóvel e adicione um inquilino para vê-lo aqui.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                emptyMsg.classList.add('hidden');
                return;
            }

            emptyMsg.classList.add('hidden');

            tbody.innerHTML = tenants.map(p => `
                    <tr class="hover:bg-gray-50 group border-b border-gray-100">
                        <td class="px-6 py-4">
                            <div class="font-bold text-gray-800">${sanitizeHTML(p.tenant)}</div>
                            ${p.tenantDoc ? `<div class="text-[10px] text-gray-500 font-mono mt-0.5">CPF: ${sanitizeHTML(p.tenantDoc)}</div>` : ''}
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-gray-800">${sanitizeHTML(p.name)}</div>
                            <div class="text-xs text-gray-400">${sanitizeHTML(p.address) || 'Sem endereço'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-700 flex items-center gap-1">
                                <i data-lucide="phone" class="w-3 h-3 text-gray-400"></i>
                                ${sanitizeHTML(p.phone) || 'Não informado'}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-plena-blue">${fmtMoney(p.value || 0)}</div>
                            <div class="text-xs text-gray-500">Dia ${p.dueDay || 5}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">
                                Ativo
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <div class="flex justify-center space-x-2">
                                <button onclick="openPropertyModal('${p.id}')" 
                                        class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1">
                                    <i data-lucide="edit-2" class="w-3 h-3"></i> Editar
                                </button>
                                ${p.phone ? `
                                <button onclick="sendReminder('${p.id}')" 
                                        class="bg-green-50 text-green-600 hover:bg-green-100 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1">
                                    <i data-lucide="message-circle" class="w-3 h-3"></i> Contato
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');

            if (window.lucide) lucide.createIcons();
        }

        // PAGAMENTOS
        function registerPayment(propertyId, monthKey) {
            const property = db.properties.find(p => p.id === propertyId);
            if (!property) return;

            // Lógica de Cálculo de Juros
            let finalAmount = property.value || 0;
            const [yearStr, monthStr] = monthKey.split('-');
            const dueDay = property.dueDay || 5;

            // Data de vencimento baseada no mês de competência
            const dueDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, dueDay);
            const today = new Date();
            // Zerar horas para comparação justa de datas
            dueDate.setHours(23, 59, 59, 999);
            today.setHours(0, 0, 0, 0);

            if (today > dueDate) {
                const diffTime = Math.abs(today - dueDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                const lateFeePercent = parseFloat(db.settings.lateFee) || 0;
                const dailyInterestPercent = parseFloat(db.settings.dailyInterest) || 0;

                if (lateFeePercent > 0 || dailyInterestPercent > 0) {
                    const fineValue = finalAmount * (lateFeePercent / 100);
                    const interestValue = finalAmount * (dailyInterestPercent / 100) * diffDays;
                    const newTotal = finalAmount + fineValue + interestValue;

                    const lateMessage = `⚠️ Pagamento em Atraso (${diffDays} dias)!\n\n` +
                        `Valor Base: ${fmtMoney(finalAmount)}\n` +
                        `Multa (${lateFeePercent}%): ${fmtMoney(fineValue)}\n` +
                        `Juros (${dailyInterestPercent}%/dia): ${fmtMoney(interestValue)}\n\n` +
                        `Novo Total: ${fmtMoney(newTotal)}`;

                    showCustomConfirm(
                        'Aplicar Encargos?',
                        lateMessage,
                        () => finishPayment(property, monthKey, newTotal, true), // On Confirm
                        false,
                        'Aplicar Juros',
                        'Manter Original',
                        () => finishPayment(property, monthKey, finalAmount, false) // On Cancel
                    );
                    return;
                }
            }

            finishPayment(property, monthKey, finalAmount, false);
        }

        function finishPayment(property, monthKey, finalAmount, isLate) {
            // Marcar como pago
            if (!property.payments) property.payments = {};
            property.payments[monthKey] = {
                date: new Date().toISOString(),
                amount: finalAmount,
                status: 'paid',
                originalValue: property.value,
                lateApplied: isLate
            };

            // Registrar transação automaticamente
            const monthNumber = monthKey.slice(5, 7);
            const yearNumber = monthKey.slice(0, 4);

            db.transactions.push({
                id: getID(),
                type: 'income',
                desc: `Aluguel ${property.name} (${monthNumber}/${yearNumber}) ${isLate ? '(Com Juros)' : ''}`,
                amount: finalAmount,
                propertyId: property.id,
                date: new Date().toISOString().split('T')[0]
            });

            save();
            renderDashboard();
            renderTransactions();

            showNotification(`Pagamento registrado: ${fmtMoney(finalAmount)}`, 'success');

            // Perguntar se quer enviar recibo
            if (property.phone) {
                showCustomConfirm('Enviar Recibo', 'Deseja enviar o recibo por WhatsApp agora?',
                    () => sendReceipt(property.id, monthKey),
                    false,
                    'Enviar Agora',
                    'Não'
                );
            }
        }

        function sendReminder(propertyId) {
            const property = db.properties.find(p => p.id === propertyId);
            if (!property || !property.phone) {
                showNotification('Imóvel sem telefone cadastrado.', 'error');
                return;
            }

            // Formatação visual "Card" (Lembrete Padronizado - Texto Limpo)
            const msg = `*LEMBRETE DE ALUGUEL*\n` +
                `----------------------------\n` +
                `*Inquilino:* ${sanitizeHTML(property.tenant)}\n` +
                `*Imóvel:* ${sanitizeHTML(property.name)}\n` +
                `----------------------------\n` +
                `*Valor:* ${fmtMoney(property.value || 0)}\n` +
                `*Vencimento:* Dia ${property.dueDay || 5}\n` +
                `----------------------------\n` +
                `*Status:* Aguardando pagamento\n` +
                `_Gerado por Plena Aluguéis_`;

            window.open(`https://wa.me/55${property.phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function sendReceipt(propertyId, monthKey) {
            const property = db.properties.find(p => p.id === propertyId);
            if (!property || !property.phone) return;

            const monthNumber = monthKey.slice(5, 7);
            const yearNumber = monthKey.slice(0, 4);

            // Formatação visual "Card" (Recibo Padronizado - Texto Limpo)
            const msg = `*RECIBO DE PAGAMENTO*\n` +
                `----------------------------\n` +
                `*Inquilino:* ${sanitizeHTML(property.tenant)}\n` +
                `*Imóvel:* ${sanitizeHTML(property.name)}\n` +
                `----------------------------\n` +
                `*Valor Pago:* ${fmtMoney(property.value || 0)}\n` +
                `*Referência:* ${monthNumber}/${yearNumber}\n` +
                `*Data:* ${new Date().toLocaleDateString('pt-BR')}\n` +
                `----------------------------\n` +
                `*Status:* PAGO\n` +
                `_Gerado por Plena Aluguéis_`;

            // Envio com encodeURIComponent para garantir emojis e quebras de linha corretos
            window.open(`https://wa.me/55${property.phone.replace(/\D/g, '')}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // TRANSAÇÕES
        function openTransModal(transaction = null) {
            // Popular select de imóveis
            const propertySelect = document.getElementById('t-property');
            propertySelect.innerHTML = '<option value="">Geral</option>' +
                db.properties.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

            // Popular select de categorias
            const catSelect = document.getElementById('t-cat');
            catSelect.innerHTML = '<option value="">Geral</option>' +
                db.categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const modal = document.getElementById('transactionModal');
            const title = modal.querySelector('h3');
            const form = modal.querySelector('form');

            if (transaction) {
                // Modo edição
                title.textContent = 'Editar Movimentação';
                document.getElementById('t-id').value = transaction.id;
                document.querySelector(`input[name="t-type"][value="${transaction.type}"]`).checked = true;
                document.getElementById('t-amount').value = transaction.amount;
                document.getElementById('t-desc').value = transaction.desc;
                document.getElementById('t-property').value = transaction.propertyId || '';
                document.getElementById('t-cat').value = transaction.catId || '';
                document.getElementById('t-date').value = transaction.date;
            } else {
                // Modo criação
                title.textContent = 'Nova Movimentação';
                form.reset();
                document.getElementById('t-id').value = '';
                document.getElementById('t-date').value = new Date().toISOString().split('T')[0];
                document.querySelector('input[name="t-type"][value="income"]').checked = true;
            }

            modal.classList.remove('hidden');
        }

        function submitTransaction(e) {
            e.preventDefault();

            const id = document.getElementById('t-id').value;
            const type = document.querySelector('input[name="t-type"]:checked').value;
            const amount = parseFloat(document.getElementById('t-amount').value);
            const desc = document.getElementById('t-desc').value.trim();
            const propertyId = document.getElementById('t-property').value;
            const catId = document.getElementById('t-cat').value;
            const date = document.getElementById('t-date').value;

            if (!desc || !amount || amount <= 0) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            const transaction = {
                id: id || getID(),
                type,
                amount,
                desc,
                propertyId: propertyId || null,
                catId: catId || null,
                date
            };

            if (id) {
                // Editar transação existente
                const index = db.transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    db.transactions[index] = transaction;
                }
            } else {
                // Adicionar nova transação
                db.transactions.push(transaction);
            }

            save();
            closeModal('transactionModal');

            // Resetar formulário
            e.target.reset();
            document.getElementById('t-date').value = new Date().toISOString().split('T')[0];

            // Atualizar views
            if (document.getElementById('view-transactions').classList.contains('hide') === false) {
                renderTransactions();
            }
            if (document.getElementById('view-dashboard').classList.contains('hide') === false) {
                renderDashboard();
            }

            showNotification('Movimentação salva com sucesso!', 'success');
        }

        function renderTransactions() {
            const term = document.getElementById('search-transactions').value.toLowerCase();
            const filter = document.getElementById('filter-trans-type').value;
            const start = document.getElementById('filter-start-date').value;
            const end = document.getElementById('filter-end-date').value;

            // Filtrar transações
            let filtered = db.transactions.filter(t => {
                const matchesTerm = t.desc.toLowerCase().includes(term) ||
                    (t.propertyId && getPropertyName(t.propertyId).toLowerCase().includes(term));
                const matchesType = filter === 'all' || t.type === filter;
                const matchesDate = (!start || t.date >= start) && (!end || t.date <= end);

                return matchesTerm && matchesType && matchesDate;
            });

            // Ordenar por data (mais recente primeiro)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Atualizar tabela
            const tbody = document.getElementById('trans-table-body');
            const emptyMsg = document.getElementById('trans-empty-msg');

            if (filtered.length === 0) {
                tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="py-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <div class="bg-gray-50 p-4 rounded-full mb-4">
                                        <i data-lucide="search-x" class="w-12 h-12 text-gray-300"></i>
                                    </div>
                                    <h3 class="text-gray-900 font-bold text-lg mb-1">Nenhuma transação encontrada</h3>
                                    <p class="text-gray-500 text-sm">Tente ajustar os filtros ou adicione uma nova movimentação.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                emptyMsg.classList.add('hidden');
                updateTransactionSummary([]);
                return;
            }

            emptyMsg.classList.add('hidden');

            tbody.innerHTML = filtered.map(t => {
                const propertyName = t.propertyId ? getPropertyName(t.propertyId) : 'Geral';
                const category = t.catId ? db.categories.find(c => c.id === t.catId) : null;
                const isIncome = t.type === 'income';

                return `
                        <tr class="hover:bg-gray-50 group border-b border-gray-100">
                            <td class="px-6 py-4 text-gray-500 whitespace-nowrap text-sm">${fmtDate(t.date)}</td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-800">${sanitizeHTML(t.desc)}</div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded">${sanitizeHTML(propertyName)}</span>
                            </td>
                            <td class="px-6 py-4">
                                ${category ?
                        `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold" 
                                        style="background:${sanitizeHTML(category.color)}20; color:${sanitizeHTML(category.color)}">
                                        ${sanitizeHTML(category.name)}
                                    </span>` :
                        '<span class="text-xs text-gray-400">-</span>'
                    }
                            </td>
                            <td class="px-6 py-4 text-right font-bold ${isIncome ? 'text-green-600' : 'text-red-500'}">
                                ${isIncome ? '+' : '-'} ${fmtMoney(t.amount)}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex justify-center gap-2">
                                    <button onclick="openReceiptModal('${t.id}')" 
                                            class="p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
                                            title="Imprimir Recibo">
                                        <i data-lucide="printer" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="editTransaction('${t.id}')" 
                                            class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                            title="Editar">
                                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                                    </button>
                                    <button onclick="deleteTransaction('${t.id}')" 
                                            class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                                            title="Excluir">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
            }).join('');

            lucide.createIcons();
            updateTransactionSummary(filtered);
        }

        // Make function globally accessible and robust
        window.openReceiptModal = function (id) {
            console.log('Tentando abrir recibo para ID:', id);

            // Validate ID
            if (!id || id === 'undefined' || id === 'null') {
                alert('Erro: ID da transação inválido.');
                console.error('ID inválido recebido:', id);
                return;
            }

            const transaction = db.transactions.find(t => t.id === id);

            if (!transaction) {
                // Fallback: Try to find transaction by Property ID if mistakenly passed?
                // For now, just alert error.
                alert('Erro: Transação não encontrada. Verifique se o pagamento foi registrado.');
                console.error('Transação não encontrada para ID:', id);
                return;
            }

            const property = db.properties.find(p => p.id === transaction.propertyId);

            // Populate Modal Data
            const amountStr = fmtMoney(transaction.amount);
            if (document.getElementById('rec-value')) document.getElementById('rec-value').textContent = amountStr;
            if (document.getElementById('rec-value-text')) document.getElementById('rec-value-text').textContent = amountStr;

            if (document.getElementById('rec-tenant')) document.getElementById('rec-tenant').textContent = property ? property.tenant : (transaction.description || 'N/A');
            if (document.getElementById('rec-address')) document.getElementById('rec-address').textContent = property ? (property.address || property.name) : 'Endereço não informado';

            // Format Date
            if (transaction.date) {
                const dateParts = transaction.date.split('-'); // YYYY-MM-DD
                if (document.getElementById('rec-period')) document.getElementById('rec-period').textContent = `${dateParts[1]}/${dateParts[0]}`;
            }

            if (document.getElementById('rec-due')) document.getElementById('rec-due').textContent = property ? property.dueDay : '05';

            const now = new Date();
            const longDate = now.toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
            if (document.getElementById('rec-date')) document.getElementById('rec-date').textContent = `Local, ${longDate}`;

            // Generate Hash
            if (document.getElementById('rec-hash')) document.getElementById('rec-hash').textContent = Math.random().toString(36).substring(2, 10).toUpperCase();

            // OWNER DATA (Auto-Fill from Settings)
            const ownerName = db.settings.ownerName || 'Proprietário / Administrador';
            const ownerDoc = db.settings.ownerDoc || '';
            if (document.getElementById('rec-owner-name')) document.getElementById('rec-owner-name').textContent = ownerName;
            if (document.getElementById('rec-owner-doc')) document.getElementById('rec-owner-doc').textContent = ownerDoc;

            // Use global openModal
            if (typeof openModal === 'function') {
                openModal('receiptModal');
            } else {
                // Fallback if openModal missing
                const modal = document.getElementById('receiptModal');
                if (modal) modal.classList.remove('hidden');
            }
        }

        function editTransaction(id) {
            const transaction = db.transactions.find(t => t.id === id);
            if (transaction) {
                openTransModal(transaction);
            }
        }

        function deleteTransaction(id) {
            showCustomConfirm('Excluir Movimentação', 'Tem certeza que deseja excluir esta movimentação?', () => {
                db.transactions = db.transactions.filter(t => t.id !== id);
                save();

                // Atualizar views
                if (document.getElementById('view-transactions').classList.contains('hide') === false) {
                    renderTransactions();
                }
                if (document.getElementById('view-dashboard').classList.contains('hide') === false) {
                    renderDashboard();
                }

                showNotification('Movimentação excluída com sucesso!', 'success');
            });
        }

        function updateTransactionSummary(transactions) {
            const income = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('filter-income').textContent = fmtMoney(income);
            document.getElementById('filter-expense').textContent = fmtMoney(expense);
            document.getElementById('filter-balance').textContent = fmtMoney(balance);
        }

        function clearTransactionFilters() {
            const firstDay = new Date();
            firstDay.setDate(1);
            const firstDayStr = firstDay.toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];

            document.getElementById('search-transactions').value = '';
            document.getElementById('filter-trans-type').value = 'all';
            document.getElementById('filter-start-date').value = firstDayStr;
            document.getElementById('filter-end-date').value = today;

            renderTransactions();
        }

        function getPropertyName(propertyId) {
            const property = db.properties.find(p => p.id === propertyId);
            return property ? property.name : 'Desconhecido';
        }

        // CATEGORIAS
        function renderCategories() {
            const container = document.getElementById('cat-list');

            if (db.categories.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Nenhuma categoria cadastrada</p>';
                return;
            }

            container.innerHTML = db.categories.map(cat => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full mr-3" style="background:${sanitizeHTML(cat.color)}"></div>
                            <span class="text-sm font-medium text-gray-800">${sanitizeHTML(cat.name)}</span>
                        </div>
                        <button onclick="deleteCategory('${cat.id}')" 
                                class="text-gray-400 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');

            if (window.lucide) lucide.createIcons();
        }

        function toggleCatForm() {
            const formBox = document.getElementById('cat-form-box');
            formBox.classList.toggle('hidden');

            if (!formBox.classList.contains('hidden')) {
                document.getElementById('new-cat-name').focus();
            }
        }

        function addCategory() {
            const name = document.getElementById('new-cat-name').value.trim();
            const color = document.getElementById('new-cat-color').value;

            if (!name) {
                alert('Por favor, insira um nome para a categoria.');
                return;
            }

            // Verificar se já existe categoria com mesmo nome
            const exists = db.categories.some(c => c.name.toLowerCase() === name.toLowerCase());

            if (exists) {
                alert('Já existe uma categoria com este nome.');
                return;
            }

            db.categories.push({
                id: getID(),
                name,
                color
            });

            save();
            renderCategories();
            toggleCatForm();

            // Limpar formulário
            document.getElementById('new-cat-name').value = '';
            document.getElementById('new-cat-color').value = '#7C3AED';

            showNotification('Categoria adicionada com sucesso!', 'success');
        }

        function deleteCategory(id) {
            showCustomConfirm('Excluir Categoria', 'Tem certeza que deseja excluir esta categoria? Transações associadas perderão a categoria.', () => {
                // Remover categoria de transações
                db.transactions = db.transactions.map(t => {
                    if (t.catId === id) {
                        return { ...t, catId: null };
                    }
                    return t;
                });

                // Remover categoria
                db.categories = db.categories.filter(c => c.id !== id);

                save();
                renderCategories();
                showNotification('Categoria removida com sucesso!', 'success');
            });
        }

        function saveGlobalSettings() {
            // Removido usageType pois o elemento foi removido do HTML
            const establishmentName = document.getElementById('set-establishment-name').value.trim();
            const ownerName = document.getElementById('set-owner-name').value.trim();
            const ownerDoc = document.getElementById('set-owner-doc').value.trim();

            // Validation for Owner Doc if provided
            if (ownerDoc) {
                const isCPF = ownerDoc.length <= 14;
                if (isCPF && !validateCPF(ownerDoc)) {
                    showNotification('CPF inválido! Verifique os números.', 'error');
                    return;
                }
                if (!isCPF && !validateCNPJ(ownerDoc)) {
                    showNotification('CNPJ inválido! Verifique os números.', 'error');
                    return;
                }
            }

            db.settings.establishmentName = establishmentName;
            db.settings.ownerName = ownerName;
            db.settings.ownerDoc = ownerDoc;
            db.settings.lateFee = parseFloat(document.getElementById('set-late-fee').value) || 0;
            db.settings.dailyInterest = parseFloat(document.getElementById('set-daily-interest').value) || 0;

            save();
            showNotification('Configurações salvas com sucesso!', 'success');
        }

        // RELATÓRIOS

        function generateReport() {
            const start = document.getElementById('rep-start').value;
            const end = document.getElementById('rep-end').value;

            if (!start || !end) {
                alert('Por favor, selecione um período.');
                return;
            }

            const transactions = db.transactions.filter(t => t.date >= start && t.date <= end);
            const income = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('rep-inc').textContent = fmtMoney(income);
            document.getElementById('rep-exp').textContent = fmtMoney(expense);
            document.getElementById('rep-bal').textContent = fmtMoney(balance);

            // Gerar análise por imóvel
            renderPropertyReport(transactions);

            document.getElementById('report-result').classList.remove('hide');
        }

        function setReportPeriod(period) {
            const today = new Date();
            let start, end;

            if (period === 'last-month') {
                start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                end = new Date(today.getFullYear(), today.getMonth(), 0);
            } else if (period === 'this-year') {
                start = new Date(today.getFullYear(), 0, 1);
                end = new Date(today.getFullYear(), 11, 31);
            } else if (period === 'last-year') {
                start = new Date(today.getFullYear() - 1, 0, 1);
                end = new Date(today.getFullYear() - 1, 11, 31);
            }

            document.getElementById('rep-start').value = start.toISOString().split('T')[0];
            document.getElementById('rep-end').value = end.toISOString().split('T')[0];
            generateReport();
        }

        function generateFullReport() {
            setReportPeriod('this-year'); // Default to full current year for "Full Report"
        }

        function generateReport() {
            const startStr = document.getElementById('rep-start').value;
            const endStr = document.getElementById('rep-end').value;

            if (!startStr || !endStr) {
                alert('Por favor, selecione um período.');
                return;
            }

            const start = startStr;
            const end = endStr;

            // Fill PrintHeader info
            document.getElementById('print-date').textContent = `Gerado em: ${new Date().toLocaleDateString('pt-BR')}`;
            document.getElementById('print-period').textContent = `Período: ${new Date(start + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(end + 'T00:00:00').toLocaleDateString('pt-BR')}`;

            const transactions = db.transactions.filter(t => t.date >= start && t.date <= end);
            const income = transactions.filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            document.getElementById('rep-inc').textContent = fmtMoney(income);
            document.getElementById('rep-exp').textContent = fmtMoney(expense);
            document.getElementById('rep-bal').textContent = fmtMoney(balance);

            // Gerar relatórios detalhados
            renderPropertyReport(transactions);
            renderCategoryReport(transactions);
            renderFinancialChart(income, expense);

            document.getElementById('report-result').classList.remove('hide');
        }

        function renderCategoryReport(transactions) {
            const expenseTrans = transactions.filter(t => t.type === 'expense');
            const catMap = {};
            let totalExpense = 0;

            expenseTrans.forEach(t => {
                totalExpense += t.amount;
                const catId = t.catId || 'uncategorized';
                if (!catMap[catId]) catMap[catId] = 0;
                catMap[catId] += t.amount;
            });

            const container = document.getElementById('category-report');

            if (expenseTrans.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm italic">Sem despesas no período.</p>';
                return;
            }

            const sortedCats = Object.entries(catMap).sort((a, b) => b[1] - a[1]);

            container.innerHTML = sortedCats.map(([catId, amount]) => {
                const cat = catId === 'uncategorized'
                    ? { name: 'Sem Categoria', color: '#9ca3af' }
                    : db.categories.find(c => c.id === catId) || { name: 'Apagada', color: '#9ca3af' };

                const percent = totalExpense > 0 ? (amount / totalExpense) * 100 : 0;

                return `
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full print-color-exact" style="background-color: ${cat.color}"></div>
                                <span class="text-gray-700 font-medium">${sanitizeHTML(cat.name)}</span>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-gray-900">${fmtMoney(amount)}</span>
                                <span class="text-xs text-gray-400 ml-1">(${percent.toFixed(0)}%)</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1 print-color-exact">
                            <div class="h-1.5 rounded-full print-color-exact" style="width: ${percent}%; background-color: ${cat.color}"></div>
                        </div>
                    `;
            }).join('');
        }

        function renderFinancialChart(income, expense) {
            const container = document.getElementById('financial-chart');
            const max = Math.max(income, expense) || 1;

            const incPercent = (income / max) * 100;
            const expPercent = (expense / max) * 100;

            container.innerHTML = `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-600">Receitas</span>
                            <span class="font-bold text-green-600">${fmtMoney(income)}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-8 print-color-exact">
                            <div class="h-8 rounded-full bg-green-500 flex items-center justify-end px-3 text-xs text-white font-bold transition-all duration-1000 print-color-exact" 
                                style="width: ${incPercent}%">
                                ${incPercent > 10 ? Math.round(incPercent) + '%' : ''}
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium text-gray-600">Despesas</span>
                            <span class="font-bold text-red-600">${fmtMoney(expense)}</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-8 print-color-exact">
                            <div class="h-8 rounded-full bg-red-500 flex items-center justify-end px-3 text-xs text-white font-bold transition-all duration-1000 print-color-exact" 
                                style="width: ${expPercent}%">
                                ${expPercent > 10 ? Math.round(expPercent) + '%' : ''}
                            </div>
                        </div>
                    </div>
                `;
        }

        function printReport() {
            window.print();
        }

        function shareReport() {
            const startStr = document.getElementById('rep-start').value;
            const endStr = document.getElementById('rep-end').value;

            if (!startStr || !endStr) return;

            // Recalcular totais para o relatório
            const transactions = db.transactions.filter(t => t.date >= startStr && t.date <= endStr);
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;

            // Top 3 Categorias de Despesa
            const expenseTrans = transactions.filter(t => t.type === 'expense');
            const catMap = {};
            expenseTrans.forEach(t => {
                const catId = t.catId || 'uncategorized';
                if (!catMap[catId]) catMap[catId] = 0;
                catMap[catId] += t.amount;
            });

            const topCats = Object.entries(catMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([catId, amount]) => {
                    const catName = catId === 'uncategorized' ? 'Sem Categoria' : (db.categories.find(c => c.id === catId)?.name || 'Outros');
                    return `- ${catName}: ${fmtMoney(amount)}`;
                });

            // Formatar mensagem (Clean Text)
            const msg = `*RELATÓRIO FINANCEIRO*\n` +
                `Plena Aluguéis\n\n` +
                `*Período:* ${new Date(startStr + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endStr + 'T00:00:00').toLocaleDateString('pt-BR')}\n\n` +
                `*RESUMO*\n` +
                `Entradas: ${fmtMoney(income)}\n` +
                `Saídas: ${fmtMoney(expense)}\n` +
                `*Saldo: ${fmtMoney(balance)}*\n\n` +
                (topCats.length > 0 ? `*PRINCIPAIS DESPESAS*\n${topCats.join('\n')}\n\n` : '') +
                `_Gerado automaticamente pelo App Plena Aluguéis_`;

            const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function renderPropertyReport(transactions) {
            const propertyMap = {};

            transactions.forEach(t => {
                if (t.propertyId) {
                    const property = db.properties.find(p => p.id === t.propertyId);
                    const propertyName = property ? property.name : 'Desconhecido';

                    if (!propertyMap[propertyName]) {
                        propertyMap[propertyName] = { income: 0, expense: 0 };
                    }

                    if (t.type === 'income') {
                        propertyMap[propertyName].income += t.amount;
                    } else {
                        propertyMap[propertyName].expense += t.amount;
                    }
                }
            });

            const container = document.getElementById('property-report');
            const sortedProperties = Object.entries(propertyMap)
                .sort((a, b) => (b[1].income + b[1].expense) - (a[1].income + a[1].expense));

            if (sortedProperties.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center">Sem dados para o período selecionado</p>';
                return;
            }

            container.innerHTML = sortedProperties.map(([name, data]) => {
                const total = data.income + data.expense;
                const net = data.income - data.expense;

                return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center">
                                <i data-lucide="home" class="w-4 h-4 mr-3 text-gray-400"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">${sanitizeHTML(name)}</p>
                                    <p class="text-xs text-gray-500">${data.income > 0 ? 'Receitas' : 'Despesas'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold ${net >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${net >= 0 ? '+' : ''}${fmtMoney(total)}
                                </p>
                                <p class="text-xs text-gray-500">${fmtMoney(net)} líquido</p>
                            </div>
                        </div>
                    `;
            }).join('');
        }

        // EXPORTAÇÃO E BACKUP
        // Funções de exportação removidas

        function downloadBackup() {
            const backupData = {
                ...db,
                exportedAt: new Date().toISOString(),
                version: 'plena_alugueis_v4'
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileName = `plena_alugueis_backup_${new Date().toISOString().slice(0, 10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();

            showNotification('Backup baixado com sucesso!', 'success');
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const backup = JSON.parse(e.target.result);

                    // Validar backup
                    if (!backup.properties || !backup.transactions) {
                        throw new Error('Arquivo de backup inválido');
                    }

                    showCustomConfirm('Restaurar Backup', 'Restaurar backup substituirá todos os dados atuais. Tem certeza?', () => {
                        db = backup;
                        save();
                        location.reload();
                    });
                } catch (error) {
                    showNotification('Erro ao restaurar backup: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllTransactions() {
            showCustomConfirm('Limpar Tudo', 'Tem certeza que deseja limpar TODAS as transações? Esta ação é irreversível!', () => {
                db.transactions = [];
                save();
                renderDashboard();
                renderTransactions();
                showNotification('Todas as transações foram removidas!', 'success');
            });
        }

        function factoryReset() {
            showCustomConfirm('Reset de Fábrica', 'ATENÇÃO: Isso resetará TODO o sistema para as configurações de fábrica. Todos os dados serão perdidos. Tem certeza?', () => {
                localStorage.removeItem(DB_KEY);
                location.reload();
            });
        }

        // UTILITÁRIOS GERAIS
        function updateDataStatus() {
            const totalProperties = db.properties.length;
            const occupiedProperties = db.properties.filter(p => p.tenant && p.tenant.trim() !== '').length;
            const totalTransactions = db.transactions.length;

            console.log(`Dados atualizados: ${totalProperties} imóveis (${occupiedProperties} ocupados), ${totalTransactions} transações`);
        }

        function showNotification(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
                }`;
            notification.innerHTML = `
                    <div class="flex items-center">
                        <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}" 
                        class="w-5 h-5 mr-2"></i>
                        <span>${sanitizeHTML(message)}</span>
                    </div>
                `;

            document.body.appendChild(notification);
            lucide.createIcons();

            // Remover após 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function printMonthReport() {
            window.print();
        }

        function printReport() {
            window.print();
        }

        // FUNÇÃO DE IMPRESSÃO DE RECIBO (VIA MODAL)
        function openReceiptModal(propertyId, monthKey) {
            const property = db.properties.find(p => p.id === propertyId);
            if (!property) return;

            const [year, month] = monthKey.split('-');
            const dateObj = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };

            // Preencher dados
            document.getElementById('rec-tenant').innerHTML = `${property.tenant} <br><span class="text-sm font-normal text-gray-500">${property.tenantDoc ? 'CPF: ' + property.tenantDoc : ''}</span>`;
            document.getElementById('rec-value').textContent = fmtMoney(property.value || 0);
            document.getElementById('rec-value-text').textContent = fmtMoney(property.value || 0);
            document.getElementById('rec-address').textContent = `${property.address || 'Endereço não informado'} (${property.name})`;
            document.getElementById('rec-period').textContent = `${month}/${year}`;
            document.getElementById('rec-due').textContent = property.dueDay;
            document.getElementById('rec-date').textContent = `Local, ${dateObj.toLocaleDateString('pt-BR', options)}`;
            document.getElementById('rec-hash').textContent = getID().toUpperCase();

            // Atualizar Assinatura
            const signatureTitle = document.querySelector('#receipt-content .border-t p');
            if (signatureTitle) {
                const ownerInfo = db.settings.ownerName ? `${db.settings.ownerName} ${db.settings.ownerDoc ? ' - ' + db.settings.ownerDoc : ''}` : 'Proprietário / Administrador';
                signatureTitle.textContent = ownerInfo;
            }

            // Mostrar Modal
            document.getElementById('receiptModal').classList.remove('hidden');
        }

        // SUPORTE OFFLINE E DETECÇÃO DE REDE
        window.addEventListener('online', () => {
            showNotification('Conexão restaurada!', 'success');
        });

        window.addEventListener('offline', () => {
            showNotification('Modo offline ativado. Seus dados estão seguros localmente.', 'warning');
        });

        // INICIALIZAR APLICATIVO
        document.addEventListener('DOMContentLoaded', () => {
            init();
            // Register SW for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('SW Registered'))
                    .catch(err => console.error('SW Error:', err));
            }
        });
    </script>
    <script>
        // CONTEXT AWARENESS FOR IFRAMES
        if (window.self !== window.top) {
            document.body.classList.add('in-iframe');
        }
    </script>









    
    <script>
        // Legacy Notifs Removed </script>

    <!-- Legacy Modal Removed -->
    </div>
    </script>

    <div id="pwa-install-toast" class="fixed bottom-4 left-4 right-4 z-[9999] hidden animate-slide-in">
        <div
            class="bg-slate-900 text-white p-4 rounded-2xl shadow-2xl flex items-center justify-between gap-4 border border-slate-700 max-w-md mx-auto w-full">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-plena-indigo rounded-xl flex items-center justify-center shrink-0">
                    <i class="fa-solid fa-download text-white"></i>
                </div>
                <div>
                    <h4 class="font-bold text-sm">Instalar Aplicativo</h4>
                    <p class="text-xs text-slate-400">Acesso offline e tela cheia.</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="dismissInstall()" class="p-2 text-slate-400 hover:text-white transition"><i
                        class="fa-solid fa-xmark"></i></button>
                <button onclick="installPWA()"
                    class="bg-plena-indigo hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wide transition shadow-lg">INSTALAR</button>
            </div>
        </div>
    </div>



<script>
// SISTEMA DE ATUALIZAÇÃO E PWA (ROBUSTO)
        // ==========================================
        const BUILD_DATE = new Date().toLocaleDateString('pt-BR');

        const CHANGELOG = [
            { version: 'v4.3', date: '24/01/2026', changes: ['Melhoria no mecanismo de update', 'Detecção real de versão do SW'] },
            { version: 'v4.2', date: '24/01/2026', changes: ['Novo Sistema Centralizado', 'Aba de Diagnóstico e Rede', 'Notificações em Tempo Real'] },
            { version: 'v4.1', date: '10/01/2026', changes: ['Módulo Financeiro Avançado', 'Exportação PDF'] },
            { version: 'v4.0', date: '01/01/2026', changes: ['Lançamento Oficial'] }
        ];

        let CURRENT_VERSION = CHANGELOG[0].version; // Default to latest logic in this file

        // --- SYSTEM VIEW LOGIC ---

        // ==========================================================
        // MÓDULO DE NOTIFICAÇÕES INTELIGENTE V5.2 (Red Dot & Secure)
        // ==========================================================
        const NOTIF_API_URL = '../../api_licenca.php';

        let activeNotifications = [];

        async function initNotificationSystem() {
            const licenseKey = localStorage.getItem('plena_license_key');
            if (!licenseKey) return;

            try {
                const response = await fetch(`${NOTIF_API_URL}?action=get_notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey })
                });

                if (!response.ok) return;

                const data = await response.json();
                const serverNotifications = data.notifications || [];
                processNotifications(serverNotifications);

            } catch (error) {
                console.warn('SysNotif: Erro silencioso de conexão');
            }
        }

        function processNotifications(serverList) {
            const readIds = JSON.parse(localStorage.getItem('plena_read_notifs') || '[]');

            // Filtra apenas não lidas
            const unreadList = serverList.filter(n => !readIds.includes(n.id));
            activeNotifications = unreadList;

            // 1. Atualiza Visual (Ponto Vermelho Pulsante)
            updateBadgeUI(unreadList.length > 0);

            // 2. Renderiza Lista (se estiver na aba sistema)
            renderNotificationList(unreadList);

            // 3. Lógica de Bloqueio (Correção de Tipagem Robusta)
            const blockingNotif = unreadList.find(n => {
                return n.requireRead === true || n.requireRead === "true" || n.requireRead === 1;
            });

            if (blockingNotif) {
                showBlockingModal(blockingNotif);
            }
        }

        function updateBadgeUI(hasUnread) {
            // 1. Badge do Header (Sino)
            const headerBadge = document.getElementById('header-badge');
            if (headerBadge) {
                if (hasUnread) {
                    headerBadge.classList.remove('hidden');
                    headerBadge.style.display = 'flex';
                } else {
                    headerBadge.classList.add('hidden');
                    headerBadge.style.display = 'none';
                }
            }

            // 2. Badge da Sidebar (Aba Sistema)
            const sidebarBadge = document.getElementById('sidebar-badge');
            if (sidebarBadge) {
                if (hasUnread) {
                    sidebarBadge.classList.remove('hidden');
                    sidebarBadge.style.display = 'flex'; // Garante alinhamento flex
                } else {
                    sidebarBadge.classList.add('hidden');
                    sidebarBadge.style.display = 'none';
                }
            }
        }

        function renderNotificationList(list) {
            const container = document.getElementById('notification-feed-container');
            if (!container) return;

            if (list.length === 0) {
                container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-8 text-slate-400 opacity-60">
                <i class="fa-regular fa-circle-check text-4xl mb-2"></i>
                <p class="text-sm font-medium">Tudo limpo por aqui!</p>
            </div>
        `;
                return;
            }

            let html = '';
            list.forEach(n => {
                let iconColor = 'text-blue-500';
                let icon = 'info';
                let borderLeft = 'border-l-4 border-l-blue-500';

                if (n.type === 'danger') { iconColor = 'text-red-500'; icon = 'alert-triangle'; borderLeft = 'border-l-4 border-l-red-500'; }
                if (n.type === 'warning') { iconColor = 'text-orange-500'; icon = 'alert-circle'; borderLeft = 'border-l-4 border-l-orange-500'; }

                html += `
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100 ${borderLeft} mb-3 flex gap-4 transition hover:shadow-md">
                <div class="mt-1 ${iconColor}"><i data-lucide="${icon}" class="text-xl"></i></div>
                <div class="flex-1">
                    <h4 class="font-bold text-slate-800 text-sm">${n.title || 'Mensagem do Sistema'}</h4>
                    <p class="text-slate-600 text-xs mt-1 leading-relaxed">${n.message}</p>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="text-[10px] text-slate-400 font-medium">${n.date}</span>
                        <button onclick="markSingleAsRead('${n.id}')" class="text-[10px] uppercase font-bold text-slate-400 hover:text-blue-600 transition">
                            Marcar como lido
                        </button>
                    </div>
                </div>
            </div>
        `;
            });

            container.innerHTML = html;
        }

        function markAllAsRead() {
            if (activeNotifications.length === 0) return;
            const readIds = JSON.parse(localStorage.getItem('plena_read_notifs') || '[]');
            activeNotifications.forEach(n => { if (!readIds.includes(n.id)) readIds.push(n.id); });
            localStorage.setItem('plena_read_notifs', JSON.stringify(readIds));
            initNotificationSystem();
        }

        function markSingleAsRead(id) {
            const readIds = JSON.parse(localStorage.getItem('plena_read_notifs') || '[]');
            if (!readIds.includes(id)) {
                readIds.push(id);
                localStorage.setItem('plena_read_notifs', JSON.stringify(readIds));
            }
            initNotificationSystem();
        }

        function showBlockingModal(notif) {
            const existing = document.getElementById('sys-blocking-backdrop');
            if (existing) return;

            const modalHTML = `
    <div id="sys-blocking-backdrop" class="fixed inset-0 bg-slate-900/95 z-[99999] flex items-center justify-center p-6 backdrop-blur-md animate-fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-100">
            <div class="bg-red-600 p-6 text-white text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-white/10 opacity-20 transform -skew-y-6 scale-150"></div>
                <i data-lucide="hand" text-5xl mb-3 relative z-10 animate-pulse"></i>
                <h3 class="font-bold text-xl uppercase tracking-widest relative z-10">Atenção Necessária</h3>
            </div>
            <div class="p-8 text-center">
                <h4 class="font-bold text-slate-800 text-xl mb-4">${notif.title || 'Aviso Importante'}</h4>
                <div class="bg-red-50 text-slate-700 text-sm leading-relaxed p-4 rounded-xl border border-red-100 text-left">
                    ${notif.message}
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t border-slate-100">
                <button onclick="acknowledgeBlocking('${notif.id}')" 
                    class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition transform hover:scale-[1.01] active:scale-95 flex items-center justify-center gap-2 text-sm uppercase tracking-wide">
                    <i data-lucide="check"></i> Entendi e Li a Mensagem
                </button>
            </div>
        </div>
    </div>
    `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
        }

        function acknowledgeBlocking(id) {
            markSingleAsRead(id);
            const el = document.getElementById('sys-blocking-backdrop');
            if (el) el.remove();
            document.body.style.overflow = '';
        }

        document.addEventListener('DOMContentLoaded', () => { setTimeout(initNotificationSystem, 1000); });
        window.markAllAsRead = markAllAsRead;
        window.markSingleAsRead = markSingleAsRead;
        window.acknowledgeBlocking = acknowledgeBlocking;
        window.clearSystemNotifications = markAllAsRead;



        function renderSystemTab() { setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 10);
            // 1. Initial Render
            renderChangelog();
            updateDiagnostics();
            updateVersionDisplay();
            initNotificationSystem();

            // 2. Check real version from SW (Async)
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    if (event.data.type === 'VERSION') {
                        // Only update if different to avoid flicker
                        if (CURRENT_VERSION !== event.data.version) {
                            CURRENT_VERSION = event.data.version;
                            updateVersionDisplay();
                            renderChangelog(); // Re-render to update badges
                        }
                    }
                };
                navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' }, [messageChannel.port2]);
            }

            // Clear Badges
            document.getElementById('header-badge').classList.add('hidden');
            document.getElementById('sidebar-badge').classList.add('hidden');
        }

        function updateVersionDisplay() {
            // Update big card
            const mainDisplay = document.getElementById('display-installed-version');
            if (mainDisplay) mainDisplay.textContent = CURRENT_VERSION;

            // Update settings small text
            const subDisplay = document.getElementById('app-version-display');
            if (subDisplay) subDisplay.textContent = `${CURRENT_VERSION} (Desktop Pro)`;
        }

        function renderChangelog() {
            const feed = document.getElementById('changelog-feed');
            if (feed) {
                feed.innerHTML = CHANGELOG.map((log, index) => {
                    // It is current if it matches CURRENT_VERSION
                    // OR if it is the first item and we haven't detected SW yet (fallback)
                    const isCurrent = log.version === CURRENT_VERSION;

                    return `
                    <div class="relative pl-6 pb-6 border-l border-slate-200 last:border-0 ${index === CHANGELOG.length - 1 ? '' : 'border-l-2'} border-slate-200">
                        <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full ${isCurrent ? 'bg-plena-blue border-white ring-4 ring-blue-50' : 'bg-slate-200 border-white'} border-2"></div>
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-sm font-bold text-slate-800">${log.version}</span>
                                <span class="text-xs text-slate-400 ml-2">${log.date}</span>
                            </div>
                            ${isCurrent ? '<span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">Instalado</span>' : ''}
                        </div>
                        <ul class="space-y-1">
                            ${log.changes.map(change => `<li class="text-xs text-slate-600 flex items-start gap-2"><span class="text-slate-300">•</span> ${change}</li>`).join('')}
                        </ul>
                    </div>
                `}).join('');
            }
        }


        function updateDiagnostics() {
            // Storage
            if ('storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                    const percent = Math.round((estimate.usage / estimate.quota) * 100);
                    document.getElementById('storage-usage').textContent = `${usedMB} MB usado`;
                    document.getElementById('storage-bar').style.width = `${Math.max(percent, 5)}%`;
                });
            } else {
                document.getElementById('storage-usage').textContent = '—';
            }

            // Backup Status Check
            const lastBackup = localStorage.getItem('plena_last_backup_date');

            // Let's create a dedicated Backup Status element if not exists or override connection for now to save space as requested
            // Better: Add a new row in diagnostics dynamically if missing
            let backupStatusEl = document.getElementById('backup-status-text');
            if (!backupStatusEl) {
                const grid = document.querySelector('#view-system .grid.grid-cols-2.gap-3');
                if (grid) {
                    grid.innerHTML += `
                        <div class="p-3 bg-slate-50 rounded-lg text-center col-span-2">
                            <span class="block text-slate-400 mb-1 text-[10px] uppercase font-bold">Último Backup</span>
                            <span id="backup-status-text" class="font-bold text-slate-700">-</span>
                        </div>
                     `;
                    backupStatusEl = document.getElementById('backup-status-text');
                }
            }

            if (backupStatusEl) {
                if (!lastBackup) {
                    backupStatusEl.textContent = 'Nunca realizado ⚠️';
                    backupStatusEl.className = 'font-bold text-red-500';
                } else {
                    const daysDiff = Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
                    if (daysDiff === 0) {
                        backupStatusEl.textContent = 'Hoje ✅';
                        backupStatusEl.className = 'font-bold text-green-600';
                    } else if (daysDiff > 7) {
                        backupStatusEl.textContent = `${daysDiff} dias atrás ⚠️`;
                        backupStatusEl.className = 'font-bold text-amber-500';
                    } else {
                        backupStatusEl.textContent = `${daysDiff} dias atrás`;
                        backupStatusEl.className = 'font-bold text-slate-600';
                    }
                }
            }

            // Connection
            const cStatus = document.getElementById('conn-status');
            if (cStatus) {
                cStatus.textContent = navigator.onLine ? 'Online' : 'Offline';
                cStatus.className = navigator.onLine ? 'font-bold text-green-600' : 'font-bold text-red-600';
            }

            // SW Status
            const swStatus = document.getElementById('sw-status');
            if (swStatus) {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    swStatus.textContent = 'Ativo';
                    swStatus.className = 'font-bold text-green-600';
                } else {
                    swStatus.textContent = 'Inativo';
                    swStatus.className = 'font-bold text-amber-500';
                }
            }
        }

        async function clearSystemNotifications() {
            // 1. Get current notifications from DOM or State to find the latest ID
            // Since we don't have global state here easily, we fetch 'latest' from the API logic implicit context or just save the current timestamp
            // Better: Save the latest notification ID available in the list.

            // Simpler robust approach: Save 'plena_cleared_timestamp' = Now
            const now = new Date().getTime();
            localStorage.setItem('plena_cleared_timestamp', now);

            // 2. Clear Visuals
            document.getElementById('system-notifications-list').innerHTML = `
                <div class="p-8 text-center text-slate-400">
                    <i data-lucide="bell-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    <p class="text-xs">Nenhuma notificação</p>
                </div>
            `;

            // 3. Clear Badges
            document.getElementById('header-badge').classList.add('hidden');
            document.getElementById('sidebar-badge').classList.add('hidden');

            // 4. Update Read State
            // Also mark the latest visible notification as read just in case
            // (Handled by the timestamp filter now)

            showNotification('Notificações limpas!', 'success');
            lucide.createIcons();
        }

        function checkForUpdates() {
            const btn = document.querySelector('[onclick="checkForUpdates()"]');
            const originalText = btn.innerHTML;

            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Buscando...`;
            lucide.createIcons();

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(reg => {
                    reg.update().then(() => {
                        // Wait a bit to see if a new worker appears
                        setTimeout(() => {
                            if (reg.installing || reg.waiting) {
                                // Found update! Check Backup first logic implicit in showUpdateToast action
                                btn.innerHTML = `<i data-lucide="download" class="w-4 h-4"></i> Atualizar...`;
                                showUpdateToast(reg.installing || reg.waiting);
                            } else {
                                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Sistema Atualizado`;
                                showNotification(`Versão mais recente (${CURRENT_VERSION})`, 'success');
                                document.getElementById('last-update-check').textContent = new Date().toLocaleTimeString();
                                setTimeout(() => btn.innerHTML = originalText, 3000);
                            }
                        }, 1000);
                    });
                }).catch(err => {
                    console.error('Update check failed:', err);
                    btn.innerHTML = originalText;
                    showNotification('Erro ao verificar.', 'error');
                });
            } else {
                showNotification('Modo Dev/Offline: SW não detectado.', 'warning');
                btn.innerHTML = originalText;
            }
        }

        // --- INIT LOGIC ---
        function initSystemVersionCheck() {
            // Simple logic: if SW version != stored version, show badge
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    if (event.data.type === 'VERSION') {
                        const realVersion = event.data.version;
                        const stored = localStorage.getItem('plena_last_viewed_version');

                        if (realVersion !== stored) {
                            document.getElementById('header-badge').classList.remove('hidden');
                            document.getElementById('sidebar-badge').classList.remove('hidden');

                            const list = document.getElementById('system-notifications-list');
                            if (list) {
                                // Add notification if not already there
                                if (!list.innerHTML.includes('Sistema Atualizado')) {
                                    const notifHTML = `
                                        <div class="p-3 bg-green-50 rounded-lg border border-green-100 flex items-start gap-3 animate-pulse">
                                            <i data-lucide="zap" class="w-5 h-5 text-green-600 mt-0.5"></i>
                                            <div>
                                                <p class="text-xs font-bold text-green-800">Nova Versão ${realVersion}</p>
                                                <p class="text-xs text-green-600 mt-1">O sistema foi atualizado em segundo plano.</p>
                                                <p class="text-[10px] text-green-500 mt-1">Agora</p>
                                            </div>
                                        </div>
                                     `;
                                    list.insertAdjacentHTML('afterbegin', notifHTML);
                                    lucide.createIcons();
                                }
                            }
                        }
                        CURRENT_VERSION = realVersion; // Sync global
                        updateVersionDisplay();
                    }
                };
                navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' }, [messageChannel.port2]);
            }
        }

        
    // Extended Router for System Tab
    const _baseRouter = window.router;
    window.router = function(view) {
        if (typeof _baseRouter === 'function') _baseRouter(view);
        if (view === 'system') {
             // Standard view toggle if not handled by base router for 'system'
             document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
             const sysEl = document.getElementById('view-system');
             if(sysEl) sysEl.classList.remove('hide');
             
             // Nav highlight
             document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav', 'bg-white/10'));
             const navSys = document.getElementById('nav-system');
             if(navSys) navSys.classList.add('active-nav', 'bg-white/10');
             
             renderSystemTab();
        }
    };
    // SW REGISTRATION & UPDATE DETECTION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW Registered:', reg.scope);
                        initSystemVersionCheck(); // Check after registration
                        // initNotificationSystem(); // Auto-init is already handled by DOMContentLoaded

                        // If waiting (update downloaded but not active), prompt user
                        if (reg.waiting) {
                            showUpdateToast(reg.waiting);
                            return;
                        }

                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showUpdateToast(newWorker);
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.error('SW Error:', err);
                        const swStatus = document.getElementById('sw-status');
                        if (swStatus) {
                            swStatus.textContent = 'Erro';
                            swStatus.className = 'font-bold text-red-500';
                        }
                    });
            });

            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    window.location.reload();
                    refreshing = true;
                }
            });
        }

        function showUpdateToast(worker) {
            if (document.getElementById('update-toast')) return;

            const toastHTML = `
                <div id="update-toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-4 animate-bounce" style="z-index: 10000; min-width: 300px;">
                    <div class="flex-1">
                        <p class="font-bold text-sm text-white">Nova Versão Disponível! 🚀</p>
                        <p class="text-xs text-slate-300">Toque para atualizar.</p>
                    </div>
                    <button id="btn-update-confirm" class="bg-plena-blue hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors whitespace-nowrap">
                        Atualizar Agora
                    </button>
                    <button onclick="document.getElementById('update-toast').style.display='none'" class="text-slate-500 hover:text-white">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', toastHTML);
            lucide.createIcons();

            // Handle click
            document.getElementById('btn-update-confirm').addEventListener('click', () => {
                const lastBackup = localStorage.getItem('plena_last_backup_date');
                const daysDiff = lastBackup ? Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24)) : 999;

                if (daysDiff > 0) { // If backup wasn't made TODAY
                    const proceed = confirm(
                        !lastBackup
                            ? "⚠️ PERIGO: Você NUNCA fez um backup!\n\nSe prosseguir com a atualização, seus dados estarão seguros, mas recomendamos baixá-los antes por precaução.\n\nDeseja atualizar mesmo sem backup?"
                            : `⚠️ ATENÇÃO: Seu último backup foi há ${daysDiff} dias.\n\nRecomendamos baixar seus dados recentes antes de atualizar.\n\nDeseja atualizar agora?`
                    );

                    if (!proceed) {
                        closeModal('changelog-modal'); // Close any modal if open
                        router('settings'); // Go to settings
                        showNotification('Vá em Segurança de Dados para baixar seu Backup.', 'warning');
                        document.getElementById('update-toast').style.display = 'none';
                        return; // Stop update
                    }
                }

                if (worker) {
                    worker.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        }


    
</script>

<!-- PWA INSTALLATION TOAST (Standardized) -->
    <div id="pwa-install-toast"
        style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: white; color: black; padding: 12px 16px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 9999; align-items: center; gap: 12px; border: 1px solid #e5e7eb; min-width: 300px;">
        <div
            style="background-color: transparent; padding: 0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <img src="./icons/icon-192.png" alt="App Icon"
                style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">
        </div>
        <div style="flex: 1;">
            <p style="font-size: 14px; font-weight: bold; margin: 0; color: #1f2937;">Instalar Aplicativo</p>
            <p style="font-size: 12px; color: #6b7280; margin: 0;">Acesso rápido 100% offline</p>
        </div>
        <button onclick="installPWA()"
            style="background-color: #000; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap;">
            Instalar
        </button>
        <button onclick="dismissInstall()"
            style="background-color: transparent; border: none; color: #9ca3af; cursor: pointer; padding: 4px; display: flex; align-items: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-x">
                <path d="M18 6 6 18" />
                <path d="m6 6 12 12" />
            </svg>
        </button>
    </div>

    <script>
        let deferredPrompt;

        // Check if installed (Robust Check)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches
            || window.navigator.standalone
            || document.referrer.includes('android-app://');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            deferredPrompt = e;
            console.log("PWA Install Prompt Captured");

            // Show the toast if not in standalone mode
            if (!isStandalone) {
                const toast = document.getElementById('pwa-install-toast');
                if (toast) toast.style.display = 'flex';
            }
        });

        // Fallback: If techincally not triggering (e.g. dev mode), we can't force it, 
        // but we can ensure the UI is ready if it DOES trigger.

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            } else {
                alert("O navegador não permitiu a instalação automática. Tente pelo menu do navegador > Instalar app.");
            }
        }

        function dismissInstall() {
            const toast = document.getElementById('pwa-install-toast');
            if (toast) toast.style.display = 'none';
            // localStorage.setItem('pwa_dismissed', 'true'); // Temporarily disabled persistence
        }
    </script>
</body>

</html>