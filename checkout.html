<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra | Plena Aplicativos</title>

    <!-- FAVICON -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- MERCADO PAGO SDK -->
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <!-- GOOGLE FONTS -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        [v-cloak] {
            display: none;
        }

        /* Tech Grid Background (Subtle) */
        .tech-bg {
            background-color: #0f172a;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col">

    <div id="app" v-cloak class="flex-1 flex flex-col">

        <!-- HEADER -->
        <header class="bg-white border-b border-slate-200 py-4 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
                <a href="index.html" class="flex items-center gap-2 group">
                    <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">P
                    </div>
                    <span class="font-bold text-slate-800 group-hover:text-blue-600 transition">PLENA</span>
                </a>
                <div class="text-xs font-medium text-slate-500 flex items-center gap-2">
                    <i class="fa-solid fa-lock text-green-500"></i> Ambiente Seguro
                </div>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">

            <!-- LEFT COLUMN: PRODUCT SUMMARY -->
            <aside class="md:w-5/12 tech-bg text-white p-6 md:p-12 overflow-y-auto relative">
                <div class="relative z-10 max-w-md mx-auto md:mx-0 md:ml-auto">

                    <div class="mb-8">
                        <button onclick="history.back()"
                            class="text-slate-400 hover:text-white text-sm flex items-center gap-2 mb-6 transition">
                            <i class="fa-solid fa-arrow-left"></i> Voltar
                        </button>
                        <h2 class="text-slate-400 uppercase tracking-widest text-xs font-bold mb-2">Resumo do Pedido
                        </h2>
                        <h1 class="text-3xl font-bold mb-4">{{ product.name || 'Carregando...' }}</h1>
                        <div class="text-3xl font-bold text-green-400">
                            R$ {{ product.price || '0,00' }}
                            <span class="text-sm text-slate-400 font-normal">/ Pagamento √önico</span>
                        </div>
                    </div>

                    <!-- Product Card -->
                    <div
                        class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 mb-8 backdrop-blur-sm flex gap-4 items-start">
                        <img :src="product.img || 'https://placehold.co/100'"
                            class="w-20 h-20 object-cover rounded-lg bg-slate-900">
                        <div>
                            <h3 class="font-bold text-white text-sm mb-1">{{ product.name }}</h3>
                            <p class="text-xs text-slate-400 leading-relaxed mb-2">{{ product.desc }}</p>
                            <span
                                class="inline-block bg-blue-600/20 text-blue-400 text-[10px] px-2 py-1 rounded font-bold uppercase">Licen√ßa
                                Vital√≠cia</span>
                        </div>
                    </div>

                    <!-- Benefits -->
                    <div class="space-y-3 text-sm text-slate-300">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-check-circle text-blue-500"></i>
                            <span>Acesso Imediato ao Software</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-check-circle text-blue-500"></i>
                            <span>Sem mensalidades (Vital√≠cio)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-check-circle text-blue-500"></i>
                            <span>Suporte T√©cnico via WhatsApp</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-shield-halved text-blue-500"></i>
                            <span>Garantia de 7 dias</span>
                        </div>
                    </div>

                    <!-- Customization Upsell -->
                    <div
                        class="mt-8 bg-gradient-to-br from-indigo-900/50 to-blue-900/50 border border-indigo-500/30 p-4 rounded-xl relative overflow-hidden group hover:border-indigo-500/50 transition duration-300">
                        <div
                            class="absolute -right-4 -top-4 w-16 h-16 bg-indigo-500/20 rounded-full blur-xl group-hover:bg-indigo-500/30 transition">
                        </div>

                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class="bg-indigo-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider">Opcional</span>
                                <h4 class="font-bold text-white text-sm">Personaliza√ß√£o Premium</h4>
                            </div>
                            <p class="text-xs text-indigo-200 mb-3 leading-relaxed">
                                Quer este app com a <strong>Sua Marca e Cores</strong>? Entregamos pronto para uso em
                                seu dom√≠nio.
                            </p>
                            <div class="flex items-center justify-between">
                                <span class="font-bold text-white text-lg">+ R$ 39,90</span>
                                <a href="https://wa.me/5512992191018?text=Ol%C3%A1%2C%20estou%20no%20checkout%20e%20gostaria%20de%20comprar%20o%20app%20personalizado%20com%20minha%20marca%20por%20mais%20R%2439%2C90."
                                    target="_blank"
                                    class="bg-white text-indigo-900 hover:bg-indigo-50 text-xs font-bold px-3 py-2 rounded-lg transition flex items-center gap-2 shadow-lg">
                                    <i class="fa-brands fa-whatsapp"></i> Solicitar
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Security Badge -->
                    <div class="mt-12 pt-8 border-t border-slate-700/50 flex items-center gap-4 opacity-50">
                        <i class="fa-brands fa-cc-mastercard text-2xl"></i>
                        <i class="fa-brands fa-cc-visa text-2xl"></i>
                        <i class="fa-brands fa-pix text-2xl"></i>
                        <div class="h-4 w-px bg-slate-600"></div>
                        <span class="text-xs">Pagamento processado por <strong>Mercado Pago</strong></span>
                    </div>
                </div>

                <!-- Abstract Decor -->
                <div class="absolute top-0 right-0 w-full h-full opacity-30 pointer-events-none"
                    style="background: radial-gradient(circle at 100% 0%, #1d4ed8 0%, transparent 50%);"></div>
            </aside>

            <!-- RIGHT COLUMN: CHECKOUT FORM -->
            <section class="md:w-7/12 bg-slate-50 p-6 md:p-12 overflow-y-auto">
                <div class="max-w-md mx-auto md:mr-auto">

                    <!-- SUCCESS STATE -->
                    <div v-if="purchaseSuccess" class="text-center py-10 animate-fade-in">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa-solid fa-check text-4xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Pagamento Confirmado!</h2>
                        <p class="text-slate-500 mb-8">Sua licen√ßa foi gerada com sucesso. Acesse abaixo.</p>

                        <div class="bg-white p-6 rounded-xl shadow border border-slate-200 mb-8 text-left">
                            <p class="text-xs text-slate-400 uppercase font-bold mb-1">Seu Link de Acesso:</p>
                            <div class="flex items-center gap-2 bg-slate-50 p-3 rounded border border-slate-200">
                                <code
                                    class="text-blue-600 font-mono text-sm break-all flex-1">{{ generatedLink }}</code>
                                <button @click="copyLink" class="text-slate-400 hover:text-blue-600 p-2"><i
                                        class="fa-solid fa-copy"></i></button>
                            </div>
                            <p class="text-xs text-amber-600 mt-2"><i class="fa-solid fa-triangle-exclamation"></i>
                                Salve este link! Enviamos tamb√©m por email.</p>
                        </div>

                        <a :href="generatedLink"
                            class="bg-green-600 hover:bg-green-700 text-white px-8 py-4 rounded-xl font-bold block w-full transition shadow-lg shadow-green-600/20">
                            Acessar Sistema Agora <i class="fa-solid fa-arrow-right ml-2"></i>
                        </a>
                    </div>

                    <!-- CHECKOUT FORM -->
                    <div v-else>
                        <!-- Steps -->
                        <div class="flex items-center gap-4 mb-8">
                            <div class="flex items-center gap-2">
                                <span
                                    class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                                <span class="text-sm font-bold text-slate-800">Dados</span>
                            </div>
                            <div class="h-px w-8 bg-slate-300"></div>
                            <div class="flex items-center gap-2 opacity-50">
                                <span
                                    class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-xs flex items-center justify-center font-bold">2</span>
                                <span class="text-sm font-bold text-slate-800">Pagamento</span>
                            </div>
                        </div>

                        <form @submit.prevent="processPayment" class="space-y-6">

                            <!-- Personal Info -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-user text-blue-500"></i> Informa√ß√µes Pessoais
                                </h3>
                                <div class="grid gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome
                                            Completo</label>
                                        <input v-model="form.name" type="text" required
                                            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                            placeholder="Ex: Jo√£o da Silva">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email (Onde
                                            receber√° o acesso)</label>
                                        <input v-model="form.email" type="email" required
                                            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                            placeholder="seu@email.com">
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-slate-500 uppercase mb-1">CPF/CNPJ</label>
                                            <input v-model="form.doc" type="text" required
                                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                                placeholder="000.000.000-00">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Celular
                                                (WhatsApp)</label>
                                            <input v-model="form.phone" type="tel" required
                                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition"
                                                placeholder="(00) 00000-0000">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Container (Mercado Pago Brick) -->
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-credit-card text-blue-500"></i> Pagamento Seguro
                                </h3>

                                <!-- Container where MP Brick loads -->
                                <div id="cardPaymentBrick_container"></div>

                                <!-- Simulating Brick for now since we don't have visual in backend -->
                                <div v-if="!mpLoaded" class="animate-pulse space-y-3">
                                    <div class="h-10 bg-slate-100 rounded"></div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="h-10 bg-slate-100 rounded"></div>
                                        <div class="h-10 bg-slate-100 rounded"></div>
                                    </div>
                                    <div class="h-12 bg-slate-200 rounded mt-4"></div>
                                    <p class="text-xs text-center text-slate-400 mt-2">Carregando m√≥dulo seguro do
                                        Mercado Pago...</p>
                                </div>
                            </div>

                            <!-- Manual Submit (Hidden if Brick works) -->
                            <button v-if="!mpLoaded" type="submit" :disabled="processing"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-600/20 transition flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <div v-if="processing" class="loader"></div>
                                <span v-else>Pagar Agora R$ {{ product.price }}</span>
                            </button>

                            <p class="text-center text-xs text-slate-400">
                                <i class="fa-solid fa-lock"></i> Seus dados est√£o criptografados e seguros.
                            </p>

                        </form>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // FIREBASE CONFIG (SAME AS ADMIN)
        const firebaseConfig = {
            apiKey: "AIzaSyDuYEnG0xwn9_m3I6YKQdz89NJTJpnSPHY",
            authDomain: "plena-system.firebaseapp.com",
            projectId: "plena-system",
            storageBucket: "plena-system.firebasestorage.app",
            messagingSenderId: "580090911924",
            appId: "1:580090911924:web:2942afdf2e49b0c1580be1",
            measurementId: "G-H208D85X75"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const { createApp, ref, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const product = ref({});
                const processing = ref(false);
                const purchaseSuccess = ref(false);
                const generatedLink = ref('');
                const mpLoaded = ref(false);

                const form = reactive({
                    name: '',
                    email: '',
                    doc: '',
                    phone: ''
                });

                // INIT MERCADO PAGO
                // Replace with your PUBLIC KEY
                const mp = new MercadoPago('TEST-cb348507-8898-472d-8686-25f095908b6e', {
                    locale: 'pt-BR'
                });

                onMounted(() => {
                    // 1. Get Product from URL Params
                    const params = new URLSearchParams(window.location.search);
                    if (params.has('name')) {
                        product.value = {
                            name: params.get('name'),
                            price: params.get('price'),
                            img: params.get('img'),
                            desc: params.get('desc'),
                            link: params.get('link') // The access URL
                        };
                    } else {
                        // Fallback/Demo Data
                        product.value = {
                            name: "Plena System (Demo)",
                            price: "97,00",
                            desc: "Erro: Produto n√£o selecionado.",
                            img: "https://placehold.co/100"
                        };
                        alert("Produto n√£o especificado. Retornando ao cat√°logo...");
                        window.location.href = 'index.html';
                    }

                    // 2. Load MP Bricks
                    loadPaymentBrick();
                });

                const loadPaymentBrick = async () => {
                    const bricksBuilder = mp.bricks();
                    const renderComponent = async (bricksBuilder) => {
                        const settings = {
                            initialization: {
                                amount: parseFloat(product.value.price.replace(',', '.').replace(/[^\d.]/g, '')), // Format price to float
                                preferenceId: '<PREFERENCE_ID>', // IN REAL PROD, YOU NEED BACKEND TO GENERATE PREFERENCE
                            },
                            customization: {
                                paymentMethods: {
                                    ticket: "all",
                                    creditCard: "all",
                                    debitCard: "all",
                                    mercadoPago: "all",
                                },
                            },
                            callbacks: {
                                onReady: () => {
                                    mpLoaded.value = true;
                                },
                                onSubmit: ({ selectedPaymentMethod, formData }) => {
                                    // Callback called when user clicks 'Pay'
                                    return new Promise((resolve, reject) => {
                                        processPayment(formData); // Using our logic to simulate backend
                                        resolve();
                                    });
                                },
                                onError: (error) => {
                                    console.error(error);
                                },
                            },
                        };

                        // NOTE: Payment Brick usually requires a Preference ID from Backend.
                        // For this Front-Only Architecture, we utilize CardForm or simple integration.
                        // Since we don't have a backend to create preference, we will simulate the UI 
                        // and use manual processing function.

                        // If this fails due to missing Preference, we fall back to manual form submit
                        // which is rendered via Vue.
                        try {
                            // window.cardPaymentBrickController = await bricksBuilder.create("payment", "cardPaymentBrick_container", settings);
                        } catch (e) {
                            console.log("Backend needed for Bricks. Using Standard Form.");
                            mpLoaded.value = false;
                        }
                    };
                    renderComponent(bricksBuilder);
                };

                const processPayment = async (mpData = null) => {
                    processing.value = true;

                    // SIMULA√á√ÉO DE PAGAMENTO (COMO N√ÉO TEMOS BACKEND PARA PROCESSAR O CART√ÉO REALMENTE)
                    // Num cen√°rio real, voc√™ enviaria 'mpData' (token do cart√£o) para uma Cloud Function.
                    // Aqui, vamos direto registrar a venda como "Aprovada" para demonstrar o fluxo.

                    try {
                        // 1. Save Sale to Firestore (Admin Control)
                        const amountFloat = parseFloat(product.value.price.replace('.', '').replace(',', '.'));

                        await addDoc(collection(db, "sales"), {
                            product_name: product.value.name,
                            product_link: product.value.link,
                            amount: amountFloat,
                            customer_name: form.name,
                            customer_email: form.email,
                            customer_doc: form.doc,
                            customer_phone: form.phone,
                            status: 'paid', // Assuming success for demo
                            payment_method: 'credit_card',
                            created_at: serverTimestamp()
                        });

                        // 2. Generate Access Link (Or just use product link)
                        // In a real scenario, you might append a token: ?token=xyz
                        generatedLink.value = "https://plena-aplicativos.web.app/" + product.value.link;

                        // 3. Show Success
                        setTimeout(() => {
                            purchaseSuccess.value = true;
                            processing.value = false;
                        }, 2000); // Fake Delay

                    } catch (e) {
                        console.error("Erro ao processar venda: ", e);
                        alert("Erro ao processar venda. Tente novamente.");
                        processing.value = false;
                    }
                };

                const copyLink = () => {
                    navigator.clipboard.writeText(generatedLink.value);
                    alert("Link copiado!");
                };

                return {
                    product, form, processing, purchaseSuccess, generatedLink, mpLoaded,
                    processPayment, copyLink
                };
            }
        }).mount('#app');
    </script>
</body>

</html>