<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra | Plena Aplicativos</title>

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        [v-cloak] {
            display: none;
        }

        .tech-bg {
            background-color: #0f172a;
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col">

    <div id="app" v-cloak class="flex-1 flex flex-col">
        <header class="bg-white border-b border-slate-200 py-4 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
                <a href="index.html" class="flex items-center gap-2 group">
                    <div class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center font-bold">P
                    </div>
                    <span class="font-bold text-slate-800 group-hover:text-blue-600 transition">PLENA</span>
                </a>
                <div class="text-xs font-medium text-slate-500 flex items-center gap-2">
                    <i class="fa-solid fa-lock text-green-500"></i> Ambiente Seguro
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <aside class="md:w-5/12 tech-bg text-white p-6 md:p-12 overflow-y-auto relative">
                <div class="relative z-10 max-w-md mx-auto md:mx-0 md:ml-auto">
                    <div class="mb-8">
                        <button onclick="history.back()"
                            class="text-slate-400 hover:text-white text-sm flex items-center gap-2 mb-6 transition">
                            <i class="fa-solid fa-arrow-left"></i> Voltar
                        </button>
                        <h2 class="text-slate-400 uppercase tracking-widest text-xs font-bold mb-2">Resumo do Pedido
                        </h2>
                        <h1 class="text-3xl font-bold mb-4">{{ product.name || 'Carregando...' }}</h1>
                        <div class="text-3xl font-bold text-green-400">
                            R$ {{ product.price || '0,00' }}
                            <span class="text-sm text-slate-400 font-normal">/ Pagamento √önico</span>
                        </div>
                    </div>
                    <div
                        class="bg-slate-800/50 border border-slate-700 rounded-2xl p-4 mb-8 backdrop-blur-sm flex gap-4 items-start">
                        <img :src="product.img || 'https://placehold.co/100'"
                            class="w-20 h-20 object-cover rounded-lg bg-slate-900">
                        <div>
                            <h3 class="font-bold text-white text-sm mb-1">{{ product.name }}</h3>
                            <p class="text-xs text-slate-400 leading-relaxed mb-2">{{ product.desc }}</p>
                            <span
                                class="inline-block bg-blue-600/20 text-blue-400 text-[10px] px-2 py-1 rounded font-bold uppercase">Licen√ßa
                                Vital√≠cia</span>
                        </div>
                    </div>
                    <div class="mt-12 pt-8 border-t border-slate-700/50 flex items-center gap-4 opacity-50">
                        <i class="fa-brands fa-cc-mastercard text-2xl"></i>
                        <i class="fa-brands fa-cc-visa text-2xl"></i>
                        <i class="fa-brands fa-pix text-2xl"></i>
                        <div class="h-4 w-px bg-slate-600"></div>
                        <span class="text-xs">Pagamento processado por <strong>Mercado Pago</strong></span>
                    </div>
                </div>
            </aside>

            <section class="md:w-7/12 bg-slate-50 p-6 md:p-12 overflow-y-auto">
                <div class="max-w-md mx-auto md:mr-auto">

                    <div v-if="purchaseSuccess" class="text-center py-10 animate-fade-in">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                            <i class="fa-solid fa-check text-4xl text-green-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Pagamento Aprovado!</h2>
                        <p class="text-slate-500 mb-8">Sua compra foi confirmada com seguran√ßa.</p>
                        <div class="bg-white p-6 rounded-xl shadow border border-slate-200 mb-8 text-left">
                            <p class="text-xs text-slate-400 uppercase font-bold mb-1">Acesso ao Sistema:</p>
                            <div class="flex items-center gap-2 bg-slate-50 p-3 rounded border border-slate-200">
                                <code
                                    class="text-blue-600 font-mono text-sm break-all flex-1">{{ product.link ? 'https://plena-aplicativos.web.app/' + product.link : 'Link enviado por email' }}</code>
                            </div>
                            <p class="text-xs text-amber-600 mt-2"><i class="fa-solid fa-triangle-exclamation"></i>
                                Verifique tamb√©m seu email.</p>
                        </div>
                    </div>

                    <div v-else>
                        <div class="flex items-center gap-4 mb-8">
                            <div class="flex items-center gap-2">
                                <span
                                    class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                                <span class="text-sm font-bold text-slate-800">Dados</span>
                            </div>
                            <div class="h-px w-8 bg-slate-300"></div>
                            <div class="flex items-center gap-2" :class="mpLoaded ? 'opacity-100' : 'opacity-50'">
                                <span
                                    class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-xs flex items-center justify-center font-bold">2</span>
                                <span class="text-sm font-bold text-slate-800">Pagamento</span>
                            </div>
                        </div>

                        <form @submit.prevent class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-user text-blue-500"></i> Informa√ß√µes Pessoais
                                </h3>
                                <div class="grid gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome
                                            Completo</label>
                                        <input v-model="form.name" type="text" required
                                            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 outline-none"
                                            placeholder="Ex: Jo√£o da Silva">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email (Onde
                                            receber√° o acesso)</label>
                                        <input v-model="form.email" type="email" required @blur="initPaymentBrick"
                                            class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 outline-none"
                                            placeholder="seu@email.com">
                                        <p class="text-[10px] text-blue-600 mt-1" v-if="form.email && !mpLoaded">*
                                            Preencha para liberar o pagamento</p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-slate-500 uppercase mb-1">CPF/CNPJ</label>
                                            <input v-model="form.doc" type="text"
                                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 outline-none"
                                                placeholder="000.000.000-00">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-bold text-slate-500 uppercase mb-1">Celular</label>
                                            <input v-model="form.phone" type="tel"
                                                class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:border-blue-500 outline-none"
                                                placeholder="(00) 00000-0000">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div v-show="form.email && form.name"
                                class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-fade-in">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="fa-regular fa-credit-card text-blue-500"></i> Pagamento Seguro
                                </h3>

                                <div v-if="loadingBrick" class="text-center py-8">
                                    <div class="loader mx-auto mb-2"></div>
                                    <p class="text-xs text-slate-400">Conectando ao Mercado Pago...</p>
                                </div>

                                <div id="cardPaymentBrick_container"></div>
                            </div>

                            <button v-if="form.email && form.name && !mpLoaded && !loadingBrick"
                                @click="initPaymentBrick"
                                class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">
                                Carregar Op√ß√µes de Pagamento
                            </button>

                            <p class="text-center text-xs text-slate-400">
                                <i class="fa-solid fa-lock"></i> Seus dados est√£o criptografados e seguros.
                            </p>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="assets/js/config.js"></script>
    <script type="module">
        const { createApp, ref, onMounted, reactive } = Vue;

        createApp({
            setup() {
                const product = ref({});
                const purchaseSuccess = ref(false);
                const mpLoaded = ref(false);
                const loadingBrick = ref(false);

                const form = reactive({ name: '', email: '', doc: '', phone: '' });

                // INICIALIZA O SDK (Chave P√∫blica carregada de assets/js/config.js)
                const mp = new MercadoPago(CONFIG.MP_PUBLIC_KEY, { locale: 'pt-BR' });

                onMounted(() => {
                    // 1. Carrega dados da URL
                    const params = new URLSearchParams(window.location.search);

                    // Verifica se voltou do pagamento com sucesso
                    if (params.get('status') === 'approved' || params.get('collection_status') === 'approved') {
                        purchaseSuccess.value = true;
                    }

                    if (params.has('name')) {
                        product.value = {
                            name: params.get('name'),
                            price: params.get('price'),
                            img: params.get('img'),
                            desc: params.get('desc'),
                            link: params.get('link')
                        };
                    } else {
                        // Demo Fallback
                        product.value = { name: "Plena System", price: "97,00", desc: "Software de Gest√£o" };
                    }
                });

                // FUN√á√ÉO PRINCIPAL: CHAMA O PHP PARA CRIAR O PAGAMENTO
                const initPaymentBrick = async () => {
                    if (!form.email || !form.name || mpLoaded.value || loadingBrick.value) return;

                    loadingBrick.value = true;
                    console.log("Iniciando conex√£o com Backend PHP...");

                    try {
                        // 1. Chama seu arquivo PHP na HostGator
                        // IMPORTANTE: Se estiver testando localmente, use a URL completa do seu site (https://seu-site.com/api_pagamento.php)
                        const response = await fetch('api_pagamento.php?action=create_preference', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product: {
                                    name: product.value.name,
                                    price: parseFloat(product.value.price.replace(',', '.').replace('R$', '').trim()),
                                    desc: product.value.desc
                                },
                                payer: {
                                    name: form.name,
                                    email: form.email,
                                    doc: form.doc
                                }
                            })
                        });

                        if (!response.ok) throw new Error('Falha na comunica√ß√£o com api_pagamento.php (Status ' + response.status + ')');

                        const data = await response.json();

                        if (data.error) {
                            console.error("Erro do Backend:", data);
                            alert("Erro ao criar pagamento: " + JSON.stringify(data));
                            loadingBrick.value = false;
                            return;
                        }

                        const preferenceId = data.id;
                        console.log("Preference ID recebido:", preferenceId);

                        // 2. Renderiza o Brick com o ID real
                        const bricksBuilder = mp.bricks();

                        document.getElementById('cardPaymentBrick_container').innerHTML = ''; // Limpa anterior

                        await bricksBuilder.create("payment", "cardPaymentBrick_container", {
                            initialization: {
                                amount: parseFloat(product.value.price.replace(',', '.').replace('R$', '').trim()),
                                preferenceId: preferenceId,
                            },
                            customization: {
                                paymentMethods: {
                                    ticket: "all",
                                    creditCard: "all",
                                    pix: "all"
                                },
                            },
                            callbacks: {
                                onReady: () => {
                                    mpLoaded.value = true;
                                    loadingBrick.value = false;
                                },
                                onSubmit: ({ selectedPaymentMethod, formData }) => {
                                    return new Promise((resolve, reject) => {
                                        // O Brick processa sozinho no backend do MP
                                        console.log("Processando pagamento via Brick...");
                                        resolve();
                                    });
                                },
                                onError: (error) => {
                                    console.error("Erro no Brick:", error);
                                    alert("Erro no componente de pagamento (Brick): " + JSON.stringify(error));
                                    loadingBrick.value = false;
                                },
                            },
                        });

                    } catch (e) {
                        console.error("Erro fatal:", e);
                        alert("Erro ao carregar o pagamento: " + e.message);
                        loadingBrick.value = false;
                    }
                };

                return { product, form, purchaseSuccess, mpLoaded, loadingBrick, initPaymentBrick };
            }
        }).mount('#app');
    </script>
</body>

</html>