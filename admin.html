<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plena Nexus CRM | Admin 2.0</title>

    <!-- TAILWIND & FONTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- VUE 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-deep: #0f172a;
            --sidebar-bg: #1e293b;
            --primary: #3b82f6;
            --accent: #8b5cf6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow: hidden;
        }

        /* Glass / Neumorphism bits */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }

        .glass-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Transitions */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.2s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        [v-cloak] {
            display: none;
        }

        /* Matrix Font for Logs */
        .font-mono-code {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>

<body class="h-screen w-screen text-sm">

    <div id="app" v-cloak class="flex h-full w-full">

        <!-- LOGIM SCREEN -->
        <div v-if="!auth.isLoggedIn"
            class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-sm border-t-4 border-blue-600 shadow-2xl">
                <div class="text-center mb-8">
                    <div
                        class="w-16 h-16 bg-blue-600/20 rounded-xl mx-auto flex items-center justify-center mb-4 border border-blue-500/30">
                        <i class="fa-solid fa-bolt text-2xl text-blue-500"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Plena Nexus</h1>
                    <p class="text-slate-400 text-xs">Gestão Comercial & CRM 2.0</p>
                </div>
                <form @submit.prevent="login" class="space-y-4">
                    <input v-model="loginPass" type="password" placeholder="Access Key" autofocus
                        class="w-full glass-input rounded-lg h-12 px-4">
                    <button :disabled="loading"
                        class="w-full h-12 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg transition shadow-lg shadow-blue-600/20">
                        <span v-if="loading"><i class="fa-solid fa-spinner fa-spin mr-2"></i></span>
                        <span v-else>Entrar</span>
                    </button>
                    <p v-if="auth.error" class="text-red-400 text-center text-xs mt-2">{{ auth.error }}</p>
                </form>
            </div>
        </div>

        <!-- MAIN LAYOUT -->
        <template v-else>
            <!-- SIDEBAR -->
            <aside
                class="w-64 bg-[#0b1121] border-r border-slate-800 flex flex-col shrink-0 transition-all duration-300"
                :class="{'w-20': !sidebarOpen}">
                <!-- Brand -->
                <div class="h-16 flex items-center justify-center border-b border-slate-800/50">
                    <i class="fa-solid fa-infinity text-2xl text-blue-500"></i>
                    <span v-if="sidebarOpen" class="ml-3 font-bold text-lg tracking-tight">Nexus <span
                            class="text-blue-500">CRM</span></span>
                </div>

                <!-- Nav -->
                <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                    <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id"
                        class="w-full flex items-center gap-4 px-3 py-3 rounded-xl transition-all duration-200 group relative"
                        :class="currentTab === tab.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'text-slate-400 hover:bg-slate-800 hover:text-white'">
                        <i :class="[tab.icon, 'text-lg w-6 text-center']"></i>
                        <span v-if="sidebarOpen" class="font-medium whitespace-nowrap">{{ tab.label }}</span>
                        <!-- Tooltip if closed -->
                        <div v-if="!sidebarOpen"
                            class="absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 pointer-events-none whitespace-nowrap z-50">
                            {{ tab.label }}
                        </div>
                    </button>
                </nav>

                <!-- Footer -->
                <div class="p-4 border-t border-slate-800/50 flex flex-col gap-2">
                    <button @click="sidebarOpen = !sidebarOpen"
                        class="w-full py-2 rounded-lg hover:bg-slate-800 text-slate-500 transition">
                        <i class="fa-solid" :class="sidebarOpen ? 'fa-angle-left' : 'fa-angle-right'"></i>
                    </button>
                    <button @click="logout"
                        class="w-full py-2 rounded-lg hover:bg-red-500/10 text-red-400 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-power-off"></i> <span v-if="sidebarOpen">Sair</span>
                    </button>
                </div>
            </aside>

            <!-- CONTENT -->
            <main class="flex-1 flex flex-col bg-[#020617] relative min-w-0">
                <!-- Header -->
                <header
                    class="h-16 border-b border-slate-800/50 flex justify-between items-center px-6 bg-slate-900/50 backdrop-blur-md sticky top-0 z-30">
                    <div>
                        <h2 class="text-lg font-bold text-white">{{ currentTabLabel }}</h2>
                    </div>
                    <div class="flex items-center gap-4">
                        <button @click="showEmailModal=true"
                            class="hidden md:flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-lg text-xs text-slate-300 transition">
                            <i class="fa-solid fa-vial"></i> Testar Email
                        </button>
                        <button @click="refreshData"
                            class="w-8 h-8 rounded-full bg-slate-800 hover:text-blue-400 flex items-center justify-center transition"
                            :class="{'animate-spin text-blue-500': loadingData}">
                            <i class="fa-solid fa-sync"></i>
                        </button>
                    </div>
                </header>

                <!-- View Container -->
                <div class="flex-1 overflow-auto p-6 scroll-smooth">

                    <!-- DASHBOARD VIEW -->
                    <div v-if="currentTab === 'dashboard'" class="space-y-6 animate-enter">
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div
                                class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-blue-500/30 transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-400"><i
                                            class="fa-solid fa-sack-dollar"></i></div>
                                    <span
                                        class="text-[10px] font-bold bg-emerald-500/10 text-emerald-400 px-2 py-0.5 rounded-full">+12%</span>
                                </div>
                                <div class="text-2xl font-bold text-white">R$ {{ stats.total_revenue.toFixed(2) }}</div>
                                <div class="text-slate-500 text-xs mt-1">Faturamento Total</div>
                            </div>

                            <div
                                class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-blue-500/30 transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400"><i
                                            class="fa-solid fa-users"></i></div>
                                    <span
                                        class="text-[10px] font-bold bg-blue-500/10 text-blue-400 px-2 py-0.5 rounded-full">Ativos</span>
                                </div>
                                <div class="text-2xl font-bold text-white">{{ stats.total_clients }}</div>
                                <div class="text-slate-500 text-xs mt-1">Clientes Únicos</div>
                            </div>

                            <div
                                class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-blue-500/30 transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400"><i
                                            class="fa-solid fa-magnet"></i></div>
                                    <span
                                        class="text-[10px] font-bold bg-purple-500/10 text-purple-400 px-2 py-0.5 rounded-full">CRM</span>
                                </div>
                                <div class="text-2xl font-bold text-white">{{ leads.length }}</div>
                                <div class="text-slate-500 text-xs mt-1">Leads (Abandono)</div>
                            </div>

                            <div
                                class="glass-panel p-5 rounded-2xl relative overflow-hidden group hover:border-blue-500/30 transition">
                                <div class="flex justify-between items-start mb-2">
                                    <div class="p-2 bg-amber-500/10 rounded-lg text-amber-400"><i
                                            class="fa-solid fa-percent"></i></div>
                                </div>
                                <div class="text-2xl font-bold text-white">{{ conversionRate }}%</div>
                                <div class="text-slate-500 text-xs mt-1">Taxa de Conversão</div>
                            </div>
                        </div>

                        <!-- Chart Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 glass-panel p-6 rounded-2xl">
                                <h3 class="font-bold text-white mb-4">Evolução de Vendas (30d)</h3>
                                <div class="h-64 relative w-full">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl">
                                <h3 class="font-bold text-white mb-4">Top Produtos</h3>
                                <div class="space-y-4">
                                    <div v-for="(qty, name, i) in stats.top_products" :key="name"
                                        class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span class="text-xs font-mono text-slate-500">{{ i+1 }}</span>
                                            <span class="text-sm text-slate-300 truncate w-32" :title="name">{{ name
                                                }}</span>
                                        </div>
                                        <div class="h-1.5 w-16 bg-slate-800 rounded-full overflow-hidden">
                                            <div class="h-full bg-blue-500" :style="'width:' + (qty/10)*100 + '%'">
                                            </div>
                                        </div>
                                        <span class="text-xs font-bold">{{ qty }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CRM / LEADS VIEW -->
                    <div v-if="currentTab === 'crm'" class="animate-enter h-full flex flex-col">
                        <div class="mb-6 flex justify-between items-end">
                            <div>
                                <h1 class="text-2xl font-bold text-white">Recuperação de Vendas</h1>
                                <p class="text-slate-400 text-xs mt-1">Gerencie carrinhos abandonados e leads pendentes.
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <div class="glass-input flex items-center px-3 py-2 rounded-lg">
                                    <i class="fa-solid fa-search text-slate-500 mr-2"></i>
                                    <input v-model="leadSearch" type="text" placeholder="Buscar lead..."
                                        class="bg-transparent outline-none text-xs w-48 text-white">
                                </div>
                            </div>
                        </div>

                        <div
                            class="glass-panel rounded-2xl overflow-hidden flex-1 border border-slate-800 flex flex-col">
                            <div class="overflow-auto custom-scrollbar flex-1">
                                <table class="w-full text-left border-collapse">
                                    <thead
                                        class="bg-slate-900/50 text-xs uppercase text-slate-500 font-semibold sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="px-6 py-4">Data</th>
                                            <th class="px-6 py-4">Lead / Email</th>
                                            <th class="px-6 py-4">Interesse</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4 text-right">Ação</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800/50 text-sm md:text-xs lg:text-sm">
                                        <tr v-for="lead in filteredLeads" :key="lead.email"
                                            class="hover:bg-white/5 transition group">
                                            <td class="px-6 py-4 text-slate-400 whitespace-nowrap">
                                                {{ formatDate(lead.date) }}<br>
                                                <span class="text-[10px] opacity-60">{{ timeAgo(lead.date) }}</span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="font-bold text-white">{{ lead.name || 'Visitante' }}</div>
                                                <div class="text-slate-500 text-xs">{{ lead.email }}</div>
                                                <div v-if="lead.phone" class="text-slate-500 text-xs"><i
                                                        class="fa-brands fa-whatsapp flex-inline mr-1"></i>{{ lead.phone
                                                    }}</div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span
                                                    class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-300 text-xs">{{
                                                    lead.product }}</span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <span v-if="isConverted(lead.email)"
                                                    class="text-emerald-400 font-bold flex items-center gap-1"><i
                                                        class="fa-solid fa-check-circle"></i> Recuperado</span>
                                                <span v-else class="text-amber-400 font-bold flex items-center gap-1"><i
                                                        class="fa-regular fa-clock"></i> Pendente</span>
                                            </td>
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex justify-end gap-2">
                                                    <!-- WhatsApp Action -->
                                                    <a :href="getWhatsappLink(lead)" target="_blank"
                                                        class="bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 transition hover:-translate-y-0.5 shadow-lg shadow-emerald-900/20">
                                                        <i class="fa-brands fa-whatsapp"></i> <span
                                                            class="hidden md:inline">Chamar</span>
                                                    </a>
                                                    <!-- Manual Convert -->
                                                    <button @click="openPaymentGen(lead)" title="Gerar Link Pagamento"
                                                        class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition hover:-translate-y-0.5 shadow-lg shadow-blue-900/20">
                                                        <i class="fa-solid fa-link"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr v-if="leads.length === 0">
                                            <td colspan="5" class="py-12 text-center text-slate-500">Nenhum lead
                                                encontrado.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- CUSTOMERS / LICENSES VIEW -->
                    <div v-if="currentTab === 'customers'" class="animate-enter h-full flex flex-col">
                        <div
                            class="mb-6 flex justify-between items-center bg-slate-800/50 p-4 rounded-xl border border-slate-800">
                            <div class="flex-1 max-w-md relative">
                                <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500"></i>
                                <input v-model="customerSearch" type="text"
                                    placeholder="Buscar Cliente, Email ou Chave..."
                                    class="w-full bg-slate-900 border border-slate-700 rounded-lg py-2.5 pl-10 pr-4 text-white focus:border-blue-500 outline-none">
                            </div>
                            <div class="flex gap-3">
                                <button @click="showCreateModal=true"
                                    class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-600/20 flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Nova Licença
                                </button>
                            </div>
                        </div>

                        <div class="space-y-4 pb-20">
                            <!-- Customer Card Loop -->
                            <div v-for="cust in paginatedCustomers" :key="cust.email"
                                class="glass-panel p-0 rounded-xl overflow-hidden hover:border-slate-600 transition duration-300">
                                <div class="p-4 bg-slate-900/40 flex flex-col md:flex-row md:items-center justify-between gap-4 cursor-pointer"
                                    @click="cust.expanded = !cust.expanded">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center font-bold text-white shadow-lg shadow-blue-900/20">
                                            {{ cust.email.substring(0,2).toUpperCase() }}
                                        </div>
                                        <div>
                                            <h3 class="font-bold text-white text-base">{{ cust.name || cust.email }}
                                            </h3>
                                            <p class="text-xs text-slate-500">{{ cust.items.length }} Produto(s) • LTV:
                                                <span class="text-emerald-400 font-bold">R$ {{ cust.ltv.toFixed(2)
                                                    }}</span>
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4 text-xs font-mono text-slate-400">
                                        <span>Última compra: {{ formatDate(cust.last_purchase) }}</span>
                                        <i class="fa-solid fa-chevron-down transition-transform duration-300"
                                            :class="{'rotate-180': cust.expanded}"></i>
                                    </div>
                                </div>

                                <!-- Expanded Details -->
                                <div v-show="cust.expanded" class="p-4 bg-[#0b1121] border-t border-slate-800">
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-xs text-left">
                                            <thead class="text-slate-500 bg-slate-800/50 uppercase">
                                                <th class="p-2 rounded-l">Produto</th>
                                                <th class="p-2">Chave</th>
                                                <th class="p-2">Status</th>
                                                <th class="p-2">Email</th>
                                                <th class="p-2">Dispositivo</th>
                                                <th class="p-2 rounded-r text-right">Ações</th>
                                            </thead>
                                            <tbody class="divide-y divide-slate-800">
                                                <tr v-for="lic in cust.items" :key="lic.key">
                                                    <td class="p-3 font-medium text-white">{{ lic.product }}</td>
                                                    <td class="p-3"><code
                                                            class="bg-black/50 px-2 py-1 rounded text-blue-300 border border-slate-700 select-all">{{ lic.key }}</code>
                                                    </td>
                                                    <td class="p-3">
                                                        <span v-if="lic.status=='active'"
                                                            class="text-emerald-400">Ativo</span>
                                                        <span v-else class="text-red-400">Bloqueado</span>
                                                    </td>
                                                    <td class="p-3 text-center">
                                                        <span v-if="lic.email_status==='sent'"
                                                            class="text-emerald-400 text-xs"
                                                            title="Enviado com Sucesso"><i
                                                                class="fa-solid fa-envelope-circle-check"></i></span>
                                                        <span v-else-if="lic.email_status==='failed'"
                                                            class="text-red-400 text-xs" title="Falha no Envio"><i
                                                                class="fa-solid fa-circle-exclamation"></i></span>
                                                        <span v-else class="text-slate-600 text-xs"
                                                            title="Não registrado"><i
                                                                class="fa-regular fa-envelope"></i></span>
                                                    </td>
                                                    <td class="p-3 text-slate-500">{{ lic.device_id ? 'Vinculado' :
                                                        'Livre' }}</td>
                                                    <td class="p-3 text-right flex justify-end gap-2">
                                                        <button @click.stop="resendEmail(lic.key)"
                                                            class="text-blue-400 hover:text-white"
                                                            title="Reenviar Email"><i
                                                                class="fa-solid fa-envelope"></i></button>
                                                        <button v-if="lic.phone" @click.stop="sendLicenseWhatsapp(lic)"
                                                            class="text-green-400 hover:text-white"
                                                            title="Enviar no WhatsApp"><i
                                                                class="fa-brands fa-whatsapp"></i></button>
                                                        <button v-if="lic.device_id"
                                                            @click.stop="actionLicense(lic.key, 'reset_device')"
                                                            class="text-amber-400 hover:text-white"
                                                            title="Resetar ID"><i
                                                                class="fa-solid fa-mobile-screen"></i></button>
                                                        <button v-if="lic.status!=='banned'"
                                                            @click.stop="actionLicense(lic.key, 'banned')"
                                                            class="text-red-400 hover:text-white" title="Bloquear"><i
                                                                class="fa-solid fa-ban"></i></button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-4 pt-4 border-t border-slate-800 flex justify-end">
                                        <!-- Open Details Modal -->
                                        <button @click.stop="openCustomerModal(cust)"
                                            class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                                            Ver Histórico Completo <i class="fa-solid fa-arrow-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div class="flex justify-center items-center gap-4 mt-6">
                                <button @click="currentPage--" :disabled="currentPage===1"
                                    class="w-8 h-8 rounded bg-slate-800 disabled:opacity-50"><i
                                        class="fa-solid fa-chevron-left"></i></button>
                                <span class="text-xs text-slate-400">Página {{ currentPage }} de {{ totalPages }}</span>
                                <button @click="currentPage++" :disabled="currentPage===totalPages"
                                    class="w-8 h-8 rounded bg-slate-800 disabled:opacity-50"><i
                                        class="fa-solid fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- LOGS VIEW -->
                    <div v-if="currentTab === 'logs'" class="h-full flex flex-col animate-enter">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-white">Console do Servidor</h3>
                            <input v-model="logFilter" class="glass-input px-3 py-1 rounded text-xs w-64"
                                placeholder="Grep logs...">
                        </div>
                        <div
                            class="flex-1 bg-black rounded-xl border border-slate-800 p-4 overflow-y-auto font-mono-code text-xs">
                            <div v-for="(log, idx) in filteredLogs" :key="idx"
                                class="mb-1 p-0.5 hover:bg-white/5 rounded flex gap-3 text-slate-300 break-all border-b border-transparent hover:border-slate-800">
                                <span class="text-slate-600 shrink-0">[{{ log.time }}]</span>
                                <span :class="log.color">{{ log.msg }}</span>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

            <!-- MODALS -->

            <!-- NEW LICENSE MODAL -->
            <div v-if="showCreateModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div
                    class="glass-panel w-full max-w-md rounded-2xl p-6 shadow-2xl bg-slate-900 border border-slate-700">
                    <h3 class="text-lg font-bold text-white mb-6">Nova Licença Manual</h3>
                    <form @submit.prevent="createLicense" class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-slate-400">Email do Cliente</label>
                            <input v-model="form.client" type="email" class="w-full mt-1 glass-input rounded-lg p-3"
                                required placeholder="cliente@email.com">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400">Produto</label>
                            <select v-model="form.product" class="w-full mt-1 glass-input rounded-lg p-3">
                                <option value="Plena Aluguéis">Plena Aluguéis</option>
                                <option value="Plena System">Plena System</option>
                                <option value="Plena Odonto">Plena Odonto</option>
                            </select>
                        </div>
                        <div class="pt-4 flex gap-3">
                            <button type="button" @click="showCreateModal=false"
                                class="flex-1 py-3 rounded-lg bg-slate-800 text-white hover:bg-slate-700">Cancelar</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-500 font-bold">Gerar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- CUSTOMER DETAILS MODAL -->
            <div v-if="selectedCustomer"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div
                    class="glass-panel w-full max-w-2xl rounded-2xl p-0 overflow-hidden bg-slate-900 border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-slate-800 bg-slate-900 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-xl font-bold text-white">
                                {{ selectedCustomer.email.substring(0,1).toUpperCase() }}</div>
                            <div>
                                <h3 class="text-lg font-bold text-white">{{ selectedCustomer.email }}</h3>
                                <p class="text-xs text-slate-400">Cliente desde {{
                                    formatDate(selectedCustomer.first_purchase) }}</p>
                            </div>
                        </div>
                        <button @click="selectedCustomer=null" class="text-slate-400 hover:text-white"><i
                                class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    <div class="p-6 overflow-y-auto space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 rounded-xl bg-slate-800/50 border border-slate-800">
                                <div class="text-xs text-slate-500 uppercase font-bold">LTV Total</div>
                                <div class="text-2xl font-bold text-emerald-400">R$ {{ selectedCustomer.ltv.toFixed(2)
                                    }}</div>
                            </div>
                            <div class="p-4 rounded-xl bg-slate-800/50 border border-slate-800">
                                <div class="text-xs text-slate-500 uppercase font-bold">Licenças</div>
                                <div class="text-2xl font-bold text-blue-400">{{ selectedCustomer.items.length }}</div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold text-white mb-3 text-sm">Histórico de Pedidos</h4>
                            <div class="space-y-2">
                                <div v-for="order in selectedCustomer.items" :key="order.key"
                                    class="p-3 rounded-lg bg-slate-800/30 border border-slate-800 flex justify-between items-center">
                                    <div>
                                        <div class="text-sm font-medium text-white">{{ order.product }}</div>
                                        <div class="text-xs text-slate-500">{{ formatDate(order.created_at) }}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs font-mono text-blue-300">{{ order.payment_id || 'Manual' }}
                                        </div>
                                        <div class="text-[10px] text-emerald-500 font-bold uppercase">Pago</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="font-bold text-white mb-3 text-sm">Anotações Internas</h4>
                            <textarea placeholder="Adicione notas sobre este cliente (ex: Pediu reembolso, VIP, etc)..."
                                class="w-full h-24 bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white focus:border-blue-500 outline-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EMAIL TEST MODAL -->
            <div v-if="showEmailModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                <div class="glass-panel w-full max-w-sm rounded-2xl p-6 bg-slate-900 border border-slate-700">
                    <h3 class="font-bold text-white mb-4">Teste de Email (SMTP/Mail)</h3>
                    <input v-model="testEmailAddr" class="w-full glass-input p-3 rounded-lg mb-4"
                        placeholder="email@teste.com">
                    <p v-if="emailStatus" class="mb-4 text-xs font-mono p-2 rounded bg-black/30"
                        :class="emailStatus.includes('SUCESSO') ? 'text-green-400' : 'text-red-400'">{{ emailStatus }}
                    </p>
                    <div class="flex gap-2">
                        <button @click="showEmailModal=false;emailStatus=''"
                            class="flex-1 py-2 bg-slate-800 rounded">Cancelar</button>
                        <button @click="runEmailTest"
                            class="flex-1 py-2 bg-blue-600 rounded text-white font-bold">Enviar</button>
                    </div>
                </div>
            </div>

        </template> <!-- End Logged In -->
    </div>

    <!-- APP LOGIC -->
    <script>
        const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // STATE
                const auth = reactive({ isLoggedIn: false, error: '' });
                const loginPass = ref(localStorage.getItem('plena_admin_pass') || '');
                const loading = ref(false);
                const loadingData = ref(false);
                const sidebarOpen = ref(true);
                const currentTab = ref('dashboard');

                // DATA
                const stats = reactive({ total_revenue: 0, sales_today: 0, total_clients: 0, top_products: {} });
                const chartData = reactive({ labels: [], data: [] });
                const licenses = ref([]);
                const leads = ref([]);
                const logs = ref([]);

                // UI
                const showCreateModal = ref(false);
                const showEmailModal = ref(false);
                const selectedCustomer = ref(null);
                const form = reactive({ client: '', product: 'Plena Aluguéis' });
                const customerSearch = ref('');
                const leadSearch = ref('');
                const logFilter = ref('');
                const currentPage = ref(1);
                const itemsPerPage = 20;

                // TEST EMAIL
                const testEmailAddr = ref('');
                const emailStatus = ref('');

                // NAV
                const tabs = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'fa-solid fa-chart-pie' },
                    { id: 'crm', label: 'CRM / Recuperação', icon: 'fa-solid fa-rocket' },
                    { id: 'customers', label: 'Clientes & Licenças', icon: 'fa-solid fa-users-viewfinder' },
                    { id: 'logs', label: 'Tech Logs', icon: 'fa-solid fa-terminal' }
                ];

                const currentTabLabel = computed(() => tabs.find(t => t.id === currentTab.value)?.label);

                // --- AUTH ---
                const login = async () => {
                    loading.value = true;
                    // Simple Local Auth validation against API to see if secret works
                    try {
                        const r = await fetch(`api_licenca.php?action=list&secret=${loginPass.value}`);
                        const d = await r.json();
                        if (r.ok && !d.error) {
                            auth.isLoggedIn = true;
                            localStorage.setItem('plena_admin_pass', loginPass.value);
                            refreshData();
                        } else {
                            auth.error = "Chave de acesso inválida.";
                        }
                    } catch (e) { auth.error = "Erro de conexão."; }
                    finally { loading.value = false; }
                };

                const logout = () => {
                    auth.isLoggedIn = false;
                    localStorage.removeItem('plena_admin_pass');
                    loginPass.value = '';
                };

                // --- DATA ---
                const refreshData = async () => {
                    if (!auth.isLoggedIn) return;
                    loadingData.value = true;
                    const sec = loginPass.value;

                    try {
                        // 1. Stats
                        fetch(`api_licenca.php?action=dashboard_stats&secret=${sec}`).then(r => r.json()).then(d => {
                            Object.assign(stats, d);
                            chartData.labels = d.chart.labels;
                            chartData.data = d.chart.data;
                            renderChart();
                        });

                        // 2. Licenses
                        fetch(`api_licenca.php?action=list&secret=${sec}`).then(r => r.json()).then(d => {
                            licenses.value = Array.isArray(d) ? d : [];
                        });

                        // 3. Leads (CRM)
                        fetch(`api_licenca.php?action=get_leads&secret=${sec}`).then(r => r.json()).then(d => {
                            leads.value = Array.isArray(d) ? d : [];
                        });

                        // 4. Logs
                        fetch(`api_licenca.php?action=get_logs&secret=${sec}`).then(r => r.json()).then(d => {
                            logs.value = d.logs || [];
                        });

                    } catch (e) { console.error(e); }
                    finally { loadingData.value = false; }
                };

                // --- COMPUTED HELPERS ---

                // 1. Customer Grouping
                const customersGrouped = computed(() => {
                    const map = {};
                    licenses.value.forEach(lic => {
                        const email = (lic.client || 'sem_email').toLowerCase();
                        if (!map[email]) {
                            map[email] = {
                                email: lic.client,
                                name: lic.client.split('@')[0],
                                items: [],
                                ltv: 0,
                                first_purchase: lic.created_at,
                                last_purchase: lic.created_at,
                                expanded: false
                            };
                        }
                        map[email].items.push(lic);

                        // Fake prices for LTV calculation
                        let price = 97;
                        if (lic.product.includes('Odonto')) price = 127;
                        if (lic.product.includes('System')) price = 147;

                        map[email].ltv += price;

                        if (lic.created_at > map[email].last_purchase) map[email].last_purchase = lic.created_at;
                        if (lic.created_at < map[email].first_purchase) map[email].first_purchase = lic.created_at;
                    });

                    let arr = Object.values(map);

                    // Filter
                    if (customerSearch.value) {
                        const q = customerSearch.value.toLowerCase();
                        arr = arr.filter(c => c.email.toLowerCase().includes(q) || c.items.some(i => i.key.toLowerCase().includes(q)));
                    }

                    // Sort by recent purchase
                    return arr.sort((a, b) => new Date(b.last_purchase) - new Date(a.last_purchase));
                });

                const totalPages = computed(() => Math.ceil(customersGrouped.value.length / itemsPerPage));
                const paginatedCustomers = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage;
                    return customersGrouped.value.slice(start, start + itemsPerPage);
                });

                // 2. Leads Filtering
                const filteredLeads = computed(() => {
                    let arr = leads.value;
                    if (leadSearch.value) {
                        const s = leadSearch.value.toLowerCase();
                        arr = arr.filter(l => l.email?.toLowerCase().includes(s) || l.name?.toLowerCase().includes(s));
                    }
                    return arr;
                });

                // Check if lead is converted (exists in licenses)
                const isConverted = (email) => {
                    if (!email) return false;
                    return licenses.value.some(l => l.client.toLowerCase() === email.toLowerCase());
                };

                const conversionRate = computed(() => {
                    if (leads.value.length === 0) return 0;
                    // Count how many leads are in licenses list
                    const convertedCount = leads.value.filter(lead => isConverted(lead.email)).length;
                    return ((convertedCount / leads.value.length) * 100).toFixed(1);
                });

                // 3. Logs
                const filteredLogs = computed(() => {
                    let arr = logs.value.map(l => {
                        const parts = l.match(/^(\d{2}:\d{2}:\d{2})\s-\s(.*)/);
                        const time = parts ? parts[1] : '';
                        const msg = parts ? parts[2] : l;
                        let color = 'text-slate-300';
                        if (msg.toLowerCase().includes('erro') || msg.toLowerCase().includes('falha')) color = 'text-red-400 font-bold';
                        if (msg.toLowerCase().includes('sucesso') || msg.toLowerCase().includes('aprovado')) color = 'text-emerald-400';
                        return { time, msg, color };
                    }).reverse();

                    if (logFilter.value) return arr.filter(l => l.msg.toLowerCase().includes(logFilter.value.toLowerCase()));
                    return arr;
                });

                // --- ACTIONS ---
                // WhatsApp Link Generator
                const getWhatsappLink = (lead) => {
                    if (!lead.phone) return '#';
                    const phone = lead.phone.replace(/\D/g, '');
                    const msg = `Olá ${lead.name}, vi que você tentou comprar o ${lead.product} mas não concluiu. Ficou alguma dúvida? Posso te ajudar?`;
                    return `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`;
                };

                // Manual Payment Link (Mock)
                const openPaymentGen = (lead) => {
                    // In real scenario, this would generate a MP preference
                    const link = `https://plenaaplicativos.com.br/checkout?email=${lead.email}&prod=${encodeURIComponent(lead.product)}`;
                    prompt("Link de Pagamento Pré-preenchido (Copie e envie):", link);
                };

                const createLicense = async () => {
                    if (!confirm("Gerar licença manual?")) return;
                    loadingData.value = true;
                    try {
                        const r = await fetch('api_licenca.php?action=create', {
                            method: 'POST', body: JSON.stringify({ secret: loginPass.value, client_name: form.client, product: form.product })
                        });
                        const d = await r.json();
                        if (d.success) { alert("Gerado: " + d.license_key); showCreateModal.value = false; refreshData(); }
                        else alert("Erro: " + d.error);
                    } catch (e) { alert(e); }
                    finally { loadingData.value = false; }
                };

                const actionLicense = async (key, type) => {
                    if (!confirm("Confirmar ação?")) return;
                    try {
                        const r = await fetch('api_licenca.php?action=update_status', {
                            method: 'POST', body: JSON.stringify({ secret: loginPass.value, key, status: type })
                        });
                        refreshData();
                    } catch (e) { console.error(e); }
                };

                const resendEmail = async (key) => {
                    if (!confirm("Reenviar email?")) return;
                    try {
                        const r = await fetch('api_licenca.php?action=resend_email', {
                            method: 'POST', body: JSON.stringify({ secret: loginPass.value, key })
                        });
                        const d = await r.json();
                        alert(d.message);
                    } catch (e) { alert("Erro ao enviar"); }
                };

                const sendLicenseWhatsapp = (lic) => {
                    if (!lic.phone) return alert('Telefone não registrado.');
                    const phone = lic.phone.replace(/\D/g, '');
                    const msg = `Olá! Compra Confirmada. 
Produto: *${lic.product}*. 
Sua chave: *${lic.key}*. 
Acesse agora: ${lic.app_link}`;
                    window.open(`https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`, '_blank');
                };

                const openCustomerModal = (cust) => { selectedCustomer.value = cust; };

                // Email Test
                const runEmailTest = async () => {
                    emailStatus.value = "Enviando...";
                    try {
                        const r = await fetch(`api_pagamento.php?action=test_email&email=${testEmailAddr.value}`);
                        const d = await r.json();
                        emailStatus.value = d.success ? `SUCESSO: ${d.msg}` : `ERRO: ${d.msg}`;
                    } catch (e) { emailStatus.value = "Erro de Conexão"; }
                };

                // Utils
                const formatDate = (str) => { if (!str) return '-'; return new Date(str).toLocaleDateString('pt-BR'); };
                const timeAgo = (dateStr) => {
                    if (!dateStr) return '';
                    const diff = new Date() - new Date(dateStr);
                    const hours = Math.floor(diff / 3600000);
                    if (hours < 24) return `${hours}h atrás`;
                    return Math.floor(hours / 24) + 'd atrás';
                };

                // Chart
                let chartInstance = null;
                const renderChart = () => {
                    if (currentTab.value !== 'dashboard') return;
                    nextTick(() => {
                        const ctx = document.getElementById('salesChart');
                        if (!ctx) return;
                        if (chartInstance) chartInstance.destroy();
                        chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: chartData.labels,
                                datasets: [{
                                    label: 'Vendas',
                                    data: chartData.data,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { x: { display: false }, y: { display: false } }
                            }
                        });
                    });
                };

                watch(currentTab, renderChart);

                // Auto Login
                if (loginPass.value) login();

                return {
                    auth, loginPass, login, logout, loading, loadingData,
                    sidebarOpen, currentTab, tabs, currentTabLabel,
                    stats, leads, licenses, customersGrouped, paginatedCustomers, filteredLeads, filteredLogs, conversionRate,
                    refreshData, createLicense, actionLicense, resendEmail, sendLicenseWhatsapp,
                    showCreateModal, showEmailModal, form, selectedCustomer, openCustomerModal,
                    customerSearch, leadSearch, logFilter,
                    currentPage, totalPages,
                    testEmailAddr, emailStatus, runEmailTest,
                    formatDate, timeAgo, getWhatsappLink, openPaymentGen, isConverted
                };
            }
        }).mount('#app');
    </script>
</body>

</html>