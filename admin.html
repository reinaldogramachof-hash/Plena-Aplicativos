<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plena Admin | Torre de Controle</title>

    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- VUE.JS 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- FONT INTER -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        [v-cloak] {
            display: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <div id="app" v-cloak>

        <!-- ================= LOGIN SCREEN ================= -->
        <div v-if="!user" class="min-h-screen flex items-center justify-center bg-slate-900 p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
                <div class="p-8 pb-6 text-center">
                    <div class="w-12 h-12 bg-indigo-600 rounded-lg mx-auto flex items-center justify-center mb-4">
                        <i class="fa-solid fa-layer-group text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800">Plena Admin</h2>
                    <p class="text-slate-500 text-sm mt-1">Torre de Controle</p>
                </div>

                <form @submit.prevent="login" class="p-8 pt-2 space-y-4">
                    <div v-if="loginError"
                        class="bg-red-50 text-red-600 p-3 rounded-lg text-sm text-center border border-red-100">
                        {{ loginError }}
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                        <input v-model="loginForm.email" type="email" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                        <input v-model="loginForm.password" type="password" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <button type="submit" :disabled="loading"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50">
                        {{ loading ? 'Acessando...' : 'Entrar' }}
                    </button>

                    <!-- Simples auxiliar para Google Login se preferir -->
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-200"></div>
                        </div>
                        <div class="relative flex justify-center text-xs"><span
                                class="px-2 bg-white text-slate-400">Ou</span></div>
                    </div>

                    <button type="button" @click="loginGoogle"
                        class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-2.5 rounded-lg transition flex items-center justify-center gap-2">
                        <i class="fa-brands fa-google"></i> Google
                    </button>
                </form>
            </div>
        </div>

        <!-- ================= MAIN LAYOUT ================= -->
        <div v-else class="flex h-screen overflow-hidden">

            <!-- SIDEBAR -->
            <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300"
                :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0 absolute md:relative z-50 h-full'">
                <div class="p-6 border-b border-slate-800 flex items-center justify-between">
                    <div>
                        <h1 class="font-bold text-lg">PLENA</h1>
                        <p class="text-[10px] text-indigo-400 uppercase tracking-widest">Admin 3.0</p>
                    </div>
                    <button @click="sidebarOpen = false" class="md:hidden text-slate-400 hover:text-white"><i
                            class="fa-solid fa-times"></i></button>
                </div>

                <nav class="flex-1 p-4 space-y-1">
                    <a href="#" @click.prevent="currentView = 'dashboard'"
                        :class="currentView === 'dashboard' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                        class="flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium">
                        <i class="fa-solid fa-chart-pie w-5 text-center"></i> Dashboard
                    </a>
                    <a href="#" @click.prevent="currentView = 'products'"
                        :class="currentView === 'products' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                        class="flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium">
                        <i class="fa-solid fa-box w-5 text-center"></i> Produtos
                    </a>
                    <a href="#" @click.prevent="currentView = 'sales'"
                        :class="currentView === 'sales' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                        class="flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium">
                        <i class="fa-solid fa-sack-dollar w-5 text-center"></i> Vendas
                    </a>
                    <a href="#" @click.prevent="currentView = 'licenses'"
                        :class="currentView === 'licenses' ? 'bg-indigo-600 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                        class="flex items-center gap-3 px-4 py-3 rounded-lg transition font-medium">
                        <i class="fa-solid fa-key w-5 text-center"></i> Licenças
                    </a>
                </nav>

                <div class="p-4 border-t border-slate-800">
                    <div class="flex items-center gap-3 mb-4 px-2">
                        <div
                            class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold">
                            {{ userInitials }}</div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium truncate">{{ user.email }}</p>
                        </div>
                    </div>
                    <button @click="logout"
                        class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-400 hover:bg-slate-800 rounded-lg transition">
                        <i class="fa-solid fa-right-from-bracket"></i> Sair
                    </button>
                </div>
            </aside>

            <!-- CONTENT AREA -->
            <main class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
                <!-- Mobile Header -->
                <header class="bg-white border-b border-slate-200 p-4 md:hidden flex justify-between items-center z-10">
                    <button @click="sidebarOpen = true" class="text-slate-600"><i
                            class="fa-solid fa-bars text-xl"></i></button>
                    <span class="font-bold text-slate-800">Plena Admin</span>
                    <div class="w-6"></div>
                </header>

                <div class="flex-1 overflow-auto p-4 md:p-8">

                    <!-- DASHBOARD VIEW -->
                    <div v-if="currentView === 'dashboard'" class="animate-fade-in">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Visão Geral</h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase">Faturamento (Total)</p>
                                        <h3 class="text-2xl font-bold text-emerald-600 mt-1">R$ {{
                                            stats.totalRevenue.toFixed(2) }}</h3>
                                    </div>
                                    <div class="bg-emerald-100 p-3 rounded-lg text-emerald-600"><i
                                            class="fa-solid fa-dollar-sign text-xl"></i></div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase">Vendas Realizadas</p>
                                        <h3 class="text-2xl font-bold text-blue-600 mt-1">{{ stats.totalSalesCount }}
                                        </h3>
                                    </div>
                                    <div class="bg-blue-100 p-3 rounded-lg text-blue-600"><i
                                            class="fa-solid fa-cart-shopping text-xl"></i></div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-xs font-bold text-slate-400 uppercase">Produtos Ativos</p>
                                        <h3 class="text-2xl font-bold text-purple-600 mt-1">{{ products.length }}</h3>
                                    </div>
                                    <div class="bg-purple-100 p-3 rounded-lg text-purple-600"><i
                                            class="fa-solid fa-box-open text-xl"></i></div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Sales Table Placeholder -->
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h3 class="font-bold text-slate-800">Últimas Vendas</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-4">ID</th>
                                            <th class="px-6 py-4">Produto</th>
                                            <th class="px-6 py-4">Valor</th>
                                            <th class="px-6 py-4">Data</th>
                                            <th class="px-6 py-4">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr v-for="sale in sales.slice(0, 5)" :key="sale.id" class="hover:bg-slate-50">
                                            <td class="px-6 py-4 font-mono text-xs">{{ sale.id.substring(0,8) }}...</td>
                                            <td class="px-6 py-4 font-medium text-slate-800">{{ sale.product_name ||
                                                'Produto Desconhecido' }}</td>
                                            <td class="px-6 py-4 text-emerald-600 font-bold">R$ {{ (sale.amount ||
                                                0).toFixed(2) }}</td>
                                            <td class="px-6 py-4">{{ formatDate(sale.created_at) }}</td>
                                            <td class="px-6 py-4"><span
                                                    class="px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700">Pago</span>
                                            </td>
                                        </tr>
                                        <tr v-if="sales.length === 0">
                                            <td colspan="5" class="px-6 py-8 text-center text-slate-400">Nenhuma venda
                                                registrada ainda.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- PRODUCTS VIEW -->
                    <div v-if="currentView === 'products'" class="animate-fade-in">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-slate-800">Meus Produtos</h2>
                            <button @click="openProductModal()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2 transition">
                                <i class="fa-solid fa-plus"></i> Novo Produto
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="prod in products" :key="prod.id"
                                class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden group hover:shadow-md transition">
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div
                                            class="w-12 h-12 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xl">
                                            {{ prod.name.charAt(0) }}
                                        </div>
                                        <div class="relative">
                                            <button @click="deleteProduct(prod.id)"
                                                class="text-slate-300 hover:text-red-500 transition" title="Excluir">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <h3 class="font-bold text-lg text-slate-800 mb-1">{{ prod.name }}</h3>
                                    <p class="text-sm text-slate-500 mb-4 line-clamp-1">{{ prod.link }}</p>

                                    <div
                                        class="flex flex-col gap-2 text-xs text-slate-400 font-mono bg-slate-50 p-3 rounded border border-slate-100">
                                        <div class="flex justify-between">
                                            <span>Kiwify ID:</span>
                                            <span class="text-slate-600 select-all">{{ prod.kiwify_id }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Preço:</span>
                                            <span class="text-emerald-600 font-bold">R$ {{ prod.price }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 px-6 py-3 border-t border-slate-100 flex justify-end">
                                    <button @click="openProductModal(prod)"
                                        class="text-sm font-medium text-indigo-600 hover:text-indigo-800">Editar <i
                                            class="fa-solid fa-pen ml-1"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SALES VIEW -->
                    <div v-if="currentView === 'sales'" class="animate-fade-in">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Histórico de Vendas</h2>
                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-600">
                                    <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-4">Data</th>
                                            <th class="px-6 py-4">Cliente</th>
                                            <th class="px-6 py-4">Produto</th>
                                            <th class="px-6 py-4">Valor</th>
                                            <th class="px-6 py-4">Plataforma</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <tr v-for="sale in sales" :key="sale.id" class="hover:bg-slate-50">
                                            <td class="px-6 py-4">{{ formatDate(sale.created_at) }}</td>
                                            <td class="px-6 py-4">
                                                <div class="font-medium text-slate-800">{{ sale.customer_name ||
                                                    'Cliente' }}</div>
                                                <div class="text-xs text-slate-400">{{ sale.customer_email || '-' }}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">{{ sale.product_name }}</td>
                                            <td class="px-6 py-4 text-emerald-600 font-bold">R$ {{ (sale.amount ||
                                                0).toFixed(2) }}</td>
                                            <td class="px-6 py-4"><span
                                                    class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Kiwify</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- LICENSES VIEW -->
                    <div v-if="currentView === 'licenses'" class="animate-fade-in">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6">Gestão de Licenças (DRM)</h2>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 h-fit">
                                <h3 class="font-bold text-slate-800 mb-4">Gerar Nova Licença</h3>
                                <form @submit.prevent="createLicense" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Cliente</label>
                                        <input v-model="licenseForm.client" type="text" required
                                            class="w-full px-4 py-2 border rounded-lg" placeholder="Nome do Cliente">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Produto</label>
                                        <select v-model="licenseForm.product"
                                            class="w-full px-4 py-2 border rounded-lg bg-white">
                                            <option value="" disabled>Selecione...</option>
                                            <option v-for="p in products" :value="p.name">{{ p.name }}</option>
                                            <option value="Outro">Outro (Manual)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">Senha Admin</label>
                                        <input v-model="licenseForm.secret" type="password" required
                                            class="w-full px-4 py-2 border rounded-lg"
                                            placeholder="Senha do secrets.php">
                                    </div>

                                    <button type="submit" :disabled="loadingLicense"
                                        class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg transition flex justify-center items-center gap-2">
                                        <i v-if="loadingLicense" class="fa-solid fa-spinner fa-spin"></i>
                                        {{ loadingLicense ? 'Gerando...' : 'Gerar Chave' }}
                                    </button>
                                </form>

                                <div v-if="generatedKey"
                                    class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg text-center animate-fade-in">
                                    <p class="text-xs text-green-800 uppercase font-bold mb-1">Chave Gerada:</p>
                                    <code
                                        class="text-lg font-mono font-bold text-slate-800 select-all block bg-white p-2 rounded border border-green-100 mb-2">{{ generatedKey }}</code>
                                    <button @click="copyKey" class="text-xs text-green-700 hover:underline"><i
                                            class="fa-solid fa-copy"></i> Copiar</button>
                                </div>
                            </div>

                            <div
                                class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden flex flex-col">
                                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-800">Últimas Licenças</h3>
                                    <div class="flex gap-2">
                                        <input v-model="licenseForm.secret" type="password" placeholder="Senha Admin"
                                            class="text-xs border rounded px-2 py-1 w-24">
                                        <button @click="loadLicenses" class="text-sm text-indigo-600 hover:underline"><i
                                                class="fa-solid fa-rotate"></i> Atualizar</button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto flex-1">
                                    <table class="w-full text-sm text-left text-slate-600">
                                        <thead class="bg-slate-50 text-xs text-slate-500 uppercase font-bold">
                                            <tr>
                                                <th class="px-4 py-3">Cliente / Produto</th>
                                                <th class="px-4 py-3">Chave</th>
                                                <th class="px-4 py-3">Status</th>
                                                <th class="px-4 py-3 text-right">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            <tr v-for="lic in licensesList" :key="lic.key" class="hover:bg-slate-50">
                                                <td class="px-4 py-3">
                                                    <div class="font-bold text-slate-800">{{ lic.client }}</div>
                                                    <div class="text-xs text-slate-400">{{ lic.product }}</div>
                                                    <div class="text-[10px] text-slate-300">{{
                                                        formatDate(lic.created_at) }}</div>
                                                </td>
                                                <td class="px-4 py-3 font-mono text-xs select-all text-slate-500">{{
                                                    lic.key }}</td>
                                                <td class="px-4 py-3">
                                                    <span v-if="lic.status === 'banned'"
                                                        class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs font-bold">Banido</span>
                                                    <span v-else-if="lic.device_id"
                                                        class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold"
                                                        title="Dispositivo Vinculado">Em Uso</span>
                                                    <span v-else
                                                        class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold">Aguardando</span>
                                                </td>
                                                <td class="px-4 py-3 text-right space-x-2">
                                                    <button v-if="lic.device_id"
                                                        @click="manageLicense(lic.key, 'reset_device')"
                                                        title="Resetar Dispositivo (Troca de Celular)"
                                                        class="text-slate-400 hover:text-blue-600 transition"><i
                                                            class="fa-solid fa-mobile-screen-button"></i></button>
                                                    <button v-if="lic.status !== 'banned'"
                                                        @click="manageLicense(lic.key, 'banned')"
                                                        title="Bloquear Acesso"
                                                        class="text-slate-400 hover:text-red-600 transition"><i
                                                            class="fa-solid fa-ban"></i></button>
                                                    <button v-if="lic.status === 'banned'"
                                                        @click="manageLicense(lic.key, 'active')" title="Desbloquear"
                                                        class="text-slate-400 hover:text-green-600 transition"><i
                                                            class="fa-solid fa-check"></i></button>
                                                </td>
                                            </tr>
                                            <tr v-if="licensesList.length === 0">
                                                <td colspan="4" class="px-6 py-8 text-center text-slate-400">Nenhuma
                                                    licença carregada (Insira a senha e clique em atualizar).</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- MODAL PRODUTO -->
        <div v-if="showModal"
            class="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-800">{{ editingProduct ? 'Editar Produto' : 'Novo Produto'
                        }}</h3>
                    <button @click="showModal = false" class="text-slate-400 hover:text-slate-600"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <form @submit.prevent="saveProduct" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nome do Produto</label>
                        <input v-model="form.name" type="text" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">ID Kiwify/Plataforma</label>
                        <input v-model="form.kiwify_id" type="text"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="Ex: Pro-123">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Preço (R$)</label>
                        <input v-model="form.price" type="number" step="0.01"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Link de Acesso (URL)</label>
                        <input v-model="form.link" type="url" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none"
                            placeholder="https://...">
                    </div>
                    <div class="pt-2">
                        <button type="submit"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">
                            Salvar Produto
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </div>

    <!-- APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // =========================================================================
        // ⚙️ CONFIGURAÇÃO FIREBASE (Cole suas chaves aqui!)
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDuYEnG0xwn9_m3I6YKQdz89NJTJpnSPHY",
            authDomain: "plena-system.firebaseapp.com",
            projectId: "plena-system",
            storageBucket: "plena-system.firebasestorage.app",
            messagingSenderId: "580090911924",
            appId: "1:580090911924:web:2942afdf2e49b0c1580be1",
            measurementId: "G-H208D85X75"
        };
        // =========================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const { createApp, ref, computed, onMounted, reactive, watch } = Vue;

        createApp({
            setup() {
                // State
                const user = ref(null);
                const loading = ref(false);
                const sidebarOpen = ref(false);
                const loginError = ref('');
                const currentView = ref('dashboard');
                const products = ref([]);
                const sales = ref([]);

                // Login Form
                const loginForm = reactive({ email: '', password: '' });

                // Modal / Product Form
                const showModal = ref(false);
                const editingProduct = ref(null);
                const form = reactive({ name: '', kiwify_id: '', link: '', price: '' });

                // --- LICENÇAS ---
                const licensesList = ref([]);
                const loadingLicense = ref(false);
                const generatedKey = ref('');
                // Mantenha o secret aqui vazio para o usuário digitar, ou hardcoded se for uso pessoal local
                const licenseForm = reactive({ client: '', product: '', secret: '' });

                // 1. Carregar Licenças
                const loadLicenses = async () => {
                    if (!licenseForm.secret) {
                        // Tenta pegar do localStorage se tiver salvo
                        const savedSecret = localStorage.getItem('plena_admin_secret');
                        if (savedSecret) licenseForm.secret = savedSecret;
                        else return; // Não carrega sem senha
                    }

                    try {
                        const req = await fetch(`api_licenca.php?action=list&secret=${licenseForm.secret}`);
                        const data = await req.json();

                        if (data.error) {
                            alert(data.error);
                        } else if (Array.isArray(data)) {
                            licensesList.value = data;
                            // Salva a senha para facilitar navegação
                            localStorage.setItem('plena_admin_secret', licenseForm.secret);
                        }
                    } catch (e) {
                        console.error("Erro ao carregar licenças", e);
                    }
                };

                // 2. Criar Licença
                const createLicense = async () => {
                    loadingLicense.value = true;
                    try {
                        const req = await fetch('api_licenca.php?action=create', {
                            method: 'POST',
                            body: JSON.stringify({
                                secret: licenseForm.secret,
                                client_name: licenseForm.client,
                                product: licenseForm.product
                            })
                        });
                        const res = await req.json();

                        if (res.success) {
                            generatedKey.value = res.license_key;
                            licenseForm.client = ''; // Limpa cliente
                            localStorage.setItem('plena_admin_secret', licenseForm.secret); // Salva senha
                            loadLicenses(); // Atualiza a tabela
                        } else {
                            alert("Erro: " + (res.error || "Falha desconhecida"));
                        }
                    } catch (e) {
                        alert("Erro de conexão");
                    } finally {
                        loadingLicense.value = false;
                    }
                };

                // 3. Gerenciar (Banir/Resetar)
                const manageLicense = async (key, actionType) => {
                    let confirmMsg = "Confirmar alteração?";
                    if (actionType === 'banned') confirmMsg = "Tem certeza que deseja BLOQUEAR esta licença?";
                    if (actionType === 'reset_device') confirmMsg = "Isso permitirá que o cliente ative em um NOVO dispositivo. Confirmar?";

                    if (!confirm(confirmMsg)) return;

                    try {
                        const req = await fetch('api_licenca.php?action=update_status', {
                            method: 'POST',
                            body: JSON.stringify({
                                secret: licenseForm.secret,
                                key: key,
                                status: actionType
                            })
                        });
                        const res = await req.json();
                        if (res.success) {
                            loadLicenses();
                        } else {
                            alert("Erro: " + res.error);
                        }
                    } catch (e) {
                        alert("Erro ao atualizar status");
                    }
                };

                const copyKey = () => {
                    navigator.clipboard.writeText(generatedKey.value);
                    alert("Copiado!");
                };

                // Carregar licenças automaticamente ao entrar na tela
                watch(currentView, (newVal) => {
                    if (newVal === 'licenses') loadLicenses();
                });

                // Computed
                const userInitials = computed(() => {
                    if (!user.value || !user.value.email) return 'U';
                    return user.value.email.substring(0, 2).toUpperCase();
                });

                const stats = computed(() => {
                    const totalSalesCount = sales.value.length;
                    const totalRevenue = sales.value.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                    return { totalSalesCount, totalRevenue };
                });

                // Lifecycle
                onMounted(() => {
                    onAuthStateChanged(auth, (currentUser) => {
                        user.value = currentUser;
                        if (currentUser) {
                            loadData();
                        }
                    });
                });

                // Actions
                const login = async () => {
                    loading.value = true;
                    loginError.value = '';
                    try {
                        // BYPASS LOGIN FOR TESTING
                        user.value = { email: 'admin@teste.com', uid: 'test-admin' };
                        loadData();
                        return;

                        // REAL AUTH (Commented out for tests)
                        /* await signInWithEmailAndPassword(auth, loginForm.email, loginForm.password); */
                    } catch (err) {
                        console.error(err);
                        loginError.value = "Erro ao entrar. Verifique suas credenciais.";
                    } finally {
                        loading.value = false;
                    }
                };

                const loginGoogle = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (err) {
                        console.error(err);
                        loginError.value = "Erro no Login Google.";
                    }
                };

                const logout = async () => {
                    await signOut(auth);
                    products.value = [];
                    sales.value = [];
                };

                // DATA LOADING (REALTIME)
                const loadData = () => {
                    // Load Products
                    const qProducts = query(collection(db, 'products'), orderBy('name'));
                    onSnapshot(qProducts, (snapshot) => {
                        products.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });

                    // Load Sales
                    try {
                        const qSales = query(collection(db, 'sales')); // Add orderBy if field exists
                        onSnapshot(qSales, (snapshot) => {
                            sales.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        });
                    } catch (e) {
                        console.log("Sales collection might be empty or missing index");
                    }
                };

                // CRUD PRODUCTS
                const openProductModal = (product = null) => {
                    editingProduct.value = product;
                    if (product) {
                        form.name = product.name;
                        form.kiwify_id = product.kiwify_id || '';
                        form.link = product.link || '';
                        form.price = product.price || '';
                    } else {
                        form.name = '';
                        form.kiwify_id = '';
                        form.link = '';
                        form.price = '';
                    }
                    showModal.value = true;
                };

                const saveProduct = async () => {
                    try {
                        const payload = { ...form };
                        if (editingProduct.value) {
                            await updateDoc(doc(db, 'products', editingProduct.value.id), payload);
                        } else {
                            await addDoc(collection(db, 'products'), payload);
                        }
                        showModal.value = false;
                    } catch (e) {
                        alert("Erro ao salvar: " + e.message);
                    }
                };

                const deleteProduct = async (id) => {
                    if (confirm("Tem certeza que deseja excluir este produto?")) {
                        await deleteDoc(doc(db, 'products', id));
                    }
                };

                // UTILS
                const formatDate = (timestamp) => {
                    if (!timestamp) return '-';
                    // Handle Firestore Timestamp or Date string
                    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    return new Intl.DateTimeFormat('pt-BR').format(date);
                };

                return {
                    user, loading, sidebarOpen, loginError, loginForm,
                    currentView, products, sales, stats, userInitials,
                    login, loginGoogle, logout,
                    showModal, editingProduct, form, openProductModal, saveProduct, deleteProduct,
                    formatDate,
                    // Licenças
                    licensesList, licenseForm, createLicense, loadLicenses, manageLicense, generatedKey, copyKey, loadingLicense
                };
            }
        }).mount('#app');
    </script>
</body>

</html>