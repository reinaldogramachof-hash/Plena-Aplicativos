<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plena Admin | Torre de Controle</title>

    <!-- TAILWIND & FONTS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- VUE 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- CHART.JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-link.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .sidebar-link {
            transition: all 0.3s;
        }

        .sidebar-link:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="overflow-hidden h-screen">

    <div id="app" v-cloak class="h-full flex flex-col">

        <!-- LOGIN WALL (Bloqueio de Segurança) -->
        <div v-if="!auth.isLoggedIn"
            class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-sm shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-600"></div>

                <div class="text-center mb-8">
                    <div
                        class="w-16 h-16 bg-blue-600 rounded-xl mx-auto flex items-center justify-center shadow-lg mb-4">
                        <i class="fa-solid fa-tower-broadcast text-2xl text-white"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white">Plena Tower V2</h1>
                    <p class="text-slate-400 text-sm">Acesso Restrito ao Admin</p>
                </div>

                <form @submit.prevent="login" class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Senha Mestra</label>
                        <input v-model="loginPass" type="password"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:ring-2 focus:ring-blue-500 outline-none transition"
                            autofocus placeholder="••••••••">
                    </div>
                    <button :disabled="loading"
                        class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-500/30 flex justify-center items-center gap-2">
                        <i v-if="loading" class="fa-solid fa-circle-notch fa-spin"></i>
                        {{ loading ? 'Verificando...' : 'Desbloquear Sistema' }}
                    </button>
                </form>
                <p v-if="auth.error" class="mt-4 text-center text-red-400 text-xs">{{ auth.error }}</p>
            </div>
        </div>

        <!-- MAIN APP (Acesso Liberado) -->
        <div v-else class="flex flex-1 h-full overflow-hidden">

            <!-- SIDEBAR -->
            <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col z-20">
                <div class="p-6 flex items-center gap-3 border-b border-slate-800/50">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center"><span
                            class="font-bold text-white">P</span></div>
                    <div>
                        <h2 class="font-bold text-white">Plena</h2>
                        <p class="text-[10px] text-blue-400 uppercase tracking-widest">Control Tower</p>
                    </div>
                </div>

                <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                    <a @click="view = 'dashboard'" :class="{active: view==='dashboard'}"
                        class="sidebar-link cursor-pointer flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 font-medium">
                        <i class="fa-solid fa-chart-line w-5 text-center"></i> Dashboard
                    </a>
                    <a @click="view = 'licenses'" :class="{active: view==='licenses'}"
                        class="sidebar-link cursor-pointer flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 font-medium">
                        <i class="fa-solid fa-key w-5 text-center"></i> Licenças
                    </a>
                    <a @click="view = 'crm'" :class="{active: view==='crm'}"
                        class="sidebar-link cursor-pointer flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 font-medium">
                        <i class="fa-solid fa-users w-5 text-center"></i> CRM Clientes
                    </a>
                    <div class="my-4 border-t border-slate-800"></div>
                    <a @click="view = 'logs'" :class="{active: view==='logs'}"
                        class="sidebar-link cursor-pointer flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white font-medium text-sm">
                        <i class="fa-solid fa-terminal w-5 text-center"></i> Logs Server
                    </a>
                </nav>

                <div class="p-4 border-t border-slate-800">
                    <div class="flex items-center gap-3 mb-4 px-2">
                        <div
                            class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center text-xs font-bold">
                            RG</div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-medium truncate">Reinaldo Gramacho</p>
                            <p class="text-[10px] text-green-400">● Online</p>
                        </div>
                    </div>
                    <button @click="logout"
                        class="w-full flex items-center justify-center gap-2 px-4 py-2 text-red-400 hover:bg-slate-800 rounded-lg text-sm transition">
                        <i class="fa-solid fa-right-from-bracket"></i> Sair
                    </button>
                </div>
            </aside>

            <!-- CONTENT -->
            <main class="flex-1 bg-slate-950 relative overflow-y-auto overflow-x-hidden">
                <!-- Header Mobile/Desktop Info -->
                <header
                    class="sticky top-0 z-10 bg-slate-950/80 backdrop-blur border-b border-slate-800 p-4 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white capitalize">{{ viewNames[view] }}</h2>
                    <div class="flex items-center gap-4">
                        <button @click="reloadData"
                            class="w-8 h-8 rounded-full bg-slate-800 hover:bg-slate-700 flex items-center justify-center text-slate-400 transition"
                            title="Recarregar Dados">
                            <i class="fa-solid fa-sync" :class="{'fa-spin': loadingData}"></i>
                        </button>
                        <div
                            class="flex items-center gap-2 text-xs bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-slate-300">Online</span>
                        </div>
                    </div>
                </header>

                <div class="p-6 md:p-8 max-w-7xl mx-auto space-y-8 animate-fade-in">

                    <!-- DASHBOARD VIEW -->
                    <div v-if="view === 'dashboard'" class="space-y-6">
                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                                <div
                                    class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition transform">
                                    <i class="fa-solid fa-dollar-sign text-6xl text-emerald-400"></i></div>
                                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Faturamento Total
                                </p>
                                <h3 class="text-3xl font-bold text-emerald-400 mt-2">R$ {{
                                    stats.total_revenue.toFixed(2) }}</h3>
                                <p
                                    class="text-xs text-emerald-600 mt-1 bg-emerald-400/10 inline-block px-2 py-0.5 rounded">
                                    +{{ stats.sales_month }} vendas este mês</p>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                                <div
                                    class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition transform">
                                    <i class="fa-solid fa-cart-shopping text-6xl text-blue-400"></i></div>
                                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Vendas Hoje</p>
                                <h3 class="text-3xl font-bold text-blue-400 mt-2">{{ stats.sales_today }}</h3>
                                <p class="text-xs text-slate-500 mt-1">Licenças geradas nas últimas 24h</p>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                                <div
                                    class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition transform">
                                    <i class="fa-solid fa-users text-6xl text-purple-400"></i></div>
                                <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">Clientes Únicos</p>
                                <h3 class="text-3xl font-bold text-purple-400 mt-2">{{ stats.total_clients }}</h3>
                                <p class="text-xs text-slate-500 mt-1">Base de dados ativa</p>
                            </div>
                        </div>

                        <!-- Chart & Top Products -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="glass-panel p-6 rounded-2xl lg:col-span-2">
                                <h3 class="text-lg font-bold text-white mb-4">Evolução de Vendas (30 Dias)</h3>
                                <div class="h-64">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl">
                                <h3 class="text-lg font-bold text-white mb-4">Top Produtos</h3>
                                <ul class="space-y-3">
                                    <li v-for="(count, name, idx) in stats.top_products" :key="name"
                                        class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <span
                                                class="w-6 h-6 rounded bg-slate-800 flex items-center justify-center text-xs font-bold text-slate-500">{{
                                                idx+1 }}</span>
                                            <span class="text-sm text-slate-300 font-medium">{{ name }}</span>
                                        </div>
                                        <div class="text-xs font-bold text-blue-400 bg-blue-400/10 px-2 py-1 rounded">{{
                                            count }} un.</div>
                                    </li>
                                    <li v-if="Object.keys(stats.top_products).length === 0"
                                        class="text-slate-500 text-sm text-center py-4">Sem dados ainda.</li>
                                </ul>
                            </div>
                        </div>

                        <!-- Recent Sales Table -->
                        <div class="glass-panel rounded-2xl overflow-hidden">
                            <div class="p-6 border-b border-slate-800/50 flex justify-between items-center">
                                <h3 class="font-bold text-white">Últimas Vendas</h3>
                                <button @click="view='licenses'" class="text-xs text-blue-400 hover:text-blue-300">Ver
                                    Todas</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="bg-slate-800/50 text-xs uppercase font-bold text-slate-500">
                                        <tr>
                                            <th class="px-6 py-3">Cliente</th>
                                            <th class="px-6 py-3">Produto</th>
                                            <th class="px-6 py-3">Data</th>
                                            <th class="px-6 py-3">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800/50">
                                        <tr v-for="sale in stats.recent_sales" :key="sale.key"
                                            class="hover:bg-slate-800/30 transition">
                                            <td class="px-6 py-3 font-medium text-white">{{ sale.client }}</td>
                                            <td class="px-6 py-3">{{ sale.product }}</td>
                                            <td class="px-6 py-3">{{ formatDate(sale.created_at) }}</td>
                                            <td class="px-6 py-3">
                                                <span v-if="sale.payment_id"
                                                    class="text-emerald-400 text-xs font-bold bg-emerald-400/10 px-2 py-1 rounded">Pago</span>
                                                <span v-else
                                                    class="text-slate-400 text-xs font-bold bg-slate-800 px-2 py-1 rounded">Manual</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- LICENSES VIEW -->
                    <div v-if="view === 'licenses'" class="space-y-6">
                        <div class="flex justify-between items-center">
                            <div class="glass-panel px-4 py-2 rounded-lg flex items-center gap-2 w-full max-w-md">
                                <i class="fa-solid fa-search text-slate-500"></i>
                                <input v-model="filters.search" type="text"
                                    placeholder="Buscar por email, chave ou produto..."
                                    class="bg-transparent border-none outline-none text-white w-full text-sm">
                            </div>
                            <button @click="showCreateModal=true"
                                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20"><i
                                    class="fa-solid fa-plus mr-2"></i> Nova Licença</button>
                        </div>

                        <div class="glass-panel rounded-2xl overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-slate-400">
                                    <thead class="bg-slate-800/50 text-xs uppercase font-bold text-slate-500">
                                        <tr>
                                            <th class="px-6 py-3">Data</th>
                                            <th class="px-6 py-3">Cliente</th>
                                            <th class="px-6 py-3">Chave</th>
                                            <th class="px-6 py-3">Dispositivo</th>
                                            <th class="px-6 py-3 text-right">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-800/50">
                                        <tr v-for="lic in filteredLicenses" :key="lic.key"
                                            class="hover:bg-slate-800/30 transition group">
                                            <td class="px-6 py-3 whitespace-nowrap">{{ formatDate(lic.created_at) }}
                                            </td>
                                            <td class="px-6 py-3 font-medium text-white">
                                                <div>{{ lic.client }}</div>
                                                <div class="text-[10px] text-slate-500">{{ lic.product }}</div>
                                            </td>
                                            <td class="px-6 py-3 font-mono text-xs text-blue-300 select-all">{{ lic.key
                                                }}</td>
                                            <td class="px-6 py-3">
                                                <span v-if="lic.status === 'banned'"
                                                    class="text-red-400 text-xs font-bold bg-red-400/10 px-2 py-1 rounded">Bloqueado</span>
                                                <span v-else-if="lic.device_id"
                                                    class="text-emerald-400 text-xs font-bold bg-emerald-400/10 px-2 py-1 rounded"
                                                    :title="lic.device_id">Ativo</span>
                                                <span v-else
                                                    class="text-yellow-400 text-xs font-bold bg-yellow-400/10 px-2 py-1 rounded">Aguardando</span>
                                            </td>
                                            <td class="px-6 py-3 text-right">
                                                <div
                                                    class="flex justify-end gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition">
                                                    <button v-if="lic.device_id"
                                                        @click="actionLicense(lic.key, 'reset_device')"
                                                        class="p-2 bg-slate-800 hover:bg-blue-600 rounded text-slate-300 hover:text-white transition"
                                                        title="Resetar Dispositivo"><i
                                                            class="fa-solid fa-mobile-alt"></i></button>
                                                    <button v-if="lic.status !== 'banned'"
                                                        @click="actionLicense(lic.key, 'banned')"
                                                        class="p-2 bg-slate-800 hover:bg-red-600 rounded text-slate-300 hover:text-white transition"
                                                        title="Banir"><i class="fa-solid fa-ban"></i></button>
                                                    <button v-else @click="actionLicense(lic.key, 'active')"
                                                        class="p-2 bg-slate-800 hover:bg-green-600 rounded text-slate-300 hover:text-white transition"
                                                        title="Ativar"><i class="fa-solid fa-check"></i></button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-if="filteredLicenses.length === 0" class="p-8 text-center text-slate-500">Nenhuma
                                licença encontrada.</div>
                        </div>
                    </div>

                    <!-- CRM VIEW (Simplificado) -->
                    <div v-if="view === 'crm'" class="space-y-6">
                        <h3 class="text-xl font-bold text-white">CRM - Base de Clientes</h3>
                        <div class="glass-panel rounded-2xl overflow-hidden">
                            <table class="w-full text-sm text-left text-slate-400">
                                <thead class="bg-slate-800/50 text-xs uppercase font-bold text-slate-500">
                                    <tr>
                                        <th class="px-6 py-3">Email / Cliente</th>
                                        <th class="px-6 py-3">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-800/50">
                                    <tr v-for="client in stats.crm_clients" :key="client" class="hover:bg-slate-800/30">
                                        <td class="px-6 py-3 text-white font-medium">{{ client }}</td>
                                        <td class="px-6 py-3"><span
                                                class="bg-blue-500/20 text-blue-400 px-2 py-1 rounded text-xs font-bold">Cliente</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- LOGS VIEW -->
                    <div v-if="view === 'logs'" class="h-full flex flex-col">
                        <div class="flex-1 bg-black rounded-xl p-4 font-mono text-xs text-green-400 overflow-auto border border-slate-800 shadow-inner custom-scrollbar"
                            style="min-height: 400px; white-space: pre-wrap;">
                            {{ logsContent || 'Carregando logs...' }}
                        </div>
                    </div>

                </div>
            </main>
        </div>

        <!-- MODAL CREATE LICENSE -->
        <div v-if="showCreateModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
            <div class="glass-panel bg-slate-900 w-full max-w-md rounded-2xl p-6 shadow-2xl border border-slate-700">
                <h3 class="text-lg font-bold text-white mb-4">Gerar Nova Licença</h3>
                <form @submit.prevent="createLicense" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nome do Cliente /
                            Email</label>
                        <input v-model="form.client" type="text" required
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Produto</label>
                        <select v-model="form.product"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg p-2.5 text-white focus:border-blue-500 outline-none">
                            <option value="Plena Aluguéis">Plena Aluguéis</option>
                            <option value="Plena System">Plena System</option>
                            <option value="Plena Odonto">Plena Odonto</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" @click="showCreateModal=false; generatedKey=''"
                            class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-2 rounded-lg transition">Cancelar</button>
                        <button type="submit"
                            class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition shadow-lg shadow-blue-500/20">Gerar</button>
                    </div>
                </form>

                <div v-if="generatedKey"
                    class="mt-6 p-4 bg-emerald-500/10 border border-emerald-500/30 rounded-lg text-center">
                    <p class="text-xs text-emerald-400 uppercase font-bold mb-2">Licença Gerada com Sucesso</p>
                    <div class="flex items-center gap-2">
                        <code
                            class="flex-1 bg-black/30 p-2 rounded text-emerald-300 font-mono font-bold select-all">{{ generatedKey }}</code>
                        <button @click="copyKey" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-500"><i
                                class="fa-solid fa-copy"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                // STATE
                const auth = reactive({ isLoggedIn: false, error: '' });
                const loginPass = ref('');
                const loading = ref(false);
                const loadingData = ref(false);
                const view = ref('dashboard'); // dashboard, licenses, logs, crm
                const video = ref(null);

                // Dados Seguros
                const password = ref(''); // Armazena senha após login
                const stats = reactive({
                    total_revenue: 0, sales_today: 0, sales_month: 0, total_clients: 0,
                    active_licenses: 0, recent_sales: [], top_products: {}, crm_clients: [],
                    chart: { labels: [], data: [] }
                });

                const licenses = ref([]);
                const logsContent = ref('');
                const filters = reactive({ search: '' });

                // MODAL
                const showCreateModal = ref(false);
                const form = reactive({ client: '', product: 'Plena Aluguéis' });
                const generatedKey = ref('');

                // CHART INSTANCE
                let chartInstance = null;

                // AUTH ACTIONS
                const checkSession = async () => {
                    // Limpa sessão antiga se houver alteração de segredos
                    if (!localStorage.getItem('plena_admin_pass')) {
                        auth.isLoggedIn = false;
                        return;
                    }
                    // Tenta logar com a senha salva
                    loginPass.value = localStorage.getItem('plena_admin_pass');
                    await login();
                };

                const login = async () => {
                    if (!loginPass.value) return;
                    loading.value = true;
                    auth.error = '';

                    try {
                        const req = await fetch('api_auth.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ password: loginPass.value })
                        });

                        if (req.ok) {
                            const res = await req.json();
                            if (res.auth) {
                                auth.isLoggedIn = true;
                                password.value = loginPass.value;
                                localStorage.setItem('plena_admin_pass', loginPass.value);
                                await reloadData();
                            } else {
                                if (auth.isLoggedIn) auth.isLoggedIn = false; // Force logout if re-check fails
                                auth.error = 'Senha inválida';
                                localStorage.removeItem('plena_admin_pass');
                            }
                        } else {
                            auth.error = 'Acesso negado';
                        }
                    } catch (e) {
                        auth.error = 'Erro de conexão';
                    } finally {
                        loading.value = false;
                    }
                };

                const logout = () => {
                    auth.isLoggedIn = false;
                    password.value = '';
                    loginPass.value = '';
                    localStorage.removeItem('plena_admin_pass');
                };

                // DATA ACTIONS
                const reloadData = async () => {
                    loadingData.value = true;
                    try {
                        // 1. Dashboard Stats
                        const res = await fetch(`api_licenca.php?action=dashboard_stats&secret=${password.value}`).then(r => r.json());
                        Object.assign(stats, res);
                        updateChart();

                        // 2. Licenças
                        const resLic = await fetch(`api_licenca.php?action=list&secret=${password.value}`).then(r => r.json());
                        if (Array.isArray(resLic)) licenses.value = resLic;

                        // 3. Logs
                        const resLogs = await fetch(`debug_log.txt?t=${Date.now()}`).then(r => r.text());
                        logsContent.value = resLogs;

                    } catch (e) { console.error(e); }
                    finally { loadingData.value = false; }
                };

                const updateChart = () => {
                    if (view.value !== 'dashboard') return;
                    nextTick(() => {
                        const ctx = document.getElementById('salesChart');
                        if (!ctx) return;

                        if (chartInstance) chartInstance.destroy();

                        chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: stats.chart.labels,
                                datasets: [{
                                    label: 'Vendas',
                                    data: stats.chart.data,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                                    x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                                }
                            }
                        });
                    });
                };

                // CRUD
                const createLicense = async () => {
                    try {
                        const req = await fetch('api_licenca.php?action=create', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ secret: password.value, client_name: form.client, product: form.product })
                        });
                        const res = await req.json();
                        if (res.success) {
                            generatedKey.value = res.license_key;
                            reloadData();
                        } else alert(res.error);
                    } catch (e) { alert("Erro ao criar"); }
                };

                const actionLicense = async (key, action) => {
                    if (!confirm("Tem certeza?")) return;
                    try {
                        const req = await fetch('api_licenca.php?action=update_status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ secret: password.value, key: key, status: action })
                        });
                        const res = await req.json();
                        if (res.success) reloadData();
                        else alert(res.error);
                    } catch (e) { alert("Erro"); }
                };

                const copyKey = () => {
                    navigator.clipboard.writeText(generatedKey.value);
                }

                // UTILS
                const formatDate = (d) => { if (!d) return '-'; return new Date(d).toLocaleDateString('pt-BR'); }
                const viewNames = { dashboard: 'Dashboard Geral', licenses: 'Gestão de Licenças', crm: 'Base de Clientes', logs: 'Logs do Sistema' };

                // Computed
                const filteredLicenses = computed(() => {
                    if (!filters.search) return licenses.value;
                    const s = filters.search.toLowerCase();
                    return licenses.value.filter(l =>
                        l.client.toLowerCase().includes(s) ||
                        l.key.toLowerCase().includes(s) ||
                        l.product.toLowerCase().includes(s)
                    );
                });

                watch(view, (v) => { if (v === 'dashboard') reloadData(); });

                onMounted(() => {
                    checkSession();
                });

                return {
                    auth, loginPass, login, logout, password, loading, loadingData,
                    view, viewNames, stats, licenses, filteredLicenses, filters, logsContent,
                    showCreateModal, form, createLicense, generatedKey, actionLicense, copyKey,
                    formatDate, reloadData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>