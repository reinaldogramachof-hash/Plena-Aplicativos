<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plena Desktop Pro - Gestão de Estoque</title>
    
    <meta name="theme-color" content="#0e7490">
    <link rel="manifest" href="data:application/manifest+json,{}">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        plena: { 
                            primary: '#0891B2',   // Cyan 600
                            dark: '#164E63',      // Cyan 900
                            light: '#E0F2FE',     // Sky 100
                            accent: '#F59E0B',    // Amber 500
                            danger: '#EF4444',    // Red 500
                            success: '#10B981',   // Emerald 500
                            bg: '#F8FAFC'         // Slate 50
                        },
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* CSS Otimizado para Desktop */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #F1F5F9;
        }

        /* Scrollbar Fina e Elegante */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .sidebar-fixed {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 50;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-wrapper {
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 1024px) {
            .main-wrapper { margin-left: 280px; }
            .sidebar-fixed { transform: translateX(0); }
        }

        @media (max-width: 1023px) {
            .sidebar-fixed { transform: translateX(-100%); }
            .sidebar-fixed.open { transform: translateX(0); }
            .overlay.open { display: block; }
        }

        /* Tabela Corporativa */
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .table-dense th {
            background-color: #F8FAFC;
            color: #64748B;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
            white-space: nowrap;
        }
        
        .table-dense td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #F1F5F9;
            color: #334155;
            font-size: 0.875rem;
            vertical-align: middle;
        }

        .table-dense tr:last-child td { border-bottom: none; }
        .table-dense tr:hover td { background-color: #F8FAFC; }

        /* Utilitários */
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Backdrop */
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>

<body class="text-slate-800 antialiased h-screen overflow-hidden flex bg-slate-100">

    <div id="overlay" class="overlay hidden fixed inset-0 bg-black/50 z-40 transition-opacity" onclick="toggleSidebar()"></div>

    <aside id="sidebar" class="sidebar-fixed bg-slate-900 text-white flex flex-col shadow-2xl border-r border-slate-800">
        <div class="h-16 flex items-center px-6 bg-gradient-to-r from-cyan-600 to-cyan-800 border-b border-cyan-700 shadow-md z-10">
            <i data-lucide="layout-grid" class="w-6 h-6 mr-3 text-white"></i>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white leading-none">PLENA PRO</h1>
                <p class="text-[10px] text-cyan-100 font-medium tracking-wider mt-1 opacity-80">DESKTOP EDITION v5.0</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Gestão</p>
            
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="bar-chart-2" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Dashboard
            </button>
            
            <button onclick="router('inventory')" id="nav-inventory" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="package" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Inventário
            </button>
            
            <button onclick="router('shopping')" id="nav-shopping" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="shopping-cart" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Compras
            </button>

            <button onclick="router('history')" id="nav-history" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="history" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Histórico
            </button>

            <div class="border-t border-slate-700 my-4 mx-2"></div>
            <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Sistema</p>

            <button onclick="router('settings')" id="nav-settings" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="settings" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Configurações
            </button>
            
            <button onclick="router('manual')" id="nav-manual" class="nav-item w-full flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all group hover:bg-white/10 text-slate-400 hover:text-white">
                <i data-lucide="book-open" class="w-5 h-5 mr-3 opacity-70 group-hover:opacity-100"></i>
                Manual
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-900/50">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-cyan-600 flex items-center justify-center text-xs font-bold">PL</div>
                <div>
                    <p class="text-sm font-medium text-white">Usuário Plena</p>
                    <p class="text-xs text-slate-500">Licença Vitalícia</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="main-wrapper flex-1 flex flex-col h-full bg-slate-100 w-full">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-20 shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-slate-500 hover:bg-slate-100 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="page-title" class="text-xl font-bold text-slate-800">Visão Geral</h2>
            </div>
            
            <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center text-xs text-slate-400 font-medium bg-slate-50 px-3 py-1.5 rounded-full border border-slate-200">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>
                    SISTEMA ONLINE
                </div>
                <button onclick="downloadBackup()" title="Backup Rápido" class="p-2 text-slate-400 hover:text-cyan-600 hover:bg-cyan-50 rounded-lg transition-colors">
                    <i data-lucide="download-cloud" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8" id="content-area">

            <section id="view-dashboard" class="fade-in max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-cyan-300 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Total de Itens</p>
                            <h3 id="dash-total" class="text-2xl font-bold text-slate-800">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-cyan-50 flex items-center justify-center text-cyan-600">
                            <i data-lucide="package" class="w-5 h-5"></i>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-red-300 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Reposição</p>
                            <h3 id="dash-low" class="text-2xl font-bold text-red-600">0</h3>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-red-50 flex items-center justify-center text-red-600">
                            <i data-lucide="arrow-down-circle" class="w-5 h-5"></i>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-amber-300 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Vencimentos</p>
                            <h3 id="dash-exp" class="text-2xl font-bold text-amber-600">0</h3>
                            <p class="text-[10px] text-slate-400">Próximos 30 dias</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center text-amber-600">
                            <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-blue-300 transition-colors">
                        <div>
                            <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Movimentações</p>
                            <h3 id="dash-today-moves" class="text-2xl font-bold text-blue-600">0</h3>
                            <p class="text-[10px] text-slate-400">Registros hoje</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600">
                            <i data-lucide="activity" class="w-5 h-5"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-96">
                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 class="font-bold text-slate-700 flex items-center">
                                <i data-lucide="alert-triangle" class="w-4 h-4 mr-2 text-red-500"></i>
                                Atenção Requerida (Críticos)
                            </h3>
                            <button onclick="router('shopping')" class="text-xs font-medium text-cyan-600 hover:underline">Ver Lista Completa</button>
                        </div>
                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-left table-dense">
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th class="text-center">Atual</th>
                                        <th class="text-center">Mínimo</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="dash-critical-list"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-96">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50">
                            <h3 class="font-bold text-slate-700 flex items-center">
                                <i data-lucide="history" class="w-4 h-4 mr-2 text-slate-500"></i>
                                Últimos Registros
                            </h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="dash-history-list">
                            </div>
                    </div>
                </div>
            </section>

            <section id="view-inventory" class="hide fade-in h-full">
                <div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-140px)]">
                    
                    <div class="w-full lg:w-1/3 flex flex-col gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 overflow-y-auto">
                            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                                <i data-lucide="edit-3" class="w-5 h-5 mr-2 text-cyan-600"></i>
                                <span id="form-title">Cadastrar Item</span>
                            </h3>
                            
                            <form id="inventory-form" onsubmit="submitProductInline(event)" class="space-y-4">
                                <input type="hidden" id="inp-id">
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome do Produto</label>
                                    <input type="text" id="inp-name" required class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 outline-none transition-all" placeholder="Ex: Toner HP 85A">
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoria</label>
                                    <input type="text" id="inp-cat" list="cat-list" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-cyan-500 outline-none" placeholder="Ex: Suprimentos">
                                    <datalist id="cat-list"></datalist>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Qtd Atual</label>
                                        <input type="number" id="inp-qty" required step="any" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm font-bold text-slate-700 outline-none focus:border-cyan-500">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Estoque Mínimo</label>
                                        <input type="number" id="inp-min" required step="any" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm text-slate-700 outline-none focus:border-cyan-500">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Validade (Opcional)</label>
                                    <input type="date" id="inp-exp" class="w-full border border-slate-300 rounded-lg px-3 py-2.5 text-sm outline-none focus:border-cyan-500">
                                </div>

                                <div class="pt-4 flex gap-2">
                                    <button type="button" id="btn-cancel" onclick="resetForm()" class="hidden px-4 py-2 text-slate-500 hover:text-slate-700 font-medium text-sm">Cancelar</button>
                                    <button type="submit" class="flex-1 bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2.5 rounded-lg text-sm transition-colors shadow-sm flex justify-center items-center gap-2">
                                        <i data-lucide="save" class="w-4 h-4"></i> Salvar
                                    </button>
                                </div>
                                <button type="button" id="btn-delete" onclick="deleteProductInline()" class="hidden w-full mt-2 text-red-500 hover:text-red-700 text-xs font-bold uppercase py-2 border border-transparent hover:border-red-200 rounded">Excluir Item</button>
                            </form>
                        </div>
                    </div>

                    <div class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-200 flex flex-col sm:flex-row gap-3 justify-between bg-slate-50">
                            <div class="relative flex-1 max-w-md">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="inv-search" onkeyup="renderInventory()" class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500" placeholder="Buscar por nome, código ou categoria...">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-bold text-slate-500 uppercase" id="inv-count">0 itens</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto">
                            <table class="w-full text-left table-dense">
                                <thead class="sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th>Nome</th>
                                        <th>Categoria</th>
                                        <th class="text-center">Estoque</th>
                                        <th>Validade</th>
                                        <th class="text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="inv-table-body" class="divide-y divide-slate-100">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="view-shopping" class="hide fade-in max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Sugestão de Compra</h3>
                            <p class="text-sm text-slate-500">Itens abaixo do estoque mínimo configurado.</p>
                        </div>
                        <button onclick="copyShoppingList()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-lg font-bold text-sm flex items-center gap-2 shadow-sm transition-colors">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copiar Lista
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left table-dense">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Categoria</th>
                                    <th class="text-center">Estoque Atual</th>
                                    <th class="text-center">Mínimo</th>
                                    <th class="text-right">Comprar (Qtd)</th>
                                </tr>
                            </thead>
                            <tbody id="shopping-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-history" class="hide fade-in max-w-6xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-6 border-b border-slate-200 bg-slate-50">
                        <h3 class="text-lg font-bold text-slate-800">Histórico de Movimentações</h3>
                    </div>
                    <div class="overflow-x-auto h-[600px]">
                        <table class="w-full text-left table-dense">
                            <thead class="sticky top-0 z-10">
                                <tr>
                                    <th>Data / Hora</th>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th class="text-right">Quantidade</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="view-settings" class="hide fade-in max-w-4xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="database" class="w-5 h-5 text-cyan-600"></i>
                            Dados e Backup
                        </h3>
                        <p class="text-sm text-slate-500 mb-6">Os dados são salvos localmente neste navegador. Faça backup regularmente.</p>
                        <div class="space-y-3">
                            <button onclick="downloadBackup()" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 transition-colors">
                                <i data-lucide="download" class="w-4 h-4"></i> Baixar Backup (.json)
                            </button>
                            <div class="relative">
                                <button class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-slate-800 text-white rounded-lg text-sm font-medium hover:bg-slate-900 transition-colors">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Restaurar Backup
                                </button>
                                <input type="file" onchange="restoreBackup(this)" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-red-500">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                            Zona de Perigo
                        </h3>
                        <p class="text-sm text-slate-500 mb-6">Ações irreversíveis.</p>
                        <button onclick="factoryReset()" class="w-full px-4 py-3 bg-red-50 text-red-600 rounded-lg text-sm font-bold border border-red-200 hover:bg-red-100 transition-colors">
                            Resetar Sistema de Fábrica
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <div id="moveModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 animate-fade-in-up">
            <div class="text-center mb-6">
                <h3 class="text-lg font-bold text-slate-800" id="mv-title">Registrar Movimentação</h3>
                <p class="text-sm text-slate-500" id="mv-subtitle">Produto...</p>
            </div>
            <form onsubmit="submitMove(event)" class="space-y-6">
                <input type="hidden" id="mv-pid">
                <div class="flex gap-3">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="mv-type" value="in" class="peer hidden">
                        <div class="p-3 rounded-xl border-2 border-slate-200 text-center peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 transition-all">
                            <span class="block font-bold">Entrada</span>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="mv-type" value="out" class="peer hidden" checked>
                        <div class="p-3 rounded-xl border-2 border-slate-200 text-center peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 transition-all">
                            <span class="block font-bold">Saída</span>
                        </div>
                    </label>
                </div>
                <div>
                    <input type="number" id="mv-qty" required placeholder="Qtd" min="0.01" step="any" class="w-full border-2 border-slate-200 p-4 rounded-xl text-center text-3xl font-bold text-slate-800 focus:border-cyan-500 outline-none">
                </div>
                <div class="flex gap-2">
                    <button type="button" onclick="closeModal('moveModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="flex-1 bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 shadow-lg">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2"></div>

    <script>
        // --- LOGIC CORE ---
        const DB_KEY = 'plena_estoque_v1';
        let db = { products: [], movements: [], settings: {} };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            router('dashboard');
            lucide.createIcons();
            
            // Mobile Sidebar Closes on click outside
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                const btn = document.querySelector('button[onclick="toggleSidebar()"]');
                if (window.innerWidth < 1024 && sidebar.classList.contains('open') && !sidebar.contains(e.target) && !btn.contains(e.target)) {
                    toggleSidebar();
                }
            });
        });

        function loadData() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) db = JSON.parse(stored);
            if (!db.products) db.products = [];
            if (!db.movements) db.movements = [];
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            renderDashboard(); // Update stats background
        }

        function router(view) {
            // Hide all sections
            document.querySelectorAll('section').forEach(el => el.classList.add('hide'));
            // Remove active state from nav
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-white/10', 'text-white', 'shadow-inner');
                el.classList.add('text-slate-400');
            });

            // Show current view
            const target = document.getElementById(`view-${view}`);
            if (target) {
                target.classList.remove('hide');
                if (view === 'inventory') renderInventory();
                if (view === 'shopping') renderShopping();
                if (view === 'history') renderHistory();
                if (view === 'dashboard') renderDashboard();
            }

            // Set active nav
            const navBtn = document.getElementById(`nav-${view}`);
            if (navBtn) {
                navBtn.classList.add('bg-white/10', 'text-white', 'shadow-inner');
                navBtn.classList.remove('text-slate-400');
            }

            // Update Title
            const titles = {
                dashboard: 'Dashboard Executivo',
                inventory: 'Controle de Inventário',
                shopping: 'Planejamento de Compras',
                history: 'Histórico de Transações',
                settings: 'Sistema',
                manual: 'Manual do Usuário'
            };
            document.getElementById('page-title').innerText = titles[view] || 'Plena Pro';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        }

        // --- DASHBOARD LOGIC ---
        function renderDashboard() {
            const total = db.products.length;
            const low = db.products.filter(p => parseFloat(p.qty) < parseFloat(p.min)).length;
            
            // Expiring Logic
            const today = new Date();
            const next30 = new Date(); next30.setDate(today.getDate() + 30);
            const expiring = db.products.filter(p => {
                if (!p.exp) return false;
                const d = new Date(p.exp);
                return d >= today && d <= next30;
            }).length;

            // Moves Today
            const todayStr = new Date().toISOString().split('T')[0];
            const movesToday = db.movements.filter(m => m.date.startsWith(todayStr)).length;

            document.getElementById('dash-total').innerText = total;
            document.getElementById('dash-low').innerText = low;
            document.getElementById('dash-exp').innerText = expiring;
            document.getElementById('dash-today-moves').innerText = movesToday;

            // Critical List
            const criticalList = db.products.filter(p => parseFloat(p.qty) < parseFloat(p.min)).slice(0, 5);
            const tbody = document.getElementById('dash-critical-list');
            tbody.innerHTML = criticalList.length ? criticalList.map(p => `
                <tr class="hover:bg-slate-50 cursor-pointer" onclick="router('inventory'); editProduct('${p.id}')">
                    <td class="font-medium text-slate-700">${p.name}</td>
                    <td class="text-center font-bold text-red-600">${p.qty}</td>
                    <td class="text-center text-slate-500">${p.min}</td>
                    <td><span class="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 uppercase">Repor</span></td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="text-center py-4 text-slate-400 text-sm">Estoque saudável.</td></tr>';

            // History List
            const histList = db.movements.slice().reverse().slice(0, 6);
            const hbody = document.getElementById('dash-history-list');
            hbody.innerHTML = histList.length ? histList.map(m => `
                <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full ${m.type === 'in' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'} flex items-center justify-center">
                            <i data-lucide="${m.type === 'in' ? 'arrow-down' : 'arrow-up'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700">${m.prodName}</p>
                            <p class="text-xs text-slate-400">${new Date(m.date).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                        </div>
                    </div>
                    <span class="font-bold ${m.type === 'in' ? 'text-emerald-600' : 'text-red-600'}">
                        ${m.type === 'in' ? '+' : '-'} ${m.qty}
                    </span>
                </div>
            `).join('') : '<p class="text-center py-4 text-slate-400 text-sm">Sem movimentações recentes.</p>';
            
            lucide.createIcons();
        }

        // --- INVENTORY LOGIC (SPLIT VIEW) ---
        function renderInventory() {
            const term = document.getElementById('inv-search').value.toLowerCase();
            const filtered = db.products.filter(p => p.name.toLowerCase().includes(term) || (p.cat || '').toLowerCase().includes(term));
            
            // Populate Datalist for categories
            const cats = [...new Set(db.products.map(p => p.cat).filter(Boolean))];
            document.getElementById('cat-list').innerHTML = cats.map(c => `<option value="${c}">`).join('');
            
            document.getElementById('inv-count').innerText = `${filtered.length} ITENS`;

            const tbody = document.getElementById('inv-table-body');
            tbody.innerHTML = filtered.map(p => {
                const isLow = parseFloat(p.qty) < parseFloat(p.min);
                const isExpired = p.exp && new Date(p.exp) < new Date();
                
                return `
                <tr class="group hover:bg-cyan-50/50 transition-colors ${isLow ? 'bg-red-50/30' : ''}">
                    <td class="font-medium text-slate-700">
                        ${p.name}
                        ${isLow ? '<span class="ml-2 inline-block w-2 h-2 rounded-full bg-red-500" title="Estoque Baixo"></span>' : ''}
                    </td>
                    <td><span class="px-2 py-1 rounded-md bg-slate-100 text-slate-500 text-xs font-medium uppercase">${p.cat || '-'}</span></td>
                    <td class="text-center font-bold ${isLow ? 'text-red-600' : 'text-slate-700'}">${p.qty}</td>
                    <td class="text-xs ${isExpired ? 'text-red-600 font-bold' : 'text-slate-500'}">
                        ${p.exp ? new Date(p.exp).toLocaleDateString('pt-BR') : '-'}
                        ${isExpired ? '(Vencido)' : ''}
                    </td>
                    <td class="text-right space-x-1">
                        <button onclick="openMoveModal('${p.id}')" title="Movimentar" class="p-1.5 text-slate-400 hover:text-cyan-600 hover:bg-white rounded border border-transparent hover:border-slate-200 transition-all">
                            <i data-lucide="arrow-right-left" class="w-4 h-4"></i>
                        </button>
                        <button onclick="editProduct('${p.id}')" title="Editar" class="p-1.5 text-slate-400 hover:text-amber-600 hover:bg-white rounded border border-transparent hover:border-slate-200 transition-all">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons();
        }

        // Inline Form Actions
        function submitProductInline(e) {
            e.preventDefault();
            const id = document.getElementById('inp-id').value;
            const data = {
                id: id || Date.now().toString(36),
                name: document.getElementById('inp-name').value,
                cat: document.getElementById('inp-cat').value,
                qty: parseFloat(document.getElementById('inp-qty').value),
                min: parseFloat(document.getElementById('inp-min').value),
                exp: document.getElementById('inp-exp').value
            };

            if (id) {
                const idx = db.products.findIndex(p => p.id === id);
                if(idx > -1) db.products[idx] = data;
                showToast('Produto atualizado com sucesso!', 'success');
            } else {
                db.products.push(data);
                showToast('Produto cadastrado!', 'success');
            }
            
            saveData();
            resetForm();
            renderInventory();
        }

        function editProduct(id) {
            const p = db.products.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('inp-id').value = p.id;
            document.getElementById('inp-name').value = p.name;
            document.getElementById('inp-cat').value = p.cat;
            document.getElementById('inp-qty').value = p.qty;
            document.getElementById('inp-min').value = p.min;
            document.getElementById('inp-exp').value = p.exp || '';
            
            document.getElementById('form-title').innerText = 'Editar Item';
            document.getElementById('btn-cancel').classList.remove('hidden');
            document.getElementById('btn-delete').classList.remove('hidden');
            
            // Visual feedback focus
            document.getElementById('inventory-form').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('inp-name').focus();
        }

        function resetForm() {
            document.getElementById('inventory-form').reset();
            document.getElementById('inp-id').value = '';
            document.getElementById('form-title').innerText = 'Cadastrar Item';
            document.getElementById('btn-cancel').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden');
        }

        function deleteProductInline() {
            const id = document.getElementById('inp-id').value;
            if(!id) return;
            if(confirm('Tem certeza? Essa ação não pode ser desfeita.')) {
                db.products = db.products.filter(p => p.id !== id);
                saveData();
                resetForm();
                renderInventory();
                showToast('Item excluído.', 'info');
            }
        }

        // --- MOVEMENTS ---
        function openMoveModal(pid) {
            const p = db.products.find(x => x.id === pid);
            if (!p) return;
            document.getElementById('moveModal').classList.remove('hidden');
            document.getElementById('mv-pid').value = pid;
            document.getElementById('mv-subtitle').innerText = `${p.name} (Saldo: ${p.qty})`;
            document.getElementById('mv-qty').value = '';
            document.getElementById('mv-qty').focus();
        }

        function submitMove(e) {
            e.preventDefault();
            const pid = document.getElementById('mv-pid').value;
            const type = document.querySelector('input[name="mv-type"]:checked').value;
            const qty = parseFloat(document.getElementById('mv-qty').value);
            
            if(!qty) return;

            const idx = db.products.findIndex(p => p.id === pid);
            if(idx > -1) {
                const oldQty = parseFloat(db.products[idx].qty);
                if (type === 'out' && oldQty < qty) {
                    return alert('Saldo insuficiente!');
                }
                
                db.products[idx].qty = type === 'in' ? oldQty + qty : oldQty - qty;
                
                db.movements.push({
                    id: Date.now().toString(),
                    pid,
                    prodName: db.products[idx].name,
                    type,
                    qty,
                    date: new Date().toISOString()
                });

                saveData();
                closeModal('moveModal');
                renderInventory();
                showToast('Movimentação registrada.', 'success');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- SHOPPING & HISTORY ---
        function renderShopping() {
            const list = db.products.filter(p => parseFloat(p.qty) < parseFloat(p.min));
            document.getElementById('shopping-table-body').innerHTML = list.length ? list.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="font-medium">${p.name}</td>
                    <td class="text-slate-500 text-sm">${p.cat || '-'}</td>
                    <td class="text-center font-bold text-red-600">${p.qty}</td>
                    <td class="text-center text-slate-500">${p.min}</td>
                    <td class="text-right font-bold text-emerald-600">+${(p.min - p.qty).toFixed(2)}</td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center py-8 text-slate-400">Tudo em ordem no estoque!</td></tr>';
        }

        function copyShoppingList() {
            const list = db.products.filter(p => parseFloat(p.qty) < parseFloat(p.min));
            if (!list.length) return showToast('Lista vazia.', 'info');
            const text = "*LISTA DE COMPRAS - PLENA PRO*\n\n" + list.map(p => `[ ] ${p.name}: Comprar ${p.min - p.qty}`).join('\n');
            navigator.clipboard.writeText(text);
            showToast('Copiado para área de transferência!', 'success');
        }

        function renderHistory() {
            const list = db.movements.slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('history-table-body').innerHTML = list.length ? list.map(m => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="text-slate-500 text-sm">${new Date(m.date).toLocaleString('pt-BR')}</td>
                    <td class="font-medium text-slate-700">${m.prodName}</td>
                    <td>
                        <span class="px-2 py-1 rounded text-xs font-bold uppercase ${m.type === 'in' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                            ${m.type === 'in' ? 'Entrada' : 'Saída'}
                        </span>
                    </td>
                    <td class="text-right font-mono font-bold text-slate-700">${m.qty}</td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="text-center py-8 text-slate-400">Nenhum registro.</td></tr>';
        }

        // --- SYSTEM ---
        function downloadBackup() {
            const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const a = document.createElement('a');
            a.href = data;
            a.download = `backup_plena_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function restoreBackup(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    db = JSON.parse(e.target.result);
                    saveData();
                    location.reload();
                } catch(err) { alert('Arquivo inválido.'); }
            };
            reader.readAsText(input.files[0]);
        }

        function factoryReset() {
            if(confirm('ATENÇÃO: Isso apagará TODOS os dados. Continuar?')) {
                localStorage.removeItem(DB_KEY);
                location.reload();
            }
        }

        // UI Toast
        function showToast(msg, type='info') {
            const colors = { success: 'bg-emerald-600', info: 'bg-slate-800', error: 'bg-red-600' };
            const el = document.createElement('div');
            el.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg text-sm font-medium flex items-center gap-2 animate-fade-in-up`;
            el.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(el);
            lucide.createIcons();
            setTimeout(() => el.remove(), 3000);
        }
    </script>
</body>
</html>