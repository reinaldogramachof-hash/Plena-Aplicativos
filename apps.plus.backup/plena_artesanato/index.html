<!DOCTYPE html>
<html lang="pt-BR">

<!-- 
    ARQUITETURA DO PROJETO - PLENA ARTESANATO HÍBRIDO PRO
    1. HTML: Estrutura Híbrida (Desktop Fixo / Mobile Retrátil)
    2. CSS: Estilos refinados com Breakpoints (lg: 1024px) e Paleta Pink
    3. JS: Lógica de Precificação, Estoque e Gestão Financeira
-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plena Artesanato - Precificação Profissional</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#db2777">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        plena: {
                            pink: '#db2777',
                            dark: '#be185d',
                            black: '#0f172a',
                            blue: '#3B82F6',
                            green: '#10B981',
                            red: '#EF4444',
                            yellow: '#F59E0B',
                            soft: '#FDF2F8'
                        }
                    },
                    screens: {
                        'lg': '1024px',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC;
            color: #0f172a;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LÓGICA HÍBRIDA (SIDEBAR) --- */
        .sidebar-container {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            background: #0f172a;
            color: white;
            z-index: 50;
            border-right: 1px solid #1e293b;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(2px);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        /* Desktop (≥1024px) */
        @media (min-width: 1024px) {
            .sidebar-container { transform: translateX(0); }
            .main-container { margin-left: 280px; }
            .hamburger-btn { display: none !important; }
        }

        /* Mobile/Tablet (<1024px) */
        @media (max-width: 1023px) {
            .sidebar-container { transform: translateX(-100%); box-shadow: 10px 0 25px -5px rgba(0,0,0,0.5); }
            .sidebar-container.open { transform: translateX(0); }
            .main-container { margin-left: 0; }
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #F8FAFC;
            transition: margin-left 0.3s ease;
        }

        /* Utilitários */
        .hide { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Navegação */
        .nav-item {
            transition: all 0.2s ease;
            margin-bottom: 4px;
            border-radius: 0.5rem;
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: #fff; }
        .nav-item.active-nav {
            background: rgba(219, 39, 119, 0.15); /* Pink tint */
            color: #F472B6; /* Pink light */
            border-right: 3px solid #db2777;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Card Hover */
        .card-hover { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(219, 39, 119, 0.1); }

        /* Impressão */
        @media print {
            .sidebar-container, .hamburger-btn, header, .no-print { display: none !important; }
            .main-container { margin-left: 0; width: 100%; }
            body { background: white; }
            .view-section { display: none; }
            #view-reports { display: block !important; }
            .print-color-exact { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>

<body class="antialiased bg-slate-50">

    <!-- Overlay Mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="sidebar-container flex flex-col shadow-2xl">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 bg-slate-900 border-b border-slate-800">
            <div class="bg-gradient-to-br from-plena-pink to-plena-dark p-2 rounded-lg mr-3 shadow-lg shadow-pink-900/50">
                <i data-lucide="palette" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold tracking-tight text-white">PLENA ARTESANATO</h1>
                <p class="text-xs text-slate-400 font-medium tracking-wide">DESKTOP PRO</p>
            </div>
            <button onclick="toggleSidebar()" class="lg:hidden ml-auto text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Menu -->
        <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
            <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Ateliê</p>
            
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-plena-pink"></i> Dashboard
            </button>
            <button onclick="router('products')" id="nav-products" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="package" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-plena-pink"></i> Meus Produtos
            </button>
            <button onclick="router('materials')" id="nav-materials" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="layers" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-plena-pink"></i> Estoque
            </button>
            <button onclick="router('transactions')" id="nav-transactions" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="wallet" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-plena-pink"></i> Caixa
            </button>

            <div class="pt-4 pb-2"><div class="border-t border-slate-800"></div></div>
            <p class="px-4 text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Ferramentas</p>

            <button onclick="router('reports')" id="nav-reports" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> Relatórios
            </button>
            <button onclick="router('settings')" id="nav-settings" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="calculator" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> Configurações
            </button>
            <button onclick="router('instructions')" id="nav-instructions" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="book-open" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> Manual
            </button>
            <button onclick="router('about')" id="nav-about" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group">
                <i data-lucide="info" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> Sobre
            </button>
            <button onclick="router('system')" id="nav-system" class="nav-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg text-slate-300 group relative">
                <i data-lucide="cpu" class="w-5 h-5 mr-3 text-slate-400 group-hover:text-white"></i> Sistema
                <span id="sidebar-badge" class="hidden absolute right-4 flex h-2.5 w-2.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                </span>
            </button>
        </nav>

        <div class="p-6 bg-slate-900 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-pink-500 to-rose-400 flex items-center justify-center font-bold text-xs">AR</div>
                <div>
                    <p class="text-sm font-medium text-white">Artesã(o)</p>
                    <p class="text-xs text-slate-500">Online</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-container">
        <!-- Header -->
        <header class="h-20 bg-white border-b border-slate-200 sticky top-0 z-30 px-4 md:px-8 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="hamburger-btn p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div>
                    <h2 id="page-title" class="text-xl md:text-2xl font-bold text-slate-800 tracking-tight">Dashboard</h2>
                    <p class="text-xs text-slate-500 mt-0.5 font-medium uppercase tracking-wider hidden md:block">Gestão de Ateliê</p>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="router('system')" class="relative p-2 text-slate-400 hover:bg-slate-100 rounded-full transition-colors hidden md:block">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                    <span id="header-badge" class="absolute top-2 right-2 flex h-2.5 w-2.5 hidden">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                    </span>
                </button>

                <div class="h-8 w-px bg-slate-200 hidden md:block"></div>

                <button onclick="openClosingModal()" class="flex items-center px-3 md:px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-50 transition-all shadow-sm">
                    <i data-lucide="check-circle-2" class="w-4 h-4 md:mr-2 text-green-600"></i>
                    <span class="hidden md:inline">Fechar Caixa</span>
                </button>

                <button onclick="openProductModal()" class="flex items-center px-3 md:px-5 py-2.5 bg-plena-pink text-white rounded-lg text-sm font-semibold hover:bg-plena-dark transition-all shadow-md shadow-pink-200">
                    <i data-lucide="plus" class="w-5 h-5 md:mr-2"></i>
                    <span class="hidden md:inline">Criar Peça</span>
                </button>
            </div>
        </header>

        <!-- Content -->
        <div class="p-4 md:p-8 flex-1 overflow-y-auto">
            
            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="view-section fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h3 class="text-lg font-bold text-slate-700 w-full sm:w-auto">Resumo Financeiro</h3>
                    <div class="relative w-full sm:w-auto">
                        <i data-lucide="calendar" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="month" id="month-selector" onchange="renderDashboard()"
                            class="w-full sm:w-auto pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm font-bold text-slate-700 focus:ring-2 focus:ring-plena-pink outline-none cursor-pointer hover:bg-white">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Valor Hora</p>
                                <h3 id="dash-hourly-rate" class="text-2xl md:text-3xl font-bold text-plena-pink mt-2">R$ 0,00</h3>
                                <p class="text-xs text-slate-500 mt-1">Sua meta calculada</p>
                            </div>
                            <div class="p-3 bg-pink-50 rounded-lg text-plena-pink"><i data-lucide="clock" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Produtos</p>
                                <h3 id="dash-products-count" class="text-2xl md:text-3xl font-bold text-slate-900 mt-2">0</h3>
                                <p class="text-xs text-slate-500 mt-1">Peças cadastradas</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="package" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Vendas (Mês)</p>
                                <h3 id="dash-revenue" class="text-2xl md:text-3xl font-bold text-green-600 mt-2">R$ 0,00</h3>
                                <p class="text-xs text-slate-500 mt-1">Entradas</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg text-green-600"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm card-hover">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Custos (Mês)</p>
                                <h3 id="dash-costs" class="text-2xl md:text-3xl font-bold text-red-600 mt-2">R$ 0,00</h3>
                                <p class="text-xs text-slate-500 mt-1">Saídas</p>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg text-red-600"><i data-lucide="trending-down" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Chart Area -->
                    <div class="xl:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col">
                        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-xl">
                            <h3 class="font-bold text-slate-800 text-lg flex items-center">
                                <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-slate-500"></i>
                                Fluxo de Caixa (7 Dias)
                            </h3>
                            <div class="flex gap-4">
                                <div class="flex items-center gap-2 text-xs font-bold text-slate-600"><div class="w-3 h-3 rounded-full bg-green-500"></div> Vendas</div>
                                <div class="flex items-center gap-2 text-xs font-bold text-slate-600"><div class="w-3 h-3 rounded-full bg-red-500"></div> Custos</div>
                            </div>
                        </div>
                        <div class="p-6 h-64 w-full">
                            <!-- Custom CSS Chart (Simples e Eficiente) -->
                            <div id="chart-area" class="flex items-end justify-between h-full gap-2"></div>
                        </div>
                    </div>

                    <!-- Side Lists -->
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                                <i data-lucide="star" class="w-4 h-4 mr-2 text-plena-pink"></i>
                                Destaques (Rentabilidade)
                            </h3>
                            <div id="top-products" class="space-y-3"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                                <i data-lucide="history" class="w-4 h-4 mr-2 text-slate-400"></i>
                                Produtos Recentes
                            </h3>
                            <div id="recent-products" class="space-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: PRODUTOS -->
            <section id="view-products" class="view-section hide fade-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Catálogo de Produtos</h2>
                        <p class="text-sm text-slate-500 hidden sm:block">Gerencie suas criações e preços</p>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto">
                        <button onclick="exportProductsCSV()" class="flex-1 md:flex-none justify-center bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-200 flex items-center shadow-sm">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i> CSV
                        </button>
                        <button onclick="openProductModal()" class="flex-1 md:flex-none justify-center bg-plena-pink text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-plena-dark flex items-center shadow-md">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Novo
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-wrap gap-4 items-center">
                    <div class="relative flex-1 min-w-[200px] w-full">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="search-term" onkeyup="renderProducts()" placeholder="Buscar produto..."
                            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-plena-pink outline-none">
                    </div>
                    <select id="filter-category" onchange="renderProducts()" class="w-full md:w-auto border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
                        <option value="all">Todas Categorias</option>
                        <option value="Bolsas">Bolsas</option><option value="Roupas">Roupas</option><option value="Acessórios">Acessórios</option><option value="Decoração">Decoração</option><option value="Outros">Outros</option>
                    </select>
                    <select id="filter-sort" onchange="renderProducts()" class="w-full md:w-auto border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
                        <option value="newest">Mais recentes</option>
                        <option value="price-high">Maior preço</option>
                        <option value="price-low">Menor preço</option>
                    </select>
                </div>

                <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                <div id="empty-msg" class="hidden p-12 text-center text-slate-400">
                    <i data-lucide="package-open" class="w-12 h-12 mx-auto mb-3 text-slate-300"></i>
                    <p>Nenhum produto encontrado.</p>
                </div>
            </section>

            <!-- VIEW: MATERIAIS -->
            <section id="view-materials" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Estoque de Materiais</h2>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-auto lg:h-[calc(100vh-200px)]">
                    <!-- Form -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-fit">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center">
                            <i data-lucide="plus-circle" class="w-5 h-5 mr-2 text-plena-pink"></i>
                            Cadastrar Material
                        </h3>
                        <form onsubmit="submitMaterial(event)" class="space-y-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Nome</label><input type="text" id="mat-name" required class="w-full border p-2.5 rounded-lg text-sm mt-1"></div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Categoria</label>
                                <select id="mat-category" class="w-full border p-2.5 rounded-lg text-sm mt-1 bg-white">
                                    <option value="Tecidos">Tecidos</option><option value="Linhas">Linhas</option><option value="Tintas">Tintas</option><option value="Acessórios">Acessórios</option><option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Custo (R$)</label><input type="number" step="0.01" id="mat-cost" required class="w-full border p-2.5 rounded-lg text-sm mt-1"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Qtd Total</label><input type="number" step="0.01" id="mat-quantity" required class="w-full border p-2.5 rounded-lg text-sm mt-1"></div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase">Unidade</label>
                                <select id="mat-unit" class="w-full border p-2.5 rounded-lg text-sm mt-1 bg-white">
                                    <option value="unidades">Unidades</option><option value="metros">Metros</option><option value="gramas">Gramas</option><option value="litros">Litros</option><option value="pacotes">Pacotes</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full bg-plena-pink text-white py-3 rounded-xl font-bold hover:bg-plena-dark shadow-lg shadow-pink-200 mt-2">Salvar no Estoque</button>
                        </form>
                    </div>
                    <!-- Lista -->
                    <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-[500px] lg:h-auto">
                        <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-800">Itens em Estoque</h3>
                            <div class="relative w-48 md:w-64">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-slate-400"></i>
                                <input type="text" id="mat-search" onkeyup="renderMaterials()" placeholder="Filtrar..." class="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-lg text-xs focus:ring-1 focus:ring-plena-pink outline-none">
                            </div>
                        </div>
                        <div class="flex-1 overflow-y-auto p-4" id="materials-list"></div>
                    </div>
                </div>
            </section>

            <!-- VIEW: CAIXA -->
            <section id="view-transactions" class="view-section hide fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-slate-800">Caixa do Ateliê</h2>
                    <button onclick="openTransModal()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-900 shadow-md flex items-center">
                        <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Lançar
                    </button>
                </div>
                <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm mb-6 flex flex-col lg:flex-row gap-4 items-end">
                    <div class="w-full lg:flex-1 relative">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Buscar</label>
                        <i data-lucide="search" class="absolute left-3 top-8 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="trans-search-term" onkeyup="renderTransactions()" placeholder="Descrição..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-plena-pink outline-none">
                    </div>
                    <div class="flex gap-2 w-full lg:w-auto">
                        <div class="flex-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Início</label><input type="date" id="filter-start" onchange="renderTransactions()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm"></div>
                        <div class="flex-1"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Fim</label><input type="date" id="filter-end" onchange="renderTransactions()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm"></div>
                    </div>
                    <div class="w-full lg:w-auto">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tipo</label>
                        <select id="filter-type" onchange="renderTransactions()" class="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white">
                            <option value="all">Todos</option><option value="income">Vendas</option><option value="expense">Custos</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-green-50 p-4 rounded-xl border border-green-100"><p class="text-xs font-bold text-green-700 uppercase">Vendas</p><p id="filter-income" class="text-xl font-bold text-green-800">R$ 0,00</p></div>
                    <div class="bg-red-50 p-4 rounded-xl border border-red-100"><p class="text-xs font-bold text-red-700 uppercase">Custos</p><p id="filter-expense" class="text-xl font-bold text-red-800">R$ 0,00</p></div>
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><p class="text-xs font-bold text-blue-700 uppercase">Saldo</p><p id="filter-balance" class="text-xl font-bold text-blue-800">R$ 0,00</p></div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[600px]">
                            <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs border-b border-slate-200">
                                <tr><th class="px-6 py-3">Data</th><th class="px-6 py-3">Descrição</th><th class="px-6 py-3">Tipo</th><th class="px-6 py-3">Categoria</th><th class="px-6 py-3 text-right">Valor</th><th class="px-6 py-3 text-center">Ações</th></tr>
                            </thead>
                            <tbody id="trans-table-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    <div id="trans-empty-msg" class="hidden p-12 text-center text-slate-400">Nenhuma movimentação.</div>
                </div>
            </section>

            <!-- VIEW: RELATÓRIOS -->
            <section id="view-reports" class="view-section hide fade-in">
                <h2 class="text-xl font-bold text-slate-800 mb-6">Relatórios</h2>
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6 max-w-3xl">
                    <h3 class="font-bold text-slate-800 mb-4">Configurar Período</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Início</label><input type="date" id="rep-start" class="w-full border p-2 rounded-lg text-sm mt-1"></div>
                        <div><label class="text-xs font-bold text-slate-500 uppercase">Fim</label><input type="date" id="rep-end" class="w-full border p-2 rounded-lg text-sm mt-1"></div>
                        <div class="flex gap-2">
                            <button onclick="generateReport()" class="flex-1 bg-plena-pink text-white px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-plena-dark">Gerar</button>
                            <button onclick="generateFullReport()" class="bg-slate-100 px-4 py-2.5 rounded-lg text-sm font-bold hover:bg-slate-200"><i data-lucide="calendar" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
                <div id="report-result" class="hide">
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        <div class="bg-green-50 p-4 rounded-xl border border-green-200 text-center"><p class="text-xs font-bold text-green-700 uppercase">Vendas</p><p id="rep-inc" class="text-2xl font-bold text-green-800">R$ 0,00</p></div>
                        <div class="bg-red-50 p-4 rounded-xl border border-red-200 text-center"><p class="text-xs font-bold text-red-700 uppercase">Custos</p><p id="rep-exp" class="text-2xl font-bold text-red-800">R$ 0,00</p></div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center"><p class="text-xs font-bold text-blue-700 uppercase">Lucro</p><p id="rep-bal" class="text-2xl font-bold text-blue-800">R$ 0,00</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm mb-6">
                        <h3 class="font-bold text-slate-800 mb-4">Análise por Categoria</h3>
                        <div id="category-report" class="space-y-3"></div>
                    </div>
                    <div class="flex justify-end gap-4 no-print">
                        <button onclick="shareReport()" class="bg-[#25D366] text-white px-6 py-2.5 rounded-lg font-bold flex items-center"><i data-lucide="message-circle" class="w-4 h-4 mr-2"></i> WhatsApp</button>
                        <button onclick="printReport()" class="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold flex items-center"><i data-lucide="printer" class="w-4 h-4 mr-2"></i> Imprimir</button>
                    </div>
                </div>
            </section>

            <!-- VIEW: CONFIGURAÇÕES -->
            <section id="view-settings" class="view-section hide fade-in">
                <h2 class="text-xl font-bold text-slate-800 mb-6">Configurações</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center"><i data-lucide="calculator" class="w-5 h-5 mr-2 text-plena-pink"></i> Calculadora de Valor Hora</h3>
                        <div class="space-y-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Salário Desejado (R$)</label><input type="number" id="conf-salary" class="w-full border p-3 rounded-lg mt-1" onchange="calculateHourlyRate()"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Horas/Dia</label><input type="number" id="conf-hours-day" class="w-full border p-3 rounded-lg mt-1" onchange="calculateHourlyRate()"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Dias/Semana</label><input type="number" id="conf-days-week" class="w-full border p-3 rounded-lg mt-1" onchange="calculateHourlyRate()"></div>
                            </div>
                            <div class="bg-pink-50 p-4 rounded-lg text-center mt-2 border border-pink-100">
                                <p class="text-xs text-pink-800 font-bold uppercase">Sua Hora Vale</p>
                                <h2 id="conf-result-rate" class="text-3xl font-bold text-plena-pink">R$ 0,00</h2>
                            </div>
                            <button onclick="saveSettings()" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold">Salvar Configuração</button>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4">Dados do Ateliê</h3>
                            <div class="space-y-3">
                                <input type="text" id="set-owner-name" class="w-full border p-3 rounded-lg text-sm" placeholder="Nome do Responsável">
                                <input type="text" id="set-owner-doc" class="w-full border p-3 rounded-lg text-sm" placeholder="CPF/CNPJ">
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-4">Backup</h3>
                            <div class="flex gap-3">
                                <button onclick="downloadBackup()" class="border border-slate-300 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-50 flex justify-center items-center gap-2 flex-1"><i data-lucide="download" class="w-4 h-4"></i> Baixar</button>
                                <label class="bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 flex justify-center items-center gap-2 flex-1 cursor-pointer">
                                    <i data-lucide="upload" class="w-4 h-4"></i> Restaurar
                                    <input type="file" onchange="restoreBackup(this)" accept=".json" class="hidden">
                                </label>
                            </div>
                            <button onclick="factoryReset()" class="w-full text-red-500 text-xs font-bold mt-4 hover:underline">Resetar Sistema</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: SYSTEM, INSTRUCTIONS, ABOUT -->
            <section id="view-system" class="view-section hide fade-in">
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between items-end mb-8">
                        <h2 class="text-2xl font-bold text-slate-800">Painel do Sistema</h2>
                        <button onclick="checkForUpdates()" class="bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center"><i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i> Verificar</button>
                    </div>
                    <div class="bg-slate-900 text-white rounded-xl shadow-lg p-6 relative overflow-hidden mb-6">
                        <div class="absolute top-0 right-0 p-8 opacity-10"><i data-lucide="cpu" class="w-32 h-32"></i></div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">Versão</p>
                        <h2 id="display-installed-version" class="text-4xl font-bold mb-1">v5.3.1</h2>
                        <p class="text-slate-400 text-sm">Build Híbrido Pro</p>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                        <h3 class="font-bold text-slate-800 mb-4">Changelog</h3>
                        <div id="changelog-feed"></div>
                    </div>
                </div>
            </section>
            <section id="view-instructions" class="view-section hide fade-in"><div class="p-8 text-center text-slate-500 bg-white rounded-xl border border-slate-200 shadow-sm">Manual Interativo em desenvolvimento.</div></section>
            <section id="view-about" class="view-section hide fade-in"><div class="p-8 text-center text-slate-500 bg-white rounded-xl border border-slate-200 shadow-sm">Plena Soluções Digitais - v5.3.1</div></section>

        </div>
    </main>

    <!-- MODAIS -->
    
    <!-- Product Modal -->
    <div id="productModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b border-slate-100">
                <h3 class="text-xl font-bold text-slate-800" id="prod-modal-title">Novo Produto</h3>
                <button onclick="closeModal('productModal')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x"></i></button>
            </div>
            <form onsubmit="submitProduct(event)" class="p-6 md:p-8 space-y-6">
                <input type="hidden" id="pd-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Nome da Peça</label><input type="text" id="pd-name" required class="w-full border p-3 rounded-lg text-sm" placeholder="Ex: Bolsa de Crochê"></div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 uppercase">Categoria</label>
                        <select id="pd-category" class="w-full border p-3 rounded-lg text-sm bg-white">
                            <option value="Bolsas">Bolsas</option><option value="Roupas">Roupas</option><option value="Acessórios">Acessórios</option><option value="Decoração">Decoração</option><option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>
                
                <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-slate-700 text-sm flex items-center"><i data-lucide="layers" class="w-4 h-4 mr-2"></i> Materiais Usados</h4>
                    </div>
                    <div class="grid grid-cols-3 gap-3 mb-3">
                        <input type="text" id="temp-mat-name" class="col-span-2 border p-2 rounded-lg text-sm" placeholder="Material (Ex: Fio)">
                        <div class="flex gap-2">
                            <input type="number" step="0.01" id="temp-mat-cost" class="border p-2 rounded-lg text-sm w-full" placeholder="Custo">
                            <button type="button" onclick="addTempMaterial()" class="bg-slate-800 text-white px-3 rounded-lg hover:bg-black"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <ul id="materials-list-modal" class="space-y-2 text-sm text-slate-600 mb-3 max-h-32 overflow-y-auto bg-white p-2 rounded border border-slate-100"></ul>
                    <div class="flex justify-between border-t border-slate-200 pt-2 font-bold text-slate-800">
                        <span>Custo Materiais:</span><span id="display-mat-total">R$ 0,00</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Tempo (Horas)</label><input type="number" step="0.1" id="pd-time" required class="w-full border p-3 rounded-lg text-sm" placeholder="Ex: 2.5" onkeyup="calculatePrice()"></div>
                    <div><label class="text-xs font-bold text-slate-500 uppercase">Lucro (%)</label><input type="number" id="pd-profit" class="w-full border p-3 rounded-lg text-sm" value="50" onkeyup="calculatePrice()"></div>
                </div>

                <div class="bg-pink-50 p-6 rounded-xl border border-pink-100 text-center">
                    <p class="text-xs text-pink-700 font-bold uppercase mb-1">Preço Sugerido</p>
                    <h2 id="display-final-price" class="text-4xl font-bold text-plena-pink">R$ 0,00</h2>
                    <input type="hidden" id="pd-final-price">
                </div>

                <div class="flex gap-3 justify-end pt-4 border-t border-slate-100">
                    <button type="button" onclick="deleteProduct()" id="btn-delete-prod" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg font-bold text-sm hidden">Excluir</button>
                    <button type="submit" class="bg-plena-pink text-white px-8 py-3 rounded-xl font-bold hover:bg-plena-dark shadow-lg shadow-pink-200 transition-all">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">Nova Movimentação</h3>
                <button onclick="closeModal('transactionModal')"><i data-lucide="x" class="text-slate-400"></i></button>
            </div>
            <form onsubmit="submitTransaction(event)" class="space-y-4">
                <input type="hidden" id="t-id">
                <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-lg">
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="t-type" value="income" class="peer hidden" checked>
                        <div class="py-2 text-sm font-bold text-slate-500 rounded-md peer-checked:bg-white peer-checked:text-green-600 shadow-sm transition-all">Venda</div>
                    </label>
                    <label class="cursor-pointer text-center">
                        <input type="radio" name="t-type" value="expense" class="peer hidden">
                        <div class="py-2 text-sm font-bold text-slate-500 rounded-md peer-checked:bg-white peer-checked:text-red-600 shadow-sm transition-all">Despesa</div>
                    </label>
                </div>
                <input type="number" id="t-amount" step="0.01" required class="w-full border-2 border-slate-200 p-3 rounded-xl text-xl font-bold text-center" placeholder="R$ 0,00">
                <input type="text" id="t-desc" required class="w-full border p-3 rounded-lg text-sm" placeholder="Descrição">
                <div class="grid grid-cols-2 gap-3">
                    <select id="t-cat" class="w-full border p-3 rounded-lg text-sm bg-white"><option value="Venda">Venda</option><option value="Material">Material</option><option value="Outro">Outro</option></select>
                    <select id="t-method" class="w-full border p-3 rounded-lg text-sm bg-white"><option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option><option value="Cartão">Cartão</option></select>
                </div>
                <input type="date" id="t-date" required class="w-full border p-3 rounded-lg text-sm">
                <button type="submit" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Closing Modal -->
    <div id="closingModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-slate-900 p-6 text-center text-white">
                <h3 class="font-bold text-lg">Fechamento do Dia</h3>
                <p id="close-date" class="text-sm text-slate-400 mt-1">Hoje</p>
            </div>
            <div class="p-6">
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between p-3 bg-green-50 rounded border border-green-100"><span class="text-green-800 font-medium">Vendas</span><span id="close-inc" class="font-bold text-green-700">R$ 0,00</span></div>
                    <div class="flex justify-between p-3 bg-red-50 rounded border border-red-100"><span class="text-red-800 font-medium">Custos</span><span id="close-exp" class="font-bold text-red-700">R$ 0,00</span></div>
                    <div class="flex justify-between pt-4 border-t border-slate-200 mt-2"><span class="font-bold text-slate-800 text-lg">Saldo</span><span id="close-bal" class="font-bold text-2xl text-slate-900">R$ 0,00</span></div>
                </div>
                <button onclick="closeModal('closingModal')" class="w-full mt-4 text-slate-400 text-sm hover:text-slate-600">Fechar</button>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        // --- 1. CONFIGURAÇÃO ---
        const DB_KEY = 'plena_artesanato_pro_v5';
        const defaultDB = {
            products: [], materials: [], transactions: [],
            settings: { salary: 0, hoursDay: 0, daysWeek: 0, hourlyRate: 0, ownerName: '' },
            changelog: [{ version: 'v5.3.1', date: '24/01/2026', changes: ['Layout Híbrido Pro', 'Melhoria Mobile'] }]
        };
        let db = JSON.parse(localStorage.getItem(DB_KEY)) || defaultDB;
        let tempMaterials = [];

        // --- 2. UTILITÁRIOS ---
        const save = () => localStorage.setItem(DB_KEY, JSON.stringify(db));
        const fmtMoney = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const fmtDate = (d) => new Date(d).toLocaleDateString('pt-BR');
        const getID = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        const sanitizeHTML = (str) => String(str || '').replace(/[&<>"']/g, '');

        // --- 3. INICIALIZAÇÃO ---
        function init() {
            lucide.createIcons();
            const today = new Date().toISOString().split('T')[0];
            const first = new Date(); first.setDate(1);
            ['t-date', 'rep-end', 'filter-end'].forEach(id => { const el = document.getElementById(id); if(el) el.value = today; });
            if(document.getElementById('rep-start')) document.getElementById('rep-start').value = first.toISOString().split('T')[0];
            if(document.getElementById('filter-start')) document.getElementById('filter-start').value = first.toISOString().split('T')[0];
            document.getElementById('month-selector').value = today.slice(0, 7);

            loadSettings();
            renderDashboard();
            renderSystemTab();
            setInterval(save, 30000);
        }

        // --- 4. ROTEAMENTO ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function router(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-nav'));
            const target = document.getElementById('view-' + view);
            if(target) { target.classList.remove('hide'); target.classList.add('fade-in'); }
            const nav = document.getElementById('nav-' + view);
            if(nav) nav.classList.add('active-nav');
            document.getElementById('page-title').innerText = { dashboard: 'Dashboard', products: 'Meus Produtos', materials: 'Estoque', transactions: 'Caixa', reports: 'Relatórios', settings: 'Configurações' }[view] || 'Plena Artesanato';
            if(window.innerWidth < 1024) { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebar-overlay').classList.remove('active'); }
            
            if(view === 'dashboard') renderDashboard();
            if(view === 'products') renderProducts();
            if(view === 'materials') renderMaterials();
            if(view === 'transactions') renderTransactions();
            if(view === 'settings') loadSettings();
            if(view === 'system') renderSystemTab();
        }

        // --- 5. LÓGICA DE NEGÓCIOS ---
        // Dashboard
        function renderDashboard() {
            const monthVal = document.getElementById('month-selector').value;
            const trans = db.transactions.filter(t => t.date.startsWith(monthVal));
            const income = trans.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const expense = trans.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            document.getElementById('dash-hourly-rate').innerText = fmtMoney(db.settings.hourlyRate || 0);
            document.getElementById('dash-products-count').innerText = db.products.length;
            document.getElementById('dash-revenue').innerText = fmtMoney(income);
            document.getElementById('dash-costs').innerText = fmtMoney(expense);
            renderChart(monthVal);
            renderTopProducts();
            renderRecentProducts();
            lucide.createIcons();
        }

        function renderChart(month) {
            const container = document.getElementById('chart-area');
            const days = [];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dStr = d.toISOString().split('T')[0];
                const dayTrans = db.transactions.filter(t => t.date === dStr);
                days.push({ label: d.getDate(), inc: dayTrans.filter(t => t.type === 'income').reduce((s,t)=>s+t.amount,0), exp: dayTrans.filter(t => t.type === 'expense').reduce((s,t)=>s+t.amount,0) });
            }
            const max = Math.max(...days.map(d => Math.max(d.inc, d.exp)), 100);
            container.innerHTML = days.map(d => `
                <div class="flex-1 flex flex-col justify-end h-full relative group">
                    <div class="flex items-end justify-center gap-1 h-full w-full">
                        <div class="w-3 bg-green-500 rounded-t transition-all duration-500" style="height:${(d.inc/max)*100}%" title="V: ${fmtMoney(d.inc)}"></div>
                        <div class="w-3 bg-red-500 rounded-t transition-all duration-500" style="height:${(d.exp/max)*100}%" title="C: ${fmtMoney(d.exp)}"></div>
                    </div>
                    <div class="text-[10px] text-center text-slate-400 mt-1 font-mono">${d.label}</div>
                </div>
            `).join('');
        }

        function renderTopProducts() {
            const list = document.getElementById('top-products');
            const sorted = [...db.products].sort((a,b) => b.finalPrice - a.finalPrice).slice(0, 3);
            list.innerHTML = sorted.map(p => `
                <div class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded">
                    <div><span class="font-bold">${p.name}</span> <span class="text-slate-400">(${p.category})</span></div>
                    <div class="font-bold text-plena-pink">${fmtMoney(p.finalPrice)}</div>
                </div>
            `).join('') || '<p class="text-slate-400 text-sm">Sem produtos</p>';
        }

        function renderRecentProducts() {
            const list = document.getElementById('recent-products');
            const sorted = [...db.products].reverse().slice(0, 3);
            list.innerHTML = sorted.map(p => `
                <div class="flex justify-between items-center text-sm p-2 hover:bg-slate-50 rounded cursor-pointer" onclick="openProductModal('${p.id}')">
                    <span class="font-medium">${p.name}</span>
                    <span class="text-xs bg-slate-100 px-2 py-1 rounded">Ver</span>
                </div>
            `).join('') || '<p class="text-slate-400 text-sm">Sem produtos recentes</p>';
        }

        // Products & Modal
        function renderProducts() {
            const term = document.getElementById('search-term').value.toLowerCase();
            const filtered = db.products.filter(p => p.name.toLowerCase().includes(term));
            const grid = document.getElementById('products-grid');
            if(filtered.length === 0) { grid.innerHTML = ''; document.getElementById('empty-msg').classList.remove('hidden'); return; }
            document.getElementById('empty-msg').classList.add('hidden');
            grid.innerHTML = filtered.map(p => {
                const matCost = p.materials ? p.materials.reduce((s,m) => s + m.cost, 0) : 0;
                return `
                <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm card-hover cursor-pointer relative group" onclick="openProductModal('${p.id}')">
                    <h3 class="font-bold text-lg text-slate-800 truncate">${p.name}</h3>
                    <p class="text-sm text-slate-500 mb-4">${p.category}</p>
                    <div class="text-xs text-slate-400 mb-4 space-y-1">
                        <p><i data-lucide="clock" class="w-3 h-3 inline"></i> ${p.productionTime}h</p>
                        <p><i data-lucide="layers" class="w-3 h-3 inline"></i> R$ ${matCost.toFixed(2)} mat.</p>
                    </div>
                    <div class="flex justify-between items-center border-t pt-4">
                        <span class="text-xs font-bold uppercase text-slate-400">Preço</span>
                        <span class="font-bold text-xl text-plena-pink">${fmtMoney(p.finalPrice)}</span>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function openProductModal(id) {
            document.querySelector('#productModal form').reset();
            tempMaterials = [];
            document.getElementById('btn-delete-prod').classList.add('hidden');
            if(id) {
                const p = db.products.find(x => x.id === id);
                document.getElementById('pd-id').value = p.id;
                document.getElementById('pd-name').value = p.name;
                document.getElementById('pd-category').value = p.category;
                document.getElementById('pd-time').value = p.productionTime;
                document.getElementById('pd-profit').value = p.profitMargin;
                tempMaterials = p.materials || [];
                document.getElementById('prod-modal-title').textContent = 'Editar Produto';
                document.getElementById('btn-delete-prod').classList.remove('hidden');
            } else {
                document.getElementById('pd-id').value = '';
                document.getElementById('prod-modal-title').textContent = 'Novo Produto';
            }
            renderTempMaterials();
            calculatePrice();
            openModal('productModal');
        }

        function addTempMaterial() {
            const name = document.getElementById('temp-mat-name').value;
            const cost = parseFloat(document.getElementById('temp-mat-cost').value);
            if(name && cost) {
                tempMaterials.push({ id: getID(), name, cost });
                document.getElementById('temp-mat-name').value = '';
                document.getElementById('temp-mat-cost').value = '';
                renderTempMaterials();
                calculatePrice();
            }
        }

        function renderTempMaterials() {
            const list = document.getElementById('materials-list-modal');
            list.innerHTML = tempMaterials.map((m, idx) => `
                <li class="flex justify-between items-center border-b border-slate-100 pb-1">
                    <span>${m.name}</span>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-slate-600">${fmtMoney(m.cost)}</span>
                        <button type="button" onclick="removeTempMaterial(${idx})" class="text-red-500 hover:text-red-700">×</button>
                    </div>
                </li>
            `).join('');
            document.getElementById('display-mat-total').textContent = fmtMoney(tempMaterials.reduce((s,m) => s + m.cost, 0));
        }

        function removeTempMaterial(idx) { tempMaterials.splice(idx, 1); renderTempMaterials(); calculatePrice(); }

        function calculatePrice() {
            const time = parseFloat(document.getElementById('pd-time').value) || 0;
            const profit = parseFloat(document.getElementById('pd-profit').value) || 0;
            const matTotal = tempMaterials.reduce((s,m) => s + m.cost, 0);
            const labor = time * (db.settings.hourlyRate || 0);
            const final = (matTotal + labor) * (1 + profit / 100);
            document.getElementById('display-final-price').textContent = fmtMoney(final);
            document.getElementById('pd-final-price').value = final;
        }

        function submitProduct(e) {
            e.preventDefault();
            const id = document.getElementById('pd-id').value;
            const prod = {
                id: id || getID(),
                name: document.getElementById('pd-name').value,
                category: document.getElementById('pd-category').value,
                productionTime: parseFloat(document.getElementById('pd-time').value),
                profitMargin: parseFloat(document.getElementById('pd-profit').value),
                materials: tempMaterials,
                finalPrice: parseFloat(document.getElementById('pd-final-price').value),
                date: new Date().toISOString()
            };
            if(id) { const idx = db.products.findIndex(x => x.id === id); db.products[idx] = prod; }
            else { db.products.push(prod); }
            save(); closeModal('productModal'); renderProducts(); renderDashboard();
        }

        function deleteProduct() {
            if(!confirm('Excluir produto?')) return;
            const id = document.getElementById('pd-id').value;
            db.products = db.products.filter(x => x.id !== id);
            save(); closeModal('productModal'); renderProducts(); renderDashboard();
        }

        // Materials
        function submitMaterial(e) {
            e.preventDefault();
            const mat = {
                id: getID(),
                name: document.getElementById('mat-name').value,
                category: document.getElementById('mat-category').value,
                cost: parseFloat(document.getElementById('mat-cost').value),
                quantity: parseFloat(document.getElementById('mat-quantity').value),
                unit: document.getElementById('mat-unit').value,
                date: new Date().toISOString()
            };
            db.materials.push(mat);
            save(); e.target.reset(); renderMaterials(); alert('Material cadastrado!');
        }

        function renderMaterials() {
            const term = document.getElementById('mat-search')?.value.toLowerCase() || '';
            const filtered = db.materials.filter(m => m.name.toLowerCase().includes(term));
            const list = document.getElementById('materials-list');
            if(filtered.length === 0) { list.innerHTML = '<p class="text-slate-400 text-sm text-center mt-4">Nenhum material.</p>'; return; }
            list.innerHTML = filtered.map(m => `
                <div class="flex items-center justify-between p-3 border-b border-slate-100 hover:bg-slate-50 transition-colors">
                    <div><p class="font-bold text-slate-800 text-sm">${m.name}</p><p class="text-xs text-slate-500">${m.category} • ${m.quantity} ${m.unit}</p></div>
                    <div class="text-right"><p class="font-bold text-slate-900 text-sm">${fmtMoney(m.cost)}</p></div>
                </div>
            `).join('');
        }

        // Transactions
        function renderTransactions() {
            const term = document.getElementById('trans-search-term').value.toLowerCase();
            const type = document.getElementById('filter-type').value;
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            const list = db.transactions.filter(t => {
                const matchTerm = t.desc.toLowerCase().includes(term);
                const matchType = type === 'all' || t.type === type;
                const matchDate = (!start || t.date >= start) && (!end || t.date <= end);
                return matchTerm && matchType && matchDate;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));

            const inc = list.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const exp = list.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            document.getElementById('filter-income').textContent = fmtMoney(inc);
            document.getElementById('filter-expense').textContent = fmtMoney(exp);
            document.getElementById('filter-balance').textContent = fmtMoney(inc - exp);

            const tbody = document.getElementById('trans-table-body');
            tbody.innerHTML = list.length === 0 ? '' : list.map(t => `
                <tr class="hover:bg-slate-50 border-b border-slate-100">
                    <td class="px-6 py-4 text-slate-500">${fmtDate(t.date)}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${t.desc}</td>
                    <td class="px-6 py-4"><span class="badge ${t.type === 'income' ? 'text-green-700 bg-green-100 px-2 py-1 rounded text-xs' : 'text-red-700 bg-red-100 px-2 py-1 rounded text-xs'}">${t.type === 'income' ? 'Venda' : 'Custo'}</span></td>
                    <td class="px-6 py-4 text-sm text-slate-500">${t.cat || '-'}</td>
                    <td class="px-6 py-4 text-right font-bold ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? '+' : '-'} ${fmtMoney(t.amount)}</td>
                    <td class="px-6 py-4 text-center"><button onclick="deleteTransaction('${t.id}')" class="text-slate-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            if(list.length === 0) document.getElementById('trans-empty-msg').classList.remove('hidden'); else document.getElementById('trans-empty-msg').classList.add('hidden');
            lucide.createIcons();
        }

        function openTransModal() {
            document.querySelector('#transactionModal form').reset();
            document.getElementById('t-id').value = '';
            document.getElementById('t-date').value = new Date().toISOString().split('T')[0];
            openModal('transactionModal');
        }

        function submitTransaction(e) {
            e.preventDefault();
            const t = {
                id: getID(),
                type: document.querySelector('input[name="t-type"]:checked').value,
                amount: parseFloat(document.getElementById('t-amount').value),
                desc: document.getElementById('t-desc').value,
                cat: document.getElementById('t-cat').value,
                method: document.getElementById('t-method').value,
                date: document.getElementById('t-date').value
            };
            db.transactions.push(t);
            save(); closeModal('transactionModal'); renderTransactions(); renderDashboard();
        }

        function deleteTransaction(id) {
            if(!confirm('Excluir?')) return;
            db.transactions = db.transactions.filter(t => t.id !== id);
            save(); renderTransactions(); renderDashboard();
        }

        // Settings
        function loadSettings() {
            document.getElementById('conf-salary').value = db.settings.salary || '';
            document.getElementById('conf-hours-day').value = db.settings.hoursDay || '';
            document.getElementById('conf-days-week').value = db.settings.daysWeek || '';
            document.getElementById('conf-result-rate').textContent = fmtMoney(db.settings.hourlyRate || 0);
            document.getElementById('set-owner-name').value = db.settings.ownerName || '';
            document.getElementById('set-owner-doc').value = db.settings.ownerDoc || '';
        }

        function calculateHourlyRate() {
            const sal = parseFloat(document.getElementById('conf-salary').value) || 0;
            const hours = parseFloat(document.getElementById('conf-hours-day').value) || 0;
            const days = parseFloat(document.getElementById('conf-days-week').value) || 0;
            if(sal && hours && days) {
                const totalHours = hours * days * 4.33;
                const rate = sal / totalHours;
                document.getElementById('conf-result-rate').textContent = fmtMoney(rate);
                return rate;
            }
            return 0;
        }

        function saveSettings() {
            db.settings.salary = parseFloat(document.getElementById('conf-salary').value);
            db.settings.hoursDay = parseFloat(document.getElementById('conf-hours-day').value);
            db.settings.daysWeek = parseFloat(document.getElementById('conf-days-week').value);
            db.settings.hourlyRate = calculateHourlyRate();
            db.settings.ownerName = document.getElementById('set-owner-name').value;
            db.settings.ownerDoc = document.getElementById('set-owner-doc').value;
            save(); alert('Configurações salvas!'); renderDashboard();
        }

        // System & Utils
        function renderSystemTab() {
            const feed = document.getElementById('changelog-feed');
            if(feed) feed.innerHTML = db.changelog.map(log => `<div class="mb-2"><span class="font-bold text-slate-700">${log.version}</span> - ${log.date} <ul class="list-disc pl-5 text-sm text-slate-600">${log.changes.map(c => `<li>${c}</li>`).join('')}</ul></div>`).join('');
        }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openClosingModal() {
            const today = new Date().toISOString().split('T')[0];
            const trans = db.transactions.filter(t => t.date === today);
            const inc = trans.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const exp = trans.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            document.getElementById('close-inc').textContent = fmtMoney(inc);
            document.getElementById('close-exp').textContent = fmtMoney(exp);
            document.getElementById('close-bal').textContent = fmtMoney(inc - exp);
            document.getElementById('close-date').textContent = fmtDate(today);
            openModal('closingModal');
        }
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "backup_plena_artesanato.json");
            document.body.appendChild(node); node.click(); node.remove();
        }
        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try { db = JSON.parse(e.target.result); save(); alert('Restaurado!'); location.reload(); } catch(err) { alert('Erro ao ler arquivo.'); }
            };
            reader.readAsText(file);
        }
        function factoryReset() { if(confirm('Apagar tudo?')) { localStorage.removeItem(DB_KEY); location.reload(); } }
        function checkForUpdates() { alert('Sistema atualizado: v5.3.1'); }
        function exportProductsCSV() { alert('Função CSV disponível em breve.'); }
        function printProducts() { window.print(); }
        function generateReport() {
            const start = document.getElementById('rep-start').value;
            const end = document.getElementById('rep-end').value;
            const list = db.transactions.filter(t => t.date >= start && t.date <= end);
            const inc = list.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const exp = list.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            document.getElementById('rep-inc').textContent = fmtMoney(inc);
            document.getElementById('rep-exp').textContent = fmtMoney(exp);
            document.getElementById('rep-bal').textContent = fmtMoney(inc - exp);
            
            // Category Report
            const cats = {};
            list.forEach(t => { const c = t.cat || 'Outros'; if(!cats[c]) cats[c]=0; cats[c]+=t.amount; });
            document.getElementById('category-report').innerHTML = Object.entries(cats).map(([k,v]) => `<div class="flex justify-between text-sm p-2 bg-slate-50 mb-1"><span>${k}</span><span class="font-bold">${fmtMoney(v)}</span></div>`).join('');
            
            document.getElementById('report-result').classList.remove('hide');
        }
        function shareReport() { alert('Compartilhar via WhatsApp'); }
        function printReport() { window.print(); }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>