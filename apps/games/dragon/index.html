<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Som do Dragão | Plena Arcade</title>
    <!-- LIBS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
    </style>
</head>

<body
    class="bg-zinc-900 text-white min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden select-none">

    <!-- GAME CONTAINER -->
    <div id="game-container"
        class="relative w-full max-w-4xl aspect-video bg-black rounded-lg shadow-2xl overflow-hidden border-4 border-zinc-800 crt">

        <!-- HUD -->
        <div class="absolute top-4 left-4 right-4 flex justify-between items-center z-10 text-xl font-bold">
            <!-- P1 Health -->
            <div class="w-1/3 h-6 bg-red-900 border-2 border-white relative">
                <div id="p1-health" class="h-full bg-yellow-400 transition-all duration-100" style="width: 100%;"></div>
            </div>

            <!-- Timer -->
            <div id="timer" class="text-4xl text-yellow-500 drop-shadow-md">99</div>

            <!-- P2 Health -->
            <div class="w-1/3 h-6 bg-red-900 border-2 border-white relative">
                <div id="p2-health" class="h-full bg-yellow-400 transition-all duration-100" style="width: 100%;"></div>
            </div>
        </div>

        <!-- CANVAS -->
        <canvas id="gameCanvas" class="w-full h-full block bg-slate-800"></canvas>

        <!-- START OVERLAY -->
        <div id="start-screen" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20">
            <h1 class="text-4xl md:text-6xl text-yellow-500 mb-8 text-center leading-snug">SOM DO<br>DRAGÃO</h1>
            <p class="text-zinc-400 text-center mb-8 text-xs md:text-sm max-w-md leading-relaxed">
                Use FONES DE OUVIDO para a experiência completa.<br><br>
                [ESPAÇO] Ataque<br>
                [SETAS] Movimento<br>
                [ESC] Defesa
            </p>
            <button onclick="startGame()"
                class="bg-red-600 hover:bg-red-700 text-white px-8 py-4 text-xl border-4 border-white animate-pulse">
                INSERT COIN
            </button>
            <div class="mt-8 flex gap-4">
                <button onclick="toggleAccessibility()"
                    class="text-xs text-zinc-500 hover:text-white border border-zinc-700 px-4 py-2 rounded">
                    <i class="fa-solid fa-eye-slash"></i> Modo Alto Contraste
                </button>
            </div>
        </div>

        <!-- GAME OVER OVERLAY -->
        <div id="game-over-screen"
            class="hidden absolute inset-0 bg-black/90 flex flex-col items-center justify-center z-20">
            <h2 id="winner-text" class="text-4xl text-yellow-500 mb-8">PLAYER WINS</h2>
            <button onclick="resetGame()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 border-4 border-white">
                TRY AGAIN
            </button>
        </div>

    </div>

    <!-- CONTROLS MOBILE (Visible only on touch) -->
    <div class="md:hidden mt-8 flex w-full max-w-4xl justify-between px-4 gap-4">
        <div class="flex gap-2">
            <button ontouchstart="input.left=true" ontouchend="input.left=false"
                class="w-16 h-16 bg-zinc-800 rounded-full border-2 border-zinc-600 active:bg-zinc-700"><i
                    class="fa-solid fa-arrow-left"></i></button>
            <button ontouchstart="input.right=true" ontouchend="input.right=false"
                class="w-16 h-16 bg-zinc-800 rounded-full border-2 border-zinc-600 active:bg-zinc-700"><i
                    class="fa-solid fa-arrow-right"></i></button>
        </div>
        <div class="flex gap-2">
            <button ontouchstart="input.block=true" ontouchend="input.block=false"
                class="w-16 h-16 bg-blue-900 rounded-full border-2 border-blue-700 active:bg-blue-800"><i
                    class="fa-solid fa-shield"></i></button>
            <button ontouchstart="playerAttack()"
                class="w-20 h-20 bg-red-800 rounded-full border-4 border-red-600 active:bg-red-700"><i
                    class="fa-solid fa-fist-raised"></i></button>
        </div>
    </div>

    <!-- AUDIO ENGINE (Web Audio API) -->
    <script>
        // --- GAME LOGIC ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let gameHeight, gameWidth;
        // Resize logic
        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            gameWidth = canvas.width;
            gameHeight = canvas.height;
        }
        window.addEventListener('resize', resize);
        resize();

        // State
        let playing = false;
        let highContrast = false;
        let frame = 0;
        let audioCtx;

        const player = { x: 100, y: 0, w: 50, h: 100, color: '#3B82F6', hp: 100, state: 'idle', facing: 1 };
        const enemy = { x: 300, y: 0, w: 50, h: 100, color: '#EF4444', hp: 100, state: 'idle', facing: -1, moveTimer: 0 };
        const input = { left: false, right: false, block: false };

        // Audio Synth
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playTone(freq, type, duration, panVal = 0) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const panner = audioCtx.createStereoPanner();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);

            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);

            panner.pan.value = panVal;

            osc.connect(gain);
            gain.connect(panner);
            panner.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // Accessibility Audio Cues
        function updateAudioCues() {
            if (frame % 30 === 0 && playing) {
                // Enemy Proximity Radar
                const dist = Math.abs(player.x - enemy.x);
                const pan = (enemy.x - player.x) / (gameWidth / 2); // -1 to 1 based on screen position relative to player

                // Beep speed based on distance
                // Closer = Higher pitch beep
                const freq = 200 + (100000 / (dist + 100));
                playTone(freq, 'sine', 0.1, Math.max(-1, Math.min(1, pan)));
            }
        }

        function startGame() {
            initAudio();
            document.getElementById('start-screen').style.display = 'none';
            playing = true;
            loop();
            // TTS
            const u = new SpeechSynthesisUtterance("Luta!");
            u.lang = 'pt-BR';
            window.speechSynthesis.speak(u);
        }

        function resetGame() {
            player.hp = 100;
            enemy.hp = 100;
            player.x = gameWidth * 0.2;
            enemy.x = gameWidth * 0.8;
            document.getElementById('game-over-screen').classList.add('hidden');
            playing = true;
            loop();
        }

        function toggleAccessibility() {
            highContrast = !highContrast;
            if (highContrast) {
                document.body.style.filter = "grayscale(100%) contrast(150%)";
            } else {
                document.body.style.filter = "none";
            }
        }

        // Input
        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') input.left = true;
            if (e.key === 'ArrowRight') input.right = true;
            if (e.key === ' ') playerAttack();
            if (e.key === 'Escape') input.block = true;
        });
        window.addEventListener('keyup', e => {
            if (e.key === 'ArrowLeft') input.left = false;
            if (e.key === 'ArrowRight') input.right = false;
            if (e.key === 'Escape') input.block = false;
        });

        function playerAttack() {
            if (player.state !== 'idle') return;
            player.state = 'attack';
            playTone(400, 'square', 0.1); // Attack sound

            // Hitbox check
            if (Math.abs(player.x - enemy.x) < 80) {
                if (enemy.state === 'block') {
                    playTone(100, 'sawtooth', 0.1); // Block sound (dull)
                } else {
                    enemy.hp -= 10;
                    playTone(800, 'sawtooth', 0.2); // Hit sound
                    enemy.state = 'hit';
                    setTimeout(() => enemy.state = 'idle', 300);
                }
            }

            setTimeout(() => player.state = 'idle', 300);
        }

        function enemyAI() {
            // Simple AI
            const dist = player.x - enemy.x;

            if (Math.abs(dist) > 60) {
                // Move towards player
                enemy.x += dist > 0 ? 2 : -2;
            } else {
                // Attack range
                if (Math.random() < 0.02 && enemy.state === 'idle') {
                    // Attack
                    enemy.state = 'attack';
                    if (!input.block) {
                        player.hp -= 15;
                        playTone(150, 'sawtooth', 0.3); // Player gets hit low pitch
                    } else {
                        playTone(100, 'sawtooth', 0.1); // Blocked
                    }
                    setTimeout(() => enemy.state = 'idle', 500);
                }
            }
            // Keep on screen
            enemy.x = Math.max(0, Math.min(gameWidth - enemy.w, enemy.x));
        }

        function update() {
            if (!playing) return;

            // Player Move
            if (input.left) player.x -= 4;
            if (input.right) player.x += 4;
            player.x = Math.max(0, Math.min(gameWidth - player.w, player.x));

            enemyAI();

            // Check Win/Loss
            if (player.hp <= 0 || enemy.hp <= 0) {
                playing = false;
                const winner = player.hp > 0 ? "VOCÊ VENCEU" : "VOCÊ PERDEU";
                document.getElementById('winner-text').innerText = winner;
                document.getElementById('game-over-screen').classList.remove('hidden');

                const u = new SpeechSynthesisUtterance(winner.toLowerCase());
                u.lang = 'pt-BR';
                window.speechSynthesis.speak(u);
            }

            // HUD
            document.getElementById('p1-health').style.width = player.hp + "%";
            document.getElementById('p2-health').style.width = enemy.hp + "%";

            updateAudioCues();
            frame++;
        }

        function draw() {
            // Background
            if (highContrast) {
                ctx.fillStyle = '#000';
            } else {
                ctx.fillStyle = '#1e293b';
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Floor
            ctx.fillStyle = highContrast ? '#fff' : '#334155';
            ctx.fillRect(0, gameHeight - 20, gameWidth, 20);

            // Player
            ctx.fillStyle = highContrast ? '#fff' : (player.state === 'attack' ? '#60A5FA' : player.color);
            ctx.fillRect(player.x, gameHeight - 20 - player.h, player.w, player.h);

            // Attack Visual
            if (player.state === 'attack') {
                ctx.fillStyle = '#FFFF00';
                ctx.fillRect(player.x + (player.w), gameHeight - 80, 40, 20);
            }

            // Enemy
            ctx.fillStyle = highContrast ? '#fff' : (enemy.state === 'attack' ? '#F87171' : enemy.color);
            if (highContrast) ctx.strokeStyle = '#fff'; // hollow for enemy in HC? No, maybe texture.
            // Let's make enemy striped in HC
            ctx.fillRect(enemy.x, gameHeight - 20 - enemy.h, enemy.w, enemy.h);
        }

        function loop() {
            if (!playing) return;
            update();
            draw();
            requestAnimationFrame(loop);
        }

    </script>
</body>

</html>