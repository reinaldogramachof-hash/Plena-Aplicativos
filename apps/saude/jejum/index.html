<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jejum Intermitente | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #111827;
            color: white;
            font-family: 'Segoe UI', sans-serif;
        }

        [v-cloak] {
            display: none;
        }
    </style>
    <script src="../../../assets/js/plena-lock.js"></script>
</head>

<body class="pb-20">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen flex flex-col items-center p-6">

        <header class="w-full flex justify-between items-center mb-8">
            <h1 class="text-xl font-bold text-teal-400"><i class="fa-solid fa-clock"></i> Jejum Pro</h1>
            <div class="flex gap-4 text-xs font-bold bg-gray-800 rounded-full p-1">
                <button v-for="p in protocols" @click="setProtocol(p)"
                    :class="protocol.label === p.label ? 'bg-teal-600 text-white' : 'text-gray-400'"
                    class="px-3 py-1 rounded-full transition">{{ p.label }}</button>
            </div>
        </header>

        <!-- TIMER -->
        <div class="relative w-64 h-64 flex items-center justify-center mb-10">
            <!-- Ring -->
            <svg class="w-full h-full transform -rotate-90">
                <circle cx="128" cy="128" r="120" stroke="currentColor" stroke-width="8" fill="transparent"
                    class="text-gray-800" />
                <circle cx="128" cy="128" r="120" stroke="currentColor" stroke-width="8" fill="transparent"
                    :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset"
                    class="text-teal-500 transition-all duration-1000" />
            </svg>

            <!-- Center Text -->
            <div class="absolute text-center">
                <div v-if="isActive" class="text-teal-400 text-xs font-bold uppercase tracking-widest animate-pulse">
                    Jejum Ativo</div>
                <div v-else class="text-gray-500 text-xs font-bold uppercase tracking-widest">Descanso</div>

                <div class="text-5xl font-mono font-bold my-2">{{ formattedTime }}</div>

                <div class="text-xs text-gray-400 flex flex-col">
                    <span>Meta: {{ protocol.hours }}h</span>
                    <span v-if="isActive">Início: {{ startTimeFormatted }}</span>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <button v-if="!isActive" @click="startFast"
            class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-4 rounded-full shadow-lg shadow-teal-900/50 mb-4 text-lg">
            INICIAR JEJUM
        </button>
        <button v-else @click="stopFast"
            class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-full shadow-lg shadow-red-900/50 mb-4 text-lg">
            ENCERRAR JEJUM
        </button>

        <!-- HISTORY -->
        <div class="w-full mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-gray-400 font-bold uppercase text-xs">Histórico Recente</h3>
                <span class="text-xs text-teal-600">{{ history.length }} jejuns</span>
            </div>

            <div class="space-y-3">
                <div v-for="(h, idx) in history.slice(0, 5)" :key="idx"
                    class="bg-gray-800 p-4 rounded-xl flex justify-between items-center border border-gray-700">
                    <div>
                        <div class="text-sm font-bold text-gray-300">{{ formatDate(h.end) }}</div>
                        <div class="text-xs text-gray-500">{{ h.protocol }} ({{ formatDuration(h.duration) }})</div>
                    </div>
                    <div v-if="h.duration >= h.target * 3600000" class="text-green-400 text-xl"><i
                            class="fa-solid fa-check-circle"></i></div>
                    <div v-else class="text-yellow-500 text-xl"><i class="fa-solid fa-person-running"></i></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                const protocols = [
                    { label: "14:10", hours: 14 },
                    { label: "16:8", hours: 16 },
                    { label: "18:6", hours: 18 },
                    { label: "20:4", hours: 20 }
                ];

                const protocol = ref(protocols[1]); // Default 16:8
                const isActive = ref(false);
                const startTime = ref(null);
                const elapsed = ref(0);
                const history = ref([]);
                const timer = ref(null);

                const circumference = 2 * Math.PI * 120;

                const setProtocol = (p) => {
                    if (isActive.value && !confirm("Mudar protocolo vai reiniciar o timer visual. Continuar?")) return;
                    protocol.value = p;
                };

                const startFast = () => {
                    startTime.value = Date.now();
                    isActive.value = true;
                    elapsed.value = 0;
                    tick();
                };

                const stopFast = () => {
                    isActive.value = false;
                    history.value.unshift({
                        start: startTime.value,
                        end: Date.now(),
                        duration: elapsed.value,
                        target: protocol.value.hours,
                        protocol: protocol.value.label
                    });
                    elapsed.value = 0;
                    startTime.value = null;
                };

                const tick = () => {
                    if (!isActive.value) return;
                    elapsed.value = Date.now() - startTime.value;
                    timer.value = requestAnimationFrame(tick);
                };

                onUnmounted(() => cancelAnimationFrame(timer.value));

                const formattedTime = computed(() => {
                    const totalSecs = Math.floor(elapsed.value / 1000);
                    const h = Math.floor(totalSecs / 3600);
                    const m = Math.floor((totalSecs % 3600) / 60);
                    const s = totalSecs % 60;
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                });

                const startTimeFormatted = computed(() => {
                    if (!startTime.value) return '';
                    return new Date(startTime.value).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                });

                const dashOffset = computed(() => {
                    const totalMs = protocol.value.hours * 3600000;
                    const progress = Math.min(elapsed.value / totalMs, 1);
                    return circumference - (progress * circumference);
                });

                const formatDate = (ts) => new Date(ts).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });

                const formatDuration = (ms) => {
                    const h = (ms / 3600000).toFixed(1);
                    return `${h}h`;
                };

                // Persistence
                onMounted(() => {
                    const d = localStorage.getItem('plena_fasting');
                    if (d) {
                        const p = JSON.parse(d);
                        history.value = p.history || [];
                        if (p.active) {
                            isActive.value = true;
                            startTime.value = p.start;
                            protocol.value = protocols.find(x => x.label === p.protocolLabel) || protocols[1];
                            tick();
                        }
                    }
                });

                watch([history, isActive, startTime, protocol], () => {
                    localStorage.setItem('plena_fasting', JSON.stringify({
                        history: history.value,
                        active: isActive.value,
                        start: startTime.value,
                        protocolLabel: protocol.value.label
                    }));
                }, { deep: true });

                return { protocols, protocol, isActive, formattedTime, startTimeFormatted, setProtocol, startFast, stopFast, circumference, dashOffset, history, formatDate, formatDuration };
            }
        }).mount('#app');
    </script>
</body>

</html>