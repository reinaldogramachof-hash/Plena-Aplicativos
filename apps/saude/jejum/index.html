<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jejum Intermitente | Plena Aplicativos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        fast: { 50: '#ecfeff', 100: '#cffafe', 400: '#22d3ee', 500: '#06b6d4', 600: '#0891b2', 900: '#164e63' },
                        eat: { 500: '#84cc16', 600: '#65a30d' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #ecfeff;
            color: #164e63;
            user-select: none;
        }

        ::-webkit-scrollbar {
            width: 0px;
        }

        .progress-ring__circle {
            transition: stroke-dashoffset 0.5s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <div id="app" class="flex-1 flex h-full w-full relative">

        <!-- Sidebar -->
        <aside class="w-full md:w-[400px] bg-white border-r border-fast-100 z-10 flex flex-col h-full shadow-xl">
            <div class="p-6 border-b border-fast-50 flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-fast-500 rounded-full flex items-center justify-center text-white shadow-lg shadow-fast-500/30">
                    <i class="fa-solid fa-infinity text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl text-fast-900 tracking-tight">Jejum <span
                            class="text-fast-500">Fácil</span></h1>
                    <p class="text-xs text-fast-400">Rastreador de Jejum</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-8">

                <!-- Protocol Selection -->
                <div class="space-y-3">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Protocolo de Jejum</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button v-for="p in protocols" :key="p.hours" @click="setProtocol(p)"
                            :class="targetHours === p.hours ? 'bg-fast-500 text-white shadow-md ring-2 ring-fast-200' : 'bg-slate-50 text-slate-600 hover:bg-fast-50 hover:text-fast-600'"
                            class="p-4 rounded-2xl transition flex flex-col items-center justify-center gap-1 border border-transparent">
                            <span class="font-black text-2xl">{{ p.label }}</span>
                            <span class="text-[10px] uppercase font-bold opacity-80">{{ p.name }}</span>
                        </button>
                    </div>
                </div>

                <!-- Custom Time Adjustment -->
                <div class="bg-fast-50 rounded-2xl p-4 border border-fast-100" v-if="!isActive">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-fast-900">Início Personalizado</span>
                        <span class="text-xs text-fast-500 bg-white px-2 py-0.5 rounded border border-fast-100">Agora:
                            {{ nowFormatted }}</span>
                    </div>
                    <div class="flex gap-2">
                        <input v-model="customStartDate" type="datetime-local"
                            class="w-full bg-white border border-fast-200 rounded-lg px-3 py-2 text-sm text-fast-900 outline-none focus:border-fast-500">
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                        <div class="text-indigo-400 text-xs font-bold uppercase mb-1">Jejuns Completos</div>
                        <div class="text-2xl font-black text-indigo-900">{{ history.length }}</div>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                        <div class="text-emerald-500 text-xs font-bold uppercase mb-1">Média Horas</div>
                        <div class="text-2xl font-black text-emerald-900">{{ avgHours }}h</div>
                    </div>
                </div>

            </div>

            <!-- History Toggle Button (Mobile) or Footer -->
            <div class="p-6 border-t border-fast-50 bg-white z-20">
                <button @click="showHistory = !showHistory"
                    class="w-full py-3 text-sm font-bold text-slate-400 hover:text-fast-600 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i> {{ showHistory ? 'Ocultar Histórico' : 'Ver Histórico'
                    }}
                </button>
            </div>
        </aside>

        <!-- Main Display -->
        <main
            class="flex-1 bg-gradient-to-br from-fast-50 to-white flex flex-col items-center justify-center p-6 relative overflow-hidden">

            <!-- Circular Timer -->
            <div class="relative w-72 h-72 md:w-96 md:h-96 flex items-center justify-center">
                <!-- SVG Ring -->
                <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                    <!-- Background Track -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#e2e8f0" stroke-width="4" />
                    <!-- Progress Bar -->
                    <circle cx="50" cy="50" r="45" fill="none" :stroke="progressColor" stroke-width="4"
                        stroke-linecap="round" :stroke-dasharray="circumference" :stroke-dashoffset="dashOffset"
                        class="transition-all duration-1000 ease-linear" />
                </svg>

                <!-- Inner Content -->
                <div class="flex flex-col items-center justify-center z-10 text-center">

                    <div v-if="isActive">
                        <div class="text-sm font-bold uppercase tracking-widest mb-2"
                            :class="isEating ? 'text-eat-600' : 'text-fast-600'">
                            {{ isEating ? 'Janela Alimentar' : 'Em Jejum' }}
                        </div>

                        <div class="text-6xl md:text-7xl font-black text-slate-800 tabular-nums leading-none mb-2">{{
                            timerDisplay }}</div>

                        <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Meta: {{ formatTime(endTime) }}
                        </div>

                        <div v-if="progress >= 100 && !isEating" class="mt-4 animate-bounce">
                            <span
                                class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                                <i class="fa-solid fa-trophy"></i> META ATINGIDA!
                            </span>
                        </div>
                        <div v-if="isEating" class="mt-4">
                            <span class="bg-eat-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg">
                                <i class="fa-solid fa-utensils"></i> HORA DE COMER
                            </span>
                        </div>
                    </div>

                    <div v-else>
                        <div class="text-slate-300 text-6xl mb-4"><i class="fa-solid fa-power-off"></i></div>
                        <div class="text-xl font-bold text-slate-400">Pronto para começar?</div>
                    </div>

                </div>

                <!-- Glow Effect -->
                <div v-if="isActive"
                    class="absolute inset-0 bg-fast-400 blur-3xl opacity-10 rounded-full animate-pulse pointer-events-none">
                </div>

            </div>

            <!-- Action Button -->
            <div class="mt-12 z-20">
                <button v-if="!isActive" @click="startFast"
                    class="bg-fast-500 hover:bg-fast-400 text-white text-xl font-bold py-4 px-12 rounded-full shadow-[0_10px_40px_-10px_rgba(6,182,212,0.5)] transition hover:scale-105 active:scale-95 flex items-center gap-3">
                    <i class="fa-solid fa-play"></i> INICIAR JEJUM
                </button>
                <button v-else @click="endFast"
                    class="bg-white hover:bg-red-50 text-slate-800 hover:text-red-500 border border-slate-200 text-lg font-bold py-4 px-10 rounded-full shadow-lg transition hover:scale-105 active:scale-95 flex items-center gap-3">
                    <i class="fa-solid fa-stop"></i> {{ isEating ? 'ENCERRAR JANELA' : 'QUEBRAR JEJUM' }}
                </button>
            </div>

            <!-- Edit Start Time (Small) -->
            <button v-if="isActive" @click="editStartTime"
                class="mt-6 text-xs text-slate-400 hover:text-fast-600 underline decoration-dashed">
                Ajustar Início ({{ formatTime(startTime) }})
            </button>


        </main>

        <!-- History Overlay -->
        <div v-if="showHistory"
            class="absolute inset-0 bg-white/95 backdrop-blur z-50 flex flex-col p-6 animate-fade-in md:w-[400px] md:border-r md:shadow-2xl md:left-0 md:bg-white md:backdrop-blur-none">
            <div class="flex justify-between items-center mb-6">
                <h2 class="font-bold text-2xl text-slate-800">Histórico</h2>
                <button @click="showHistory = false"
                    class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200"><i
                        class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto space-y-3">
                <div v-for="(entry, idx) in history" :key="idx"
                    class="bg-slate-50 border border-slate-100 p-4 rounded-xl flex justify-between items-center">
                    <div>
                        <div class="text-xs text-slate-400 font-bold mb-1">{{ formatDate(entry.end) }}</div>
                        <div class="font-black text-lg text-slate-700">{{ entry.duration }}h <span
                                class="text-sm font-normal text-slate-500">jejum</span></div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] bg-white px-2 py-1 rounded border border-slate-200 text-slate-500 mb-1">
                            {{ entry.protocol }}</div>
                        <div v-if="entry.reachedGoal" class="text-emerald-500 text-lg"><i
                                class="fa-solid fa-circle-check"></i></div>
                        <div v-else class="text-orange-300 text-lg"><i class="fa-solid fa-circle-minus"></i></div>
                    </div>
                </div>

                <div v-if="history.length === 0" class="text-center py-10 text-slate-400 opacity-50">
                    <i class="fa-solid fa-ghost text-4xl mb-2"></i>
                    <p>Nenhum jejum registrado ainda.</p>
                </div>
            </div>

            <button @click="clearHistory"
                class="mt-4 text-xs text-red-300 hover:text-red-500 text-center w-full py-2">Apagar Histórico</button>

        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted, watch } = Vue;
        const DB_KEY = 'plena_jejum_v1';

        createApp({
            setup() {
                // Config
                const protocols = [
                    { hours: 13, label: '13:11', name: 'Circadiano' },
                    { hours: 16, label: '16:8', name: 'Leangains' },
                    { hours: 18, label: '18:6', name: 'Avançado' },
                    { hours: 20, label: '20:4', name: 'Guerreiro' },
                    { hours: 24, label: '24h', name: 'Monge' }
                ];

                // State
                const targetHours = ref(16);
                const startTime = ref(null);
                const endTime = ref(null);
                const isActive = ref(false);
                const isEating = ref(false); // New state? For now simplifying: Active = Fasting.
                // When "Ending Fast", we could start "Eating Window" timer... keeping simple first.

                const history = ref([]);
                const showHistory = ref(false);
                const customStartDate = ref('');

                // Timer
                const now = ref(Date.now());
                let timerInterval = null;

                onMounted(() => {
                    const d = localStorage.getItem(DB_KEY);
                    if (d) {
                        const parsed = JSON.parse(d);
                        history.value = parsed.history || [];
                        if (parsed.activeSession) {
                            targetHours.value = parsed.activeSession.targetHours;
                            startTime.value = parsed.activeSession.startTime;
                            endTime.value = parsed.activeSession.endTime;
                            isActive.value = true;
                        }
                    }

                    // Init custom date to now
                    const tzOffset = (new Date()).getTimezoneOffset() * 60000;
                    customStartDate.value = (new Date(Date.now() - tzOffset)).toISOString().slice(0, 16);

                    timerInterval = setInterval(() => {
                        now.value = Date.now();
                        // Auto finish visually if reached? No, keep counting up.
                    }, 1000);
                });

                watch([history, isActive, startTime, endTime, targetHours], () => {
                    const data = {
                        history: history.value,
                        activeSession: isActive.value ? {
                            targetHours: targetHours.value,
                            startTime: startTime.value,
                            endTime: endTime.value
                        } : null
                    };
                    localStorage.setItem(DB_KEY, JSON.stringify(data));
                });

                // Computed
                const circumference = 2 * Math.PI * 45; // r=45

                const totalDurationMs = computed(() => (targetHours.value * 60 * 60 * 1000));

                const elapsedMs = computed(() => {
                    if (!startTime.value) return 0;
                    return now.value - startTime.value;
                });

                const progress = computed(() => {
                    if (!isActive.value) return 0;
                    let p = (elapsedMs.value / totalDurationMs.value) * 100;
                    // Cap at 100 for circle visual usually, but sticking to 100 max for dashoffset logic
                    return p;
                });

                const dashOffset = computed(() => {
                    // Stroke Dashoffset: 100 = empty, 0 = full (if circle is 100 length)
                    // Circumference ~ 282.7
                    // Empty = 282.7
                    // Full = 0
                    const max = circumference;
                    const p = Math.min(progress.value, 100);
                    return max - (p / 100) * max;
                });

                const progressColor = computed(() => {
                    if (progress.value >= 100) return '#84cc16'; // Green
                    return '#06b6d4'; // Cyan
                });

                const timerDisplay = computed(() => {
                    if (!startTime.value) return '00:00:00';
                    const ms = elapsedMs.value;
                    const h = Math.floor(ms / 3600000);
                    const m = Math.floor((ms % 3600000) / 60000);
                    const s = Math.floor((ms % 60000) / 1000);
                    return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                });

                const avgHours = computed(() => {
                    if (!history.value.length) return 0;
                    const total = history.value.reduce((acc, cur) => acc + parseFloat(cur.duration), 0);
                    return (total / history.value.length).toFixed(1);
                });

                const nowFormatted = computed(() => {
                    return new Date(now.value).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                });

                // Methods
                const setProtocol = (p) => {
                    if (isActive.value) return;
                    targetHours.value = p.hours;
                };

                const startFast = () => {
                    const start = new Date(customStartDate.value).getTime();
                    // If custom date is in future, warn? Na, just allow it or clamp to now.
                    // If start is way in past, auto-complete?
                    startTime.value = start;
                    endTime.value = start + (targetHours.value * 3600000);
                    isActive.value = true;

                    // Confetti if starting!
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
                };

                const endFast = () => {
                    if (!confirm('Deseja encerrar o jejum agora?')) return;

                    const durationMs = now.value - startTime.value;
                    const durationH = (durationMs / 3600000).toFixed(1);
                    const reached = durationMs >= (totalDurationMs.value);

                    history.value.unshift({
                        start: startTime.value,
                        end: now.value,
                        duration: durationH,
                        protocol: `${targetHours.value}h`,
                        reachedGoal: reached
                    });

                    if (reached) {
                        confetti({ particleCount: 150, spread: 100, colors: ['#84cc16', '#22d3ee'] });
                    }

                    isActive.value = false;
                    startTime.value = null;
                    endTime.value = null;
                };

                const editStartTime = () => {
                    const newVal = prompt("Editar Hora de Início (HH:MM)?", new Date(startTime.value).toTimeString().substring(0, 5));
                    if (newVal) {
                        const [h, m] = newVal.split(':');
                        const newStart = new Date(startTime.value);
                        newStart.setHours(h);
                        newStart.setMinutes(m);
                        startTime.value = newStart.getTime();
                        endTime.value = startTime.value + (targetHours.value * 3600000);
                    }
                };

                const formatTime = (ts) => {
                    if (!ts) return '--:--';
                    return new Date(ts).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                };

                const formatDate = (ts) => {
                    const d = new Date(ts);
                    return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                };

                const clearHistory = () => {
                    if (confirm('Apagar todo o histórico?')) history.value = [];
                };

                return {
                    protocols, targetHours, startTime, endTime, isActive, isEating,
                    history, showHistory, customStartDate, nowFormatted,
                    circumference, dashOffset, progressColor, timerDisplay, progress,
                    setProtocol, startFast, endFast, editStartTime,
                    formatTime, formatDate, avgHours, clearHistory
                };
            }
        }).mount('#app');
    </script>
</body>

</html>