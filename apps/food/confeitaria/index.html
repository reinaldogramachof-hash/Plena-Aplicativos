<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confeitaria Lucrativa | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #fff0f5;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Lavender theme */
        [v-cloak] {
            display: none;
        }
    </style>
    <script src="../../../assets/js/plena-lock.js"></script>
</head>

<body class="pb-20">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">

        <header class="bg-pink-400 text-white p-6 rounded-b-3xl mb-6 shadow-md relative">
            <h1 class="text-2xl font-bold flex items-center gap-2"><i class="fa-solid fa-cake-candles"></i> Confeitaria
                Pro</h1>
            <p class="text-pink-100 text-sm">Precifica√ß√£o e Estoque</p>

            <div class="absolute top-6 right-6 flex gap-2">
                <button @click="backupData" class="bg-pink-500 hover:bg-pink-600 p-2 rounded-full shadow transition"
                    title="Backup"><i class="fa-solid fa-download"></i></button>
                <label class="bg-pink-500 hover:bg-pink-600 p-2 rounded-full shadow transition cursor-pointer"
                    title="Restore">
                    <i class="fa-solid fa-upload"></i>
                    <input type="file" @change="restoreData" class="hidden" accept=".json">
                </label>
            </div>
        </header>

        <!-- TABS -->
        <div class="px-6 flex gap-2 mb-6">
            <button @click="tab='calculator'"
                :class="tab==='calculator' ? 'bg-pink-500 text-white' : 'bg-pink-100 text-pink-500'"
                class="flex-1 py-2 rounded-xl font-bold transition">Precificar</button>
            <button @click="tab='stock'" :class="tab==='stock' ? 'bg-pink-500 text-white' : 'bg-pink-100 text-pink-500'"
                class="flex-1 py-2 rounded-xl font-bold transition">Estoque</button>
        </div>

        <!-- CALCULATOR -->
        <div v-if="tab==='calculator'" class="px-6 flex-grow">
            <div class="bg-pink-50 p-4 rounded-xl border border-pink-100 mb-6">
                <h3 class="font-bold text-pink-600 mb-3">Ingredientes do Bolo/Doce</h3>
                <div class="space-y-2 mb-4">
                    <div v-for="(ing, idx) in recipe" :key="idx" class="flex gap-2">
                        <input v-model="ing.name" type="text" placeholder="Item"
                            class="flex-grow p-2 rounded text-sm outline-none">
                        <input v-model.number="ing.cost" type="number" placeholder="R$"
                            class="w-20 p-2 rounded text-sm outline-none">
                        <button @click="recipe.splice(idx,1)" class="text-gray-400"><i
                                class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <button @click="recipe.push({name:'', cost:null})"
                    class="bg-white text-pink-500 w-full py-2 rounded font-bold border border-pink-200 hover:bg-pink-100">+
                    Ingrediente</button>
            </div>

            <!-- Pricing Logic -->
            <div class="space-y-4">
                <div class="flex justify-between items-center text-gray-600">
                    <span>Custo Ingredientes:</span>
                    <span class="font-bold">R$ {{ totalCost.toFixed(2) }}</span>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-gray-600 text-sm">Margem Lucro (%):</span>
                    <input v-model.number="margin" type="number" class="w-16 p-1 border rounded text-center">
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-gray-600 text-sm">Embalagem/Extra (R$):</span>
                    <input v-model.number="extra" type="number" class="w-16 p-1 border rounded text-center">
                </div>

                <div class="bg-green-100 p-4 rounded-xl text-center border border-green-200 mt-4">
                    <p class="text-green-700 uppercase text-xs font-bold">Pre√ßo de Venda Sugerido</p>
                    <p class="text-3xl font-bold text-green-700">R$ {{ suggestedPrice.toFixed(2) }}</p>
                </div>
            </div>

            <button @click="shareQuote" class="w-full bg-green-500 text-white font-bold py-3 mt-6 rounded-xl shadow">
                <i class="fa-brands fa-whatsapp"></i> Compartilhar Or√ßamento
            </button>
        </div>

        <!-- STOCK -->
        <div v-if="tab==='stock'" class="px-6 flex-grow">
            <!-- Add Item -->
            <div class="flex gap-2 mb-4">
                <input v-model="newItem" placeholder="Novo Ingrediente"
                    class="flex-grow p-2 bg-gray-50 rounded border outline-none">
                <input v-model="newExpiry" type="date" class="bg-gray-50 rounded border outline-none p-1">
                <button @click="addStock" class="bg-pink-500 text-white px-4 rounded font-bold"><i
                        class="fa-solid fa-plus"></i></button>
            </div>

            <div class="space-y-3 overflow-y-auto">
                <div v-for="(item, idx) in stock" :key="idx"
                    class="bg-white border rounded-xl p-3 flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-bold text-gray-800">{{ item.name }}</p>
                        <p class="text-xs" :class="getExpiryColor(item.expiry)">Validade: {{ formatDate(item.expiry) }}
                        </p>
                    </div>
                    <button @click="stock.splice(idx,1)" class="text-gray-300 hover:text-red-500"><i
                            class="fa-solid fa-trash"></i></button>
                </div>
                <div v-if="stock.length === 0" class="text-center text-gray-400 italic py-4">Estoque vazio.</div>
            </div>
            <div class="mt-4 bg-yellow-50 p-3 rounded text-xs text-yellow-700 italic border border-yellow-200">
                <i class="fa-solid fa-circle-info"></i> Itens pr√≥ximos do vencimento aparecem em vermelho/laranja.
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const tab = ref('calculator');
                const recipe = ref([{ name: 'Farinha', cost: 2.50 }, { name: 'Ovos', cost: 1.00 }]);
                const margin = ref(100);
                const extra = ref(2.00);

                const stock = ref([]);
                const newItem = ref('');
                const newExpiry = ref('');

                // Computed
                const totalCost = computed(() => recipe.value.reduce((a, b) => a + (b.cost || 0), 0));

                const suggestedPrice = computed(() => {
                    const base = totalCost.value + (extra.value || 0);
                    return base + (base * (margin.value / 100));
                });

                // Actions
                const addStock = () => {
                    if (!newItem.value || !newExpiry.value) return;
                    stock.value.push({
                        name: newItem.value,
                        expiry: newExpiry.value
                    });
                    newItem.value = '';
                    newExpiry.value = '';
                };

                const getExpiryColor = (dateStr) => {
                    const d = new Date(dateStr);
                    const today = new Date();
                    const diff = (d - today) / (1000 * 60 * 60 * 24);
                    if (diff < 0) return 'text-red-600 font-bold'; // Expired
                    if (diff < 7) return 'text-orange-500 font-bold'; // Close
                    return 'text-green-600';
                };

                const formatDate = (ds) => {
                    if (!ds) return '-';
                    const p = ds.split('-');
                    return `${p[2]}/${p[1]}/${p[0]}`;
                };

                const shareQuote = () => {
                    let text = `üç∞ *Or√ßamento Confeitaria*\n\n` +
                        `Pre√ßo Final: *R$ ${suggestedPrice.value.toFixed(2)}*\n\n` +
                        `Ref: Bolo/Doce Personalizado\n`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                // Backup
                const backupData = () => {
                    const blob = new Blob([JSON.stringify({ stock: stock.value })], { type: "application/json" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `backup_confeitaria_${Date.now()}.json`;
                    a.click();
                };

                const restoreData = (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const r = new FileReader();
                    r.onload = (v) => { try { const d = JSON.parse(v.target.result); stock.value = d.stock || []; alert("Restaurado!"); } catch (e) { alert("Erro!"); } };
                    r.readAsText(f);
                };

                // Persist
                onMounted(() => {
                    const s = localStorage.getItem('plena_conf_stock');
                    if (s) stock.value = JSON.parse(s);
                });
                watch(stock, () => localStorage.setItem('plena_conf_stock', JSON.stringify(stock.value)), { deep: true });

                return {
                    tab, recipe, margin, extra, stock, newItem, newExpiry,
                    totalCost, suggestedPrice,
                    addStock, getExpiryColor, formatDate, shareQuote, backupData, restoreData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>