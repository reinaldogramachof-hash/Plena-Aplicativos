<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Focus | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.5s ease;
        }

        .mode-focus {
            background-color: #ba4949;
        }

        .mode-short {
            background-color: #38858a;
        }

        .mode-long {
            background-color: #397097;
        }

        [v-cloak] {
            display: none;
        }

        /* Slide Animations */
        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }
    </style>
</head>

<body :class="bgClass" class="text-white min-h-screen flex flex-col items-center">

    <div id="app" v-cloak class="w-full max-w-lg p-4 flex-grow flex flex-col">

        <!-- HEADER -->
        <header class="flex justify-between items-center py-6 border-b border-white/20 mb-8">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-circle-check"></i> Pomodoro Focus
            </h1>
            <div class="flex gap-3">
                <button @click="backupData"
                    class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-bold transition" title="Backup">
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                </button>
                <label
                    class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-bold transition cursor-pointer"
                    title="Restaurar">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <input type="file" @change="restoreData" class="hidden" accept=".json">
                </label>
                <button @click="toggleReport"
                    class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded text-xs font-bold transition">
                    <i class="fa-solid fa-chart-pie"></i> Relat√≥rio
                </button>
            </div>
        </header>

        <!-- TIMER CARD -->
        <div class="bg-white/10 backdrop-blur-md rounded-3xl p-8 mb-8 shadow-xl text-center">

            <!-- CONTROLS -->
            <div class="flex justify-center gap-2 mb-8">
                <button @click="setMode('focus')" :class="mode === 'focus' ? 'bg-black/20 font-bold' : ''"
                    class="px-4 py-1 rounded-full text-sm transition">Foco</button>
                <button @click="setMode('short')" :class="mode === 'short' ? 'bg-black/20 font-bold' : ''"
                    class="px-4 py-1 rounded-full text-sm transition">Curta</button>
                <button @click="setMode('long')" :class="mode === 'long' ? 'bg-black/20 font-bold' : ''"
                    class="px-4 py-1 rounded-full text-sm transition">Longa</button>
            </div>

            <!-- TIMER DISPLAY -->
            <div class="text-[6rem] font-bold leading-none mb-8 font-mono tracking-tighter">
                {{ formattedTime }}
            </div>

            <!-- MAIN BUTTON -->
            <button @click="toggleTimer"
                class="bg-white text-gray-800 text-2xl font-bold uppercase py-4 px-12 rounded shadow-lg hover:shadow-2xl hover:-translate-y-1 transition active:translate-y-0 active:shadow-sm w-full md:w-auto">
                {{ running ? 'Pausar' : 'Iniciar' }}
            </button>
        </div>

        <!-- TASKS SECTION -->
        <div class="flex-grow">
            <div class="flex justify-between items-end mb-4 border-b border-white/20 pb-2">
                <h2 class="font-bold text-lg">Tarefas</h2>
                <button @click="showTaskForm = true"
                    class="bg-black/20 hover:bg-black/30 w-10 h-10 rounded-xl flex items-center justify-center transition">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div v-if="showTaskForm" class="bg-white rounded-xl p-4 mb-4 text-gray-800 animate-fade-in-down">
                <input v-model="newTask" @keyup.enter="addTask" type="text" placeholder="No que voc√™ vai trabalhar?"
                    class="w-full text-lg font-bold outline-none mb-4 placeholder-gray-400">
                <div class="flex justify-end gap-2">
                    <button @click="showTaskForm = false"
                        class="text-gray-500 font-bold text-sm px-4 py-2">Cancelar</button>
                    <button @click="addTask"
                        class="bg-gray-800 text-white font-bold text-sm px-6 py-2 rounded-lg shadow">Salvar</button>
                </div>
            </div>

            <div class="space-y-3">
                <div v-for="(task, idx) in tasks" :key="idx"
                    class="bg-white rounded-xl p-4 text-gray-800 shadow-lg flex justify-between items-center cursor-pointer border-l-8 hover:translate-x-1 transition"
                    :class="activeTask === idx ? 'border-yellow-400 ring-2 ring-white/50' : 'border-transparent opacity-90'"
                    @click="activeTask = idx">

                    <div class="flex items-center gap-3">
                        <div @click.stop="toggleTaskDone(idx)"
                            class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer transition"
                            :class="task.done ? 'bg-green-500 border-green-500' : 'hover:border-gray-400'">
                            <i v-if="task.done" class="fa-solid fa-check text-white text-xs"></i>
                        </div>
                        <span :class="{'line-through text-gray-400': task.done, 'font-bold': activeTask === idx}">{{
                            task.name }}</span>
                    </div>

                    <div class="flex items-center gap-4">
                        <span class="text-gray-400 text-sm font-bold">{{ task.pomodoros }}/{{ task.est || 1 }} <i
                                class="fa-solid fa-clock text-xs ml-0.5"></i></span>
                        <button @click.stop="deleteTask(idx)" class="text-gray-300 hover:text-red-400 transition"><i
                                class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>

            <div v-if="tasks.length === 0 && !showTaskForm" class="text-center py-10 opacity-60 italic">
                Sem tarefas. Adicione uma para manter o foco!
            </div>
        </div>

        <!-- REPORT MODAL -->
        <div v-if="showReport"
            class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-white text-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-fade-in-up">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-gray-700">Relat√≥rio Di√°rio</h3>
                    <button @click="showReport = false" class="text-gray-400 hover:text-gray-600"><i
                            class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <div class="flex gap-4 mb-6">
                    <div class="flex-1 bg-red-50 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-red-500">{{ stats.focusHours }}h</div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Em Foco</div>
                    </div>
                    <div class="flex-1 bg-green-50 p-4 rounded-xl text-center">
                        <div class="text-2xl font-bold text-green-500">{{ stats.completedTasks }}</div>
                        <div class="text-xs text-gray-500 font-bold uppercase">Tarefas</div>
                    </div>
                </div>

                <div class="space-y-2 mb-6 max-h-40 overflow-y-auto text-sm">
                    <div v-for="log in stats.history" class="flex justify-between border-b border-gray-100 py-2">
                        <span class="text-gray-600 truncate mr-2">{{ log.task || 'Sem tarefa' }}</span>
                        <span class="font-bold text-gray-400">{{ log.time }}m</span>
                    </div>
                </div>

                <button @click="shareWhatsapp"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow flex items-center justify-center gap-2 transition">
                    <i class="fa-brands fa-whatsapp"></i> Compartilhar
                </button>
            </div>
        </div>

    </div>

    <!-- AUDIO -->
    <audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
        const { createApp, ref, computed, watch, onMounted } = Vue;

        createApp({
            setup() {
                // STATE
                const mode = ref('focus'); // focus, short, long
                const time = ref(25 * 60);
                const running = ref(false);
                const tasks = ref([]);
                const activeTask = ref(null);
                const showTaskForm = ref(false);
                const newTask = ref('');
                const showReport = ref(false);
                const history = ref([]); // { date, task, time, mode }

                let timerInterval;

                // COMPUTED
                const bgClass = computed(() => {
                    return {
                        'mode-focus': mode.value === 'focus',
                        'mode-short': mode.value === 'short',
                        'mode-long': mode.value === 'long'
                    }[mode.value];
                });

                const formattedTime = computed(() => {
                    const m = Math.floor(time.value / 60).toString().padStart(2, '0');
                    const s = (time.value % 60).toString().padStart(2, '0');
                    return `${m}:${s}`;
                });

                const stats = computed(() => {
                    const today = new Date().toLocaleDateString();
                    const todaysLogs = history.value.filter(h => h.date === today && h.mode === 'focus');
                    const totalMin = todaysLogs.reduce((acc, l) => acc + l.time, 0);

                    return {
                        focusHours: (totalMin / 60).toFixed(1),
                        completedTasks: tasks.value.filter(t => t.done).length,
                        history: todaysLogs
                    };
                });

                // ACTIONS
                const setMode = (m) => {
                    running.value = false;
                    clearInterval(timerInterval);
                    mode.value = m;
                    if (m === 'focus') time.value = 25 * 60;
                    if (m === 'short') time.value = 5 * 60;
                    if (m === 'long') time.value = 15 * 60;

                    // Update Title
                    document.title = `${m === 'focus' ? 'Foco' : 'Pausa'} - Pomodoro`;
                };

                const toggleTimer = () => {
                    if (running.value) {
                        running.value = false;
                        clearInterval(timerInterval);
                    } else {
                        running.value = true;
                        timerInterval = setInterval(() => {
                            if (time.value > 0) {
                                time.value--;
                            } else {
                                completeSession();
                            }
                        }, 1000);
                    }
                };

                const completeSession = () => {
                    running.value = false;
                    clearInterval(timerInterval);
                    document.getElementById('alarm-sound').play();

                    // Log History
                    const workedTime = mode.value === 'focus' ? 25 : (mode.value === 'short' ? 5 : 15);
                    history.value.unshift({
                        date: new Date().toLocaleDateString(),
                        task: activeTask.value !== null ? tasks.value[activeTask.value].name : 'Geral',
                        time: workedTime,
                        mode: mode.value
                    });

                    // Increment Task Counter
                    if (mode.value === 'focus' && activeTask.value !== null) {
                        tasks.value[activeTask.value].pomodoros++;
                    }

                    alert(mode.value === 'focus' ? "O tempo acabou! Hora de descansar." : "Pausa acabou! De volta ao trabalho.");
                };

                const addTask = () => {
                    if (!newTask.value) return;
                    tasks.value.push({ name: newTask.value, pomodoros: 0, est: 1, done: false });
                    newTask.value = '';
                    showTaskForm.value = false;
                    if (activeTask.value === null) activeTask.value = tasks.value.length - 1;
                };

                const deleteTask = (idx) => {
                    if (confirm("Remover tarefa?")) {
                        tasks.value.splice(idx, 1);
                        if (activeTask.value === idx) activeTask.value = null;
                    }
                };

                const toggleTaskDone = (idx) => {
                    tasks.value[idx].done = !tasks.value[idx].done;
                };

                const toggleReport = () => showReport.value = !showReport.value;

                // BACKUP & RESTORE
                const backupData = () => {
                    const data = { tasks: tasks.value, history: history.value };
                    const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `backup_pomodoro_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                    a.click();
                };

                const restoreData = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.tasks) tasks.value = data.tasks;
                            if (data.history) history.value = data.history;
                            alert("Dados restaurados com sucesso!");
                        } catch (err) {
                            alert("Erro ao ler arquivo. Verifique se √© um backup v√°lido.");
                        }
                    };
                    reader.readAsText(file);
                };

                const shareWhatsapp = () => {
                    const text = `üçÖ *Relat√≥rio Pomodoro Focus* üçÖ\n\nüìÖ Data: ${new Date().toLocaleDateString()}\n‚è±Ô∏è Foco Total: ${stats.value.focusHours}h\n‚úÖ Tarefas: ${stats.value.completedTasks}\n\n_Gerado por Plena Apps_`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                // STORAGE
                onMounted(() => {
                    const t = localStorage.getItem('pomodoro_tasks');
                    if (t) tasks.value = JSON.parse(t);
                    const h = localStorage.getItem('pomodoro_history');
                    if (h) history.value = JSON.parse(h);
                });

                watch(tasks, () => localStorage.setItem('pomodoro_tasks', JSON.stringify(tasks.value)), { deep: true });
                watch(history, () => localStorage.setItem('pomodoro_history', JSON.stringify(history.value)), { deep: true });

                return {
                    mode, time, running, tasks, activeTask, newTask, showTaskForm, showReport,
                    bgClass, formattedTime, stats,
                    setMode, toggleTimer, addTask, deleteTask, toggleTaskDone, toggleReport,
                    backupData, restoreData, shareWhatsapp
                };
            }
        }).mount('#app');
    </script>
</body>

</html>