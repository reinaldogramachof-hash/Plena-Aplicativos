<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Escala de Trabalho | Plena Aplicativos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .print-area {
            display: none;
        }

        @media print {
            @page {
                size: landscape;
                margin: 5mm;
            }

            body * {
                visibility: hidden;
            }

            .print-area,
            .print-area * {
                visibility: visible;
            }

            .print-area {
                display: block;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>

<body class="h-screen overflow-hidden flex flex-col md:flex-row">

    <div id="app" class="flex-1 flex h-full w-full relative">

        <!-- Sidebar Controls -->
        <aside class="w-full md:w-80 bg-white border-r border-slate-200 z-10 flex flex-col h-full shadow-lg">
            <div class="p-5 border-b border-slate-100 flex items-center gap-3 bg-slate-50">
                <div
                    class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-600/30">
                    <i class="fa-solid fa-calendar-days text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-slate-800 tracking-tight">Escala <span
                            class="text-indigo-600">Visual</span></h1>
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Gestor de Turnos</p>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6">

                <!-- Period -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase">Período</label>
                    <div class="flex gap-2">
                        <select v-model="currentMonth" class="input flex-2">
                            <option v-for="(m, i) in months" :value="i">{{ m }}</option>
                        </select>
                        <select v-model="currentYear" class="input flex-1">
                            <option v-for="y in years" :value="y">{{ y }}</option>
                        </select>
                    </div>
                </div>

                <!-- Employees -->
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-slate-400 uppercase">Equipe</label>
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">{{ employees.length
                            }}</span>
                    </div>

                    <div class="flex gap-2">
                        <input v-model="newEmpName" @keyup.enter="addEmployee" class="input"
                            placeholder="Novo Funcionário...">
                        <button @click="addEmployee"
                            class="bg-indigo-600 text-white rounded-lg w-10 shrink-0 hover:bg-indigo-700 transition"><i
                                class="fa-solid fa-plus"></i></button>
                    </div>

                    <div class="max-h-60 overflow-y-auto space-y-1 pr-1">
                        <div v-for="(emp, idx) in employees" :key="emp.id"
                            class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-100 group hover:border-indigo-200">
                            <div class="flex items-center gap-2 overflow-hidden">
                                <div
                                    class="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xs font-bold shrink-0">
                                    {{ emp.name.charAt(0) }}</div>
                                <span class="text-sm truncate">{{ emp.name }}</span>
                            </div>
                            <button @click="removeEmployee(idx)"
                                class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition px-2"><i
                                    class="fa-solid fa-times"></i></button>
                        </div>
                        <div v-if="employees.length === 0" class="text-center text-xs text-slate-400 py-4 italic">Nenhum
                            funcionário cadastrado</div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-400 uppercase">Legenda de Turnos</label>
                    <div class="grid grid-cols-2 gap-2">
                        <div v-for="type in shiftTypes" :key="type.code"
                            class="flex items-center gap-2 p-2 rounded bg-slate-50 border border-slate-100 text-xs">
                            <div class="w-4 h-4 rounded shadow-sm" :class="type.color"></div>
                            <span class="font-bold text-slate-600">{{ type.label }}</span>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">Dica: Clique na grade para alterar o turno.</p>
                </div>

                <!-- Tools -->
                <div class="pt-4 border-t border-slate-200">
                    <button @click="printScale"
                        class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-700 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-print"></i> Imprimir Escala
                    </button>
                    <div class="mt-2 flex gap-2">
                        <button @click="resetData"
                            class="flex-1 py-2 text-xs text-red-400 hover:bg-red-50 rounded border border-transparent hover:border-red-100">Limpar
                            Tudo</button>
                        <button @click="backupData"
                            class="flex-1 py-2 text-xs text-indigo-500 hover:bg-indigo-50 rounded border border-transparent hover:border-indigo-100">Backup</button>
                    </div>
                </div>

            </div>
        </aside>

        <!-- Main Grid Area -->
        <main class="flex-1 bg-slate-100 flex flex-col h-full overflow-hidden relative">

            <div class="flex-1 overflow-auto p-4 md:p-8" id="scale-container">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden min-w-max border border-slate-200">

                    <!-- Calendar Header -->
                    <div class="flex border-b border-slate-200 bg-slate-50 sticky top-0 z-20">
                        <div
                            class="w-48 p-4 shrink-0 font-bold text-sm text-slate-500 uppercase flex items-center border-r border-slate-200 sticky left-0 bg-slate-50 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                            Funcionário
                        </div>
                        <div v-for="day in daysInMonth" :key="day.date"
                            class="w-10 flex flex-col items-center justify-center border-r border-slate-100 py-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">{{ day.weekDay
                                }}</span>
                            <span class="text-sm font-bold"
                                :class="{'text-red-500': day.isWeekend, 'text-slate-700': !day.isWeekend}">{{ day.day
                                }}</span>
                        </div>
                        <div
                            class="w-20 p-2 shrink-0 border-l border-slate-200 flex flex-col items-center justify-center text-xs font-bold text-slate-500">
                            Folgas
                        </div>
                    </div>

                    <!-- Calendar Body -->
                    <div class="divide-y divide-slate-100">
                        <div v-for="emp in employees" :key="emp.id" class="flex group hover:bg-slate-50 transition">
                            <!-- Name Column -->
                            <div
                                class="w-48 p-3 shrink-0 flex items-center gap-2 border-r border-slate-200 sticky left-0 bg-white group-hover:bg-slate-50 z-10 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
                                <span class="font-bold text-sm text-slate-700 truncate" :title="emp.name">{{ emp.name
                                    }}</span>
                            </div>

                            <!-- Days Columns -->
                            <div v-for="day in daysInMonth" :key="day.key" @click="cycleScale(emp.id, day.key)"
                                @contextmenu.prevent="reverseCycleScale(emp.id, day.key)"
                                class="w-10 h-10 border-r border-slate-100 flex items-center justify-center cursor-pointer relative select-none"
                                :class="getScaleColor(emp.id, day.key)">

                                <span class="font-bold text-xs mix-blend-multiply opacity-80">
                                    {{ getScaleLabel(emp.id, day.key) }}
                                </span>
                            </div>

                            <!-- Stats Column -->
                            <div class="w-20 p-2 shrink-0 border-l border-slate-200 flex items-center justify-center">
                                <span
                                    class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold border border-green-200">
                                    {{ countFolgas(emp.id) }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Hidden Print Table Structure -->
        <div class="print-area font-sans p-4">
            <h1 class="text-2xl font-bold text-center mb-2 uppercase">Escala de Trabalho</h1>
            <p class="text-center text-sm text-gray-500 mb-6 uppercase">{{ months[currentMonth] }} / {{ currentYear }}
            </p>

            <table class="w-full border-collapse border border-gray-300 text-[10px]">
                <thead>
                    <tr>
                        <th class="border border-gray-300 p-1 bg-gray-100 text-left">Nome</th>
                        <th v-for="day in daysInMonth" :key="'h'+day.date"
                            class="border border-gray-300 p-1 text-center bg-gray-50"
                            :class="{'bg-gray-200': day.isWeekend}">
                            {{ day.day }}
                        </th>
                        <th class="border border-gray-300 p-1 bg-gray-100">Folgas</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="emp in employees" :key="'p'+emp.id">
                        <td class="border border-gray-300 p-1 font-bold">{{ emp.name }}</td>
                        <td v-for="day in daysInMonth" :key="'c'+day.key"
                            class="border border-gray-300 p-1 text-center font-bold relative print-color-adjust-exact"
                            :style="getPrintStyle(emp.id, day.key)">
                            {{ getScaleLabel(emp.id, day.key) }}
                        </td>
                        <td class="border border-gray-300 p-1 text-center">{{ countFolgas(emp.id) }}</td>
                    </tr>
                </tbody>
            </table>

            <div class="mt-4 flex gap-4 text-[10px]">
                <div v-for="type in shiftTypes" class="flex items-center gap-1">
                    <div class="w-3 h-3 border border-gray-400" :style="{backgroundColor: type.printColor}"></div>
                    <span>{{ type.label }}</span>
                </div>
            </div>
        </div>

    </div>

    <style>
        .input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            outline: none;
            transition: all;
            background: #f8fafc;
            font-size: 0.85rem;
        }

        .input:focus {
            border-color: #4f46e5;
            background: #fff;
        }
    </style>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const DB_KEY = 'plena_escala_v1';

        createApp({
            setup() {
                // Config
                const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const years = [2024, 2025, 2026];

                const shiftTypes = [
                    { code: 'T', label: 'T', full: 'Trabalho', color: 'bg-white hover:bg-slate-100', printColor: '#ffffff' },
                    { code: 'F', label: 'F', full: 'Folga', color: 'bg-green-300 hover:bg-green-400', printColor: '#86efac' },
                    { code: 'FE', label: 'FÉ', full: 'Férias', color: 'bg-yellow-200 hover:bg-yellow-300', printColor: '#fef08a' },
                    { code: 'M', label: 'M', full: 'Manhã', color: 'bg-cyan-200 hover:bg-cyan-300', printColor: '#a5f3fc' },
                    { code: 'N', label: 'N', full: 'Noite', color: 'bg-purple-300 hover:bg-purple-400', printColor: '#d8b4fe' },
                    { code: 'A', label: 'AT', full: 'Atestado', color: 'bg-red-200 hover:bg-red-300', printColor: '#fecaca' }
                ];

                // State
                const currentMonth = ref(new Date().getMonth());
                const currentYear = ref(new Date().getFullYear());
                const newEmpName = ref('');

                const employees = ref([
                    { id: 1, name: 'João Silva' },
                    { id: 2, name: 'Maria Santos' }
                ]);

                // Data: { "year-month": { "empId-day": "code" } }
                const rosterData = ref({});

                // Init
                onMounted(() => {
                    const d = localStorage.getItem(DB_KEY);
                    if (d) {
                        const parsed = JSON.parse(d);
                        employees.value = parsed.employees || [];
                        rosterData.value = parsed.rosterData || {};
                    }
                });

                watch([employees, rosterData], () => {
                    localStorage.setItem(DB_KEY, JSON.stringify({
                        employees: employees.value,
                        rosterData: rosterData.value
                    }));
                }, { deep: true });

                // Computed
                const daysInMonth = computed(() => {
                    const date = new Date(currentYear.value, currentMonth.value, 1);
                    const days = [];
                    const weekDays = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];

                    while (date.getMonth() === currentMonth.value) {
                        days.push({
                            day: date.getDate(),
                            weekDay: weekDays[date.getDay()],
                            isWeekend: date.getDay() === 0 || date.getDay() === 6,
                            key: date.getDate(),
                            fullDate: new Date(date)
                        });
                        date.setDate(date.getDate() + 1);
                    }
                    return days;
                });

                const currentMonthKey = computed(() => `${currentYear.value}-${currentMonth.value}`);

                // Methods
                const addEmployee = () => {
                    if (!newEmpName.value.trim()) return;
                    employees.value.push({ id: Date.now(), name: newEmpName.value });
                    newEmpName.value = '';
                };

                const removeEmployee = (idx) => {
                    if (confirm('Remover funcionário?')) employees.value.splice(idx, 1);
                };

                const getScaleCode = (empId, day) => {
                    const mKey = currentMonthKey.value;
                    if (!rosterData.value[mKey]) return 'T'; // Default to Work
                    return rosterData.value[mKey][`${empId}-${day}`] || 'T';
                };

                const getScaleColor = (empId, day) => {
                    const code = getScaleCode(empId, day);
                    const type = shiftTypes.find(t => t.code === code) || shiftTypes[0];
                    return type.color;
                };

                const getScaleLabel = (empId, day) => {
                    const code = getScaleCode(empId, day);
                    return code === 'T' ? '' : code;
                };

                const getPrintStyle = (empId, day) => {
                    const code = getScaleCode(empId, day);
                    const type = shiftTypes.find(t => t.code === code) || shiftTypes[0];
                    return { backgroundColor: type.printColor };
                };

                const cycleScale = (empId, day) => {
                    const mKey = currentMonthKey.value;
                    if (!rosterData.value[mKey]) rosterData.value[mKey] = {};

                    const current = rosterData.value[mKey][`${empId}-${day}`] || 'T';
                    const idx = shiftTypes.findIndex(t => t.code === current);
                    const nextIdx = (idx + 1) % shiftTypes.length;

                    rosterData.value[mKey][`${empId}-${day}`] = shiftTypes[nextIdx].code;
                };

                const reverseCycleScale = (empId, day) => {
                    // Similar but backwards, optional logic
                    cycleScale(empId, day);
                };

                const countFolgas = (empId) => {
                    const mKey = currentMonthKey.value;
                    if (!rosterData.value[mKey]) return 0;

                    let count = 0;
                    for (let d = 1; d <= 31; d++) {
                        const code = rosterData.value[mKey][`${empId}-${d}`];
                        if (code === 'F') count++;
                    }
                    return count;
                };

                const resetData = () => {
                    if (confirm('Isso apagará toda a escala. Continuar?')) {
                        rosterData.value = {};
                    }
                };

                const backupData = () => {
                    const blob = new Blob([JSON.stringify({ employees: employees.value, rosterData: rosterData.value })], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'escala_backup.json';
                    a.click();
                };

                const printScale = () => window.print();

                return {
                    months, years, currentMonth, currentYear, newEmpName, employees, shiftTypes,
                    daysInMonth,
                    addEmployee, removeEmployee,
                    getScaleColor, getScaleLabel, getPrintStyle, cycleScale, reverseCycleScale,
                    countFolgas,
                    resetData, backupData, printScale
                };
            }
        }).mount('#app');
    </script>
</body>

</html>