<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formatador JSON | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Segoe UI', sans-serif;
        }

        .code-font {
            font-family: 'Fira Code', monospace;
        }

        [v-cloak] {
            display: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
    </style>
    <script src="../../../assets/js/plena-lock.js"></script>
</head>

<body class="pb-20">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen flex flex-col">

        <header class="bg-indigo-600 text-white p-6 shadow-md z-10">
            <div class="flex justify-between items-center mb-1">
                <h1 class="text-xl font-bold font-mono">{ JSON: Tools }</h1>
                <div class="flex gap-3 text-indigo-200">
                    <label class="cursor-pointer hover:text-white" title="Upload JSON"><i
                            class="fa-solid fa-folder-open"></i><input type="file" @change="loadFile" class="hidden"
                            accept=".json,.txt"></label>
                    <button @click="backupData" class="hover:text-white" title="Backup History"><i
                            class="fa-solid fa-download"></i></button>
                </div>
            </div>
            <p class="text-xs text-indigo-200">Formatar, Validar e Minificar</p>
        </header>

        <div class="flex-grow p-4 space-y-4">

            <!-- EDITOR -->
            <div class="relative group">
                <textarea v-model="input" placeholder="Cole seu JSON aqui..."
                    class="w-full h-64 bg-slate-800 text-green-400 code-font p-3 text-xs rounded-xl border border-slate-700 outline-none focus:border-indigo-500 resize-none"></textarea>
                <button @click="input=''" v-if="input"
                    class="absolute top-2 right-2 text-slate-500 hover:text-red-400 text-xs bg-slate-800 px-2 py-1 rounded">Limpar</button>
            </div>

            <!-- ACTIONS -->
            <div class="grid grid-cols-2 gap-2">
                <button @click="format"
                    class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold shadow-lg transition"><i
                        class="fa-solid fa-align-left"></i> Formatar</button>
                <button @click="minify"
                    class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold shadow-lg transition"><i
                        class="fa-solid fa-compress"></i> Minificar</button>
            </div>

            <!-- STATUS/RESULT -->
            <div v-if="status"
                :class="status.type === 'error' ? 'bg-red-900/50 border-red-500 text-red-200' : 'bg-green-900/50 border-green-500 text-green-200'"
                class="p-3 rounded-lg border text-xs font-mono break-all relative">
                <i :class="status.type==='error'?'fa-circle-xmark':'fa-circle-check'" class="fa-solid mr-2"></i>
                {{ status.msg }}
                <button v-if="status.type === 'success'" @click="copy"
                    class="absolute right-2 top-2 text-green-400 hover:text-white"><i
                        class="fa-solid fa-copy"></i></button>
            </div>

            <!-- TREE VIEW (Simple) -->
            <div v-if="parsed && status.type === 'success'" class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div class="flex justify-between text-xs text-slate-400 mb-2 uppercase font-bold">
                    <span>Estrutura</span>
                    <span>{{ Object.keys(parsed).length }} chaves raiz</span>
                </div>
                <div class="text-xs text-indigo-300 code-font overflow-x-auto">
                    <div v-for="(val, key) in parsed" :key="key" class="truncate">
                        <span class="text-purple-400">{{ key }}:</span> <span class="text-slate-400">{{ typeof val ===
                            'object' ? '{...}' : val }}</span>
                    </div>
                </div>
            </div>

            <!-- HISTORY -->
            <div v-if="history.length > 0" class="mt-4">
                <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Hist√≥rico ({{ history.length }})</h3>
                <div class="space-y-2">
                    <div v-for="(h, idx) in history" :key="idx" @click="input = h.content"
                        class="bg-slate-800 p-2 rounded border border-slate-700 hover:border-indigo-500 cursor-pointer flex justify-between items-center group">
                        <div class="truncate text-xs text-slate-400 code-font w-4/5">{{ h.content.substring(0,40) }}...
                        </div>
                        <button @click.stop="history.splice(idx,1)" class="text-slate-600 hover:text-red-400"><i
                                class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>

        </div>

        <button @click="share"
            class="mx-4 mb-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow">
            <i class="fa-brands fa-whatsapp"></i> Compartilhar JSON
        </button>

    </div>

    <script>
        const { createApp, ref, watch, onMounted } = Vue;

        createApp({
            setup() {
                const input = ref('');
                const status = ref(null);
                const parsed = ref(null);
                const history = ref([]);

                const format = () => {
                    try {
                        const obj = JSON.parse(input.value);
                        input.value = JSON.stringify(obj, null, 4);
                        parsed.value = obj;
                        status.value = { type: 'success', msg: 'JSON V√°lido e Formatado!' };
                        addToHistory(input.value);
                    } catch (e) {
                        status.value = { type: 'error', msg: e.message };
                        parsed.value = null;
                    }
                };

                const minify = () => {
                    try {
                        const obj = JSON.parse(input.value);
                        input.value = JSON.stringify(obj);
                        parsed.value = obj;
                        status.value = { type: 'success', msg: 'JSON Minificado!' };
                        addToHistory(input.value);
                    } catch (e) {
                        status.value = { type: 'error', msg: e.message };
                        parsed.value = null;
                    }
                };

                const addToHistory = (txt) => {
                    if (history.value.length > 0 && history.value[0].content === txt) return;
                    history.value.unshift({ content: txt, date: Date.now() });
                    if (history.value.length > 10) history.value.pop();
                };

                const copy = () => {
                    navigator.clipboard.writeText(input.value);
                    alert("Copiado!");
                };

                const loadFile = (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const r = new FileReader();
                    r.onload = (v) => { input.value = v.target.result; format(); };
                    r.readAsText(f);
                };

                const share = () => {
                    // Sharing huge JSON via whatsapp url is bad, so we just share a snippet or status
                    if (!input.value) return alert("Nada para compartilhar");
                    const snippet = input.value.substring(0, 100) + (input.value.length > 100 ? '...' : '');
                    const text = `üíª *JSON Snippet*\n\n\`\`\`${snippet}\`\`\`\n\nValidado em Plena Apps`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                // Backup Std
                const backupData = () => {
                    const blob = new Blob([JSON.stringify(history.value)], { type: "application/json" });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `json_history.json`; a.click();
                };

                onMounted(() => {
                    const d = localStorage.getItem('plena_json');
                    if (d) history.value = JSON.parse(d);
                });
                watch(history, () => localStorage.setItem('plena_json', JSON.stringify(history.value)), { deep: true });

                return { input, status, parsed, history, format, minify, copy, loadFile, share, backupData };
            }
        }).mount('#app');
    </script>
</body>

</html>