<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calc Comiss√µes | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f0fdf4;
            font-family: 'Segoe UI', sans-serif;
        }

        [v-cloak] {
            display: none;
        }
    </style>
    <script src="../../../assets/js/plena-lock.js"></script>
</head>

<body class="pb-20">

    <div id="app" v-cloak class="max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col">

        <header class="bg-green-600 text-white p-6 shadow-md">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold"><i class="fa-solid fa-hand-holding-dollar"></i> Comiss√µes</h1>
                <div class="flex gap-3 text-green-200">
                    <button @click="backupData" class="hover:text-white"><i class="fa-solid fa-download"></i></button>
                    <label class="cursor-pointer hover:text-white"><i class="fa-solid fa-upload"></i><input type="file"
                            @change="restoreData" class="hidden" accept=".json"></label>
                </div>
            </div>
            <p class="text-green-100 text-xs">Gest√£o de Vendas e Metas</p>
        </header>

        <div class="p-6 space-y-6">

            <!-- CONFIG -->
            <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                <h3 class="font-bold text-green-800 text-xs uppercase mb-3">Configura√ß√£o</h3>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500 font-bold">META (R$)</label>
                        <input v-model.number="config.goal" type="number"
                            class="w-full border-b border-green-300 bg-transparent py-1 font-bold text-green-700 outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500 font-bold">COMISS√ÉO (%)</label>
                        <input v-model.number="config.rate" type="number"
                            class="w-full border-b border-green-300 bg-transparent py-1 font-bold text-green-700 outline-none">
                    </div>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4 relative overflow-hidden">
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <div class="text-xs text-gray-400 uppercase">Total Vendido</div>
                        <div class="text-2xl font-bold text-gray-800">R$ {{ totalSales.toFixed(2) }}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 uppercase">A Receber</div>
                        <div class="text-xl font-bold text-green-600">R$ {{ totalCommission.toFixed(2) }}</div>
                    </div>
                </div>
                <!-- Progress Bar -->
                <div class="w-full bg-gray-100 rounded-full h-2 mt-2">
                    <div class="bg-green-500 h-2 rounded-full transition-all duration-1000"
                        :style="{width: progress + '%'}"></div>
                </div>
                <div class="text-[10px] text-gray-400 text-center mt-1">{{ progress.toFixed(0) }}% da Meta</div>
            </div>

            <!-- NEW SALE -->
            <div>
                <h3 class="font-bold text-gray-700 mb-2">Nova Venda</h3>
                <div class="flex gap-2">
                    <input v-model="form.desc"
                        class="flex-[2] border p-3 rounded-l-lg outline-none focus:border-green-500"
                        placeholder="Cliente/Produto">
                    <input v-model.number="form.value" type="number"
                        class="flex-1 border p-3 outline-none focus:border-green-500" placeholder="R$ Value">
                    <button @click="addSale"
                        class="bg-green-600 hover:bg-green-500 text-white px-4 rounded-r-lg font-bold"><i
                            class="fa-solid fa-plus"></i></button>
                </div>
            </div>

            <!-- HISTORY -->
            <div>
                <h3 class="font-bold text-gray-700 mb-2">Hist√≥rico</h3>
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    <div v-for="(sale, idx) in sales" :key="idx"
                        class="flex justify-between items-center bg-gray-50 p-3 rounded border border-gray-100">
                        <div>
                            <div class="font-bold text-sm text-gray-700">{{ sale.desc }}</div>
                            <div class="text-[10px] text-gray-400">{{ formatDate(sale.date) }}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-gray-600">R$ {{ sale.value.toFixed(2) }}</span>
                            <button @click="sales.splice(idx,1)" class="text-red-300 hover:text-red-500 text-xs"><i
                                    class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div v-if="sales.length===0" class="text-center text-sm text-gray-400 py-4">Sem vendas registradas.
                    </div>
                </div>
            </div>

        </div>

        <button @click="share"
            class="mx-6 mb-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow">
            <i class="fa-brands fa-whatsapp"></i> Enviar Relat√≥rio
        </button>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const config = ref({ goal: 10000, rate: 5 });
                const form = ref({ desc: '', value: '' });
                const sales = ref([]);

                const addSale = () => {
                    if (!form.value.desc || !form.value.value) return;
                    sales.value.unshift({ ...form.value, date: Date.now() });
                    form.value = { desc: '', value: '' };
                };

                const totalSales = computed(() => sales.value.reduce((a, b) => a + Number(b.value), 0));

                const totalCommission = computed(() => {
                    // Simple flat rate logic. Could be tiered in future.
                    return totalSales.value * (config.value.rate / 100);
                });

                const progress = computed(() => {
                    if (config.value.goal <= 0) return 0;
                    return Math.min((totalSales.value / config.value.goal) * 100, 100);
                });

                const formatDate = (ts) => new Date(ts).toLocaleDateString('pt-BR');

                const share = () => {
                    const text = `üí∞ *Relat√≥rio de Vendas*\n\nTotal Vendido: R$ ${totalSales.value.toFixed(2)}\nComiss√£o (${config.value.rate}%): *R$ ${totalCommission.value.toFixed(2)}*\nMeta: ${progress.value.toFixed(0)}%\n\nGerado via Plena Apps`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                // Backup
                const backupData = () => {
                    const data = { config: config.value, sales: sales.value };
                    const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sales_report.json`; a.click();
                };
                const restoreData = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    const r = new FileReader();
                    r.onload = (v) => { const d = JSON.parse(v.target.result); config.value = d.config; sales.value = d.sales; alert("Dados restaurados!"); };
                    r.readAsText(f);
                };

                onMounted(() => {
                    const d = localStorage.getItem('plena_commission');
                    if (d) { const p = JSON.parse(d); if (p.config) config.value = p.config; if (p.sales) sales.value = p.sales; }
                });
                watch([config, sales], () => localStorage.setItem('plena_commission', JSON.stringify({ config: config.value, sales: sales.value })), { deep: true });

                return { config, form, sales, addSale, totalSales, totalCommission, progress, formatDate, share, backupData, restoreData };
            }
        }).mount('#app');
    </script>
</body>

</html>