<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Express | Plena Apps</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonte T√©cnica -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f3f4f6;
        }

        .font-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        [v-cloak] {
            display: none;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
            }

            .print-border {
                border: 1px solid #000;
            }
        }
    </style>
</head>

<body class="pb-20">

    <div id="app" v-cloak class="max-w-4xl mx-auto min-h-screen bg-white shadow-xl flex flex-col">

        <!-- HEADER (No Print) -->
        <header class="bg-blue-800 text-white p-4 shadow mb-4 no-print flex justify-between items-center">
            <h1 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-clipboard-list"></i> OS Express
            </h1>
            <div class="flex gap-2">
                <button @click="backupData" class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm transition"
                    title="Backup JSON">
                    <i class="fa-solid fa-cloud-arrow-down"></i>
                </button>
                <label class="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm transition cursor-pointer"
                    title="Restaurar JSON">
                    <i class="fa-solid fa-cloud-arrow-up"></i>
                    <input type="file" @change="restoreData" class="hidden" accept=".json">
                </label>
                <button @click="printOS"
                    class="bg-yellow-500 hover:bg-yellow-400 text-blue-900 font-bold px-4 py-1 rounded text-sm">
                    <i class="fa-solid fa-print"></i> Imprimir
                </button>
            </div>
        </header>

        <!-- FORMUL√ÅRIO -->
        <div class="p-8 flex-grow no-print" v-if="!printing">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Cliente -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-400 text-xs uppercase mb-3">Dados do Cliente</h3>
                    <div class="space-y-3">
                        <input v-model="os.client" type="text" placeholder="Nome do Cliente"
                            class="w-full p-2 border rounded">
                        <input v-model="os.phone" type="text" placeholder="Telefone/WhatsApp"
                            class="w-full p-2 border rounded">
                        <input v-model="os.device" type="text" placeholder="Equipamento/Ve√≠culo"
                            class="w-full p-2 border rounded">
                    </div>
                </div>

                <!-- Servi√ßo -->
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-400 text-xs uppercase mb-3">Detalhes do Servi√ßo</h3>
                    <div class="space-y-3">
                        <textarea v-model="os.problem" rows="2" placeholder="Defeito Relatado"
                            class="w-full p-2 border rounded"></textarea>
                        <textarea v-model="os.solution" rows="2" placeholder="Servi√ßo Realizado / Solu√ß√£o"
                            class="w-full p-2 border rounded"></textarea>
                    </div>
                </div>
            </div>

            <!-- Valores -->
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 mb-8">
                <div class="flex flex-wrap gap-4 justify-end items-end">
                    <div class="w-32">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pe√ßas (R$)</label>
                        <input v-model.number="os.parts" type="number"
                            class="w-full p-2 border rounded text-right font-mono" step="0.01">
                    </div>
                    <div class="w-32">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">M√£o de Obra (R$)</label>
                        <input v-model.number="os.labor" type="number"
                            class="w-full p-2 border rounded text-right font-mono" step="0.01">
                    </div>
                    <div class="w-32">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Desconto (R$)</label>
                        <input v-model.number="os.discount" type="number"
                            class="w-full p-2 border rounded text-right font-mono text-red-500" step="0.01">
                    </div>
                    <div class="text-right ml-4">
                        <div class="text-xs text-gray-500 font-bold uppercase">Total Geral</div>
                        <div class="text-3xl font-bold text-blue-800 font-mono">R$ {{ totalFormatted }}</div>
                    </div>
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg">
                <div class="text-sm text-gray-500">
                    ID da OS: <span class="font-mono font-bold">#{{ os.id }}</span>
                </div>
                <div class="flex gap-2">
                    <button @click="resetOS"
                        class="text-gray-500 hover:text-red-500 px-4 py-2 font-bold text-sm">Limpar</button>
                    <button @click="saveOS"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-bold shadow">
                        Salvar Nova
                    </button>
                    <button @click="shareWhatsapp"
                        class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded font-bold shadow flex items-center gap-2">
                        <i class="fa-brands fa-whatsapp"></i> Enviar
                    </button>
                </div>
            </div>

            <!-- Hist√≥rico Recente -->
            <div class="mt-8">
                <h3 class="font-bold text-gray-700 mb-4">Hist√≥rico Recente</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">Cliente</th>
                                <th class="px-4 py-3">Equipamento</th>
                                <th class="px-4 py-3">Valor</th>
                                <th class="px-4 py-3">Data</th>
                                <th class="px-4 py-3">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="item in history" :key="item.id" class="border-b hover:bg-gray-50">
                                <td class="px-4 py-3 font-mono">#{{ item.id }}</td>
                                <td class="px-4 py-3">{{ item.client }}</td>
                                <td class="px-4 py-3">{{ item.device }}</td>
                                <td class="px-4 py-3 font-bold text-blue-600">{{"R$ " + item.total.toFixed(2) }}</td>
                                <td class="px-4 py-3">{{ item.date }}</td>
                                <td class="px-4 py-3">
                                    <button @click="loadOS(item)"
                                        class="text-blue-500 font-bold hover:underline">Ver</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- PRINT TEMPLATE (Hidden unless printing) -->
        <div v-show="printing" class="p-8 text-sm">
            <div class="border-2 border-black p-6 rounded mb-4">
                <div class="flex justify-between items-center border-b-2 border-black pb-4 mb-4">
                    <div>
                        <h1 class="text-2xl font-bold">ORDEM DE SERVI√áO</h1>
                        <p class="font-mono">N¬∫: {{ os.id }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold">Sua Assist√™ncia T√©cnica</p>
                        <p>Data: {{ os.date || new Date().toLocaleDateString() }}</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="font-bold uppercase text-xs">Cliente</p>
                        <p>{{ os.client }}</p>
                        <p>{{ os.phone }}</p>
                    </div>
                    <div>
                        <p class="font-bold uppercase text-xs">Equipamento</p>
                        <p>{{ os.device }}</p>
                    </div>
                </div>

                <div class="border border-black p-2 mb-4">
                    <p class="font-bold uppercase text-xs mb-1">Defeito Relatado</p>
                    <p>{{ os.problem }}</p>
                </div>
                <div class="border border-black p-2 mb-4">
                    <p class="font-bold uppercase text-xs mb-1">Servi√ßo Realizado</p>
                    <p>{{ os.solution }}</p>
                </div>

                <div class="flex justify-end mt-8">
                    <div class="w-48">
                        <div class="flex justify-between mb-1"><span>Pe√ßas:</span> <span>R$ {{ (os.parts||0).toFixed(2)
                                }}</span></div>
                        <div class="flex justify-between mb-1"><span>M√£o de Obra:</span> <span>R$ {{
                                (os.labor||0).toFixed(2) }}</span></div>
                        <div class="flex justify-between mb-2 text-red-600" v-if="os.discount"><span>Desconto:</span>
                            <span>- R$ {{ (os.discount||0).toFixed(2) }}</span></div>
                        <div class="flex justify-between border-t border-black pt-2 font-bold text-lg">
                            <span>TOTAL:</span> <span>R$ {{ totalFormatted }}</span>
                        </div>
                    </div>
                </div>

                <div class="mt-12 text-center text-xs border-t border-black pt-4">
                    <p>Garantia de 90 dias para m√£o de obra. Equipamentos n√£o retirados em 30 dias ser√£o vendidos.</p>
                </div>
                <!-- Print Buttons (Hide inside print) -->
                <div class="mt-8 text-center no-print">
                    <button @click="window.print()" class="bg-black text-white px-4 py-2 font-bold mr-2">Confirmar
                        Impress√£o</button>
                    <button @click="printing = false" class="bg-gray-300 px-4 py-2 font-bold">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const printing = ref(false);
                const history = ref([]);

                // DATA
                const os = ref({
                    id: Date.now().toString().slice(-6),
                    date: new Date().toLocaleDateString(),
                    client: "",
                    phone: "",
                    device: "",
                    problem: "",
                    solution: "",
                    parts: 0,
                    labor: 0,
                    discount: 0
                });

                const total = computed(() => {
                    return (os.value.parts || 0) + (os.value.labor || 0) - (os.value.discount || 0);
                });

                const totalFormatted = computed(() => total.value.toFixed(2));

                const resetOS = () => {
                    os.value = {
                        id: Date.now().toString().slice(-6),
                        date: new Date().toLocaleDateString(),
                        client: "",
                        phone: "",
                        device: "",
                        problem: "",
                        solution: "",
                        parts: 0,
                        labor: 0,
                        discount: 0
                    };
                };

                const saveOS = () => {
                    const newOS = { ...os.value, total: total.value };
                    history.value.unshift(newOS);
                    resetOS();
                    alert("OS Salva no Hist√≥rico!");
                };

                const loadOS = (item) => {
                    os.value = { ...item };
                    window.scrollTo(0, 0);
                };

                const shareWhatsapp = () => {
                    const text = `üìã *Ordem de Servi√ßo #${os.value.id}*\n` +
                        `Ol√° ${os.value.client},\n\n` +
                        `*Equipamento:* ${os.value.device}\n` +
                        `*Servi√ßo:* ${os.value.solution}\n` +
                        `*Valor Total:* R$ ${totalFormatted.value}\n\n` +
                        `Qualquer d√∫vida estamos √† disposi√ß√£o!`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                const printOS = () => {
                    printing.value = true;
                    // Auto print triggers via button inside the print view to avoid stuck UI
                };

                // BACKUP
                const backupData = () => {
                    const blob = new Blob([JSON.stringify(history.value)], { type: "application/json" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `backup_os_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                    a.click();
                };

                const restoreData = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            history.value = JSON.parse(ev.target.result);
                            alert("Hist√≥rico restaurado!");
                        } catch (err) { alert("Arquivo inv√°lido"); }
                    };
                    reader.readAsText(file);
                };

                // PERSIST
                onMounted(() => {
                    const h = localStorage.getItem('plena_os_history');
                    if (h) history.value = JSON.parse(h);
                });
                watch(history, () => localStorage.setItem('plena_os_history', JSON.stringify(history.value)), { deep: true });

                return {
                    os, printing, history, totalFormatted,
                    resetOS, saveOS, loadOS, shareWhatsapp, printOS,
                    backupData, restoreData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>