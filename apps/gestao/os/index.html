<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>OS Express | Plena</title>
    <!-- CDNs Padr√£o -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Fontes -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Share+Tech+Mono&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'Share Tech Mono', monospace;
        }

        [v-cloak] {
            display: none;
        }

        /* Print Styles */
        @media print {

            aside,
            header,
            .no-print {
                display: none !important;
            }

            body,
            main {
                background: white !important;
                height: auto !important;
                overflow: visible !important;
            }

            #app {
                display: block !important;
            }

            .print-border {
                border: 1px solid #000;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">
    <div id="app" v-cloak class="flex h-full">

        <!-- SIDEBAR -->
        <aside
            :class="['fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transition-transform lg:static lg:translate-x-0 flex flex-col', isMenuOpen ? 'translate-x-0' : '-translate-x-full']">
            <!-- Logo -->
            <div class="p-6 border-b border-slate-800 flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fa-solid fa-clipboard-list"></i></div>
                <span class="font-bold text-lg leading-tight">OS Express</span>
            </div>
            <!-- Menu -->
            <nav class="flex-1 p-4 space-y-2">
                <button @click="printing = false"
                    class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/10 text-white font-bold transition flex items-center gap-2"
                    :class="{'bg-white/10': !printing}">
                    <i class="fa-solid fa-pen-to-square"></i> Nova OS
                </button>
                <div class="px-4 pt-4 text-xs text-slate-500 uppercase font-bold">Dados</div>
                <label
                    class="w-full text-left px-4 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition flex items-center gap-2 cursor-pointer">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Restaurar Backup
                    <input type="file" @change="restoreData" class="hidden" accept=".json">
                </label>
                <button @click="backupData"
                    class="w-full text-left px-4 py-2 rounded-lg text-slate-400 hover:text-white hover:bg-white/5 transition flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Fazer Backup
                </button>
            </nav>
            <!-- Voltar Loja -->
            <div class="p-4 border-t border-slate-800">
                <a href="../../../index.html"
                    class="flex items-center gap-2 text-slate-400 hover:text-white transition px-4 py-2">
                    <i class="fa-solid fa-arrow-left"></i> Voltar √† Loja
                </a>
            </div>
        </aside>

        <!-- OVERLAY MOBILE -->
        <div v-if="isMenuOpen" @click="isMenuOpen = false" class="fixed inset-0 bg-black/50 z-40 lg:hidden"></div>

        <!-- CONTE√öDO PRINCIPAL -->
        <main class="flex-1 flex flex-col relative w-full transition-all">
            <!-- Header Mobile -->
            <header class="lg:hidden bg-white p-4 border-b flex justify-between items-center shadow-sm">
                <button @click="isMenuOpen = true" class="text-slate-600"><i
                        class="fa-solid fa-bars text-xl"></i></button>
                <span class="font-bold text-slate-800">OS Express</span>
                <div class="w-6"></div>
            </header>

            <!-- √Årea de Trabalho (Scroll√°vel) -->
            <div class="flex-1 overflow-y-auto p-4 lg:p-8" v-if="!printing">

                <div class="max-w-5xl mx-auto space-y-6">

                    <!-- Top Bar -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Nova Ordem de Servi√ßo</h2>
                            <p class="text-slate-500 text-sm">Preencha os dados para gerar o documento.</p>
                        </div>
                        <div class="flex gap-2">
                            <button @click="printOS"
                                class="bg-slate-800 hover:bg-slate-700 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow flex items-center gap-2">
                                <i class="fa-solid fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>

                    <!-- Layout Grid Principal -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Coluna Esquerda: Formul√°rio -->
                        <div class="lg:col-span-2 space-y-6">

                            <!-- Dados Cliente / Equipamento -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-user"></i> Cliente e Equipamento</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <input v-model="os.client" type="text" placeholder="Nome do Cliente"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
                                    <input v-model="os.phone" type="text" placeholder="Telefone/WhatsApp"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
                                    <input v-model="os.device" type="text" placeholder="Equipamento/Ve√≠culo"
                                        class="col-span-1 md:col-span-2 w-full bg-slate-50 border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 transition text-sm">
                                </div>
                            </div>

                            <!-- Diagn√≥stico -->
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-wrench"></i> Diagn√≥stico</h3>
                                <div class="space-y-4">
                                    <textarea v-model="os.problem" rows="2" placeholder="Defeito Relatado"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 transition text-sm"></textarea>
                                    <textarea v-model="os.solution" rows="3"
                                        placeholder="Servi√ßo Realizado / Solu√ß√£o T√©cnica"
                                        class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 transition text-sm font-medium text-slate-700"></textarea>
                                </div>
                            </div>

                        </div>

                        <!-- Coluna Direita: Valores -->
                        <div class="space-y-6">
                            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                                <h3 class="font-bold text-slate-400 text-xs uppercase mb-4 flex items-center gap-2"><i
                                        class="fa-solid fa-calculator"></i> Valores</h3>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Pe√ßas (R$)</label>
                                        <input v-model.number="os.parts" type="number"
                                            class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 text-right font-mono font-bold text-slate-700"
                                            step="0.01">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">M√£o de Obra
                                            (R$)</label>
                                        <input v-model.number="os.labor" type="number"
                                            class="w-full bg-slate-50 border-slate-200 rounded-xl p-3 text-right font-mono font-bold text-slate-700"
                                            step="0.01">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 mb-1">Desconto (R$)</label>
                                        <input v-model.number="os.discount" type="number"
                                            class="w-full bg-red-50 border-red-100 rounded-xl p-3 text-right font-mono font-bold text-red-600"
                                            step="0.01">
                                    </div>

                                    <div class="pt-4 border-t border-slate-100">
                                        <div class="flex justify-between items-center bg-blue-50 p-4 rounded-xl">
                                            <span class="text-xs font-bold text-blue-600 uppercase">Total</span>
                                            <span class="text-2xl font-bold text-blue-800 font-mono">R$ {{
                                                totalFormatted }}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-6 flex flex-col gap-2">
                                    <button @click="saveOS"
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/30 transition flex justify-center items-center gap-2">
                                        <i class="fa-solid fa-save"></i> Salvar OS
                                    </button>
                                    <button @click="shareWhatsapp"
                                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 transition flex justify-center items-center gap-2">
                                        <i class="fa-brands fa-whatsapp"></i> Enviar
                                    </button>
                                    <button @click="resetOS"
                                        class="w-full text-slate-400 hover:text-red-500 font-bold py-2 text-sm transition">
                                        Limpar Tudo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hist√≥rico -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-200">
                            <h3 class="font-bold text-slate-700">Hist√≥rico Recente</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3">ID</th>
                                        <th class="px-6 py-3">Cliente</th>
                                        <th class="px-6 py-3">Data</th>
                                        <th class="px-6 py-3 text-right">Valor</th>
                                        <th class="px-6 py-3 text-center">A√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="item in history" :key="item.id"
                                        class="border-b hover:bg-slate-50 transition">
                                        <td class="px-6 py-4 font-mono font-bold text-slate-600">#{{ item.id }}</td>
                                        <td class="px-6 py-4 font-medium text-slate-800">{{ item.client }}</td>
                                        <td class="px-6 py-4">{{ item.date }}</td>
                                        <td class="px-6 py-4 text-right font-mono font-bold text-blue-600">R$ {{
                                            item.total.toFixed(2) }}</td>
                                        <td class="px-6 py-4 text-center">
                                            <button @click="loadOS(item)"
                                                class="text-blue-600 hover:text-blue-800 font-bold text-xs bg-blue-50 px-3 py-1.5 rounded-lg transition">
                                                Abrir
                                            </button>
                                        </td>
                                    </tr>
                                    <tr v-if="history.length === 0">
                                        <td colspan="5" class="px-6 py-8 text-center text-slate-400">
                                            Nenhuma ordem de servi√ßo salva.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW DE IMPRESS√ÉO (Substitui a √°rea principal quando printing = true) -->
            <div v-if="printing" class="flex-1 bg-white p-8 overflow-y-auto">
                <div class="max-w-2xl mx-auto border-2 border-black p-8 rounded-sm text-black">
                    <!-- Cabe√ßalho Impress√£o -->
                    <div class="flex justify-between items-start border-b-2 border-black pb-6 mb-6">
                        <div>
                            <h1 class="text-3xl font-black">ORDEM DE SERVI√áO</h1>
                            <p class="font-mono text-xl mt-1">N¬∫: {{ os.id }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg">Assist√™ncia T√©cnica</p>
                            <p class="text-sm">Emiss√£o: {{ os.date || new Date().toLocaleDateString() }}</p>
                        </div>
                    </div>

                    <!-- Dados -->
                    <div class="space-y-6">
                        <div class="border border-black p-4">
                            <h4 class="font-bold uppercase text-xs mb-2 border-b border-black inline-block">Cliente</h4>
                            <div class="flex justify-between">
                                <span class="font-medium text-lg">{{ os.client || 'Consumidor' }}</span>
                                <span>{{ os.phone }}</span>
                            </div>
                        </div>

                        <div class="border border-black p-4">
                            <h4 class="font-bold uppercase text-xs mb-2 border-b border-black inline-block">Equipamento
                                / Ve√≠culo</h4>
                            <p class="text-lg">{{ os.device || '-' }}</p>
                        </div>

                        <div class="border border-black p-4 bg-gray-50">
                            <h4 class="font-bold uppercase text-xs mb-2 border-b border-black inline-block">Problema
                            </h4>
                            <p class="text-lg">{{ os.problem || '-' }}</p>
                        </div>

                        <div class="border border-black p-4 bg-gray-50">
                            <h4 class="font-bold uppercase text-xs mb-2 border-b border-black inline-block">Solu√ß√£o /
                                Servi√ßo</h4>
                            <p class="text-lg">{{ os.solution || '-' }}</p>
                        </div>
                    </div>

                    <!-- Totais -->
                    <div class="mt-8 flex justify-end">
                        <div class="w-1/2 space-y-2 text-right">
                            <div class="flex justify-between text-sm"><span>Pe√ßas:</span> <span>R$ {{
                                    (os.parts||0).toFixed(2) }}</span></div>
                            <div class="flex justify-between text-sm"><span>M√£o de Obra:</span> <span>R$ {{
                                    (os.labor||0).toFixed(2) }}</span></div>
                            <div class="flex justify-between text-sm text-red-600" v-if="os.discount">
                                <span>Desconto:</span> <span>- R$ {{ (os.discount||0).toFixed(2) }}</span></div>
                            <div class="flex justify-between border-t-2 border-black pt-2 font-black text-2xl mt-4">
                                <span>TOTAL</span> <span>R$ {{ totalFormatted }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Footer Nota -->
                    <div class="mt-12 pt-4 border-t border-black text-center text-xs">
                        <p class="mb-4">Garantia de 90 dias para m√£o de obra. Equipamentos n√£o retirados em 30 dias
                            est√£o sujeitos a taxas de armazenamento.</p>
                        <div class="flex justify-between mt-12 px-12">
                            <div class="border-t border-black w-40 pt-2">Assinatura do T√©cnico</div>
                            <div class="border-t border-black w-40 pt-2">Assinatura do Cliente</div>
                        </div>
                    </div>

                    <!-- Controles de Impress√£o (N√£o sai no papel) -->
                    <div class="mt-8 text-center no-print flex justify-center gap-4">
                        <button @click="window.print()"
                            class="bg-black text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-800">
                            <i class="fa-solid fa-print"></i> Confirmar Impress√£o
                        </button>
                        <button @click="printing = false"
                            class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-bold hover:bg-gray-300">
                            Cancelar
                        </button>
                    </div>

                </div>
            </div>

            <!-- Bot√£o Flutuante (Suporte) -->
            <a v-if="!printing" href="https://wa.me/5567993333999" target="_blank"
                class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center text-3xl transition transform hover:scale-110 z-50">
                <i class="fa-brands fa-whatsapp"></i>
            </a>

        </main>
    </div>

    <!-- L√ìGICA VUE (Mantida e Adaptada) -->
    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        createApp({
            setup() {
                const isMenuOpen = ref(false);
                const printing = ref(false);
                const history = ref([]);
                const os = ref({
                    id: Date.now().toString().slice(-6),
                    date: new Date().toLocaleDateString(),
                    client: "", phone: "", device: "", problem: "", solution: "",
                    parts: 0, labor: 0, discount: 0
                });

                const total = computed(() => (os.value.parts || 0) + (os.value.labor || 0) - (os.value.discount || 0));
                const totalFormatted = computed(() => total.value.toFixed(2));

                const resetOS = () => {
                    os.value = {
                        id: Date.now().toString().slice(-6), date: new Date().toLocaleDateString(),
                        client: "", phone: "", device: "", problem: "", solution: "",
                        parts: 0, labor: 0, discount: 0
                    };
                };

                const saveOS = () => {
                    const newOS = { ...os.value, total: total.value };
                    history.value.unshift(newOS);
                    if (history.value.length > 50) history.value.pop(); // Limit history
                    resetOS();
                    alert("OS Salva no Hist√≥rico!");
                };

                const loadOS = (item) => {
                    os.value = { ...item };
                    printing.value = false; // ensure we are in edit mode
                };

                const shareWhatsapp = () => {
                    const text = `üìã *Ordem de Servi√ßo #${os.value.id}*\n` +
                        `Ol√° ${os.value.client},\n\n` +
                        `*Equipamento:* ${os.value.device}\n` +
                        `*Servi√ßo:* ${os.value.solution}\n` +
                        `*Valor Total:* R$ ${totalFormatted.value}\n\n` +
                        `Qualquer d√∫vida estamos √† disposi√ß√£o!`;
                    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
                };

                const printOS = () => { printing.value = true; };

                // BACKUP
                const backupData = () => {
                    const blob = new Blob([JSON.stringify(history.value)], { type: "application/json" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `backup_os_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
                    a.click();
                };

                const restoreData = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try { history.value = JSON.parse(ev.target.result); alert("Hist√≥rico restaurado!"); }
                        catch (err) { alert("Arquivo inv√°lido"); }
                    };
                    reader.readAsText(file);
                };

                // PERSIST
                onMounted(() => {
                    const h = localStorage.getItem('plena_os_history');
                    if (h) history.value = JSON.parse(h);
                });
                watch(history, () => localStorage.setItem('plena_os_history', JSON.stringify(history.value)), { deep: true });

                return {
                    isMenuOpen, os, printing, history, totalFormatted,
                    resetOS, saveOS, loadOS, shareWhatsapp, printOS,
                    backupData, restoreData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>