<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gerador de Orçamentos | Plena Aplicativos</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* A4 Print Styles */
        @media print {
            @page {
                margin: 0;
                size: A4;
            }

            body * {
                visibility: hidden;
            }

            #printable-area,
            #printable-area * {
                visibility: visible;
            }

            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                min-height: 297mm;
                background: white;
                padding: 20mm;
            }

            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="text-slate-800 h-screen overflow-hidden flex flex-col md:flex-row">

    <div id="app" class="flex-1 flex h-full w-full relative">

        <!-- Sidebar -->
        <aside
            class="hidden md:flex flex-col w-64 bg-slate-900 text-white border-r border-slate-800 z-20 shadow-xl no-print">
            <div class="p-6 flex items-center gap-3 border-b border-slate-800">
                <div
                    class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center shadow-lg shadow-brand-600/50">
                    <i class="fa-solid fa-file-signature text-white text-sm"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight">Orçamentos</h1>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a @click="currentView = 'editor'"
                    :class="currentView === 'editor' ? 'bg-brand-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl transition cursor-pointer font-medium select-none">
                    <i class="fa-solid fa-pen-to-square w-5 text-center"></i> <span>Novo Orçamento</span>
                </a>
                <a @click="currentView = 'history'"
                    :class="currentView === 'history' ? 'bg-brand-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl transition cursor-pointer font-medium select-none">
                    <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i> <span>Histórico</span>
                </a>
                <a @click="currentView = 'settings'"
                    :class="currentView === 'settings' ? 'bg-brand-600 text-white shadow-lg' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                    class="flex items-center gap-3 px-4 py-3 rounded-xl transition cursor-pointer font-medium select-none">
                    <i class="fa-solid fa-gear w-5 text-center"></i> <span>Configurações</span>
                </a>
            </nav>

            <div class="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                <button @click="backupData" class="hover:text-white underline">Backup</button> |
                <button @click="triggerImport" class="hover:text-white underline">Restaurar</button>
                <input type="file" id="importFile" class="hidden" @change="importData" accept=".json">
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 h-full overflow-hidden flex flex-col bg-slate-50 relative w-full">

            <!-- Mobile Header -->
            <header
                class="md:hidden h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 z-10 shrink-0 no-print">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white"><i
                            class="fa-solid fa-file-signature text-xs"></i></div>
                    <span class="font-bold text-slate-800">Orçamentos</span>
                </div>
                <!-- Mobile Menu Toggle (Simplified for brevity as Sidebar handled similarly across apps) -->
                <div class="text-xs text-slate-400">v3.0</div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">

                <!-- VIEW: EDITOR -->
                <div v-if="currentView === 'editor'" class="h-full flex flex-col md:flex-row gap-6 max-w-7xl mx-auto">

                    <!-- Form Column -->
                    <div class="flex-1 space-y-6 overflow-y-auto no-print">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-user text-brand-600"></i> Cliente</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="label">Nome do Cliente</label><input v-model="form.clientName"
                                        class="input" placeholder="Ex: João Silva"></div>
                                <div><label class="label">Telefone/Whatsapp</label><input v-model="form.clientPhone"
                                        class="input" placeholder="(00) 00000-0000"></div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2"><i
                                        class="fa-solid fa-box text-brand-600"></i> Itens</h3>
                                <button @click="addItem"
                                    class="text-xs font-bold text-brand-600 hover:text-brand-700 uppercase"><i
                                        class="fa-solid fa-plus"></i> Adicionar Item</button>
                            </div>
                            <div class="space-y-3">
                                <div v-for="(item, idx) in form.items" :key="idx" class="flex gap-2 items-start">
                                    <div class="w-16"><input v-model="item.qty" type="number" class="input text-center"
                                            placeholder="Qtd"></div>
                                    <div class="flex-1"><input v-model="item.desc" class="input"
                                            placeholder="Descrição do serviço/produto"></div>
                                    <div class="w-24"><input v-model="item.price" type="number" step="0.01"
                                            class="input text-right" placeholder="R$"></div>
                                    <button @click="removeItem(idx)" class="mt-2 text-slate-300 hover:text-red-500"><i
                                            class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="mt-4 text-right">
                                <span class="text-sm font-bold text-slate-500 uppercase mr-4">Total Estimado</span>
                                <span class="text-2xl font-bold text-brand-600">R$ {{ formatMoney(total) }}</span>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i
                                    class="fa-solid fa-calendar-days text-brand-600"></i> Detalhes da Proposta</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="label">Validade da Proposta</label><input v-model="form.validity"
                                        type="date" class="input"></div>
                                <div>
                                    <label class="label">Status Inicial</label>
                                    <select v-model="form.status" class="input">
                                        <option value="Pendente">Pendente</option>
                                        <option value="Aprovado">Aprovado</option>
                                        <option value="Recusado">Recusado</option>
                                    </select>
                                </div>
                                <div class="col-span-full"><label class="label">Observações / Condições</label><textarea
                                        v-model="form.notes" class="input h-20"
                                        placeholder="Ex: Pagamento 50% na entrada..."></textarea></div>
                            </div>
                        </div>

                        <div class="flex gap-3 pb-8">
                            <button @click="saveQuote"
                                class="flex-1 py-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl shadow-lg transition"><i
                                    class="fa-solid fa-save mr-2"></i> Salvar</button>
                            <button @click="printQuote"
                                class="flex-1 py-4 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-xl shadow-lg transition"><i
                                    class="fa-solid fa-print mr-2"></i> Imprimir / PDF</button>
                        </div>
                    </div>

                    <!-- Preview Column (A4 Scale) - Hidden on Mobile -->
                    <div
                        class="hidden xl:block w-[210mm] shrink-0 overflow-y-auto no-print bg-slate-200 p-8 rounded-2xl flex justify-center items-start">
                        <div
                            class="bg-white shadow-2xl w-[210mm] min-h-[297mm] p-[20mm] transform scale-75 origin-top relative text-xs">
                            <!-- Preview Content Mirroring the Print Area -->
                            <view-preview :data="form" :settings="settings" :total="total" :format-money="formatMoney"
                                :format-date="formatDate"></view-preview>
                        </div>
                    </div>

                </div>

                <!-- VIEW: HISTORY -->
                <div v-if="currentView === 'history'" class="max-w-5xl mx-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Orçamentos Gerados</h2>
                    <div class="space-y-4">
                        <div v-for="q in quotes" :key="q.id"
                            class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h3 class="font-bold text-slate-800 text-lg">{{ q.clientName || 'Cliente sem nome'
                                        }}</h3>
                                    <span :class="statusColor(q.status)"
                                        class="px-2 py-0.5 rounded text-xs font-bold uppercase">{{ q.status }}</span>
                                </div>
                                <div class="text-sm text-slate-500 mt-1">
                                    Emitido em {{ formatDate(q.date) }} • Válido até {{ formatDate(q.validity) }}
                                </div>
                            </div>
                            <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                                <div class="font-bold text-xl text-slate-700">R$ {{ formatMoney(q.total) }}</div>
                                <div class="flex gap-2">
                                    <button @click="loadQuote(q)" class="p-2 text-slate-400 hover:text-blue-600"><i
                                            class="fa-solid fa-pen"></i></button>
                                    <button @click="printSavedQuote(q)"
                                        class="p-2 text-slate-400 hover:text-slate-800"><i
                                            class="fa-solid fa-print"></i></button>
                                    <button @click="deleteQuote(q.id)" class="p-2 text-slate-400 hover:text-red-600"><i
                                            class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div v-if="quotes.length === 0" class="text-center py-20 text-slate-400">Nenhum orçamento salvo.
                        </div>
                    </div>
                </div>

                <!-- VIEW: SETTINGS -->
                <div v-if="currentView === 'settings'" class="max-w-2xl mx-auto">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Dados da Sua Empresa</h2>
                        <div class="space-y-4">
                            <div><label class="label">Nome da Empresa</label><input v-model="settings.companyName"
                                    class="input"></div>
                            <div><label class="label">CNPJ/CPF</label><input v-model="settings.document" class="input">
                            </div>
                            <div><label class="label">Telefone</label><input v-model="settings.phone" class="input">
                            </div>
                            <div><label class="label">Endereço</label><input v-model="settings.address" class="input">
                            </div>
                            <div><label class="label">Email/Site</label><input v-model="settings.email" class="input">
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Printable Area (The Real Document) -->
        <div id="printable-area" class="hidden">
            <!-- Logo/Header -->
            <div class="flex justify-between items-start border-b-2 border-slate-800 pb-8 mb-8">
                <div>
                    <h1 class="text-4xl font-bold text-slate-900 tracking-tight mb-2">ORÇAMENTO</h1>
                    <div class="text-sm text-slate-500 font-bold uppercase">#{{ form.id ? form.id.toString().slice(-6) :
                        'NOVO' }}</div>
                </div>
                <div class="text-right">
                    <h2 class="font-bold text-lg text-slate-800">{{ settings.companyName || 'Sua Empresa' }}</h2>
                    <p class="text-sm text-slate-500">{{ settings.document }}</p>
                    <p class="text-sm text-slate-500">{{ settings.phone }}</p>
                    <p class="text-sm text-slate-500">{{ settings.email }}</p>
                </div>
            </div>

            <!-- Client Info & Dates -->
            <div class="flex justify-between mb-12 bg-slate-50 p-6 rounded-xl">
                <div>
                    <span class="block text-xs font-bold text-slate-400 uppercase mb-1">Cliente</span>
                    <h3 class="font-bold text-xl text-slate-900">{{ form.clientName || '_______________' }}</h3>
                    <p class="text-slate-600">{{ form.clientPhone }}</p>
                </div>
                <div class="text-right space-y-2">
                    <div>
                        <span class="text-xs font-bold text-slate-400 uppercase mr-2">Data Emissão:</span>
                        <span class="font-medium">{{ formatDate(form.date) }}</span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-slate-400 uppercase mr-2">Válido até:</span>
                        <span class="font-bold text-brand-600">{{ formatDate(form.validity) || '___/___/___' }}</span>
                    </div>
                </div>
            </div>

            <!-- Items Table -->
            <table class="w-full mb-8">
                <thead>
                    <tr class="border-b border-slate-300">
                        <th class="text-left py-2 text-xs font-bold text-slate-500 uppercase">Qtd</th>
                        <th class="text-left py-2 text-xs font-bold text-slate-500 uppercase">Descrição</th>
                        <th class="text-right py-2 text-xs font-bold text-slate-500 uppercase">Valor Unit.</th>
                        <th class="text-right py-2 text-xs font-bold text-slate-500 uppercase">Total</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <tr v-for="item in form.items" class="text-sm">
                        <td class="py-3 font-medium">{{ item.qty }}</td>
                        <td class="py-3 text-slate-700">{{ item.desc }}</td>
                        <td class="py-3 text-right">R$ {{ formatMoney(item.price) }}</td>
                        <td class="py-3 text-right font-bold">R$ {{ formatMoney(item.price * item.qty) }}</td>
                    </tr>
                </tbody>
            </table>

            <!-- Total -->
            <div class="flex justify-end mb-12">
                <div class="text-right">
                    <div class="text-xs font-bold text-slate-500 uppercase mb-1">Total da Proposta</div>
                    <div class="text-4xl font-extrabold text-brand-600">R$ {{ formatMoney(total) }}</div>
                </div>
            </div>

            <!-- Footer/Notes -->
            <div v-if="form.notes" class="mb-12 border-l-4 border-slate-200 pl-4 py-2">
                <span class="block text-xs font-bold text-slate-400 uppercase mb-2">Observações & Condições</span>
                <p class="text-sm text-slate-600 leading-relaxed">{{ form.notes }}</p>
            </div>

            <!-- Signature Area -->
            <div class="mt-auto pt-20 flex justify-between gap-10">
                <div class="flex-1 border-t border-slate-300 pt-2 text-center text-xs text-slate-400">
                    {{ settings.companyName }}<br>(Responsável)
                </div>
                <div class="flex-1 border-t border-slate-300 pt-2 text-center text-xs text-slate-400">
                    {{ form.clientName }}<br>(Aprovação)
                </div>
            </div>
        </div>

    </div>

    <style>
        .label {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            outline: none;
            transition: all;
            background: #f8fafc;
            font-weight: 500;
        }

        .input:focus {
            border-color: #0ea5e9;
            background: #fff;
            ring: 2px solid #0ea5e9;
        }
    </style>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const DB_KEY_QUOTES = 'plena_orcamento_list_v1';
        const DB_KEY_SETTINGS = 'plena_orcamento_settings_v1';

        // Helper component for mirroring the printable area in the preview
        const ViewPreview = {
            props: ['data', 'settings', 'total', 'formatMoney', 'formatDate'],
            template: document.getElementById('printable-area').innerHTML // Use the same HTML for preview
        };

        createApp({
            components: { ViewPreview },
            setup() {
                const currentView = ref('editor');

                // State
                const quotes = ref([]);
                const settings = ref({ companyName: 'Minha Empresa', document: '', phone: '', address: '', email: '' });
                const form = ref({
                    id: null,
                    date: new Date().toISOString().split('T')[0],
                    clientName: '', clientPhone: '',
                    items: [{ qty: 1, desc: '', price: 0 }],
                    status: 'Pendente',
                    validity: '',
                    notes: ''
                });

                // Persistence
                onMounted(() => {
                    const savedQuotes = localStorage.getItem(DB_KEY_QUOTES);
                    if (savedQuotes) quotes.value = JSON.parse(savedQuotes);
                    const savedSettings = localStorage.getItem(DB_KEY_SETTINGS);
                    if (savedSettings) settings.value = JSON.parse(savedSettings);

                    // Set default validity (7 days from now)
                    const d = new Date(); d.setDate(d.getDate() + 7);
                    form.value.validity = d.toISOString().split('T')[0];
                });

                watch(settings, () => localStorage.setItem(DB_KEY_SETTINGS, JSON.stringify(settings.value)), { deep: true });
                watch(quotes, () => localStorage.setItem(DB_KEY_QUOTES, JSON.stringify(quotes.value)), { deep: true });

                // Computed
                const total = computed(() => {
                    return form.value.items.reduce((acc, item) => acc + (item.price * item.qty), 0);
                });

                // Methods
                const formatMoney = (v) => Number(v || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                const formatDate = (d) => d ? d.split('-').reverse().join('/') : '';
                const statusColor = (s) => {
                    if (s === 'Aprovado') return 'bg-green-100 text-green-600';
                    if (s === 'Recusado') return 'bg-red-100 text-red-600';
                    return 'bg-yellow-100 text-yellow-600';
                };

                const addItem = () => form.value.items.push({ qty: 1, desc: '', price: 0 });
                const removeItem = (i) => form.value.items.splice(i, 1);

                const saveQuote = () => {
                    if (!form.value.clientName) return alert('Preencha o nome do cliente.');
                    const snap = JSON.parse(JSON.stringify(form.value));

                    if (snap.id) {
                        const idx = quotes.value.findIndex(q => q.id === snap.id);
                        if (idx !== -1) quotes.value[idx] = { ...snap, total: total.value };
                    } else {
                        snap.id = Date.now();
                        quotes.value.unshift({ ...snap, total: total.value });
                    }

                    currentView.value = 'history';
                    resetForm();
                };

                const loadQuote = (q) => {
                    form.value = JSON.parse(JSON.stringify(q));
                    currentView.value = 'editor';
                };

                const deleteQuote = (id) => {
                    if (confirm('Excluir orçamento?')) quotes.value = quotes.value.filter(q => q.id !== id);
                };

                const resetForm = () => {
                    form.value = {
                        id: null,
                        date: new Date().toISOString().split('T')[0],
                        clientName: '', clientPhone: '',
                        items: [{ qty: 1, desc: '', price: 0 }],
                        status: 'Pendente',
                        validity: form.value.validity, // Keep validity setting
                        notes: ''
                    };
                };

                const printQuote = () => window.print();
                const printSavedQuote = (q) => {
                    loadQuote(q);
                    setTimeout(() => window.print(), 300);
                };

                // Backup
                const backupData = () => {
                    const data = { quotes: quotes.value, settings: settings.value };
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = 'orcamentos_backup.json';
                    a.click();
                };
                const triggerImport = () => document.getElementById('importFile').click();
                const importData = (e) => {
                    const f = e.target.files[0];
                    if (!f) return;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const data = JSON.parse(ev.target.result);
                        if (data.quotes) quotes.value = data.quotes;
                        if (data.settings) settings.value = data.settings;
                        location.reload();
                    }
                    r.readAsText(f);
                };

                return {
                    currentView, form, settings, quotes, total,
                    formatMoney, formatDate, statusColor,
                    addItem, removeItem, saveQuote, loadQuote, deleteQuote,
                    printQuote, printSavedQuote,
                    backupData, triggerImport, importData
                };
            }
        }).mount('#app');
    </script>
</body>

</html>